<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-language" content="en">

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Replication study: Estimating number of inections and impact of NPIs on COVID-19 in European countries (Imperial Report 13)</title>
    <meta name="description" content="">
    <meta name="author" content="The Turing Team">
    <meta name="theme-color" content="red">
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
    <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="canonical" href="/dev/posts/2020-05-04-Imperial-Report13-analysis">
    <link rel="alternate" type="application/rss+xml" title="Turing.jl" href="/dev/feed.xml">
    <meta name="lang:clipboard.copy" content="Copy to clipboard">
    <meta name="lang:clipboard.copied" content="Copied to clipboard">
    <meta name="lang:search.language" content="en">
    <meta name="lang:search.pipeline.stopwords" content="True">
    <meta name="lang:search.pipeline.trimmer" content="True">
    <meta name="lang:search.result.none" content="No matching documents">
    <meta name="lang:search.result.one" content="1 matching document">
    <meta name="lang:search.result.other" content="# matching documents">
    <meta name="lang:search.tokenizer" content="[\s\-]+">
    <script src="/versions.js"></script>
    <script src="/dev/assets/js/modernizr.74668098.js"></script>
    <link rel="shortcut icon" href="/dev/assets/img/favicon.ico">
    <link rel="stylesheet" href="/dev/assets/css/main.css">
    <link rel="stylesheet" href="/dev/assets/css/palette.css">
    <link rel="stylesheet" href="/dev/assets/css/header.css">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    

    
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    

  </head>

  <body dir="ltr" data-md-color-primary="red" data-md-color-accent="red">
    

<svg class="md-svg">
<defs>
  <svg>
  <path d="M160 304q0 10-3.125 20.5t-10.75 19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75 19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360 304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25 2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75 1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75 0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5 46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z" fill="currentColor"></path></svg>
</defs></svg>

    <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off>
    <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off>
    <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href="#replication-study-estimating-number-of-inections-and-impact-of-npis-on-covid-19-in-european-countries-imperial-report-13" tabindex=1 class=md-skip> Skip to content </a>
    <header class=md-header data-md-component=header data-md-state=none>
        <nav class="md-header-nav md-grid">
            <div class=md-flex>
                <div class="md-flex__cell md-flex__cell--shrink">
                </div>

                <div class="md-flex__cell md-flex__cell--shrink">
                    <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label>
                </div>

                <div class="md-flex__cell md-flex__cell--shrink">
                    <a class="md-header-nav__button md-logo" href="/dev/" title="Turing.jl">
                    <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title>
                        <span class=md-header-nav__topic>Turing.jl</span>
                    </div>
                    </a>
                </div>

                <div class="md-flex__cell md-flex__cell--shrink">
                  <div class="md-header-nav__source">
                    <div class="dropdown version-switch">
                      <a class="dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      </a>
                      <div class="dropdown-menu">
                        <!-- a class="dropdown-item" href="#">Stable</a -->
                        <!-- div class="dropdown-divider"></div -->
                      </div>
                    </div>
                  </div>
                </div>

                <div class="md-flex__cell md-flex__cell--shrink">
                  <div class="md-header-nav__source">
                    <a class="md-source" href="/dev/docs/using-turing/get-started" title="Get started">
                      Get Started
                    </a>
                  </div>
                </div>

                <div class="md-flex__cell md-flex__cell--shrink">
                    <div class="md-header-nav__source">
                      <a class="md-source" href="/dev/docs/using-turing/" title="View documentation">
                        Documentation
                      </a>
                    </div>
                  </div>

                  <div class="md-flex__cell md-flex__cell--shrink">
                      <div class="md-header-nav__source">
                        <a class="md-source" href="/dev/tutorials/" title="View tutorials">
                          Tutorials
                        </a>
                      </div>
                    </div>

                    <div class="md-flex__cell md-flex__cell--shrink">
                      <div class="md-header-nav__source">
                        <a class="md-source" href="/dev/news/" title="News">
                          News
                        </a>
                      </div>
                    </div>

                    <div class="md-flex__cell md-flex__cell--shrink">
                      <div class="md-header-nav__source">
                        <a class="md-source" href="/dev/team/" title="Team">
                          Team
                        </a>
                      </div>
                    </div>

                <div class="md-flex__cell md-flex__cell--shrink">
                  <div class="md-header-nav__source">
                    <a class="md-source" data-md-source="github" href="https://github.com/TuringLang/Turing.jl" title="Go to repository">
                    <div class="md-source__icon" style="padding-top:5px">
                      <i class="fa fa-github fa-3x"></i>
                    </div>
                    <div class="md-source__repository">
                      TuringLang/Turing.jl
                    </div></a>
                  </div>
                </div>

                <div class="md-flex__cell md-flex__cell--shrink">
                  <div class="md-header-nav__source">
                    <a href="https://twitter.com/TuringLang?ref_src=twsrc%5Etfw" class="twitter-follow-button"
                       data-size="large" data-show-screen-name="false" data-show-count="false">Follow @TuringLang</a>
                    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                  </div>
                </div>

                <div class="md-flex__cell md-flex__cell--shrink">
                    <label class="md-icon md-icon--search md-header-nav__button" for=__search></label>
                    <div class=md-search data-md-component=search role=dialog>
                        <label class=md-search__overlay for=__search></label>
                        <div class=md-search__inner role=search>
                            <form class=md-search__form name=search>
                                <input type=text class=md-search__input name=query placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active>
                                <label class="md-icon md-search__icon" for=__search></label>
                                <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button>
                            </form>
                            <div class=md-search__output>
                                <div class=md-search__scrollwrap data-md-scrollfix>
                                    <div class=md-search-result data-md-component=result>
                                        <div class=md-search-result__meta> Type to start searching </div>
                                        <ol class=md-search-result__list></ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
    </div>
  </nav>
</header>


    <div class="md-container">
        <main class="md-main">
            <div class="md-main__inner md-grid full-width" data-md-component="container">
            
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
  <div class="md-sidebar__scrollwrap">
    <div class="md-sidebar__inner">
      <nav class="md-nav md-nav--primary" data-md-level="0">

        <label class="md-nav__title md-nav__title--site">
            <a class="" href="/dev/" title="Turing.jl">
              <span class="md-nav__button md-logo">
                Turing.jl
              </span>
            </a>
        </label>

        <ul class="md-nav__list" data-md-scrollfix="">
          <li class="md-nav__item md-nav__item--active">
            <input class="md-toggle md-nav__toggle" data-md-toggle="toc" id="__toc" type="checkbox" />

            <nav class="md-nav md-nav--secondary">

                <a class="" href="/dev/" title="Turing.jl">
                  <label class="md-nav__title md-nav__title--site">
                    <span class="md-nav__button md-logo">
                      Turing.jl
                    </span>
                  </label>
                </a>

                <div class="md-nav__source">
                    <a class="md-source" data-md-source="github" href="https://github.com/TuringLang/Turing.jl" title="Go to repository">
                    <span class="md-source__icon">
                        <i class="fa fa-github fa-3x"></i>
                    </span>
                    <span class="md-source__repository">
                      TuringLang/Turing.jl
                    </span></a>
                </div>

                <div class="md-nav__dropdown">
                  <select id="version-selector">
                    <!-- option value="#" selected="selected">v 0.5.1</option -->
                  </select>
                </div>

              <label class="md-nav__title" for="__drawer"></label>

              

        </ul>
      </nav>
    </div>
  </div>
</div>


                <div id="md-container-pancakes">
                <div class="md-content full-width"> 
    <article class="md-content__inner md-typeset  full-width">
    <h1 style="margin-bottom:0px">Replication study: Estimating number of inections and impact of NPIs on COVID-19 in European countries (Imperial Report 13)</h1>
    
     <span class"author"> Tor Erlend Fjelde </span> <br>
    <span class="post-date" style="font-style: italic;">May 04, 2020</span>

    <style>div.two-by-two { height: 100%;display: flex;flex-direction: row;flex-wrap: wrap; } div.two-by-two > p { width: 45%; margin: 0 auto; } </style>

<p>We, i.e. the <a href="https://turing.ml/dev/team/">TuringLang team</a>, are currently exploring cooperation with other researchers in attempt to help with the ongoing crisis. As preparation for this and to get our feet wet, we decided it would be useful to do a replication study of the <a href="https://www.imperial.ac.uk/mrc-global-infectious-disease-analysis/covid-19/report-13-europe-npi-impact/">Imperial Report 13</a>. We figured it might be useful for the public, in particular other researchers working on the same or similar models, to see the results of this analysis, and thus decided to make it available here.</p>

<p>We want to emphasize that you should look to the original paper rather than this post for developments and analysis of the model. We are not aiming to make any claims about the validity or the implications of the model and refer to <a href="https://www.imperial.ac.uk/mrc-global-infectious-disease-analysis/covid-19/report-13-europe-npi-impact/">Imperial Report 13</a> for details on the model itself. This post’s purpose is only to add tiny bit of validation to the <em>inference</em> performed in the paper by obtaining the same results using a different probabilistic programming language (PPL) and to explore whether or not <code class="highlighter-rouge">Turing.jl</code> can be useful for researchers working on these problems.</p>

<div id="plot-3" class="plotly"></div>
<script>
 Plotly.d3.json("../assets/figures/2020-05-04-Imperial-Report13-analysis/plot2.json", function(err, fig) {
   Plotly.plot("plot-3", fig.data, fig.layout, {responsive: true});
 });
</script>

<p>All code and inference results shown in this post can be found <a href="https://github.com/TuringLang/Covid19">here</a>.</p>

<h1 id="setup">Setup</h1>

<p>This is all assuming that you’re in the project directory of <a href="https://github.com/TuringLang/Covid19"><code class="highlighter-rouge">Covid19.jl</code></a>, a small package where we gather most of our ongoing work.</p>

<p>In the project we use <a href="https://github.com/JuliaDynamics/DrWatson.jl"><code class="highlighter-rouge">DrWatson.jl</code></a> which provides a lot of convenient functionality for, well, working with a project. The below code will activate the <code class="highlighter-rouge">Covid19.jl</code> project to ensure that we’re using correct versions of all the dependencies, i.e. code is reproducible. It’s basically just doing <code class="highlighter-rouge">] activate</code> but with a few bells and whistles that we’ll use later.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="n">DrWatson</span>
<span class="n">quickactivate</span><span class="x">(</span><span class="nd">@__DIR__</span><span class="x">)</span>
</code></pre></div></div>

<p>With the project activate, we can import the <code class="highlighter-rouge">Covid19.jl</code> package:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Loading the project (https://github.com/TuringLang/Covid19)</span>
<span class="k">using</span> <span class="n">Covid19</span>
</code></pre></div></div>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Some other packages we'll need</span>
<span class="k">using</span> <span class="n">Random</span><span class="x">,</span> <span class="n">Dates</span><span class="x">,</span> <span class="n">Turing</span><span class="x">,</span> <span class="n">Bijectors</span>
</code></pre></div></div>

<p>And we’ll be using the new <a href="https://julialang.org/blog/2019/07/multithreading/">multithreading functionality in Julia</a> to speed things up, so we need the <code class="highlighter-rouge">Base.Threads</code> package.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="n">Base</span><span class="o">.</span><span class="n">Threads</span>
<span class="n">nthreads</span><span class="x">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>4
</code></pre></div></div>

<p>Here’s a summary of the setup:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="n">Pkg</span>
<span class="n">Pkg</span><span class="o">.</span><span class="n">status</span><span class="x">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Project Covid19 v0.1.0
Status `~/Projects/mine/Covid19/Project.toml`
  [dce04be8] ArgCheck v2.0.0
  [c7e460c6] ArgParse v1.1.0
  [131c737c] ArviZ v0.4.1
  [76274a88] Bijectors v0.6.7 #tor/using-bijectors-in-link-and-invlink (https://github.com/TuringLang/Bijectors.jl.git)
  [336ed68f] CSV v0.6.1
  [a93c6f00] DataFrames v0.20.2
  [31c24e10] Distributions v0.23.2
  [ced4e74d] DistributionsAD v0.4.10
  [634d3b9d] DrWatson v1.10.2
  [1a297f60] FillArrays v0.8.7
  [58dd65bb] Plotly v0.3.0
  [f0f68f2c] PlotlyJS v0.13.1
  [91a5bcdd] Plots v1.1.2
  [438e738f] PyCall v1.91.4
  [d330b81b] PyPlot v2.9.0
  [df47a6cb] RData v0.7.1
  [2913bbd2] StatsBase v0.33.0
  [f3b207a7] StatsPlots v0.14.5
  [fce5fe82] Turing v0.11.0 #tor/modelling-temporary (https://github.com/TuringLang/Turing.jl.git)
  [9a3f8284] Random 
  [10745b16] Statistics 
</code></pre></div></div>

<p>In the Github project you will find a <code class="highlighter-rouge">Manifest.toml</code>. This means that if you’re working directory is the project directory, and you do <code class="highlighter-rouge">julia --project</code> followed by <code class="highlighter-rouge">] instantiate</code> you will have <em>exactly</em> the same enviroment as we had when performing this analysis.</p>

<details><summary><p>Overloading some functionality in <code class="highlighter-rouge">DrWatson.jl</code></p>
</summary>
<p>As mentioned <code class="highlighter-rouge">DrWatson.jl</code> provides a lot of convenience functions for working in a project, and one of them is <code class="highlighter-rouge">projectdir(args...)</code> which will resolve join the <code class="highlighter-rouge">args</code> to the absolute path of the project directory. In similar fashion it provides a <code class="highlighter-rouge">datadir</code> method which defaults to <code class="highlighter-rouge">projectdir("data")</code>. But to remove the possibility of making a type later on when writing <code class="highlighter-rouge">datadir("imperial-report13")</code>, we’ll overload this method for this notebook:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="n">DrWatson</span><span class="o">:</span> <span class="n">datadir</span>

<span class="n">outdir</span><span class="x">()</span> <span class="o">=</span> <span class="n">projectdir</span><span class="x">(</span><span class="s">"out"</span><span class="x">)</span>
<span class="n">outdir</span><span class="x">(</span><span class="n">args</span><span class="o">...</span><span class="x">)</span> <span class="o">=</span> <span class="n">projectdir</span><span class="x">(</span><span class="s">"out"</span><span class="x">,</span> <span class="n">args</span><span class="o">...</span><span class="x">)</span>

<span class="n">datadir</span><span class="x">()</span> <span class="o">=</span> <span class="n">projectdir</span><span class="x">(</span><span class="s">"data"</span><span class="x">,</span> <span class="s">"imperial-report13"</span><span class="x">)</span>
<span class="n">datadir</span><span class="x">(</span><span class="n">s</span><span class="o">...</span><span class="x">)</span> <span class="o">=</span> <span class="n">projectdir</span><span class="x">(</span><span class="s">"data"</span><span class="x">,</span> <span class="s">"imperial-report13"</span><span class="x">,</span> <span class="n">s</span><span class="o">...</span><span class="x">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>datadir (generic function with 2 methods)
</code></pre></div></div>

</details>

<h1 id="data">Data</h1>

<p>To ensure consistency with the original model from the paper (and to stay up-to-date with the changes made), we preprocessed the data using the <code class="highlighter-rouge">base.r</code> script from the <a href="https://github.com/ImperialCollegeLondon/covid19model/tree/6ee3010a58a57cc14a16545ae897ca668b7c9096">original repository (#6ee3010)</a> and store the processed data in a <code class="highlighter-rouge">processed.rds</code> file. To load this RDS file obtained from the R script, we make use of the RData.jl package which allows us to load the RDS file into a Julia <code class="highlighter-rouge">Dict</code>.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="n">RData</span>
</code></pre></div></div>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rdata_full</span> <span class="o">=</span> <span class="n">load</span><span class="x">(</span><span class="n">datadir</span><span class="x">(</span><span class="s">"processed.rds"</span><span class="x">))</span>
<span class="n">rdata</span> <span class="o">=</span> <span class="n">rdata_full</span><span class="x">[</span><span class="s">"stan_data"</span><span class="x">];</span>
</code></pre></div></div>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">keys</span><span class="x">(</span><span class="n">rdata_full</span><span class="x">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Base.KeySet for a Dict{String,Int64} with 4 entries. Keys:
  "reported_cases"
  "stan_data"
  "deaths_by_country"
  "dates"
</code></pre></div></div>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">country_to_dates</span> <span class="o">=</span> <span class="n">d</span> <span class="o">=</span> <span class="kt">Dict</span><span class="x">([(</span><span class="n">k</span><span class="x">,</span> <span class="n">rdata_full</span><span class="x">[</span><span class="s">"dates"</span><span class="x">][</span><span class="n">k</span><span class="x">])</span> <span class="k">for</span> <span class="n">k</span> <span class="k">in</span> <span class="n">keys</span><span class="x">(</span><span class="n">rdata_full</span><span class="x">[</span><span class="s">"dates"</span><span class="x">])])</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dict{String,Array{Date,1}} with 14 entries:
  "Sweden"         =&gt; Date[2020-02-18, 2020-02-19, 2020-02-20, 2020-02-21, 2020…
  "Belgium"        =&gt; Date[2020-02-18, 2020-02-19, 2020-02-20, 2020-02-21, 2020…
  "Greece"         =&gt; Date[2020-02-19, 2020-02-20, 2020-02-21, 2020-02-22, 2020…
  "Switzerland"    =&gt; Date[2020-02-14, 2020-02-15, 2020-02-16, 2020-02-17, 2020…
  "Germany"        =&gt; Date[2020-02-15, 2020-02-16, 2020-02-17, 2020-02-18, 2020…
  "United_Kingdom" =&gt; Date[2020-02-12, 2020-02-13, 2020-02-14, 2020-02-15, 2020…
  "Denmark"        =&gt; Date[2020-02-21, 2020-02-22, 2020-02-23, 2020-02-24, 2020…
  "Norway"         =&gt; Date[2020-02-24, 2020-02-25, 2020-02-26, 2020-02-27, 2020…
  "France"         =&gt; Date[2020-02-07, 2020-02-08, 2020-02-09, 2020-02-10, 2020…
  "Portugal"       =&gt; Date[2020-02-21, 2020-02-22, 2020-02-23, 2020-02-24, 2020…
  "Spain"          =&gt; Date[2020-02-09, 2020-02-10, 2020-02-11, 2020-02-12, 2020…
  "Netherlands"    =&gt; Date[2020-02-14, 2020-02-15, 2020-02-16, 2020-02-17, 2020…
  "Italy"          =&gt; Date[2020-01-27, 2020-01-28, 2020-01-29, 2020-01-30, 2020…
  "Austria"        =&gt; Date[2020-02-22, 2020-02-23, 2020-02-24, 2020-02-25, 2020…
</code></pre></div></div>

<p>Since the data-format is not native Julia there might be some discrepancies in the <em>types</em> of the some data fields, and so we need to do some type-conversion of the loaded <code class="highlighter-rouge">rdata</code>. We also rename a lot of the fields to make it more understandable and for an easier mapping to our implementation of the model. Feel free to skip this snippet.</p>

<details><summary><p>Data wrangling</p>
</summary>
<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Convert some misparsed fields</span>
<span class="n">rdata</span><span class="x">[</span><span class="s">"N2"</span><span class="x">]</span> <span class="o">=</span> <span class="kt">Int</span><span class="x">(</span><span class="n">rdata</span><span class="x">[</span><span class="s">"N2"</span><span class="x">]);</span>
<span class="n">rdata</span><span class="x">[</span><span class="s">"N0"</span><span class="x">]</span> <span class="o">=</span> <span class="kt">Int</span><span class="x">(</span><span class="n">rdata</span><span class="x">[</span><span class="s">"N0"</span><span class="x">]);</span>

<span class="n">rdata</span><span class="x">[</span><span class="s">"EpidemicStart"</span><span class="x">]</span> <span class="o">=</span> <span class="kt">Int</span><span class="o">.</span><span class="x">(</span><span class="n">rdata</span><span class="x">[</span><span class="s">"EpidemicStart"</span><span class="x">]);</span>

<span class="n">rdata</span><span class="x">[</span><span class="s">"cases"</span><span class="x">]</span> <span class="o">=</span> <span class="kt">Int</span><span class="o">.</span><span class="x">(</span><span class="n">rdata</span><span class="x">[</span><span class="s">"cases"</span><span class="x">]);</span>
<span class="n">rdata</span><span class="x">[</span><span class="s">"deaths"</span><span class="x">]</span> <span class="o">=</span> <span class="kt">Int</span><span class="o">.</span><span class="x">(</span><span class="n">rdata</span><span class="x">[</span><span class="s">"deaths"</span><span class="x">]);</span>

<span class="c"># Stan will fail if these are `nothing` so we make them empty arrays</span>
<span class="n">rdata</span><span class="x">[</span><span class="s">"x"</span><span class="x">]</span> <span class="o">=</span> <span class="x">[]</span>
<span class="n">rdata</span><span class="x">[</span><span class="s">"features"</span><span class="x">]</span> <span class="o">=</span> <span class="x">[]</span>

<span class="n">countries</span> <span class="o">=</span> <span class="x">(</span>
  <span class="s">"Denmark"</span><span class="x">,</span>
  <span class="s">"Italy"</span><span class="x">,</span>
  <span class="s">"Germany"</span><span class="x">,</span>
  <span class="s">"Spain"</span><span class="x">,</span>
  <span class="s">"United_Kingdom"</span><span class="x">,</span>
  <span class="s">"France"</span><span class="x">,</span>
  <span class="s">"Norway"</span><span class="x">,</span>
  <span class="s">"Belgium"</span><span class="x">,</span>
  <span class="s">"Austria"</span><span class="x">,</span> 
  <span class="s">"Sweden"</span><span class="x">,</span>
  <span class="s">"Switzerland"</span><span class="x">,</span>
  <span class="s">"Greece"</span><span class="x">,</span>
  <span class="s">"Portugal"</span><span class="x">,</span>
  <span class="s">"Netherlands"</span>
<span class="x">)</span>
<span class="n">num_countries</span> <span class="o">=</span> <span class="n">length</span><span class="x">(</span><span class="n">countries</span><span class="x">)</span>

<span class="n">names_covariates</span> <span class="o">=</span> <span class="x">(</span><span class="s">"schools_universities"</span><span class="x">,</span> <span class="s">"self_isolating_if_ill"</span><span class="x">,</span> <span class="s">"public_events"</span><span class="x">,</span> <span class="s">"any"</span><span class="x">,</span> <span class="s">"lockdown"</span><span class="x">,</span> <span class="s">"social_distancing_encouraged"</span><span class="x">)</span>
<span class="n">lockdown_index</span> <span class="o">=</span> <span class="n">findfirst</span><span class="x">(</span><span class="o">==</span><span class="x">(</span><span class="s">"lockdown"</span><span class="x">),</span> <span class="n">names_covariates</span><span class="x">)</span>


<span class="k">function</span><span class="nf"> rename</span><span class="o">!</span><span class="x">(</span><span class="n">d</span><span class="x">,</span> <span class="n">names</span><span class="o">::</span><span class="kt">Pair</span><span class="o">...</span><span class="x">)</span>
    <span class="c"># check that keys are not yet present before updating `d`</span>
    <span class="k">for</span> <span class="n">k_new</span> <span class="k">in</span> <span class="n">values</span><span class="o">.</span><span class="x">(</span><span class="n">names</span><span class="x">)</span>
        <span class="nd">@assert</span> <span class="n">k_new</span> <span class="n">∉</span> <span class="n">keys</span><span class="x">(</span><span class="n">d</span><span class="x">)</span> <span class="s">"</span><span class="si">$(k_new) </span><span class="s">already in dictionary"</span>
    <span class="k">end</span>

    <span class="k">for</span> <span class="x">(</span><span class="n">k_old</span><span class="x">,</span> <span class="n">k_new</span><span class="x">)</span> <span class="k">in</span> <span class="n">names</span>
        <span class="n">d</span><span class="x">[</span><span class="n">k_new</span><span class="x">]</span> <span class="o">=</span> <span class="n">pop!</span><span class="x">(</span><span class="n">d</span><span class="x">,</span> <span class="n">k_old</span><span class="x">)</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">d</span>
<span class="k">end</span>

<span class="c"># `rdata` is a `DictOfVector` so we convert to a simple `Dict` for simplicity</span>
<span class="n">d</span> <span class="o">=</span> <span class="kt">Dict</span><span class="x">([(</span><span class="n">k</span><span class="x">,</span> <span class="n">rdata</span><span class="x">[</span><span class="n">k</span><span class="x">])</span> <span class="k">for</span> <span class="n">k</span> <span class="k">in</span> <span class="n">keys</span><span class="x">(</span><span class="n">rdata</span><span class="x">)])</span> <span class="c"># `values(df)` and `keys(df)` have different ordering so DON'T do `Dict(keys(df), values(df))`</span>

<span class="c"># Rename some columns</span>
<span class="n">rename!</span><span class="x">(</span>
    <span class="n">d</span><span class="x">,</span>
    <span class="s">"f"</span> <span class="o">=&gt;</span> <span class="s">"π"</span><span class="x">,</span> <span class="s">"SI"</span> <span class="o">=&gt;</span> <span class="s">"serial_intervals"</span><span class="x">,</span> <span class="s">"pop"</span> <span class="o">=&gt;</span> <span class="s">"population"</span><span class="x">,</span>
    <span class="s">"M"</span> <span class="o">=&gt;</span> <span class="s">"num_countries"</span><span class="x">,</span> <span class="s">"N0"</span> <span class="o">=&gt;</span> <span class="s">"num_impute"</span><span class="x">,</span> <span class="s">"N"</span> <span class="o">=&gt;</span> <span class="s">"num_obs_countries"</span><span class="x">,</span>
    <span class="s">"N2"</span> <span class="o">=&gt;</span> <span class="s">"num_total_days"</span><span class="x">,</span> <span class="s">"EpidemicStart"</span> <span class="o">=&gt;</span> <span class="s">"epidemic_start"</span><span class="x">,</span>
    <span class="s">"X"</span> <span class="o">=&gt;</span> <span class="s">"covariates"</span><span class="x">,</span> <span class="s">"P"</span> <span class="o">=&gt;</span> <span class="s">"num_covariates"</span>
<span class="x">)</span>

<span class="c"># Add some type-information to arrays and replace `-1` with `missing` (as `-1` is supposed to represent, well, missing data)</span>
<span class="n">d</span><span class="x">[</span><span class="s">"deaths"</span><span class="x">]</span> <span class="o">=</span> <span class="kt">Int</span><span class="o">.</span><span class="x">(</span><span class="n">d</span><span class="x">[</span><span class="s">"deaths"</span><span class="x">])</span>
<span class="c"># d["deaths"] = replace(d["deaths"], -1 =&gt; missing)</span>
<span class="n">d</span><span class="x">[</span><span class="s">"deaths"</span><span class="x">]</span> <span class="o">=</span> <span class="n">collect</span><span class="x">(</span><span class="n">eachcol</span><span class="x">(</span><span class="n">d</span><span class="x">[</span><span class="s">"deaths"</span><span class="x">]))</span> <span class="c"># convert into Array of arrays instead of matrix</span>

<span class="n">d</span><span class="x">[</span><span class="s">"cases"</span><span class="x">]</span> <span class="o">=</span> <span class="kt">Int</span><span class="o">.</span><span class="x">(</span><span class="n">d</span><span class="x">[</span><span class="s">"cases"</span><span class="x">])</span>
<span class="c"># d["cases"] = replace(d["cases"], -1 =&gt; missing)</span>
<span class="n">d</span><span class="x">[</span><span class="s">"cases"</span><span class="x">]</span> <span class="o">=</span> <span class="n">collect</span><span class="x">(</span><span class="n">eachcol</span><span class="x">(</span><span class="n">d</span><span class="x">[</span><span class="s">"cases"</span><span class="x">]))</span> <span class="c"># convert into Array of arrays instead of matrix</span>

<span class="n">d</span><span class="x">[</span><span class="s">"num_covariates"</span><span class="x">]</span> <span class="o">=</span> <span class="kt">Int</span><span class="x">(</span><span class="n">d</span><span class="x">[</span><span class="s">"num_covariates"</span><span class="x">])</span>
<span class="n">d</span><span class="x">[</span><span class="s">"num_countries"</span><span class="x">]</span> <span class="o">=</span> <span class="kt">Int</span><span class="x">(</span><span class="n">d</span><span class="x">[</span><span class="s">"num_countries"</span><span class="x">])</span>
<span class="n">d</span><span class="x">[</span><span class="s">"num_total_days"</span><span class="x">]</span> <span class="o">=</span> <span class="kt">Int</span><span class="x">(</span><span class="n">d</span><span class="x">[</span><span class="s">"num_total_days"</span><span class="x">])</span>
<span class="n">d</span><span class="x">[</span><span class="s">"num_impute"</span><span class="x">]</span> <span class="o">=</span> <span class="kt">Int</span><span class="x">(</span><span class="n">d</span><span class="x">[</span><span class="s">"num_impute"</span><span class="x">])</span>
<span class="n">d</span><span class="x">[</span><span class="s">"num_obs_countries"</span><span class="x">]</span> <span class="o">=</span> <span class="kt">Int</span><span class="o">.</span><span class="x">(</span><span class="n">d</span><span class="x">[</span><span class="s">"num_obs_countries"</span><span class="x">])</span>
<span class="n">d</span><span class="x">[</span><span class="s">"epidemic_start"</span><span class="x">]</span> <span class="o">=</span> <span class="kt">Int</span><span class="o">.</span><span class="x">(</span><span class="n">d</span><span class="x">[</span><span class="s">"epidemic_start"</span><span class="x">])</span>
<span class="n">d</span><span class="x">[</span><span class="s">"population"</span><span class="x">]</span> <span class="o">=</span> <span class="kt">Int</span><span class="o">.</span><span class="x">(</span><span class="n">d</span><span class="x">[</span><span class="s">"population"</span><span class="x">])</span>

<span class="n">d</span><span class="x">[</span><span class="s">"π"</span><span class="x">]</span> <span class="o">=</span> <span class="n">collect</span><span class="x">(</span><span class="n">eachcol</span><span class="x">(</span><span class="n">d</span><span class="x">[</span><span class="s">"π"</span><span class="x">]))</span> <span class="c"># convert into Array of arrays instead of matrix</span>

<span class="c"># Convert 3D array into Array{Matrix}</span>
<span class="n">covariates</span> <span class="o">=</span> <span class="x">[</span><span class="n">rdata</span><span class="x">[</span><span class="s">"X"</span><span class="x">][</span><span class="n">m</span><span class="x">,</span> <span class="o">:</span><span class="x">,</span> <span class="o">:</span><span class="x">]</span> <span class="k">for</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">num_countries</span><span class="x">]</span>

<span class="n">data</span> <span class="o">=</span> <span class="x">(;</span> <span class="x">(</span><span class="n">k</span> <span class="o">=&gt;</span> <span class="n">d</span><span class="x">[</span><span class="kt">String</span><span class="x">(</span><span class="n">k</span><span class="x">)]</span> <span class="k">for</span> <span class="n">k</span> <span class="k">in</span> <span class="x">[</span><span class="o">:</span><span class="n">num_countries</span><span class="x">,</span> <span class="o">:</span><span class="n">num_impute</span><span class="x">,</span> <span class="o">:</span><span class="n">num_obs_countries</span><span class="x">,</span> <span class="o">:</span><span class="n">num_total_days</span><span class="x">,</span> <span class="o">:</span><span class="n">cases</span><span class="x">,</span> <span class="o">:</span><span class="n">deaths</span><span class="x">,</span> <span class="o">:</span><span class="nb">π</span><span class="x">,</span> <span class="o">:</span><span class="n">epidemic_start</span><span class="x">,</span> <span class="o">:</span><span class="n">population</span><span class="x">,</span> <span class="o">:</span><span class="n">serial_intervals</span><span class="x">])</span><span class="o">...</span><span class="x">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">merge</span><span class="x">(</span><span class="n">data</span><span class="x">,</span> <span class="x">(</span><span class="n">covariates</span> <span class="o">=</span> <span class="n">covariates</span><span class="x">,</span> <span class="x">));</span>

<span class="c"># Can deal with ragged arrays, so we can shave off unobserved data (future) which are just filled with -1</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">merge</span><span class="x">(</span>
    <span class="n">data</span><span class="x">,</span>
    <span class="x">(</span><span class="n">cases</span> <span class="o">=</span> <span class="x">[</span><span class="n">data</span><span class="o">.</span><span class="n">cases</span><span class="x">[</span><span class="n">m</span><span class="x">][</span><span class="mi">1</span><span class="o">:</span><span class="n">data</span><span class="o">.</span><span class="n">num_obs_countries</span><span class="x">[</span><span class="n">m</span><span class="x">]]</span> <span class="k">for</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">data</span><span class="o">.</span><span class="n">num_countries</span><span class="x">],</span>
     <span class="n">deaths</span> <span class="o">=</span> <span class="x">[</span><span class="n">data</span><span class="o">.</span><span class="n">deaths</span><span class="x">[</span><span class="n">m</span><span class="x">][</span><span class="mi">1</span><span class="o">:</span><span class="n">data</span><span class="o">.</span><span class="n">num_obs_countries</span><span class="x">[</span><span class="n">m</span><span class="x">]]</span> <span class="k">for</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">data</span><span class="o">.</span><span class="n">num_countries</span><span class="x">])</span>
<span class="x">);</span>
</code></pre></div></div>

</details>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span><span class="o">.</span><span class="n">num_countries</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>14
</code></pre></div></div>

<p>Because it’s a bit much to visualize 14 countries at each step, we’re going to use UK as an example throughout.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">uk_index</span> <span class="o">=</span> <span class="n">findfirst</span><span class="x">(</span><span class="o">==</span><span class="x">(</span><span class="s">"United_Kingdom"</span><span class="x">),</span> <span class="n">countries</span><span class="x">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5
</code></pre></div></div>

<p>It’s worth noting that the data user here is not quite up-to-date for UK because on <span class="timestamp-wrapper"><span class="timestamp">&lt;2020-04-30 to.&gt; </span></span> they updated their <em>past</em> numbers by including deaths from care- and nursing-homes (data source: <a href="https://www.ecdc.europa.eu/en">ECDC</a>). Thus if you compare the prediction of the model to real numbers, it’s likely that the real numbers will be a bit higher than what the model predicts.</p>

<h1 id="model">Model</h1>

<p>For a thorough description of the model and the assumptions that have gone into it, we recommend looking at the <a href="https://www.imperial.ac.uk/mrc-global-infectious-disease-analysis/covid-19/report-13-europe-npi-impact/">original paper</a> or their very nice <a href="https://github.com/ImperialCollegeLondon/covid19model/tree/6ee3010a58a57cc14a16545ae897ca668b7c9096/Technical_description_of_Imperial_COVID_19_Model.pdf">techical report from the repository</a>. The model described here is the one corresponding to the technical report linked. The link points to the correct commit ID and so should be consistent with this post despite potential changes to the “official” model made in the future.</p>

<p>For the sake of exposition, we present a compact version of the model here:</p>

<p>\begin{align}
  \tau &amp; \sim \mathrm{Exponential}(1 / 0.03) \\<br />
  y_m &amp; \sim \mathrm{Exponential}(\tau) \quad &amp; \text{for} \quad m = 1, \dots, M \\<br />
  \kappa &amp; \sim \mathcal{N}^{ + }(0, 0.5) \\<br />
  \mu_m &amp; \sim \mathcal{N}^{ + }(3.28, \kappa) \quad &amp; \text{for} \quad m = 1, \dots, M \\<br />
  \gamma &amp; \sim \mathcal{N}^{ + }(0, 0.2) \\<br />
  \beta_m &amp; \sim \mathcal{N}(0, \gamma) \quad &amp; \text{for} \quad m = 1, \dots, M \\<br />
  \tilde{\alpha}_k &amp;\sim \mathrm{Gamma}(0.1667, 1) \quad &amp; \text{for} \quad k = 1, \dots, K \\<br />
  \alpha_k &amp;= \tilde{\alpha}_k - \frac{\log(1.05)}{6} \quad &amp; \text{for} \quad  k = 1, \dots, K \\<br />
  R_{t, m} &amp;= \mu_m \exp(- \beta_m x_{k_{\text{ld}}} - \sum_{k=1}^{K} \alpha_k x_k) \quad &amp; \text{for} \quad m = 1, \dots, M, \ t = 1, \dots, T  \\<br />
  \tilde{R}_{t, m} &amp;= 1 - \frac{1}{p_m} \sum_{\tau = 1}^{t - 1} c_{\tau, m}  \quad &amp; \text{for} \quad m = 1, \dots, M, \ t = T_{\text{impute}} + 1, \dots, T \\<br />
  c_{t, m} &amp;= y_m \quad &amp; \text{for} \quad m = 1, \dots, M, \ t = 1, \dots, T_{\text{impute}} \\<br />
  c_{t, m} &amp;= \tilde{R}_{t, m} \sum_{\tau = 1}^{t - 1} c_{\tau, m} s_{t - \tau} \quad &amp; \text{for} \quad m = 1, \dots, M, \ t = T_{\text{impute}} + 1, \dots, T \\<br />
  \varepsilon_m^{\text{ifr}} &amp;\sim \mathcal{N}(1, 0.1)^{ + } \quad &amp; \text{for} \quad m = 1, \dots, M \\<br />
  \mathrm{ifr}_m^{ * } &amp;\sim \mathrm{ifr}_m \cdot \varepsilon_m^{\text{ifr}} \quad &amp; \text{for} \quad m = 1, \dots, M \\<br />
  d_{t, m} &amp;= \mathrm{ifr}_m^{ * } \sum_{\tau=1}^{t - 1} c_{\tau, m} \pi_{t - \tau} \quad &amp; \text{for} \quad m = 1, \dots, M, \ t = 1, \dots, T \\<br />
  \phi  &amp; \sim \mathcal{N}^{ + }(0, 5) \\<br />
  D_{t, m} &amp;\sim \mathrm{NegativeBinomial}(d_{t, m}, \phi) \quad &amp; \text{for} \quad m = 1, \dots, M, \ t = 1, \dots, T 
\end{align}</p>

<p>where</p>

<ul>
  <li>it’s assumed that seeding of new infections begins 30 days before the day after a country has cumulative observed 10 deaths</li>
  <li>\(M\) denotes the number of countries</li>
  <li>\(T\) the total number of time-steps</li>
  <li>\(T_{\text{impute}}\) the time steps to <em>impute</em> values for; the first 6 of the 30 days we impute the number, and then we simulate the rest</li>
  <li>\(\alpha_k\) denotes the weights for the k-th intervention/covariate</li>
  <li>\(\beta_m\) denotes the weight for the <code class="highlighter-rouge">lockdown</code> intervention (whose index we denote by \(k_{\text{ld}}\))
    <ul>
      <li>Note that there is also a \(\alpha_{k_{\text{ld}}}\) which is shared between all the \(M\) countries</li>
      <li>In contrast, the \(\beta_m\) weight is local to the country with index \(m\)</li>
      <li>This is a sort of  way to try and deal with the fact that <code class="highlighter-rouge">lockdown</code> means different things in different countries, e.g. <code class="highlighter-rouge">lockdown</code> in UK is much more severe than “lockdown” in Norway.</li>
    </ul>
  </li>
  <li>\(\mu_m\) represents the \(R_0\) value for country \(m\) (i.e. \(R_t\) without any interventions)</li>
  <li>\(R_{t, m}\) denotes the <strong>reproduction number</strong> at time \(t\) for country \(m\)</li>
  <li>\(\tilde{R}_{t, m}\) denotes the <strong>adjusted reproduction number</strong> at time \(t\) for country \(m\), <em>adjusted</em> in the sense that it’s rescaled wrt. what proportion of the population is susceptible for infection (assuming infected people cannot get the virus again within the near future)</li>
  <li>\(p_{m}\) denotes the <strong>total/initial population</strong> for country \(m\)</li>
  <li>\(\mathrm{ifr}_m\) denotes the <strong>infection-fatality ratio</strong> for country \(m\), and \(\mathrm{ifr}_m^{ * }\) the <em>adjusted</em> infection-fatality ratio (see paper)</li>
  <li>\(\varepsilon_m^{\text{ifr}}\) denotes the noise for the multiplicative noise for the \(\mathrm{ifr}_m^{ * }\)</li>
  <li>
    <p>\(\pi\) denotes the <strong>time from infection to death</strong> and is assumed to be a sum of two independent random times: the incubation period (<em>infection-to-onset</em>) and time between onset of symptoms and death (<em>onset-to-death</em>):</p>

    <p>\begin{equation*}
\pi \sim \mathrm{Gamma}(5.1, 0.86) + \mathrm{Gamma}(18.8, 0.45)
\end{equation*}</p>

    <p>where in this case the \(\mathrm{Gamma}\) is parameterized by its mean and coefficient of variation. In the model, this is a <em>precomputed</em> quantity and not something to be inferred, though in an ideal world this would also be included in the model.</p>
  </li>
  <li>
    <p>\(\pi_t\) then denotes a discretized version of the PDF for \(\pi\). The reasoning behind the discretization is that if we assume \(d_m(t)\) to be a continuous random variable denoting the death-rate at any time \(t\), then it would be given by</p>

    <p>\begin{equation*}
d_m(t) = \mathrm{ifr}_m^{ * } \int_0^t c_m(\tau) \pi(t - \tau) dt
\end{equation*}</p>

    <p>i.e. the convolution of the number of cases observed at time time \(\tau\), \(c_m(\tau)\), and the <em>probability</em> of death at prior to time \(t\) for the new cases observed at time \(\tau\), \(\pi(t - \tau)\) (assuming stationarity of \(\pi(t)\)). Thus, \(c_m(\tau) \pi(t - \tau)\) can be interpreted as the portion people who got the virus at time \(\tau\) have died at time \(t\) (or rather, have died after having the virus for \(t - \tau\) time, with \(t &gt; \tau\)). Discretizing then results in the above model.</p>
  </li>
  <li>\(s_t\) denotes the <strong>serial intervals</strong>, i.e. the time between successive cases in a chain of transmission, also a precomputed quantity</li>
  <li>\(c_{t, m}\) denotes the <strong>expected daily cases</strong> at time \(t\) for country \(m\)</li>
  <li>\(C_{t, m}\) denotes the <strong>cumulative cases</strong> prior to time \(t\) for country \(m\)</li>
  <li>\(d_{t, m}\) denotes the <strong>expected daily deaths</strong> at time \(t\) for country \(m\)</li>
  <li>\(D_{t, m}\) denotes the <strong>daily deaths</strong> at time \(t\) for country \(m\) (in our case, this is the <strong>likelihood</strong>); note that here we’re using the mean and variance coefficient parameterization of \(\mathrm{NegativeBinomial}\)</li>
</ul>

<p>To see the reasoning for the choices of distributions and parameters for the priors, see the either the paper or the <a href="https://github.com/ImperialCollegeLondon/covid19model/tree/6ee3010a58a57cc14a16545ae897ca668b7c9096/Technical_description_of_Imperial_COVID_19_Model.pdf">techical report from the repository</a>.</p>

<h2 id="code">Code</h2>

<p>In <code class="highlighter-rouge">Turing.jl</code>, a “sample”-statement is defined by <code class="highlighter-rouge">x ~ Distribution</code>. Therefore, the priors used in the model can be written within a Turing.jl <code class="highlighter-rouge">Model</code> as:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">τ</span> <span class="o">~</span> <span class="n">Exponential</span><span class="x">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mf">0.03</span><span class="x">)</span> <span class="c"># `Exponential` has inverse parameterization of the one in Stan</span>
<span class="n">y</span> <span class="o">~</span> <span class="n">filldist</span><span class="x">(</span><span class="n">Exponential</span><span class="x">(</span><span class="n">τ</span><span class="x">),</span> <span class="n">num_countries</span><span class="x">)</span>
<span class="n">ϕ</span> <span class="o">~</span> <span class="n">truncated</span><span class="x">(</span><span class="n">Normal</span><span class="x">(</span><span class="mi">0</span><span class="x">,</span> <span class="mi">5</span><span class="x">),</span> <span class="mi">0</span><span class="x">,</span> <span class="nb">Inf</span><span class="x">)</span>
<span class="n">κ</span> <span class="o">~</span> <span class="n">truncated</span><span class="x">(</span><span class="n">Normal</span><span class="x">(</span><span class="mi">0</span><span class="x">,</span> <span class="mf">0.5</span><span class="x">),</span> <span class="mi">0</span><span class="x">,</span> <span class="nb">Inf</span><span class="x">)</span>
<span class="n">μ</span> <span class="o">~</span> <span class="n">filldist</span><span class="x">(</span><span class="n">truncated</span><span class="x">(</span><span class="n">Normal</span><span class="x">(</span><span class="mf">3.28</span><span class="x">,</span> <span class="n">κ</span><span class="x">),</span> <span class="mi">0</span><span class="x">,</span> <span class="nb">Inf</span><span class="x">),</span> <span class="n">num_countries</span><span class="x">)</span>

<span class="n">α_hier</span> <span class="o">~</span> <span class="n">filldist</span><span class="x">(</span><span class="n">Gamma</span><span class="x">(</span><span class="o">.</span><span class="mi">1667</span><span class="x">,</span> <span class="mi">1</span><span class="x">),</span> <span class="n">num_covariates</span><span class="x">)</span>
<span class="n">α</span> <span class="o">=</span> <span class="n">α_hier</span> <span class="o">.-</span> <span class="n">log</span><span class="x">(</span><span class="mf">1.05</span><span class="x">)</span> <span class="o">/</span> <span class="mf">6.</span>

<span class="n">ifr_noise</span> <span class="o">~</span> <span class="n">filldist</span><span class="x">(</span><span class="n">truncated</span><span class="x">(</span><span class="n">Normal</span><span class="x">(</span><span class="mf">1.</span><span class="x">,</span> <span class="mf">0.1</span><span class="x">),</span> <span class="mi">0</span><span class="x">,</span> <span class="nb">Inf</span><span class="x">),</span> <span class="n">num_countries</span><span class="x">)</span>

<span class="c"># lockdown-related</span>
<span class="n">γ</span> <span class="o">~</span> <span class="n">truncated</span><span class="x">(</span><span class="n">Normal</span><span class="x">(</span><span class="mi">0</span><span class="x">,</span> <span class="mf">0.2</span><span class="x">),</span> <span class="mi">0</span><span class="x">,</span> <span class="nb">Inf</span><span class="x">)</span>
<span class="n">lockdown</span> <span class="o">~</span> <span class="n">filldist</span><span class="x">(</span><span class="n">Normal</span><span class="x">(</span><span class="mi">0</span><span class="x">,</span> <span class="n">γ</span><span class="x">),</span> <span class="n">num_countries</span><span class="x">)</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">filldist</code> function in the above snippet is a function used to construct a <code class="highlighter-rouge">Distribution</code> from which we can obtain i.i.d. samples from a univariate distribution using vectorization.</p>

<p>And the full model is defined:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@model</span> <span class="k">function</span><span class="nf"> model_v2</span><span class="x">(</span>
    <span class="n">num_impute</span><span class="x">,</span>        <span class="c"># [Int] num. of days for which to impute infections</span>
    <span class="n">num_total_days</span><span class="x">,</span>    <span class="c"># [Int] days of observed data + num. of days to forecast</span>
    <span class="n">cases</span><span class="x">,</span>             <span class="c"># [AbstractVector{&lt;:AbstractVector{&lt;:Int}}] reported cases</span>
    <span class="n">deaths</span><span class="x">,</span>            <span class="c"># [AbstractVector{&lt;:AbstractVector{&lt;:Int}}] reported deaths; rows indexed by i &gt; N contain -1 and should be ignored</span>
    <span class="nb">π</span><span class="x">,</span>                 <span class="c"># [AbstractVector{&lt;:AbstractVector{&lt;:Real}}] h * s</span>
    <span class="n">covariates</span><span class="x">,</span>        <span class="c"># [Vector{&lt;:AbstractMatrix}]</span>
    <span class="n">epidemic_start</span><span class="x">,</span>    <span class="c"># [AbstractVector{&lt;:Int}]</span>
    <span class="n">population</span><span class="x">,</span>        <span class="c"># [AbstractVector{&lt;:Real}]</span>
    <span class="n">serial_intervals</span><span class="x">,</span>  <span class="c"># [AbstractVector{&lt;:Real}] fixed pre-calculated serial interval (SI) using empirical data from Neil</span>
    <span class="n">lockdown_index</span><span class="x">,</span>    <span class="c"># [Int] the index for the `lockdown` covariate in `covariates`</span>
    <span class="n">predict</span><span class="o">=</span><span class="nb">false</span><span class="x">,</span>     <span class="c"># [Bool] if `false`, will only compute what's needed to `observe` but not more</span>
    <span class="o">::</span><span class="kt">Type</span><span class="x">{</span><span class="n">TV</span><span class="x">}</span> <span class="o">=</span> <span class="kt">Vector</span><span class="x">{</span><span class="kt">Float64</span><span class="x">}</span>
<span class="x">)</span> <span class="k">where</span> <span class="x">{</span><span class="n">TV</span><span class="x">}</span>
    <span class="c"># `covariates` should be of length `num_countries` and each entry correspond to a matrix of size `(num_total_days, num_covariates)`</span>
    <span class="n">num_covariates</span> <span class="o">=</span> <span class="n">size</span><span class="x">(</span><span class="n">covariates</span><span class="x">[</span><span class="mi">1</span><span class="x">],</span> <span class="mi">2</span><span class="x">)</span>
    <span class="n">num_countries</span> <span class="o">=</span> <span class="n">length</span><span class="x">(</span><span class="n">cases</span><span class="x">)</span>
    <span class="n">num_obs_countries</span> <span class="o">=</span> <span class="n">length</span><span class="o">.</span><span class="x">(</span><span class="n">cases</span><span class="x">)</span>

    <span class="c"># If we don't want to predict the future, we only need to compute up-to time-step `num_obs_countries[m]`</span>
    <span class="n">last_time_steps</span> <span class="o">=</span> <span class="n">predict</span> <span class="o">?</span> <span class="n">fill</span><span class="x">(</span><span class="n">num_total_days</span><span class="x">,</span> <span class="n">num_countries</span><span class="x">)</span> <span class="o">:</span> <span class="n">num_obs_countries</span>

    <span class="c"># Latent variables</span>
    <span class="n">τ</span> <span class="o">~</span> <span class="n">Exponential</span><span class="x">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mf">0.03</span><span class="x">)</span> <span class="c"># `Exponential` has inverse parameterization of the one in Stan</span>
    <span class="n">y</span> <span class="o">~</span> <span class="n">filldist</span><span class="x">(</span><span class="n">Exponential</span><span class="x">(</span><span class="n">τ</span><span class="x">),</span> <span class="n">num_countries</span><span class="x">)</span>
    <span class="n">ϕ</span> <span class="o">~</span> <span class="n">truncated</span><span class="x">(</span><span class="n">Normal</span><span class="x">(</span><span class="mi">0</span><span class="x">,</span> <span class="mi">5</span><span class="x">),</span> <span class="mi">0</span><span class="x">,</span> <span class="nb">Inf</span><span class="x">)</span>
    <span class="n">κ</span> <span class="o">~</span> <span class="n">truncated</span><span class="x">(</span><span class="n">Normal</span><span class="x">(</span><span class="mi">0</span><span class="x">,</span> <span class="mf">0.5</span><span class="x">),</span> <span class="mi">0</span><span class="x">,</span> <span class="nb">Inf</span><span class="x">)</span>
    <span class="n">μ</span> <span class="o">~</span> <span class="n">filldist</span><span class="x">(</span><span class="n">truncated</span><span class="x">(</span><span class="n">Normal</span><span class="x">(</span><span class="mf">3.28</span><span class="x">,</span> <span class="n">κ</span><span class="x">),</span> <span class="mi">0</span><span class="x">,</span> <span class="nb">Inf</span><span class="x">),</span> <span class="n">num_countries</span><span class="x">)</span>

    <span class="n">α_hier</span> <span class="o">~</span> <span class="n">filldist</span><span class="x">(</span><span class="n">Gamma</span><span class="x">(</span><span class="o">.</span><span class="mi">1667</span><span class="x">,</span> <span class="mi">1</span><span class="x">),</span> <span class="n">num_covariates</span><span class="x">)</span>
    <span class="n">α</span> <span class="o">=</span> <span class="n">α_hier</span> <span class="o">.-</span> <span class="n">log</span><span class="x">(</span><span class="mf">1.05</span><span class="x">)</span> <span class="o">/</span> <span class="mf">6.</span>

    <span class="n">ifr_noise</span> <span class="o">~</span> <span class="n">filldist</span><span class="x">(</span><span class="n">truncated</span><span class="x">(</span><span class="n">Normal</span><span class="x">(</span><span class="mf">1.</span><span class="x">,</span> <span class="mf">0.1</span><span class="x">),</span> <span class="mi">0</span><span class="x">,</span> <span class="nb">Inf</span><span class="x">),</span> <span class="n">num_countries</span><span class="x">)</span>

    <span class="c"># lockdown-related</span>
    <span class="n">γ</span> <span class="o">~</span> <span class="n">truncated</span><span class="x">(</span><span class="n">Normal</span><span class="x">(</span><span class="mi">0</span><span class="x">,</span> <span class="mf">0.2</span><span class="x">),</span> <span class="mi">0</span><span class="x">,</span> <span class="nb">Inf</span><span class="x">)</span>
    <span class="n">lockdown</span> <span class="o">~</span> <span class="n">filldist</span><span class="x">(</span><span class="n">Normal</span><span class="x">(</span><span class="mi">0</span><span class="x">,</span> <span class="n">γ</span><span class="x">),</span> <span class="n">num_countries</span><span class="x">)</span>

    <span class="c"># Initialization of some quantities</span>
    <span class="n">expected_daily_cases</span> <span class="o">=</span> <span class="n">TV</span><span class="x">[</span><span class="n">TV</span><span class="x">(</span><span class="nb">undef</span><span class="x">,</span> <span class="n">last_time_steps</span><span class="x">[</span><span class="n">m</span><span class="x">])</span> <span class="k">for</span> <span class="n">m</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">num_countries</span><span class="x">]</span>
    <span class="n">cases_pred</span> <span class="o">=</span> <span class="n">TV</span><span class="x">[</span><span class="n">TV</span><span class="x">(</span><span class="nb">undef</span><span class="x">,</span> <span class="n">last_time_steps</span><span class="x">[</span><span class="n">m</span><span class="x">])</span> <span class="k">for</span> <span class="n">m</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">num_countries</span><span class="x">]</span>
    <span class="n">expected_daily_deaths</span> <span class="o">=</span> <span class="n">TV</span><span class="x">[</span><span class="n">TV</span><span class="x">(</span><span class="nb">undef</span><span class="x">,</span> <span class="n">last_time_steps</span><span class="x">[</span><span class="n">m</span><span class="x">])</span> <span class="k">for</span> <span class="n">m</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">num_countries</span><span class="x">]</span>
    <span class="n">Rt</span> <span class="o">=</span> <span class="n">TV</span><span class="x">[</span><span class="n">TV</span><span class="x">(</span><span class="nb">undef</span><span class="x">,</span> <span class="n">last_time_steps</span><span class="x">[</span><span class="n">m</span><span class="x">])</span> <span class="k">for</span> <span class="n">m</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">num_countries</span><span class="x">]</span>
    <span class="n">Rt_adj</span> <span class="o">=</span> <span class="n">TV</span><span class="x">[</span><span class="n">TV</span><span class="x">(</span><span class="nb">undef</span><span class="x">,</span> <span class="n">last_time_steps</span><span class="x">[</span><span class="n">m</span><span class="x">])</span> <span class="k">for</span> <span class="n">m</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">num_countries</span><span class="x">]</span>

    <span class="c"># Loops over countries and perform independent computations for each country</span>
    <span class="c"># since this model does not include any notion of migration across borders.</span>
    <span class="c"># =&gt; might has well wrap it in a `@threads` to perform the computation in parallel.</span>
    <span class="nd">@threads</span> <span class="k">for</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">num_countries</span>
        <span class="c"># Country-specific parameters</span>
        <span class="n">π_m</span> <span class="o">=</span> <span class="nb">π</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
        <span class="n">pop_m</span> <span class="o">=</span> <span class="n">population</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
        <span class="n">expected_daily_cases_m</span> <span class="o">=</span> <span class="n">expected_daily_cases</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
        <span class="n">cases_pred_m</span> <span class="o">=</span> <span class="n">cases_pred</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
        <span class="n">expected_daily_deaths_m</span> <span class="o">=</span> <span class="n">expected_daily_deaths</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
        <span class="n">Rt_m</span> <span class="o">=</span> <span class="n">Rt</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
        <span class="n">Rt_adj_m</span> <span class="o">=</span> <span class="n">Rt_adj</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>

        <span class="n">last_time_step</span> <span class="o">=</span> <span class="n">last_time_steps</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>

        <span class="c"># Imputation of `num_impute` days</span>
        <span class="n">expected_daily_cases_m</span><span class="x">[</span><span class="mi">1</span><span class="o">:</span><span class="n">num_impute</span><span class="x">]</span> <span class="o">.=</span> <span class="n">y</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
        <span class="n">cases_pred_m</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="o">=</span> <span class="n">zero</span><span class="x">(</span><span class="n">cases_pred_m</span><span class="x">[</span><span class="mi">1</span><span class="x">])</span>
        <span class="n">cases_pred_m</span><span class="x">[</span><span class="mi">2</span><span class="o">:</span><span class="n">num_impute</span><span class="x">]</span> <span class="o">.=</span> <span class="n">cumsum</span><span class="x">(</span><span class="n">expected_daily_cases_m</span><span class="x">[</span><span class="mi">1</span><span class="o">:</span><span class="n">num_impute</span> <span class="o">-</span> <span class="mi">1</span><span class="x">])</span>

        <span class="n">xs</span> <span class="o">=</span> <span class="n">covariates</span><span class="x">[</span><span class="n">m</span><span class="x">][</span><span class="mi">1</span><span class="o">:</span><span class="n">last_time_step</span><span class="x">,</span> <span class="o">:</span><span class="x">]</span> <span class="c"># extract covariates for the wanted time-steps and country `m`</span>
        <span class="n">Rt_m</span> <span class="o">.=</span> <span class="n">μ</span><span class="x">[</span><span class="n">m</span><span class="x">]</span> <span class="o">*</span> <span class="n">exp</span><span class="o">.</span><span class="x">(</span><span class="n">xs</span> <span class="o">*</span> <span class="x">(</span><span class="o">-</span><span class="n">α</span><span class="x">)</span> <span class="o">+</span> <span class="x">(</span><span class="o">-</span> <span class="n">lockdown</span><span class="x">[</span><span class="n">m</span><span class="x">])</span> <span class="o">*</span> <span class="n">xs</span><span class="x">[</span><span class="o">:</span><span class="x">,</span> <span class="n">lockdown_index</span><span class="x">])</span>

        <span class="c"># Adjusts for portion of pop that are susceptible</span>
        <span class="n">Rt_adj_m</span><span class="x">[</span><span class="mi">1</span><span class="o">:</span><span class="n">num_impute</span><span class="x">]</span> <span class="o">.=</span> <span class="x">(</span><span class="n">max</span><span class="o">.</span><span class="x">(</span><span class="n">pop_m</span> <span class="o">.-</span> <span class="n">cases_pred_m</span><span class="x">[</span><span class="mi">1</span><span class="o">:</span><span class="n">num_impute</span><span class="x">],</span> <span class="n">zero</span><span class="x">(</span><span class="n">cases_pred_m</span><span class="x">[</span><span class="mi">1</span><span class="x">]))</span> <span class="o">./</span> <span class="n">pop_m</span><span class="x">)</span> <span class="o">.*</span> <span class="n">Rt_m</span><span class="x">[</span><span class="mi">1</span><span class="o">:</span><span class="n">num_impute</span><span class="x">]</span>

        <span class="k">for</span> <span class="n">t</span> <span class="o">=</span> <span class="x">(</span><span class="n">num_impute</span> <span class="o">+</span> <span class="mi">1</span><span class="x">)</span><span class="o">:</span><span class="n">last_time_step</span>
            <span class="c"># Update cumulative cases</span>
            <span class="n">cases_pred_m</span><span class="x">[</span><span class="n">t</span><span class="x">]</span> <span class="o">=</span> <span class="n">cases_pred_m</span><span class="x">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+</span> <span class="n">expected_daily_cases_m</span><span class="x">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="x">]</span>

            <span class="c"># Adjusts for portion of pop that are susceptible</span>
            <span class="n">Rt_adj_m</span><span class="x">[</span><span class="n">t</span><span class="x">]</span> <span class="o">=</span> <span class="x">(</span><span class="n">max</span><span class="x">(</span><span class="n">pop_m</span> <span class="o">-</span> <span class="n">cases_pred_m</span><span class="x">[</span><span class="n">t</span><span class="x">],</span> <span class="n">zero</span><span class="x">(</span><span class="n">cases_pred_m</span><span class="x">[</span><span class="n">t</span><span class="x">]))</span> <span class="o">/</span> <span class="n">pop_m</span><span class="x">)</span> <span class="o">*</span> <span class="n">Rt_m</span><span class="x">[</span><span class="n">t</span><span class="x">]</span>

            <span class="n">expected_daily_cases_m</span><span class="x">[</span><span class="n">t</span><span class="x">]</span> <span class="o">=</span> <span class="n">Rt_adj_m</span><span class="x">[</span><span class="n">t</span><span class="x">]</span> <span class="o">*</span> <span class="n">sum</span><span class="x">(</span><span class="n">expected_daily_cases_m</span><span class="x">[</span><span class="n">τ</span><span class="x">]</span> <span class="o">*</span> <span class="n">serial_intervals</span><span class="x">[</span><span class="n">t</span> <span class="o">-</span> <span class="n">τ</span><span class="x">]</span> <span class="k">for</span> <span class="n">τ</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="x">(</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="x">))</span>
        <span class="k">end</span>

        <span class="n">expected_daily_deaths_m</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="o">=</span> <span class="mf">1e-15</span> <span class="o">*</span> <span class="n">expected_daily_cases_m</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">2</span><span class="o">:</span><span class="n">last_time_step</span>
            <span class="n">expected_daily_deaths_m</span><span class="x">[</span><span class="n">t</span><span class="x">]</span> <span class="o">=</span> <span class="n">sum</span><span class="x">(</span><span class="n">expected_daily_cases_m</span><span class="x">[</span><span class="n">τ</span><span class="x">]</span> <span class="o">*</span> <span class="n">π_m</span><span class="x">[</span><span class="n">t</span> <span class="o">-</span> <span class="n">τ</span><span class="x">]</span> <span class="o">*</span> <span class="n">ifr_noise</span><span class="x">[</span><span class="n">m</span><span class="x">]</span> <span class="k">for</span> <span class="n">τ</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="x">(</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="x">))</span>
        <span class="k">end</span>
    <span class="k">end</span>

    <span class="c"># Observe</span>
    <span class="k">for</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">num_countries</span>
        <span class="c"># Extract the estimated expected daily deaths for country `m`</span>
        <span class="n">expected_daily_deaths_m</span> <span class="o">=</span> <span class="n">expected_daily_deaths</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
        <span class="c"># Extract time-steps for which we have observations</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">epidemic_start</span><span class="x">[</span><span class="n">m</span><span class="x">]</span><span class="o">:</span><span class="n">num_obs_countries</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
        <span class="c"># Observe!</span>
        <span class="n">deaths</span><span class="x">[</span><span class="n">m</span><span class="x">][</span><span class="n">ts</span><span class="x">]</span> <span class="o">~</span> <span class="n">arraydist</span><span class="x">(</span><span class="n">NegativeBinomial2</span><span class="o">.</span><span class="x">(</span><span class="n">expected_daily_deaths_m</span><span class="x">[</span><span class="n">ts</span><span class="x">],</span> <span class="n">ϕ</span><span class="x">))</span>
    <span class="k">end</span>

    <span class="k">return</span> <span class="x">(</span>
        <span class="n">expected_daily_cases</span> <span class="o">=</span> <span class="n">expected_daily_cases</span><span class="x">,</span>
        <span class="n">expected_daily_deaths</span> <span class="o">=</span> <span class="n">expected_daily_deaths</span><span class="x">,</span>
        <span class="n">Rt</span> <span class="o">=</span> <span class="n">Rt</span><span class="x">,</span>
        <span class="n">Rt_adjusted</span> <span class="o">=</span> <span class="n">Rt_adj</span>
    <span class="x">)</span>
<span class="k">end</span><span class="x">;</span>
</code></pre></div></div>

<p>Two things worth noting is the use of the <code class="highlighter-rouge">TV</code> variable to instantiate some internal variables and the use of <code class="highlighter-rouge">@threads</code>.</p>

<p>As you can see in the arguments for the model, <code class="highlighter-rouge">TV</code> refers to a <em>type</em> and will be recognized as such by the <code class="highlighter-rouge">@model</code> macro when transforming the model code. This is used to ensure <em>type-stability</em> of the model.</p>

<details><summary><p>More detailed explanation of <code class="highlighter-rouge">TV</code></p>
</summary>
<p>A default execution of the model will then use <code class="highlighter-rouge">TV</code> as <code class="highlighter-rouge">Vector{Float64}</code>, thus making statements like <code class="highlighter-rouge">TV(undef, n)</code> result in a <code class="highlighter-rouge">Vector{Float64}</code> with <code class="highlighter-rouge">undef</code> (uninitialized) values and length <code class="highlighter-rouge">n</code>. But in case we use a sampler that requires automatic differentiation (AD), TV will be will be replaced with the AD-type corresponding to a <code class="highlighter-rouge">Vector</code>, e.g. <code class="highlighter-rouge">TrackedVector</code> in the case of <a href="https://github.com/FluxML/Tracker.jl"><code class="highlighter-rouge">Tracker.jl</code></a>.</p>

</details>

<p>The use of <code class="highlighter-rouge">@threads</code> means that inside each execution of the <code class="highlighter-rouge">Model</code>, this loop will be performed in parallel, where the number of threads are specified by the enviroment variable <code class="highlighter-rouge">JULIA_NUM_THREADS</code>. This is thanks to the really nice multithreading functionality <a href="https://julialang.org/blog/2019/07/multithreading/">introduced in Julia 1.3</a> (and so this also requires Julia 1.3 or higher to run the code). Note that the inside the loop is independent of each other and each <code class="highlighter-rouge">m</code> will be seen by only one thread, hence it’s threadsafe.</p>

<p>This model is basically identitical to the one defined in <a href="https://github.com/ImperialCollegeLondon/covid19model/blob/6ee3010a58a57cc14a16545ae897ca668b7c9096/stan-models/base.stan">stan-models/base.stan (#6ee3010)</a> with the exception of two points:</p>

<ul>
  <li>In this model we use <code class="highlighter-rouge">TruncatedNormal</code> for normally distributed variables which are positively constrained instead of sampling from a <code class="highlighter-rouge">Normal</code> and then taking the absolute value; these approaches are equivalent from a modelling perspective.</li>
  <li>We’ve added the use of <code class="highlighter-rouge">max(pop_m - cases_pred_m[t], 0)</code> in computing the <em>adjusted</em> \(R_t\), <code class="highlighter-rouge">Rt_adj</code>, to ensure that in the case where the entire populations has died there, the adjusted \(R_t\) is set to 0, i.e. if everyone in the country passed away then there is no spread of the virus (this does not affect “correctness” of inference). <sup id="fnref:fn1" role="doc-noteref"><a href="#fn:fn1" class="footnote">1</a></sup></li>
  <li>The <code class="highlighter-rouge">cases</code> and <code class="highlighter-rouge">deaths</code> arguments are arrays of arrays instead of 3D arrays, therefore we don’t need to fill the future days with <code class="highlighter-rouge">-1</code> as is done in the original model.</li>
</ul>

<h3 id="multithreaded-observe">Multithreaded observe</h3>

<p>We can also make the <code class="highlighter-rouge">observe</code> statements parallel, but because the <code class="highlighter-rouge">~</code> is not (yet) threadsafe we unfortunately have to touch some of the internals of <code class="highlighter-rouge">Turing.jl</code>. But for observations it’s very straight-forward: instead of observing by the following piece of code</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">num_countries</span>
    <span class="c"># Extract the estimated expected daily deaths for country `m`</span>
    <span class="n">expected_daily_deaths_m</span> <span class="o">=</span> <span class="n">expected_daily_deaths</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
    <span class="c"># Extract time-steps for which we have observations</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">epidemic_start</span><span class="x">[</span><span class="n">m</span><span class="x">]</span><span class="o">:</span><span class="n">num_obs_countries</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
    <span class="c"># Observe!</span>
    <span class="n">deaths</span><span class="x">[</span><span class="n">m</span><span class="x">][</span><span class="n">ts</span><span class="x">]</span> <span class="o">~</span> <span class="n">arraydist</span><span class="x">(</span><span class="n">NegativeBinomial2</span><span class="o">.</span><span class="x">(</span><span class="n">expected_daily_deaths_m</span><span class="x">[</span><span class="n">ts</span><span class="x">],</span> <span class="n">ϕ</span><span class="x">))</span>
<span class="k">end</span>
</code></pre></div></div>

<p>we can use the following</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Doing observations in parallel provides a small speedup</span>
<span class="n">logps</span> <span class="o">=</span> <span class="n">TV</span><span class="x">(</span><span class="nb">undef</span><span class="x">,</span> <span class="n">num_countries</span><span class="x">)</span>
<span class="nd">@threads</span> <span class="k">for</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">num_countries</span>
    <span class="c"># Extract the estimated expected daily deaths for country `m`</span>
    <span class="n">expected_daily_deaths_m</span> <span class="o">=</span> <span class="n">expected_daily_deaths</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
    <span class="c"># Extract time-steps for which we have observations</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">epidemic_start</span><span class="x">[</span><span class="n">m</span><span class="x">]</span><span class="o">:</span><span class="n">num_obs_countries</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
    <span class="c"># Observe!</span>
    <span class="n">logps</span><span class="x">[</span><span class="n">m</span><span class="x">]</span> <span class="o">=</span> <span class="n">logpdf</span><span class="x">(</span><span class="n">arraydist</span><span class="x">(</span><span class="n">NegativeBinomial2</span><span class="o">.</span><span class="x">(</span><span class="n">expected_daily_deaths_m</span><span class="x">[</span><span class="n">ts</span><span class="x">],</span> <span class="n">ϕ</span><span class="x">)),</span> <span class="n">deaths</span><span class="x">[</span><span class="n">m</span><span class="x">][</span><span class="n">ts</span><span class="x">])</span>
<span class="k">end</span>
<span class="n">Turing</span><span class="o">.</span><span class="n">acclogp!</span><span class="x">(</span><span class="n">_varinfo</span><span class="x">,</span> <span class="n">sum</span><span class="x">(</span><span class="n">logps</span><span class="x">))</span>
</code></pre></div></div>

<details><summary><p>Explanation of what we just did</p>
</summary>
<p>It might be worth explaining a bit about what’s going on here. First we should explain what the deal is with <code class="highlighter-rouge">_varinfo</code>. <code class="highlighter-rouge">_varinfo</code> is basically the object used internally in Turing to track the sampled variables and the log-pdf <em>for a particular evaluation</em> of the model, and so <code class="highlighter-rouge">acclogp!(_varinfo, lp)</code> will increment the log-pdf stored in <code class="highlighter-rouge">_varinfo</code> by <code class="highlighter-rouge">lp</code>. With that we can explain what happens to <code class="highlighter-rouge">~</code> inside the <code class="highlighter-rouge">@macro</code>. Using the old observe-snippet as an example, the <code class="highlighter-rouge">@model</code> macro replaces <code class="highlighter-rouge">~</code> with</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">acclogp!</span><span class="x">(</span><span class="n">_varinfo</span><span class="o">.</span><span class="x">,</span> <span class="n">logpdf</span><span class="x">(</span><span class="n">arraydist</span><span class="x">(</span><span class="n">NegativeBinomial2</span><span class="o">.</span><span class="x">(</span><span class="n">expected_daily_deaths_m</span><span class="x">[</span><span class="n">ts</span><span class="x">],</span> <span class="n">ϕ</span><span class="x">)),</span> <span class="n">deaths</span><span class="x">[</span><span class="n">m</span><span class="x">][</span><span class="n">ts</span><span class="x">]))</span>
</code></pre></div></div>

<p>But we’re iterating through <code class="highlighter-rouge">m</code>, so this would not be thread-safe since you might be two threads attempting to mutate <code class="highlighter-rouge">_varinfo</code> simultaneously.[^fn2] Therefore, since no threads sees the same <code class="highlighter-rouge">m</code>, delaying the accumulation to after having computed all the log-pdf in parallel leaves us with equivalent code that is threadsafe.</p>

<p>You can read more about the <code class="highlighter-rouge">@macro</code> and its internals <a href="https://turing.ml/dev/docs/for-developers/compiler#model-macro-and-modelgen">here</a>.</p>

</details>

<h3 id="final-model">Final model</h3>

<p>This results in the following model definition</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@model</span> <span class="k">function</span><span class="nf"> model_v2</span><span class="x">(</span>
    <span class="n">num_impute</span><span class="x">,</span>        <span class="c"># [Int] num. of days for which to impute infections</span>
    <span class="n">num_total_days</span><span class="x">,</span>    <span class="c"># [Int] days of observed data + num. of days to forecast</span>
    <span class="n">cases</span><span class="x">,</span>             <span class="c"># [AbstractVector{&lt;:AbstractVector{&lt;:Int}}] reported cases</span>
    <span class="n">deaths</span><span class="x">,</span>            <span class="c"># [AbstractVector{&lt;:AbstractVector{&lt;:Int}}] reported deaths; rows indexed by i &gt; N contain -1 and should be ignored</span>
    <span class="nb">π</span><span class="x">,</span>                 <span class="c"># [AbstractVector{&lt;:AbstractVector{&lt;:Real}}] h * s</span>
    <span class="n">covariates</span><span class="x">,</span>        <span class="c"># [Vector{&lt;:AbstractMatrix}]</span>
    <span class="n">epidemic_start</span><span class="x">,</span>    <span class="c"># [AbstractVector{&lt;:Int}]</span>
    <span class="n">population</span><span class="x">,</span>        <span class="c"># [AbstractVector{&lt;:Real}]</span>
    <span class="n">serial_intervals</span><span class="x">,</span>  <span class="c"># [AbstractVector{&lt;:Real}] fixed pre-calculated serial interval (SI) using empirical data from Neil</span>
    <span class="n">lockdown_index</span><span class="x">,</span>    <span class="c"># [Int] the index for the `lockdown` covariate in `covariates`</span>
    <span class="n">predict</span><span class="o">=</span><span class="nb">false</span><span class="x">,</span>     <span class="c"># [Bool] if `false`, will only compute what's needed to `observe` but not more</span>
    <span class="o">::</span><span class="kt">Type</span><span class="x">{</span><span class="n">TV</span><span class="x">}</span> <span class="o">=</span> <span class="kt">Vector</span><span class="x">{</span><span class="kt">Float64</span><span class="x">}</span>
<span class="x">)</span> <span class="k">where</span> <span class="x">{</span><span class="n">TV</span><span class="x">}</span>
    <span class="c"># `covariates` should be of length `num_countries` and each entry correspond to a matrix of size `(num_total_days, num_covariates)`</span>
    <span class="n">num_covariates</span> <span class="o">=</span> <span class="n">size</span><span class="x">(</span><span class="n">covariates</span><span class="x">[</span><span class="mi">1</span><span class="x">],</span> <span class="mi">2</span><span class="x">)</span>
    <span class="n">num_countries</span> <span class="o">=</span> <span class="n">length</span><span class="x">(</span><span class="n">cases</span><span class="x">)</span>
    <span class="n">num_obs_countries</span> <span class="o">=</span> <span class="n">length</span><span class="o">.</span><span class="x">(</span><span class="n">cases</span><span class="x">)</span>

    <span class="c"># If we don't want to predict the future, we only need to compute up-to time-step `num_obs_countries[m]`</span>
    <span class="n">last_time_steps</span> <span class="o">=</span> <span class="n">predict</span> <span class="o">?</span> <span class="n">fill</span><span class="x">(</span><span class="n">num_total_days</span><span class="x">,</span> <span class="n">num_countries</span><span class="x">)</span> <span class="o">:</span> <span class="n">num_obs_countries</span>

    <span class="c"># Latent variables</span>
    <span class="n">τ</span> <span class="o">~</span> <span class="n">Exponential</span><span class="x">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mf">0.03</span><span class="x">)</span> <span class="c"># `Exponential` has inverse parameterization of the one in Stan</span>
    <span class="n">y</span> <span class="o">~</span> <span class="n">filldist</span><span class="x">(</span><span class="n">Exponential</span><span class="x">(</span><span class="n">τ</span><span class="x">),</span> <span class="n">num_countries</span><span class="x">)</span>
    <span class="n">ϕ</span> <span class="o">~</span> <span class="n">truncated</span><span class="x">(</span><span class="n">Normal</span><span class="x">(</span><span class="mi">0</span><span class="x">,</span> <span class="mi">5</span><span class="x">),</span> <span class="mi">0</span><span class="x">,</span> <span class="nb">Inf</span><span class="x">)</span>
    <span class="n">κ</span> <span class="o">~</span> <span class="n">truncated</span><span class="x">(</span><span class="n">Normal</span><span class="x">(</span><span class="mi">0</span><span class="x">,</span> <span class="mf">0.5</span><span class="x">),</span> <span class="mi">0</span><span class="x">,</span> <span class="nb">Inf</span><span class="x">)</span>
    <span class="n">μ</span> <span class="o">~</span> <span class="n">filldist</span><span class="x">(</span><span class="n">truncated</span><span class="x">(</span><span class="n">Normal</span><span class="x">(</span><span class="mf">3.28</span><span class="x">,</span> <span class="n">κ</span><span class="x">),</span> <span class="mi">0</span><span class="x">,</span> <span class="nb">Inf</span><span class="x">),</span> <span class="n">num_countries</span><span class="x">)</span>

    <span class="n">α_hier</span> <span class="o">~</span> <span class="n">filldist</span><span class="x">(</span><span class="n">Gamma</span><span class="x">(</span><span class="o">.</span><span class="mi">1667</span><span class="x">,</span> <span class="mi">1</span><span class="x">),</span> <span class="n">num_covariates</span><span class="x">)</span>
    <span class="n">α</span> <span class="o">=</span> <span class="n">α_hier</span> <span class="o">.-</span> <span class="n">log</span><span class="x">(</span><span class="mf">1.05</span><span class="x">)</span> <span class="o">/</span> <span class="mf">6.</span>

    <span class="n">ifr_noise</span> <span class="o">~</span> <span class="n">filldist</span><span class="x">(</span><span class="n">truncated</span><span class="x">(</span><span class="n">Normal</span><span class="x">(</span><span class="mf">1.</span><span class="x">,</span> <span class="mf">0.1</span><span class="x">),</span> <span class="mi">0</span><span class="x">,</span> <span class="nb">Inf</span><span class="x">),</span> <span class="n">num_countries</span><span class="x">)</span>

    <span class="c"># lockdown-related</span>
    <span class="n">γ</span> <span class="o">~</span> <span class="n">truncated</span><span class="x">(</span><span class="n">Normal</span><span class="x">(</span><span class="mi">0</span><span class="x">,</span> <span class="mf">0.2</span><span class="x">),</span> <span class="mi">0</span><span class="x">,</span> <span class="nb">Inf</span><span class="x">)</span>
    <span class="n">lockdown</span> <span class="o">~</span> <span class="n">filldist</span><span class="x">(</span><span class="n">Normal</span><span class="x">(</span><span class="mi">0</span><span class="x">,</span> <span class="n">γ</span><span class="x">),</span> <span class="n">num_countries</span><span class="x">)</span>

    <span class="c"># Initialization of some quantities</span>
    <span class="n">expected_daily_cases</span> <span class="o">=</span> <span class="n">TV</span><span class="x">[</span><span class="n">TV</span><span class="x">(</span><span class="nb">undef</span><span class="x">,</span> <span class="n">last_time_steps</span><span class="x">[</span><span class="n">m</span><span class="x">])</span> <span class="k">for</span> <span class="n">m</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">num_countries</span><span class="x">]</span>
    <span class="n">cases_pred</span> <span class="o">=</span> <span class="n">TV</span><span class="x">[</span><span class="n">TV</span><span class="x">(</span><span class="nb">undef</span><span class="x">,</span> <span class="n">last_time_steps</span><span class="x">[</span><span class="n">m</span><span class="x">])</span> <span class="k">for</span> <span class="n">m</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">num_countries</span><span class="x">]</span>
    <span class="n">expected_daily_deaths</span> <span class="o">=</span> <span class="n">TV</span><span class="x">[</span><span class="n">TV</span><span class="x">(</span><span class="nb">undef</span><span class="x">,</span> <span class="n">last_time_steps</span><span class="x">[</span><span class="n">m</span><span class="x">])</span> <span class="k">for</span> <span class="n">m</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">num_countries</span><span class="x">]</span>
    <span class="n">Rt</span> <span class="o">=</span> <span class="n">TV</span><span class="x">[</span><span class="n">TV</span><span class="x">(</span><span class="nb">undef</span><span class="x">,</span> <span class="n">last_time_steps</span><span class="x">[</span><span class="n">m</span><span class="x">])</span> <span class="k">for</span> <span class="n">m</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">num_countries</span><span class="x">]</span>
    <span class="n">Rt_adj</span> <span class="o">=</span> <span class="n">TV</span><span class="x">[</span><span class="n">TV</span><span class="x">(</span><span class="nb">undef</span><span class="x">,</span> <span class="n">last_time_steps</span><span class="x">[</span><span class="n">m</span><span class="x">])</span> <span class="k">for</span> <span class="n">m</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">num_countries</span><span class="x">]</span>

    <span class="c"># Loops over countries and perform independent computations for each country</span>
    <span class="c"># since this model does not include any notion of migration across borders.</span>
    <span class="c"># =&gt; might has well wrap it in a `@threads` to perform the computation in parallel.</span>
    <span class="nd">@threads</span> <span class="k">for</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">num_countries</span>
        <span class="c"># Country-specific parameters</span>
        <span class="n">π_m</span> <span class="o">=</span> <span class="nb">π</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
        <span class="n">pop_m</span> <span class="o">=</span> <span class="n">population</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
        <span class="n">expected_daily_cases_m</span> <span class="o">=</span> <span class="n">expected_daily_cases</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
        <span class="n">cases_pred_m</span> <span class="o">=</span> <span class="n">cases_pred</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
        <span class="n">expected_daily_deaths_m</span> <span class="o">=</span> <span class="n">expected_daily_deaths</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
        <span class="n">Rt_m</span> <span class="o">=</span> <span class="n">Rt</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
        <span class="n">Rt_adj_m</span> <span class="o">=</span> <span class="n">Rt_adj</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>

        <span class="n">last_time_step</span> <span class="o">=</span> <span class="n">last_time_steps</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>

        <span class="c"># Imputation of `num_impute` days</span>
        <span class="n">expected_daily_cases_m</span><span class="x">[</span><span class="mi">1</span><span class="o">:</span><span class="n">num_impute</span><span class="x">]</span> <span class="o">.=</span> <span class="n">y</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
        <span class="n">cases_pred_m</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="o">=</span> <span class="n">zero</span><span class="x">(</span><span class="n">cases_pred_m</span><span class="x">[</span><span class="mi">1</span><span class="x">])</span>
        <span class="n">cases_pred_m</span><span class="x">[</span><span class="mi">2</span><span class="o">:</span><span class="n">num_impute</span><span class="x">]</span> <span class="o">.=</span> <span class="n">cumsum</span><span class="x">(</span><span class="n">expected_daily_cases_m</span><span class="x">[</span><span class="mi">1</span><span class="o">:</span><span class="n">num_impute</span> <span class="o">-</span> <span class="mi">1</span><span class="x">])</span>

        <span class="n">xs</span> <span class="o">=</span> <span class="n">covariates</span><span class="x">[</span><span class="n">m</span><span class="x">][</span><span class="mi">1</span><span class="o">:</span><span class="n">last_time_step</span><span class="x">,</span> <span class="o">:</span><span class="x">]</span> <span class="c"># extract covariates for the wanted time-steps and country `m`</span>
        <span class="n">Rt_m</span> <span class="o">.=</span> <span class="n">μ</span><span class="x">[</span><span class="n">m</span><span class="x">]</span> <span class="o">*</span> <span class="n">exp</span><span class="o">.</span><span class="x">(</span><span class="n">xs</span> <span class="o">*</span> <span class="x">(</span><span class="o">-</span><span class="n">α</span><span class="x">)</span> <span class="o">+</span> <span class="x">(</span><span class="o">-</span> <span class="n">lockdown</span><span class="x">[</span><span class="n">m</span><span class="x">])</span> <span class="o">*</span> <span class="n">xs</span><span class="x">[</span><span class="o">:</span><span class="x">,</span> <span class="n">lockdown_index</span><span class="x">])</span>

        <span class="c"># Adjusts for portion of pop that are susceptible</span>
        <span class="n">Rt_adj_m</span><span class="x">[</span><span class="mi">1</span><span class="o">:</span><span class="n">num_impute</span><span class="x">]</span> <span class="o">.=</span> <span class="x">(</span><span class="n">max</span><span class="o">.</span><span class="x">(</span><span class="n">pop_m</span> <span class="o">.-</span> <span class="n">cases_pred_m</span><span class="x">[</span><span class="mi">1</span><span class="o">:</span><span class="n">num_impute</span><span class="x">],</span> <span class="n">zero</span><span class="x">(</span><span class="n">cases_pred_m</span><span class="x">[</span><span class="mi">1</span><span class="x">]))</span> <span class="o">./</span> <span class="n">pop_m</span><span class="x">)</span> <span class="o">.*</span> <span class="n">Rt_m</span><span class="x">[</span><span class="mi">1</span><span class="o">:</span><span class="n">num_impute</span><span class="x">]</span>

        <span class="k">for</span> <span class="n">t</span> <span class="o">=</span> <span class="x">(</span><span class="n">num_impute</span> <span class="o">+</span> <span class="mi">1</span><span class="x">)</span><span class="o">:</span><span class="n">last_time_step</span>
            <span class="c"># Update cumulative cases</span>
            <span class="n">cases_pred_m</span><span class="x">[</span><span class="n">t</span><span class="x">]</span> <span class="o">=</span> <span class="n">cases_pred_m</span><span class="x">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="x">]</span> <span class="o">+</span> <span class="n">expected_daily_cases_m</span><span class="x">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="x">]</span>

            <span class="c"># Adjusts for portion of pop that are susceptible</span>
            <span class="n">Rt_adj_m</span><span class="x">[</span><span class="n">t</span><span class="x">]</span> <span class="o">=</span> <span class="x">(</span><span class="n">max</span><span class="x">(</span><span class="n">pop_m</span> <span class="o">-</span> <span class="n">cases_pred_m</span><span class="x">[</span><span class="n">t</span><span class="x">],</span> <span class="n">zero</span><span class="x">(</span><span class="n">cases_pred_m</span><span class="x">[</span><span class="n">t</span><span class="x">]))</span> <span class="o">/</span> <span class="n">pop_m</span><span class="x">)</span> <span class="o">*</span> <span class="n">Rt_m</span><span class="x">[</span><span class="n">t</span><span class="x">]</span>

            <span class="n">expected_daily_cases_m</span><span class="x">[</span><span class="n">t</span><span class="x">]</span> <span class="o">=</span> <span class="n">Rt_adj_m</span><span class="x">[</span><span class="n">t</span><span class="x">]</span> <span class="o">*</span> <span class="n">sum</span><span class="x">(</span><span class="n">expected_daily_cases_m</span><span class="x">[</span><span class="n">τ</span><span class="x">]</span> <span class="o">*</span> <span class="n">serial_intervals</span><span class="x">[</span><span class="n">t</span> <span class="o">-</span> <span class="n">τ</span><span class="x">]</span> <span class="k">for</span> <span class="n">τ</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="x">(</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="x">))</span>
        <span class="k">end</span>

        <span class="n">expected_daily_deaths_m</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span> <span class="o">=</span> <span class="mf">1e-15</span> <span class="o">*</span> <span class="n">expected_daily_cases_m</span><span class="x">[</span><span class="mi">1</span><span class="x">]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">2</span><span class="o">:</span><span class="n">last_time_step</span>
            <span class="n">expected_daily_deaths_m</span><span class="x">[</span><span class="n">t</span><span class="x">]</span> <span class="o">=</span> <span class="n">sum</span><span class="x">(</span><span class="n">expected_daily_cases_m</span><span class="x">[</span><span class="n">τ</span><span class="x">]</span> <span class="o">*</span> <span class="n">π_m</span><span class="x">[</span><span class="n">t</span> <span class="o">-</span> <span class="n">τ</span><span class="x">]</span> <span class="o">*</span> <span class="n">ifr_noise</span><span class="x">[</span><span class="n">m</span><span class="x">]</span> <span class="k">for</span> <span class="n">τ</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="x">(</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="x">))</span>
        <span class="k">end</span>
    <span class="k">end</span>

    <span class="c"># Observe</span>
    <span class="c"># Doing observations in parallel provides a small speedup</span>
    <span class="n">logps</span> <span class="o">=</span> <span class="n">TV</span><span class="x">(</span><span class="nb">undef</span><span class="x">,</span> <span class="n">num_countries</span><span class="x">)</span>
    <span class="nd">@threads</span> <span class="k">for</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">num_countries</span>
        <span class="c"># Extract the estimated expected daily deaths for country `m`</span>
        <span class="n">expected_daily_deaths_m</span> <span class="o">=</span> <span class="n">expected_daily_deaths</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
        <span class="c"># Extract time-steps for which we have observations</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">epidemic_start</span><span class="x">[</span><span class="n">m</span><span class="x">]</span><span class="o">:</span><span class="n">num_obs_countries</span><span class="x">[</span><span class="n">m</span><span class="x">]</span>
        <span class="c"># Observe!</span>
        <span class="n">logps</span><span class="x">[</span><span class="n">m</span><span class="x">]</span> <span class="o">=</span> <span class="n">logpdf</span><span class="x">(</span><span class="n">arraydist</span><span class="x">(</span><span class="n">NegativeBinomial2</span><span class="o">.</span><span class="x">(</span><span class="n">expected_daily_deaths_m</span><span class="x">[</span><span class="n">ts</span><span class="x">],</span> <span class="n">ϕ</span><span class="x">)),</span> <span class="n">deaths</span><span class="x">[</span><span class="n">m</span><span class="x">][</span><span class="n">ts</span><span class="x">])</span>
    <span class="k">end</span>
    <span class="n">Turing</span><span class="o">.</span><span class="n">acclogp!</span><span class="x">(</span><span class="n">_varinfo</span><span class="x">,</span> <span class="n">sum</span><span class="x">(</span><span class="n">logps</span><span class="x">))</span>

    <span class="k">return</span> <span class="x">(</span>
        <span class="n">expected_daily_cases</span> <span class="o">=</span> <span class="n">expected_daily_cases</span><span class="x">,</span>
        <span class="n">expected_daily_deaths</span> <span class="o">=</span> <span class="n">expected_daily_deaths</span><span class="x">,</span>
        <span class="n">Rt</span> <span class="o">=</span> <span class="n">Rt</span><span class="x">,</span>
        <span class="n">Rt_adjusted</span> <span class="o">=</span> <span class="n">Rt_adj</span>
    <span class="x">)</span>
<span class="k">end</span><span class="x">;</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌ Warning: you are using the internal variable `_varinfo`
└ @ DynamicPPL /homes/tef30/.julia/packages/DynamicPPL/3jy49/src/compiler.jl:175
</code></pre></div></div>

<p>We define an alias <code class="highlighter-rouge">model_def</code> so that if we want to try out a different model, there’s only one point in the notebook which we need to change.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model_def</span> <span class="o">=</span> <span class="n">model_v2</span><span class="x">;</span>
</code></pre></div></div>

<p>The input data have up to 30-40 days of unobserved future data which we might want to predict on. But during sampling we don’t want to waste computation on sampling for the future for which we do not have any observations. Therefore we have an argument <code class="highlighter-rouge">predict::Bool</code> in the model which allows us to specify whether or not to generate future quantities.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Model instantance used to for inference</span>
<span class="n">m_no_pred</span> <span class="o">=</span> <span class="n">model_def</span><span class="x">(</span>
    <span class="n">data</span><span class="o">.</span><span class="n">num_impute</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">num_total_days</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">cases</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">deaths</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="nb">π</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">covariates</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">epidemic_start</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">population</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">serial_intervals</span><span class="x">,</span>
    <span class="n">lockdown_index</span><span class="x">,</span>
    <span class="nb">false</span> <span class="c"># &lt;= DON'T predict</span>
<span class="x">);</span>
</code></pre></div></div>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Model instance used for prediction</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">model_def</span><span class="x">(</span>
    <span class="n">data</span><span class="o">.</span><span class="n">num_impute</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">num_total_days</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">cases</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">deaths</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="nb">π</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">covariates</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">epidemic_start</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">population</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">serial_intervals</span><span class="x">,</span>
    <span class="n">lockdown_index</span><span class="x">,</span>
    <span class="nb">true</span> <span class="c"># &lt;= predict</span>
<span class="x">);</span>
</code></pre></div></div>

<p>Just to make sure everything is working, we can “evaluate” the model to obtain a sample from the prior:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">res</span> <span class="o">=</span> <span class="n">m</span><span class="x">();</span>
<span class="n">res</span><span class="o">.</span><span class="n">expected_daily_cases</span><span class="x">[</span><span class="n">uk_index</span><span class="x">]</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>100-element Array{Float64,1}:
 0.2978422827487166
 0.2978422827487166
 0.2978422827487166
 0.2978422827487166
 0.2978422827487166
 0.2978422827487166
 0.832817101553483
 1.0346063917235566
 1.3678178161493468
 1.8604943842674377
 2.546129501657631
 3.4852378065416523
 4.768875412263893
 ⋮
 0.24406116233616038
 0.17186744515247868
 0.1208474970159245
 0.08485139699103932
 0.05949579772505278
 0.04166274540068994
 0.029138775736189983
 0.02035555519759347
 0.014203911930339133
 0.009900796534873262
 0.00689432670057081
 0.004796166095549548
</code></pre></div></div>

<h1 id="visualization-utilities">Visualization utilities</h1>

<p>For visualisation we of course use <a href="https://github.com/JuliaPlots/Plots.jl">Plots.jl</a>, and in this case we’re going to use the <code class="highlighter-rouge">pyplot</code> backend which uses Python’s matplotlib under the hood.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="n">Plots</span><span class="x">,</span> <span class="n">StatsPlots</span>
</code></pre></div></div>

<details><summary><p>Method definition for plotting the predictive distribution</p>
</summary>
<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Ehh, this can be made nicer...</span>
<span class="k">function</span><span class="nf"> country_prediction_plot</span><span class="x">(</span><span class="n">country_idx</span><span class="x">,</span> <span class="n">predictions_country</span><span class="o">::</span><span class="kt">AbstractMatrix</span><span class="x">,</span> <span class="n">e_deaths_country</span><span class="o">::</span><span class="kt">AbstractMatrix</span><span class="x">,</span> <span class="n">Rt_country</span><span class="o">::</span><span class="kt">AbstractMatrix</span><span class="x">;</span> <span class="n">normalize_pop</span><span class="o">::</span><span class="kt">Bool</span> <span class="o">=</span> <span class="nb">false</span><span class="x">,</span> <span class="n">main_title</span><span class="o">=</span><span class="s">""</span><span class="x">)</span>
    <span class="n">pop</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">population</span><span class="x">[</span><span class="n">country_idx</span><span class="x">]</span>
    <span class="n">num_total_days</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">num_total_days</span>
    <span class="n">num_observed_days</span> <span class="o">=</span> <span class="n">length</span><span class="x">(</span><span class="n">data</span><span class="o">.</span><span class="n">cases</span><span class="x">[</span><span class="n">country_idx</span><span class="x">])</span>

    <span class="n">country_name</span> <span class="o">=</span> <span class="n">countries</span><span class="x">[</span><span class="n">country_idx</span><span class="x">]</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="n">first</span><span class="x">(</span><span class="n">country_to_dates</span><span class="x">[</span><span class="n">country_name</span><span class="x">])</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="n">cumsum</span><span class="x">(</span><span class="n">fill</span><span class="x">(</span><span class="kt">Day</span><span class="x">(</span><span class="mi">1</span><span class="x">),</span> <span class="n">data</span><span class="o">.</span><span class="n">num_total_days</span><span class="x">))</span> <span class="o">+</span> <span class="x">(</span><span class="n">start_date</span> <span class="o">-</span> <span class="kt">Day</span><span class="x">(</span><span class="mi">1</span><span class="x">))</span>
    <span class="n">date_strings</span> <span class="o">=</span> <span class="n">Dates</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="x">(</span><span class="n">dates</span><span class="x">,</span> <span class="s">"Y-mm-dd"</span><span class="x">)</span>

    <span class="c"># A tiny bit of preprocessing of the data</span>
    <span class="n">preproc</span><span class="x">(</span><span class="n">x</span><span class="x">)</span> <span class="o">=</span> <span class="n">normalize_pop</span> <span class="o">?</span> <span class="n">x</span> <span class="o">./</span> <span class="n">pop</span> <span class="o">:</span> <span class="n">x</span>

    <span class="n">daily_deaths</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">deaths</span><span class="x">[</span><span class="n">country_idx</span><span class="x">]</span>
    <span class="n">daily_cases</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">cases</span><span class="x">[</span><span class="n">country_idx</span><span class="x">]</span>

    <span class="n">p1</span> <span class="o">=</span> <span class="n">plot</span><span class="x">(;</span> <span class="n">xaxis</span> <span class="o">=</span> <span class="nb">false</span><span class="x">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="o">:</span><span class="n">topleft</span><span class="x">)</span>
    <span class="n">bar!</span><span class="x">(</span><span class="n">preproc</span><span class="x">(</span><span class="n">daily_deaths</span><span class="x">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"Observed daily deaths"</span><span class="x">)</span>
    <span class="n">title!</span><span class="x">(</span><span class="n">replace</span><span class="x">(</span><span class="n">country_name</span><span class="x">,</span> <span class="s">"_"</span> <span class="o">=&gt;</span> <span class="s">" "</span><span class="x">)</span> <span class="o">*</span> <span class="s">" "</span> <span class="o">*</span> <span class="n">main_title</span><span class="x">)</span>
    <span class="n">vline!</span><span class="x">([</span><span class="n">data</span><span class="o">.</span><span class="n">epidemic_start</span><span class="x">[</span><span class="n">country_idx</span><span class="x">]],</span> <span class="n">label</span><span class="o">=</span><span class="s">"epidemic start"</span><span class="x">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="x">)</span>
    <span class="n">vline!</span><span class="x">([</span><span class="n">num_observed_days</span><span class="x">],</span> <span class="n">label</span><span class="o">=</span><span class="s">"end of observations"</span><span class="x">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="x">)</span>
    <span class="n">xlims!</span><span class="x">(</span><span class="mi">0</span><span class="x">,</span> <span class="n">num_total_days</span><span class="x">)</span>

    <span class="n">p2</span> <span class="o">=</span> <span class="n">plot</span><span class="x">(;</span> <span class="n">legend</span> <span class="o">=</span> <span class="o">:</span><span class="n">topleft</span><span class="x">,</span> <span class="n">xaxis</span><span class="o">=</span><span class="nb">false</span><span class="x">)</span>
    <span class="n">plot_confidence_timeseries!</span><span class="x">(</span><span class="n">p2</span><span class="x">,</span> <span class="n">preproc</span><span class="x">(</span><span class="n">e_deaths_country</span><span class="x">);</span> <span class="n">label</span> <span class="o">=</span> <span class="s">"Expected daily deaths"</span><span class="x">)</span>
    <span class="c"># title!("Expected daily deaths (pred)")</span>
    <span class="n">bar!</span><span class="x">(</span><span class="n">preproc</span><span class="x">(</span><span class="n">daily_deaths</span><span class="x">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"Recorded daily deaths (observed)"</span><span class="x">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="x">)</span>

    <span class="n">p3</span> <span class="o">=</span> <span class="n">plot</span><span class="x">(;</span> <span class="n">legend</span> <span class="o">=</span> <span class="o">:</span><span class="n">bottomleft</span><span class="x">,</span> <span class="n">xaxis</span><span class="o">=</span><span class="nb">false</span><span class="x">)</span>
    <span class="n">plot_confidence_timeseries!</span><span class="x">(</span><span class="n">p3</span><span class="x">,</span> <span class="n">Rt_country</span><span class="x">;</span> <span class="n">no_label</span> <span class="o">=</span> <span class="nb">true</span><span class="x">)</span>
    <span class="k">for</span> <span class="x">(</span><span class="n">c_idx</span><span class="x">,</span> <span class="n">c_time</span><span class="x">)</span> <span class="k">in</span> <span class="n">enumerate</span><span class="x">(</span><span class="n">findfirst</span><span class="o">.</span><span class="x">(</span><span class="o">==</span><span class="x">(</span><span class="mi">1</span><span class="x">),</span> <span class="n">eachcol</span><span class="x">(</span><span class="n">data</span><span class="o">.</span><span class="n">covariates</span><span class="x">[</span><span class="n">country_idx</span><span class="x">])))</span>
        <span class="k">if</span> <span class="n">c_time</span> <span class="o">!==</span> <span class="nb">nothing</span>
            <span class="n">c_name</span> <span class="o">=</span> <span class="n">names_covariates</span><span class="x">[</span><span class="n">c_idx</span><span class="x">]</span>
            <span class="k">if</span> <span class="x">(</span><span class="n">c_name</span> <span class="o">!=</span> <span class="s">"any"</span><span class="x">)</span>
                <span class="c"># Don't add the "any intervention" stuff</span>
                <span class="n">vline!</span><span class="x">([</span><span class="n">c_time</span> <span class="o">-</span> <span class="mi">1</span><span class="x">],</span> <span class="n">label</span><span class="o">=</span><span class="n">c_name</span><span class="x">)</span>
            <span class="k">end</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">title!</span><span class="x">(</span><span class="s">"Rt"</span><span class="x">)</span>
    <span class="n">qs</span> <span class="o">=</span> <span class="x">[</span><span class="n">quantile</span><span class="x">(</span><span class="n">v</span><span class="x">,</span> <span class="x">[</span><span class="mf">0.025</span><span class="x">,</span> <span class="mf">0.975</span><span class="x">])</span> <span class="k">for</span> <span class="n">v</span> <span class="k">in</span> <span class="n">eachrow</span><span class="x">(</span><span class="n">Rt_country</span><span class="x">)]</span>
    <span class="n">lq</span><span class="x">,</span> <span class="n">hq</span> <span class="o">=</span> <span class="x">(</span><span class="n">eachrow</span><span class="x">(</span><span class="n">hcat</span><span class="x">(</span><span class="n">qs</span><span class="o">...</span><span class="x">))</span><span class="o">...</span><span class="x">,</span> <span class="x">)</span>
    <span class="n">ylims!</span><span class="x">(</span><span class="mi">0</span><span class="x">,</span> <span class="n">maximum</span><span class="x">(</span><span class="n">hq</span><span class="x">)</span> <span class="o">+</span> <span class="mf">0.1</span><span class="x">)</span>

    <span class="n">p4</span> <span class="o">=</span> <span class="n">plot</span><span class="x">(;</span> <span class="n">legend</span> <span class="o">=</span> <span class="o">:</span><span class="n">topleft</span><span class="x">,</span> <span class="n">xaxis</span><span class="o">=</span><span class="nb">false</span><span class="x">)</span>
    <span class="n">plot_confidence_timeseries!</span><span class="x">(</span><span class="n">p4</span><span class="x">,</span> <span class="n">preproc</span><span class="x">(</span><span class="n">predictions_country</span><span class="x">);</span> <span class="n">label</span> <span class="o">=</span> <span class="s">"Expected daily cases"</span><span class="x">)</span>
    <span class="c"># title!("Expected daily cases (pred)")</span>
    <span class="n">bar!</span><span class="x">(</span><span class="n">preproc</span><span class="x">(</span><span class="n">daily_cases</span><span class="x">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"Recorded daily cases (observed)"</span><span class="x">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="x">)</span>

    <span class="n">vals</span> <span class="o">=</span> <span class="n">preproc</span><span class="x">(</span><span class="n">cumsum</span><span class="x">(</span><span class="n">e_deaths_country</span><span class="x">;</span> <span class="n">dims</span> <span class="o">=</span> <span class="mi">1</span><span class="x">))</span>
    <span class="n">p5</span> <span class="o">=</span> <span class="n">plot</span><span class="x">(;</span> <span class="n">legend</span> <span class="o">=</span> <span class="o">:</span><span class="n">topleft</span><span class="x">,</span> <span class="n">xaxis</span><span class="o">=</span><span class="nb">false</span><span class="x">)</span>
    <span class="n">plot_confidence_timeseries!</span><span class="x">(</span><span class="n">p5</span><span class="x">,</span> <span class="n">vals</span><span class="x">;</span> <span class="n">label</span> <span class="o">=</span> <span class="s">"Expected deaths"</span><span class="x">)</span>
    <span class="n">plot!</span><span class="x">(</span><span class="n">preproc</span><span class="x">(</span><span class="n">cumsum</span><span class="x">(</span><span class="n">daily_deaths</span><span class="x">)),</span> <span class="n">label</span><span class="o">=</span><span class="s">"Recorded deaths (observed)"</span><span class="x">,</span> <span class="n">color</span><span class="o">=:</span><span class="n">red</span><span class="x">)</span>
    <span class="c"># title!("Expected deaths (pred)")</span>

    <span class="n">vals</span> <span class="o">=</span> <span class="n">preproc</span><span class="x">(</span><span class="n">cumsum</span><span class="x">(</span><span class="n">predictions_country</span><span class="x">;</span> <span class="n">dims</span> <span class="o">=</span> <span class="mi">1</span><span class="x">))</span>
    <span class="n">p6</span> <span class="o">=</span> <span class="n">plot</span><span class="x">(;</span> <span class="n">legend</span> <span class="o">=</span> <span class="o">:</span><span class="n">topleft</span><span class="x">)</span>
    <span class="n">plot_confidence_timeseries!</span><span class="x">(</span><span class="n">p6</span><span class="x">,</span> <span class="n">vals</span><span class="x">;</span> <span class="n">label</span> <span class="o">=</span> <span class="s">"Expected cases"</span><span class="x">)</span>
    <span class="n">plot!</span><span class="x">(</span><span class="n">preproc</span><span class="x">(</span><span class="n">daily_cases</span><span class="x">),</span> <span class="n">label</span><span class="o">=</span><span class="s">"Recorded cases (observed)"</span><span class="x">,</span> <span class="n">color</span><span class="o">=:</span><span class="n">red</span><span class="x">)</span>
    <span class="c"># title!("Expected cases (pred)")</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">plot</span><span class="x">(</span><span class="n">p1</span><span class="x">,</span> <span class="n">p3</span><span class="x">,</span> <span class="n">p2</span><span class="x">,</span> <span class="n">p4</span><span class="x">,</span> <span class="n">p5</span><span class="x">,</span> <span class="n">p6</span><span class="x">,</span> <span class="n">layout</span><span class="o">=</span><span class="x">(</span><span class="mi">6</span><span class="x">,</span> <span class="mi">1</span><span class="x">),</span> <span class="n">size</span><span class="o">=</span><span class="x">(</span><span class="mi">900</span><span class="x">,</span> <span class="mi">1200</span><span class="x">),</span> <span class="n">sharex</span><span class="o">=</span><span class="nb">true</span><span class="x">)</span>
    <span class="n">xticks!</span><span class="x">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">3</span><span class="o">:</span><span class="n">num_total_days</span><span class="x">,</span> <span class="n">date_strings</span><span class="x">[</span><span class="mi">1</span><span class="o">:</span><span class="mi">3</span><span class="o">:</span><span class="k">end</span><span class="x">],</span> <span class="n">xrotation</span><span class="o">=</span><span class="mi">45</span><span class="x">)</span>

    <span class="k">return</span> <span class="n">p</span>
<span class="k">end</span>

<span class="k">function</span><span class="nf"> country_prediction_plot</span><span class="x">(</span><span class="n">country_idx</span><span class="x">,</span> <span class="n">cases</span><span class="x">,</span> <span class="n">e_deaths</span><span class="x">,</span> <span class="n">Rt</span><span class="x">;</span> <span class="n">kwargs</span><span class="o">...</span><span class="x">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">length</span><span class="x">(</span><span class="n">cases</span><span class="x">)</span>
    <span class="n">e_deaths_country</span> <span class="o">=</span> <span class="n">hcat</span><span class="x">([</span><span class="n">e_deaths</span><span class="x">[</span><span class="n">t</span><span class="x">][</span><span class="n">country_idx</span><span class="x">]</span> <span class="k">for</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">n</span><span class="x">]</span><span class="o">...</span><span class="x">)</span>
    <span class="n">Rt_country</span> <span class="o">=</span> <span class="n">hcat</span><span class="x">([</span><span class="n">Rt</span><span class="x">[</span><span class="n">t</span><span class="x">][</span><span class="n">country_idx</span><span class="x">]</span> <span class="k">for</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">n</span><span class="x">]</span><span class="o">...</span><span class="x">)</span>
    <span class="n">predictions_country</span> <span class="o">=</span> <span class="n">hcat</span><span class="x">([</span><span class="n">cases</span><span class="x">[</span><span class="n">t</span><span class="x">][</span><span class="n">country_idx</span><span class="x">]</span> <span class="k">for</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">n</span><span class="x">]</span><span class="o">...</span><span class="x">)</span>

    <span class="k">return</span> <span class="n">country_prediction_plot</span><span class="x">(</span><span class="n">country_idx</span><span class="x">,</span> <span class="n">predictions_country</span><span class="x">,</span> <span class="n">e_deaths_country</span><span class="x">,</span> <span class="n">Rt_country</span><span class="x">;</span> <span class="n">kwargs</span><span class="o">...</span><span class="x">)</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>country_prediction_plot (generic function with 2 methods)
</code></pre></div></div>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span><span class="nf"> arrarrarr2arr</span><span class="x">(</span><span class="n">a</span><span class="o">::</span><span class="kt">AbstractVector</span><span class="x">{</span><span class="o">&lt;:</span><span class="kt">AbstractVector</span><span class="x">{</span><span class="o">&lt;:</span><span class="kt">AbstractVector</span><span class="x">{</span><span class="n">T</span><span class="x">}}})</span> <span class="k">where</span> <span class="x">{</span><span class="n">T</span><span class="o">&lt;:</span><span class="kt">Real</span><span class="x">}</span>
    <span class="n">n1</span><span class="x">,</span> <span class="n">n2</span><span class="x">,</span> <span class="n">n3</span> <span class="o">=</span> <span class="n">length</span><span class="x">(</span><span class="n">a</span><span class="x">),</span> <span class="n">length</span><span class="x">(</span><span class="n">first</span><span class="x">(</span><span class="n">a</span><span class="x">)),</span> <span class="n">length</span><span class="x">(</span><span class="n">first</span><span class="x">(</span><span class="n">first</span><span class="x">(</span><span class="n">a</span><span class="x">)))</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">zeros</span><span class="x">(</span><span class="n">T</span><span class="x">,</span> <span class="x">(</span><span class="n">n1</span><span class="x">,</span> <span class="n">n2</span><span class="x">,</span> <span class="n">n3</span><span class="x">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">n1</span>
        <span class="k">for</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">n2</span>
            <span class="k">for</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">n3</span>
                <span class="n">A</span><span class="x">[</span><span class="n">i</span><span class="x">,</span> <span class="n">j</span><span class="x">,</span> <span class="n">k</span><span class="x">]</span> <span class="o">=</span> <span class="n">a</span><span class="x">[</span><span class="n">i</span><span class="x">][</span><span class="n">j</span><span class="x">][</span><span class="n">k</span><span class="x">]</span>
            <span class="k">end</span>
        <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">return</span> <span class="n">A</span>
<span class="k">end</span>

<span class="k">function</span><span class="nf"> country_cumulative_prediction</span><span class="x">(</span><span class="n">vals</span><span class="o">::</span><span class="kt">AbstractArray</span><span class="x">{</span><span class="o">&lt;:</span><span class="kt">Real</span><span class="x">,</span> <span class="mi">3</span><span class="x">};</span> <span class="n">normalize_pop</span> <span class="o">=</span> <span class="nb">false</span><span class="x">,</span> <span class="n">no_label</span><span class="o">=</span><span class="nb">false</span><span class="x">,</span> <span class="n">kwargs</span><span class="o">...</span><span class="x">)</span>
    <span class="n">lqs</span><span class="x">,</span> <span class="n">mqs</span><span class="x">,</span> <span class="n">hqs</span> <span class="o">=</span> <span class="x">[],</span> <span class="x">[],</span> <span class="x">[]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="x">[]</span>

    <span class="k">for</span> <span class="n">country_idx</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">length</span><span class="x">(</span><span class="n">countries</span><span class="x">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">vals</span><span class="x">[</span><span class="n">country_idx</span><span class="x">,</span> <span class="o">:</span><span class="x">,</span> <span class="o">:</span><span class="x">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">size</span><span class="x">(</span><span class="n">val</span><span class="x">,</span> <span class="mi">1</span><span class="x">)</span>

        <span class="n">pop</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">population</span><span class="x">[</span><span class="n">country_idx</span><span class="x">]</span>
        <span class="n">num_total_days</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">num_total_days</span>
        <span class="n">num_observed_days</span> <span class="o">=</span> <span class="n">length</span><span class="x">(</span><span class="n">data</span><span class="o">.</span><span class="n">cases</span><span class="x">[</span><span class="n">country_idx</span><span class="x">])</span>

        <span class="n">country_name</span> <span class="o">=</span> <span class="n">countries</span><span class="x">[</span><span class="n">country_idx</span><span class="x">]</span>

        <span class="c"># A tiny bit of preprocessing of the data</span>
        <span class="n">preproc</span><span class="x">(</span><span class="n">x</span><span class="x">)</span> <span class="o">=</span> <span class="n">normalize_pop</span> <span class="o">?</span> <span class="n">x</span> <span class="o">./</span> <span class="n">pop</span> <span class="o">:</span> <span class="n">x</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="n">preproc</span><span class="x">(</span><span class="n">cumsum</span><span class="x">(</span><span class="n">val</span><span class="x">;</span> <span class="n">dims</span> <span class="o">=</span> <span class="mi">1</span><span class="x">))</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="x">[</span><span class="n">quantile</span><span class="x">(</span><span class="n">tmp</span><span class="x">[</span><span class="n">t</span><span class="x">,</span> <span class="o">:</span><span class="x">],</span> <span class="x">[</span><span class="mf">0.025</span><span class="x">,</span> <span class="mf">0.5</span><span class="x">,</span> <span class="mf">0.975</span><span class="x">])</span> <span class="k">for</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">n</span><span class="x">]</span>
        <span class="n">lq</span><span class="x">,</span> <span class="n">mq</span><span class="x">,</span> <span class="n">hq</span> <span class="o">=</span> <span class="x">(</span><span class="n">eachrow</span><span class="x">(</span><span class="n">hcat</span><span class="x">(</span><span class="n">qs</span><span class="o">...</span><span class="x">))</span><span class="o">...</span><span class="x">,</span> <span class="x">)</span>

        <span class="n">push!</span><span class="x">(</span><span class="n">lqs</span><span class="x">,</span> <span class="n">lq</span><span class="x">)</span>
        <span class="n">push!</span><span class="x">(</span><span class="n">mqs</span><span class="x">,</span> <span class="n">mq</span><span class="x">)</span>
        <span class="n">push!</span><span class="x">(</span><span class="n">hqs</span><span class="x">,</span> <span class="n">hq</span><span class="x">)</span>
        <span class="n">push!</span><span class="x">(</span><span class="n">labels</span><span class="x">,</span> <span class="n">country_name</span><span class="x">)</span>
    <span class="k">end</span>

    <span class="n">lqs</span> <span class="o">=</span> <span class="n">reduce</span><span class="x">(</span><span class="n">hcat</span><span class="x">,</span> <span class="n">collect</span><span class="o">.</span><span class="x">(</span><span class="n">lqs</span><span class="x">))</span>
    <span class="n">mqs</span> <span class="o">=</span> <span class="n">reduce</span><span class="x">(</span><span class="n">hcat</span><span class="x">,</span> <span class="n">collect</span><span class="o">.</span><span class="x">(</span><span class="n">mqs</span><span class="x">))</span>
    <span class="n">hqs</span> <span class="o">=</span> <span class="n">reduce</span><span class="x">(</span><span class="n">hcat</span><span class="x">,</span> <span class="n">collect</span><span class="o">.</span><span class="x">(</span><span class="n">hqs</span><span class="x">))</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">plot</span><span class="x">(;</span> <span class="n">kwargs</span><span class="o">...</span><span class="x">)</span>
    <span class="k">for</span> <span class="n">country_idx</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">length</span><span class="x">(</span><span class="n">countries</span><span class="x">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">no_label</span> <span class="o">?</span> <span class="s">""</span> <span class="o">:</span> <span class="n">labels</span><span class="x">[</span><span class="n">country_idx</span><span class="x">]</span>
        <span class="n">plot!</span><span class="x">(</span><span class="n">mqs</span><span class="x">[</span><span class="o">:</span><span class="x">,</span> <span class="n">country_idx</span><span class="x">];</span> <span class="n">ribbon</span><span class="o">=</span><span class="x">(</span><span class="n">mqs</span><span class="x">[</span><span class="o">:</span><span class="x">,</span> <span class="n">country_idx</span><span class="x">]</span> <span class="o">-</span> <span class="n">lqs</span><span class="x">[</span><span class="o">:</span><span class="x">,</span> <span class="n">country_idx</span><span class="x">],</span> <span class="n">hqs</span><span class="x">[</span><span class="o">:</span><span class="x">,</span> <span class="n">country_idx</span><span class="x">]</span> <span class="o">-</span> <span class="n">mqs</span><span class="x">[</span><span class="o">:</span><span class="x">,</span> <span class="n">country_idx</span><span class="x">]),</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="x">)</span>
    <span class="k">end</span>

    <span class="k">return</span> <span class="n">p</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>country_cumulative_prediction (generic function with 1 method)
</code></pre></div></div>

</details>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">daily_deaths_arr</span> <span class="o">=</span> <span class="n">arrarrarr2arr</span><span class="x">(</span><span class="n">daily_deaths_posterior</span><span class="x">)</span>
<span class="n">daily_deaths_arr</span> <span class="o">=</span> <span class="n">permutedims</span><span class="x">(</span><span class="n">daily_deaths_arr</span><span class="x">,</span> <span class="x">(</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">))</span>

<span class="n">daily_cases_arr</span> <span class="o">=</span> <span class="n">arrarrarr2arr</span><span class="x">(</span><span class="n">daily_cases_posterior</span><span class="x">)</span>
<span class="n">daily_cases_arr</span> <span class="o">=</span> <span class="n">permutedims</span><span class="x">(</span><span class="n">daily_cases_arr</span><span class="x">,</span> <span class="x">(</span><span class="mi">2</span><span class="x">,</span> <span class="mi">3</span><span class="x">,</span> <span class="mi">1</span><span class="x">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>14×100×4000 Array{Float64,3}:
[:, :, 1] =
 31.6314   31.6314   31.6314   31.6314   …    156.61        151.178
 35.2791   35.2791   35.2791   35.2791       3646.08       3431.64
  5.82819   5.82819   5.82819   5.82819      6416.22       6282.52
 32.4507   32.4507   32.4507   32.4507       9749.19       9408.06
 33.8585   33.8585   33.8585   33.8585       6107.9        5812.33
 14.4027   14.4027   14.4027   14.4027   …  13849.1       13444.2
 13.4485   13.4485   13.4485   13.4485         73.396        70.6272
  5.32057   5.32057   5.32057   5.32057     45867.8       45212.0
 31.3424   31.3424   31.3424   31.3424        191.955       186.097
 93.6691   93.6691   93.6691   93.6691      53568.5       53719.7
 25.9993   25.9993   25.9993   25.9993   …    130.31        122.522
 63.4528   63.4528   63.4528   63.4528          0.135277      0.120549
 30.3088   30.3088   30.3088   30.3088         86.6885       82.4991
 58.7329   58.7329   58.7329   58.7329        364.967       341.81

[:, :, 2] =
 21.8248   21.8248   21.8248   21.8248   …     59.4495        56.6651
 17.6305   17.6305   17.6305   17.6305       2751.21        2577.23
 17.5398   17.5398   17.5398   17.5398       2514.87        2422.85
 39.3773   39.3773   39.3773   39.3773       2572.54        2435.6
 13.8745   13.8745   13.8745   13.8745       7143.99        6796.27
  2.43846   2.43846   2.43846   2.43846  …  21861.8        21394.1
 16.6948   16.6948   16.6948   16.6948         12.4779        11.7615
  7.64907   7.64907   7.64907   7.64907     43911.9        43155.0
 54.9893   54.9893   54.9893   54.9893        164.217        158.063
 96.3331   96.3331   96.3331   96.3331      52492.8        52575.9
  6.69537   6.69537   6.69537   6.69537  …    291.955        278.593
 41.8925   41.8925   41.8925   41.8925          0.0549723      0.0484776
 10.4633   10.4633   10.4633   10.4633       1133.48        1110.4
 53.9036   53.9036   53.9036   53.9036        285.281        266.222

[:, :, 3] =
  45.2317   45.2317   45.2317   45.2317  …     61.406         58.6976
  29.357    29.357    29.357    29.357       3176.11        2995.15
  30.394    30.394    30.394    30.394       1196.45        1139.83
 125.299   125.299   125.299   125.299       6239.52        5961.07
  36.4959   36.4959   36.4959   36.4959      4289.44        4052.54
  19.2367   19.2367   19.2367   19.2367  …  19999.4        19513.5
  16.405    16.405    16.405    16.405         13.0237        12.2817
  15.1937   15.1937   15.1937   15.1937     36906.7        36324.8
  47.9864   47.9864   47.9864   47.9864       198.327        192.355
 145.876   145.876   145.876   145.876      95512.4        93517.3
  12.7606   12.7606   12.7606   12.7606  …    140.283        132.076
  84.0577   84.0577   84.0577   84.0577         0.0887854      0.078702
  66.317    66.317    66.317    66.317         26.8103        25.0513
  50.1513   50.1513   50.1513   50.1513       385.437        362.086

...

[:, :, 3998] =
 40.6005   40.6005   40.6005   40.6005   …     41.3201      39.257
 37.4406   37.4406   37.4406   37.4406       5168.87      4928.88
  6.66627   6.66627   6.66627   6.66627      1796.71      1724.79
 19.2496   19.2496   19.2496   19.2496       2893.68      2735.41
 21.6056   21.6056   21.6056   21.6056      13520.2      13034.5
  4.69097   4.69097   4.69097   4.69097  …  12729.8      12386.1
 42.8182   42.8182   42.8182   42.8182        326.627      322.394
  7.19116   7.19116   7.19116   7.19116     50203.4      49797.1
 26.3942   26.3942   26.3942   26.3942        263.88       256.656
 53.6565   53.6565   53.6565   53.6565      83072.5      82676.3
 24.4936   24.4936   24.4936   24.4936   …    153.229      144.346
 46.8848   46.8848   46.8848   46.8848          3.16499      2.94815
 74.0729   74.0729   74.0729   74.0729         34.9909      32.6986
 84.5948   84.5948   84.5948   84.5948        600.202      567.397

[:, :, 3999] =
  17.5754    17.5754    17.5754    17.5754   …     246.31         239.819
  46.9688    46.9688    46.9688    46.9688        2641.87        2474.16
   5.1029     5.1029     5.1029     5.1029        2141.21        2071.62
  30.5983    30.5983    30.5983    30.5983        2429.53        2299.52
  15.1354    15.1354    15.1354    15.1354       15339.1        14856.2
  12.5852    12.5852    12.5852    12.5852   …   19716.9        19184.8
  20.7569    20.7569    20.7569    20.7569         198.359        193.751
   9.44519    9.44519    9.44519    9.44519      67919.1        66470.7
  46.0889    46.0889    46.0889    46.0889         106.309        102.061
  87.7028    87.7028    87.7028    87.7028      103695.0       102949.0
  34.3861    34.3861    34.3861    34.3861   …     299.303        285.163
 114.996    114.996    114.996    114.996            0.367775       0.332197
  51.0231    51.0231    51.0231    51.0231         306.67         296.26
  95.074     95.074     95.074     95.074          683.525        647.794

[:, :, 4000] =
 41.9978   41.9978   41.9978   41.9978   …    267.147        260.315
 29.6776   29.6776   29.6776   29.6776       6149.86        5851.81
 45.4262   45.4262   45.4262   45.4262       2766.05        2682.29
 67.3271   67.3271   67.3271   67.3271       3339.49        3174.33
 72.374    72.374    72.374    72.374       13353.4        12889.1
  5.65709   5.65709   5.65709   5.65709  …  39438.8        38904.1
 17.4738   17.4738   17.4738   17.4738         49.7947        47.6519
 16.4718   16.4718   16.4718   16.4718      33295.2        32990.2
 65.9772   65.9772   65.9772   65.9772        199.27         193.239
 87.5592   87.5592   87.5592   87.5592      32651.7        32673.7
 11.5608   11.5608   11.5608   11.5608   …    480.357        461.34
 88.1057   88.1057   88.1057   88.1057          0.0795788      0.070559
 27.258    27.258    27.258    27.258          97.7505        92.8548
 28.6621   28.6621   28.6621   28.6621        577.574        545.546
</code></pre></div></div>

<p>To make the plots interactive, we’re going to use the <a href="https://github.com/sglyon/PlotlyJS.jl"><code class="highlighter-rouge">PlotlyJS.jl</code></a> backend (which generates <a href="https://github.com/plotly/plotly.js/">plotly.js</a> plots under the hood):</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plotlyjs</span><span class="x">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Plots.PlotlyJSBackend()
</code></pre></div></div>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">country_cumulative_prediction</span><span class="x">(</span><span class="n">daily_deaths_arr</span><span class="x">;</span> <span class="n">size</span> <span class="o">=</span> <span class="x">(</span><span class="mi">800</span><span class="x">,</span> <span class="mi">300</span><span class="x">))</span>
<span class="n">title!</span><span class="x">(</span><span class="s">"Expected deaths (95% intervals)"</span><span class="x">)</span>
</code></pre></div></div>

<div id="plot1" class="plotly"></div>
<script>
 Plotly.d3.json("../assets/figures/2020-05-04-Imperial-Report13-analysis/plot1.json", function(err, fig) {
   Plotly.plot("plot1", fig.data, fig.layout, {responsive: true});
 });
</script>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">country_cumulative_prediction</span><span class="x">(</span><span class="n">daily_deaths_arr</span><span class="x">;</span> <span class="n">normalize_pop</span> <span class="o">=</span> <span class="nb">true</span><span class="x">,</span> <span class="n">size</span> <span class="o">=</span> <span class="x">(</span><span class="mi">800</span><span class="x">,</span> <span class="mi">300</span><span class="x">))</span>
<span class="n">title!</span><span class="x">(</span><span class="s">"Expected deaths / population (95% intervals)"</span><span class="x">)</span>
</code></pre></div></div>

<div id="plot2" class="plotly"></div>
<script>
 Plotly.d3.json("../assets/figures/2020-05-04-Imperial-Report13-analysis/plot2.json", function(err, fig) {
   Plotly.plot("plot2", fig.data, fig.layout, {responsive: true});
 });
</script>

<p>In the following sections we’re instead going to use <code class="highlighter-rouge">PyPlot.jl</code> as backend (which uses Python’s <code class="highlighter-rouge">matplotlib</code> under the hood) instead of <code class="highlighter-rouge">Plotly.js</code> since too many <code class="highlighter-rouge">Plotly.js</code> plots can slow down even the finest of computers.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pyplot</span><span class="x">()</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Plots.PyPlotBackend()
</code></pre></div></div>

<h1 id="prior">Prior</h1>

<p>Before we do any inference it can be useful to inspect the <em>prior</em> distribution, in particular if you are working with a hierarchical model where the dependencies in the prior might lead to some unexpected behavior. In Turing.jl you can sample a chain from the prior using <code class="highlighter-rouge">sample</code>, much in the same way as you would sample from the posterior.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chain_prior</span> <span class="o">=</span> <span class="n">sample</span><span class="x">(</span><span class="n">m</span><span class="x">,</span> <span class="n">Turing</span><span class="o">.</span><span class="n">Inference</span><span class="o">.</span><span class="n">PriorSampler</span><span class="x">(),</span> <span class="mi">1_000</span><span class="x">);</span>
</code></pre></div></div>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span><span class="x">(</span><span class="n">chain_prior</span><span class="x">[[</span><span class="o">:</span><span class="n">ϕ</span><span class="x">,</span> <span class="o">:</span><span class="n">τ</span><span class="x">,</span> <span class="o">:</span><span class="n">κ</span><span class="x">]];</span> <span class="n">α</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="x">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="x">)</span>
</code></pre></div></div>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/uk-prior-kappa-phi-tau-sample-plot.png" alt="nil" /></p>

<p>For the same reasons it can be very useful to inspect the <em>prior predictive</em> distribution.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Compute the "generated quantities" for the PRIOR</span>
<span class="n">generated_prior</span> <span class="o">=</span> <span class="n">vectup2tupvec</span><span class="x">(</span><span class="n">generated_quantities</span><span class="x">(</span><span class="n">m</span><span class="x">,</span> <span class="n">chain_prior</span><span class="x">));</span>
<span class="n">daily_cases_prior</span><span class="x">,</span> <span class="n">daily_deaths_prior</span><span class="x">,</span> <span class="n">Rt_prior</span><span class="x">,</span> <span class="n">Rt_adj_prior</span> <span class="o">=</span> <span class="n">generated_prior</span><span class="x">;</span>
</code></pre></div></div>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">country_prediction_plot</span><span class="x">(</span><span class="n">uk_index</span><span class="x">,</span> <span class="n">daily_cases_prior</span><span class="x">,</span> <span class="n">daily_deaths_prior</span><span class="x">,</span> <span class="n">Rt_prior</span><span class="x">;</span> <span class="n">main_title</span> <span class="o">=</span> <span class="s">"(prior)"</span><span class="x">)</span>
</code></pre></div></div>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/uk-predictive-prior-Rt.png" alt="nil" /></p>

<p>And with the Rt <em>adjusted for remaining population</em>:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">country_prediction_plot</span><span class="x">(</span><span class="n">uk_index</span><span class="x">,</span> <span class="n">daily_cases_prior</span><span class="x">,</span> <span class="n">daily_deaths_prior</span><span class="x">,</span> <span class="n">Rt_adj_prior</span><span class="x">;</span> <span class="n">main_title</span> <span class="o">=</span> <span class="s">"(prior)"</span><span class="x">)</span>
</code></pre></div></div>

<p>At this point it might be useful to remind ourselves of the total population of UK is:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span><span class="o">.</span><span class="n">population</span><span class="x">[</span><span class="n">uk_index</span><span class="x">]</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>67886004
</code></pre></div></div>

<p>As we can see from the figures, the prior allows scenarios such as</p>

<ul>
  <li><em>all</em> of the UK being infected</li>
  <li>effects of interventions, e.g. <code class="highlighter-rouge">lockdown</code>, having a <em>negative</em> effect on <code class="highlighter-rouge">Rt</code> (in the sense that it can actually <em>increase</em> the spread of the virus); you can see this from the fact that the 95% confidence interval widens after one of the interventions</li>
</ul>

<p>But at the same time, it’s clear that a very sudden increase from 0% to 100% of the population being infected is almost impossible under the prior. All in all, the model prior seems a reasonable choice: it allows for extreme situations without putting too much probabilty “mass” on those, while still encoding some structure in the model.</p>

<h1 id="posterior-inference">Posterior inference</h1>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parameters</span> <span class="o">=</span> <span class="x">(</span>
    <span class="n">warmup</span> <span class="o">=</span> <span class="mi">1000</span><span class="x">,</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="mi">3000</span>
<span class="x">);</span>
</code></pre></div></div>

<h2 id="inference">Inference</h2>

<h3 id="run">Run</h3>

<p>To perform inference for the model we would simply run the code below:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chains_posterior</span> <span class="o">=</span> <span class="n">sample</span><span class="x">(</span><span class="n">m_no_pred</span><span class="x">,</span> <span class="n">NUTS</span><span class="x">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">warmup</span><span class="x">,</span> <span class="mf">0.95</span><span class="x">,</span> <span class="mi">10</span><span class="x">),</span> <span class="n">parameters</span><span class="o">.</span><span class="n">steps</span> <span class="o">+</span> <span class="n">parameters</span><span class="o">.</span><span class="n">warmup</span><span class="x">)</span>
</code></pre></div></div>

<p><em>But</em> unfortunately it takes quite a while to run. Performing inference using <code class="highlighter-rouge">NUTS</code> with <code class="highlighter-rouge">1000</code> steps for adaptation/warmup and <code class="highlighter-rouge">3000</code> sample steps takes ~2hrs on a 6-core computer with <code class="highlighter-rouge">JULIA_NUM_THREADS = 6</code>. And so we’re instead going to load in the chains needed.</p>

<p>In contrast, <code class="highlighter-rouge">Stan</code> only takes roughly 1hr <em>on a single thread</em> using the base model from the repository. On a single thread <code class="highlighter-rouge">Turing.jl</code> is ~4-5X slower for this model, which is quite signficant.</p>

<p>This generally means that if you have a clear model in mind (or you’re already very familiar with <code class="highlighter-rouge">Stan</code>), you probably want to use <code class="highlighter-rouge">Stan</code> for these kind of models. On the other hand, if you’re in the process of heavily tweaking your model and need to be able to do <code class="highlighter-rouge">m = model(data...); m()</code> to check if it works, or you want more flexibility in what you can do with your model, e.g. discrete variables, <code class="highlighter-rouge">Turing.jl</code> might be a good option.</p>

<p>And this is an additional reason why we wanted to perform this replication study: we want <code class="highlighter-rouge">Turing.jl</code> to be <em>useful</em> and the way to check this is by applying <code class="highlighter-rouge">Turing.jl</code> to real-world problem rather than <em>just</em> benchmarks (though those are important too).</p>

<p>And regarding the performance difference, it really comes down to the difference in implementation of automatic differentation (AD). <code class="highlighter-rouge">Turing.jl</code> allows you to choose from the goto AD packages in Julia, e.g. in our runs we used <a href="https://github.com/JuliaDiff/ForwardDiff.jl">ForwardDiff.jl</a>, while <code class="highlighter-rouge">Stan</code> as a very, very fast AD implementation written exclusively for <code class="highlighter-rouge">Stan</code>. This difference becomes very clear in models such as this one where we have a lot of for-loops and recursive relationships (because this means that we can’t easily vectorize). For-loops in Julia are generally blazingly fast, but with AD there’s a bit of overhead. But that also means that in <code class="highlighter-rouge">Turing.jl</code> you have the ability to choose between different approaches to AD, i.e. forward-mode or reverse-mode, each with their different tradeoffs, and thus will benefit from potentially interesting future work, e.g. source-to-source AD using <a href="https://github.com/FluxML/Zygote.jl">Zygote.jl</a>.<sup id="fnref:fn3" role="doc-noteref"><a href="#fn:fn3" class="footnote">2</a></sup></p>

<p>And one interesting tidbit is that you can very easily use <code class="highlighter-rouge">pystan</code> within <code class="highlighter-rouge">PyCall.jl</code> to sample from a <code class="highlighter-rouge">Stan</code> model, and then convert the results into a <a href="https://github.com/TuringLang/MCMCChains.jl">MCMCChains.jl</a>. This has some nice implications:</p>

<ul>
  <li>we can use all the convenient posterior analysis tools available in MCMCChains.jl to analyze chains from <code class="highlighter-rouge">Stan</code></li>
  <li>we can use the <code class="highlighter-rouge">generated_quantities</code> method in this notebook to execute the <code class="highlighter-rouge">Turing.jl</code> <code class="highlighter-rouge">Model</code> on the samples obtain using <code class="highlighter-rouge">Stan</code></li>
</ul>

<p>This was quite useful for us to be able validate the results from <code class="highlighter-rouge">Turing.jl</code> against those from <code class="highlighter-rouge">Stan</code>, and made it very easy to check that indeed <code class="highlighter-rouge">Turing.jl</code> and <code class="highlighter-rouge">Stan</code> produce the same results. You can find examples of this in the <a href="https://github.com/TuringLang/Covid19">notebooks in our repository</a>.</p>

<details><summary><p>Sampling from <code class="highlighter-rouge">Stan</code> in Julia using <code class="highlighter-rouge">pystan</code></p>
</summary>
<p>First we import <code class="highlighter-rouge">PyCall</code>, allowing us to call Python code from within Julia.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="n">PyCall</span>

<span class="k">using</span> <span class="n">PyCall</span><span class="o">:</span> <span class="n">pyimport</span>
<span class="n">pystan</span> <span class="o">=</span> <span class="n">pyimport</span><span class="x">(</span><span class="s">"pystan"</span><span class="x">);</span>
</code></pre></div></div>

<p>Then we define the Stan model as a string</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model_str</span> <span class="o">=</span> <span class="n">raw</span><span class="s">"""
data {
  int &lt;lower=1&gt; M; // number of countries
  int &lt;lower=1&gt; P; // number of covariates
  int &lt;lower=1&gt; N0; // number of days for which to impute infections
  int&lt;lower=1&gt; N[M]; // days of observed data for country m. each entry must be &lt;= N2
  int&lt;lower=1&gt; N2; // days of observed data + # of days to forecast
  int cases[N2,M]; // reported cases
  int deaths[N2, M]; // reported deaths -- the rows with i &gt; N contain -1 and should be ignored
  matrix[N2, M] f; // h * s
  matrix[N2, P] X[M]; // features matrix
  int EpidemicStart[M];
  real pop[M];
  real SI[N2]; // fixed pre-calculated SI using emprical data from Neil
}

transformed data {
  vector[N2] SI_rev; // SI in reverse order
  vector[N2] f_rev[M]; // f in reversed order

  for(i in 1:N2)
    SI_rev[i] = SI[N2-i+1];

  for(m in 1:M){
    for(i in 1:N2) {
     f_rev[m, i] = f[N2-i+1,m];
    }
  }
}


parameters {
  real&lt;lower=0&gt; mu[M]; // intercept for Rt
  real&lt;lower=0&gt; alpha_hier[P]; // sudo parameter for the hier term for alpha
  real&lt;lower=0&gt; gamma;
  vector[M] lockdown;
  real&lt;lower=0&gt; kappa;
  real&lt;lower=0&gt; y[M];
  real&lt;lower=0&gt; phi;
  real&lt;lower=0&gt; tau;
  real &lt;lower=0&gt; ifr_noise[M];
}

transformed parameters {
    vector[P] alpha;
    matrix[N2, M] prediction = rep_matrix(0,N2,M);
    matrix[N2, M] E_deaths  = rep_matrix(0,N2,M);
    matrix[N2, M] Rt = rep_matrix(0,N2,M);
    matrix[N2, M] Rt_adj = Rt;

    {
      matrix[N2,M] cumm_sum = rep_matrix(0,N2,M);
      for(i in 1:P){
        alpha[i] = alpha_hier[i] - ( log(1.05) / 6.0 );
      }
      for (m in 1:M){
        prediction[1:N0,m] = rep_vector(y[m],N0); // learn the number of cases in the first N0 days
        cumm_sum[2:N0,m] = cumulative_sum(prediction[2:N0,m]);

        Rt[,m] = mu[m] * exp(-X[m] * alpha - X[m][,5] * lockdown[m]);
        Rt_adj[1:N0,m] = Rt[1:N0,m];
        for (i in (N0+1):N2) {
          real convolution = dot_product(sub_col(prediction, 1, m, i-1), tail(SI_rev, i-1));
          cumm_sum[i,m] = cumm_sum[i-1,m] + prediction[i-1,m];
          Rt_adj[i,m] = ((pop[m]-cumm_sum[i,m]) / pop[m]) * Rt[i,m];
          prediction[i, m] = Rt_adj[i,m] * convolution;
        }
        E_deaths[1, m]= 1e-15 * prediction[1,m];
        for (i in 2:N2){
          E_deaths[i,m] = ifr_noise[m] * dot_product(sub_col(prediction, 1, m, i-1), tail(f_rev[m], i-1));
        }
      }
    }
}
model {
  tau ~ exponential(0.03);
  for (m in 1:M){
      y[m] ~ exponential(1/tau);
  }
  gamma ~ normal(0,.2);
  lockdown ~ normal(0,gamma);
  phi ~ normal(0,5);
  kappa ~ normal(0,0.5);
  mu ~ normal(3.28, kappa); // citation: https://academic.oup.com/jtm/article/27/2/taaa021/5735319
  alpha_hier ~ gamma(.1667,1);
  ifr_noise ~ normal(1,0.1);
  for(m in 1:M){
    deaths[EpidemicStart[m]:N[m], m] ~ neg_binomial_2(E_deaths[EpidemicStart[m]:N[m], m], phi);
   }
}

generated quantities {
    matrix[N2, M] prediction0 = rep_matrix(0,N2,M);
    matrix[N2, M] E_deaths0  = rep_matrix(0,N2,M);

    {
      matrix[N2,M] cumm_sum0 = rep_matrix(0,N2,M);
      for (m in 1:M){
         for (i in 2:N0){
          cumm_sum0[i,m] = cumm_sum0[i-1,m] + y[m]; 
        }
        prediction0[1:N0,m] = rep_vector(y[m],N0); 
        for (i in (N0+1):N2) {
          real convolution0 = dot_product(sub_col(prediction0, 1, m, i-1), tail(SI_rev, i-1));
          cumm_sum0[i,m] = cumm_sum0[i-1,m] + prediction0[i-1,m];
          prediction0[i, m] = ((pop[m]-cumm_sum0[i,m]) / pop[m]) * mu[m] * convolution0;
        }
        E_deaths0[1, m]= 1e-15 * prediction0[1,m];
        for (i in 2:N2){
          E_deaths0[i,m] = ifr_noise[m] * dot_product(sub_col(prediction0, 1, m, i-1), tail(f_rev[m], i-1));
        }
      }
    }
}
"""</span>
</code></pre></div></div>

<p>We need the data to be in a format compatible with the Stan model, which we can accomplish by converting <code class="highlighter-rouge">rdata</code> into a <code class="highlighter-rouge">Dict</code>:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">d</span> <span class="o">=</span> <span class="kt">Dict</span><span class="x">([(</span><span class="n">k</span><span class="x">,</span> <span class="n">rdata</span><span class="x">[</span><span class="n">k</span><span class="x">])</span> <span class="k">for</span> <span class="n">k</span> <span class="k">in</span> <span class="n">keys</span><span class="x">(</span><span class="n">rdata</span><span class="x">)]);</span> <span class="c"># `values(df)` and `keys(df)` have different ordering so DON'T do `Dict(keys(df), values(df))`</span>
</code></pre></div></div>

<p>Then we can compile the <code class="highlighter-rouge">Stan</code> model</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sm</span> <span class="o">=</span> <span class="n">pystan</span><span class="o">.</span><span class="n">StanModel</span><span class="x">(</span><span class="n">model_code</span><span class="o">=</span><span class="n">model_str</span><span class="x">)</span>
</code></pre></div></div>

<p>And finally fit:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fit_stan</span><span class="x">(</span><span class="n">n_iters</span><span class="o">=</span><span class="mi">300</span><span class="x">,</span> <span class="n">warmup</span><span class="o">=</span><span class="mi">100</span><span class="x">)</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">sampling</span><span class="x">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">d</span><span class="x">,</span> <span class="n">iter</span><span class="o">=</span><span class="n">n_iters</span><span class="x">,</span> <span class="n">chains</span><span class="o">=</span><span class="mi">1</span><span class="x">,</span> <span class="n">warmup</span><span class="o">=</span><span class="n">warmup</span><span class="x">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s">"NUTS"</span><span class="x">,</span> 
    <span class="n">control</span><span class="o">=</span><span class="kt">Dict</span><span class="x">(</span>
        <span class="s">"adapt_delta"</span> <span class="o">=&gt;</span> <span class="mf">0.95</span><span class="x">,</span>
        <span class="s">"max_treedepth"</span> <span class="o">=&gt;</span> <span class="mi">10</span>
    <span class="x">)</span>
<span class="x">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">fit_stan</span><span class="x">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">steps</span> <span class="o">+</span> <span class="n">parameters</span><span class="o">.</span><span class="n">warmup</span><span class="x">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">warmup</span><span class="x">)</span>
</code></pre></div></div>

<p>From the fit we can extract the inferred parameters:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">la</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">extract</span><span class="x">(</span><span class="n">permuted</span><span class="o">=</span><span class="nb">true</span><span class="x">)</span>
</code></pre></div></div>

<p>Or, if you’ve done this before and saved the results using <code class="highlighter-rouge">Serialization.jl</code>, you can load the results:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="n">Serialization</span>

<span class="n">stan_chain_fname</span> <span class="o">=</span> <span class="n">first</span><span class="x">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="k">in</span> <span class="n">readdir</span><span class="x">(</span><span class="n">outdir</span><span class="x">())</span> <span class="k">if</span> <span class="n">occursin</span><span class="x">(</span><span class="s">"stan"</span><span class="x">,</span> <span class="n">s</span><span class="x">)])</span>
<span class="n">la</span> <span class="o">=</span> <span class="n">open</span><span class="x">(</span><span class="n">io</span> <span class="o">-&gt;</span> <span class="n">deserialize</span><span class="x">(</span><span class="n">io</span><span class="x">),</span> <span class="n">outdir</span><span class="x">(</span><span class="n">stan_chain_fname</span><span class="x">),</span> <span class="s">"r"</span><span class="x">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dict{Any,Any} with 17 entries:
  "E_deaths"    =&gt; [6.52866e-14 5.9334e-7 … 2.40106 2.31387; 4.77975e-14 3.5296…
  "ifr_noise"   =&gt; [0.890352 1.05228 … 1.19123 0.833645; 0.723459 1.03243 … 0.8…
  "alpha"       =&gt; [-0.00813169 -0.00812908 … 0.723476 -0.00112684; 0.237363 0.…
  "E_deaths0"   =&gt; [6.52866e-14 5.9334e-7 … 83.0411 71.0609; 4.77975e-14 3.5296…
  "tau"         =&gt; [53.4179, 96.0101, 38.1312, 68.78, 49.8292, 45.3714, 80.3358…
  "Rt_adj"      =&gt; [3.69848 3.69848 … 0.762185 0.762171; 4.19599 4.19599 … 0.77…
  "mu"          =&gt; [3.69848 3.8664 … 3.68493 4.11784; 4.19599 3.8219 … 4.09925 …
  "prediction0" =&gt; [65.2866 65.2866 … 1.56204 1.22123; 47.7975 47.7975 … 0.1296…
  "lp__"        =&gt; [560668.0, 560680.0, 560685.0, 560670.0, 560671.0, 560694.0,…
  "kappa"       =&gt; [1.05947, 0.913342, 1.05901, 1.17966, 1.12473, 1.21213, 0.99…
  "alpha_hier"  =&gt; [1.73288e-16 2.6161e-6 … 0.731608 0.00700485; 0.245495 0.023…
  "prediction"  =&gt; [65.2866 65.2866 … 106.091 102.225; 47.7975 47.7975 … 206.13…
  "phi"         =&gt; [6.8105, 7.36518, 6.41771, 7.13139, 6.70706, 7.06452, 7.0425…
  "gamma"       =&gt; [0.107149, 0.129599, 0.118666, 0.274338, 0.179847, 0.0386703…
  "lockdown"    =&gt; [-0.0199127 0.0841175 … -0.0854961 0.245588; 0.00700599 0.02…
  "Rt"          =&gt; [3.69848 3.69848 … 0.770378 0.770378; 4.19599 4.19599 … 0.78…
  "y"           =&gt; [65.2866 22.1974 … 75.7377 63.0177; 47.7975 27.7832 … 48.400…
</code></pre></div></div>

<p>And if we want to compare it with the results from <code class="highlighter-rouge">Turing.jl</code> it can be convenient to rename some of the variables</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rename!</span><span class="x">(</span>
    <span class="n">la</span><span class="x">,</span>
    <span class="s">"alpha"</span> <span class="o">=&gt;</span> <span class="s">"α"</span><span class="x">,</span>
    <span class="s">"alpha_hier"</span> <span class="o">=&gt;</span> <span class="s">"α_hier"</span><span class="x">,</span>
    <span class="s">"kappa"</span> <span class="o">=&gt;</span> <span class="s">"κ"</span><span class="x">,</span>
    <span class="s">"gamma"</span> <span class="o">=&gt;</span> <span class="s">"γ"</span><span class="x">,</span>
    <span class="s">"mu"</span> <span class="o">=&gt;</span> <span class="s">"μ"</span><span class="x">,</span>
    <span class="s">"phi"</span> <span class="o">=&gt;</span> <span class="s">"ϕ"</span><span class="x">,</span>
    <span class="s">"tau"</span> <span class="o">=&gt;</span> <span class="s">"τ"</span>
<span class="x">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dict{Any,Any} with 17 entries:
  "α_hier"      =&gt; [1.73288e-16 2.6161e-6 … 0.731608 0.00700485; 0.245495 0.023…
  "μ"           =&gt; [3.69848 3.8664 … 3.68493 4.11784; 4.19599 3.8219 … 4.09925 …
  "E_deaths"    =&gt; [6.52866e-14 5.9334e-7 … 2.40106 2.31387; 4.77975e-14 3.5296…
  "ifr_noise"   =&gt; [0.890352 1.05228 … 1.19123 0.833645; 0.723459 1.03243 … 0.8…
  "ϕ"           =&gt; [6.8105, 7.36518, 6.41771, 7.13139, 6.70706, 7.06452, 7.0425…
  "E_deaths0"   =&gt; [6.52866e-14 5.9334e-7 … 83.0411 71.0609; 4.77975e-14 3.5296…
  "α"           =&gt; [-0.00813169 -0.00812908 … 0.723476 -0.00112684; 0.237363 0.…
  "κ"           =&gt; [1.05947, 0.913342, 1.05901, 1.17966, 1.12473, 1.21213, 0.99…
  "Rt_adj"      =&gt; [3.69848 3.69848 … 0.762185 0.762171; 4.19599 4.19599 … 0.77…
  "γ"           =&gt; [0.107149, 0.129599, 0.118666, 0.274338, 0.179847, 0.0386703…
  "prediction0" =&gt; [65.2866 65.2866 … 1.56204 1.22123; 47.7975 47.7975 … 0.1296…
  "τ"           =&gt; [53.4179, 96.0101, 38.1312, 68.78, 49.8292, 45.3714, 80.3358…
  "lp__"        =&gt; [560668.0, 560680.0, 560685.0, 560670.0, 560671.0, 560694.0,…
  "prediction"  =&gt; [65.2866 65.2866 … 106.091 102.225; 47.7975 47.7975 … 206.13…
  "lockdown"    =&gt; [-0.0199127 0.0841175 … -0.0854961 0.245588; 0.00700599 0.02…
  "Rt"          =&gt; [3.69848 3.69848 … 0.770378 0.770378; 4.19599 4.19599 … 0.78…
  "y"           =&gt; [65.2866 22.1974 … 75.7377 63.0177; 47.7975 27.7832 … 48.400…
</code></pre></div></div>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Extract a subset of the variables, since we don't want everything in a `Chains` object</span>
<span class="n">la_subset</span> <span class="o">=</span> <span class="kt">Dict</span><span class="x">(</span>
    <span class="n">k</span> <span class="o">=&gt;</span> <span class="n">la</span><span class="x">[</span><span class="n">k</span><span class="x">]</span> <span class="k">for</span> <span class="n">k</span> <span class="k">in</span> 
    <span class="x">[</span><span class="s">"y"</span><span class="x">,</span> <span class="s">"κ"</span><span class="x">,</span> <span class="s">"α_hier"</span><span class="x">,</span> <span class="s">"ϕ"</span><span class="x">,</span> <span class="s">"τ"</span><span class="x">,</span> <span class="s">"ifr_noise"</span><span class="x">,</span> <span class="s">"μ"</span><span class="x">,</span> <span class="s">"γ"</span><span class="x">,</span> <span class="s">"lockdown"</span><span class="x">]</span>
<span class="x">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dict{String,Array{Float64,N} where N} with 9 entries:
  "α_hier"    =&gt; [1.73288e-16 2.6161e-6 … 0.731608 0.00700485; 0.245495 0.02364…
  "μ"         =&gt; [3.69848 3.8664 … 3.68493 4.11784; 4.19599 3.8219 … 4.09925 3.…
  "γ"         =&gt; [0.107149, 0.129599, 0.118666, 0.274338, 0.179847, 0.0386703, …
  "τ"         =&gt; [53.4179, 96.0101, 38.1312, 68.78, 49.8292, 45.3714, 80.3358, …
  "ϕ"         =&gt; [6.8105, 7.36518, 6.41771, 7.13139, 6.70706, 7.06452, 7.04253,…
  "ifr_noise" =&gt; [0.890352 1.05228 … 1.19123 0.833645; 0.723459 1.03243 … 0.892…
  "κ"         =&gt; [1.05947, 0.913342, 1.05901, 1.17966, 1.12473, 1.21213, 0.9978…
  "lockdown"  =&gt; [-0.0199127 0.0841175 … -0.0854961 0.245588; 0.00700599 0.0258…
  "y"         =&gt; [65.2866 22.1974 … 75.7377 63.0177; 47.7975 27.7832 … 48.4006 …
</code></pre></div></div>

<p>In <code class="highlighter-rouge">Covid19.jl</code> we’ve added a constructor for <code class="highlighter-rouge">MCMCChains.Chains</code> which takes a <code class="highlighter-rouge">Dict</code> as an argument, easily allowing us to convert the <code class="highlighter-rouge">la</code> from <code class="highlighter-rouge">Stan</code> into a <code class="highlighter-rouge">Chains</code> object.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span><span class="nf"> MCMCChains</span><span class="o">.</span><span class="n">_cat</span><span class="x">(</span><span class="o">::</span><span class="kt">Val</span><span class="x">{</span><span class="mi">3</span><span class="x">},</span> <span class="n">c1</span><span class="o">::</span><span class="n">Chains</span><span class="x">,</span> <span class="n">args</span><span class="o">::</span><span class="n">Chains</span><span class="o">...</span><span class="x">)</span>
    <span class="c"># check inputs</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">range</span><span class="x">(</span><span class="n">c1</span><span class="x">)</span>
    <span class="c"># (OR not, he he he)</span>
    <span class="c"># all(c -&gt; range(c) == rng, args) || throw(ArgumentError("chain ranges differ"))</span>
    <span class="n">nms</span> <span class="o">=</span> <span class="n">names</span><span class="x">(</span><span class="n">c1</span><span class="x">)</span>
    <span class="n">all</span><span class="x">(</span><span class="n">c</span> <span class="o">-&gt;</span> <span class="n">names</span><span class="x">(</span><span class="n">c</span><span class="x">)</span> <span class="o">==</span> <span class="n">nms</span><span class="x">,</span> <span class="n">args</span><span class="x">)</span> <span class="o">||</span> <span class="n">throw</span><span class="x">(</span><span class="kt">ArgumentError</span><span class="x">(</span><span class="s">"chain names differ"</span><span class="x">))</span>

    <span class="c"># concatenate all chains</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">mapreduce</span><span class="x">(</span><span class="n">c</span> <span class="o">-&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">data</span><span class="x">,</span> <span class="x">(</span><span class="n">x</span><span class="x">,</span> <span class="n">y</span><span class="x">)</span> <span class="o">-&gt;</span> <span class="n">cat</span><span class="x">(</span><span class="n">x</span><span class="x">,</span> <span class="n">y</span><span class="x">;</span> <span class="n">dims</span> <span class="o">=</span> <span class="mi">3</span><span class="x">),</span> <span class="n">args</span><span class="x">;</span>
                     <span class="n">init</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">data</span><span class="x">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">MCMCChains</span><span class="o">.</span><span class="n">AxisArray</span><span class="x">(</span><span class="n">data</span><span class="x">;</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">rng</span><span class="x">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">nms</span><span class="x">,</span> <span class="n">chain</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">size</span><span class="x">(</span><span class="n">data</span><span class="x">,</span> <span class="mi">3</span><span class="x">))</span>

    <span class="k">return</span> <span class="n">Chains</span><span class="x">(</span><span class="n">value</span><span class="x">,</span> <span class="nb">missing</span><span class="x">,</span> <span class="n">c1</span><span class="o">.</span><span class="n">name_map</span><span class="x">,</span> <span class="n">c1</span><span class="o">.</span><span class="n">info</span><span class="x">)</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stan_chain</span> <span class="o">=</span> <span class="n">Chains</span><span class="x">(</span><span class="n">la_subset</span><span class="x">);</span> <span class="c"># &lt;= results in all chains being concatenated together so we need to manually "separate" them</span>

<span class="n">steps_per_chain</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">steps</span>
<span class="n">num_chains</span> <span class="o">=</span> <span class="kt">Int</span><span class="x">(</span><span class="n">length</span><span class="x">(</span><span class="n">stan_chain</span><span class="x">)</span> <span class="o">//</span> <span class="n">steps_per_chain</span><span class="x">)</span>

<span class="n">stan_chains</span> <span class="o">=</span> <span class="x">[</span><span class="n">stan_chain</span><span class="x">[</span><span class="mi">1</span> <span class="o">+</span> <span class="x">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="x">)</span> <span class="o">*</span> <span class="n">steps_per_chain</span><span class="o">:</span><span class="n">i</span> <span class="o">*</span> <span class="n">steps_per_chain</span><span class="x">]</span> <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">:</span><span class="n">num_chains</span><span class="x">];</span>
<span class="n">stan_chains</span> <span class="o">=</span> <span class="n">chainscat</span><span class="x">(</span><span class="n">stan_chains</span><span class="o">...</span><span class="x">);</span>
<span class="n">stan_chains</span> <span class="o">=</span> <span class="n">stan_chains</span><span class="x">[</span><span class="mi">1</span><span class="o">:</span><span class="mi">3</span><span class="o">:</span><span class="k">end</span><span class="x">]</span> <span class="c"># thin</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Object of type Chains, with data of type 1000×66×4 Array{Float64,3}

Iterations        = 1:2998
Thinning interval = 3
Chains            = 1, 2, 3, 4
Samples per chain = 1000
parameters        = α_hier[1], α_hier[2], α_hier[3], α_hier[4], α_hier[5], α_hier[6], μ[1], μ[2], μ[3], μ[4], μ[5], μ[6], μ[7], μ[8], μ[9], μ[10], μ[11], μ[12], μ[13], μ[14], γ, τ, ϕ, ifr_noise[1], ifr_noise[2], ifr_noise[3], ifr_noise[4], ifr_noise[5], ifr_noise[6], ifr_noise[7], ifr_noise[8], ifr_noise[9], ifr_noise[10], ifr_noise[11], ifr_noise[12], ifr_noise[13], ifr_noise[14], κ, lockdown[1], lockdown[2], lockdown[3], lockdown[4], lockdown[5], lockdown[6], lockdown[7], lockdown[8], lockdown[9], lockdown[10], lockdown[11], lockdown[12], lockdown[13], lockdown[14], y[1], y[2], y[3], y[4], y[5], y[6], y[7], y[8], y[9], y[10], y[11], y[12], y[13], y[14]

2-element Array{ChainDataFrame,1}

Summary Statistics
     parameters      mean      std  naive_se    mcse        ess   r_hat
  ─────────────  ────────  ───────  ────────  ──────  ─────────  ──────
      α_hier[1]    0.0250   0.0509    0.0008  0.0009  3762.6907  0.9994
      α_hier[2]    0.0294   0.0562    0.0009  0.0010  4096.3296  1.0021
      α_hier[3]    0.4865   0.1666    0.0026  0.0031  3769.7698  1.0021
      α_hier[4]    0.0150   0.0322    0.0005  0.0005  3963.6029  1.0003
      α_hier[5]    1.1267   0.1498    0.0024  0.0022  3990.6714  0.9996
      α_hier[6]    0.0647   0.1037    0.0016  0.0024  4037.5795  1.0053
           μ[1]    3.9594   0.4722    0.0075  0.0075  4064.2020  0.9996
           μ[2]    3.5951   0.1701    0.0027  0.0029  3684.0289  1.0005
           μ[3]    4.2405   0.4080    0.0065  0.0092  4232.5667  1.0054
           μ[4]    4.5359   0.3732    0.0059  0.0078  4075.5280  1.0031
           μ[5]    3.9081   0.2873    0.0045  0.0076  4106.5761  1.0080
           μ[6]    4.9298   0.3241    0.0051  0.0050  3850.5272  1.0009
           μ[7]    3.8319   0.5364    0.0085  0.0075  3956.2449  0.9997
           μ[8]    6.3026   0.7068    0.0112  0.0106  3641.7136  1.0005
           μ[9]    4.3273   0.5181    0.0082  0.0077  4059.0140  1.0002
          μ[10]    2.4113   0.2297    0.0036  0.0049  4080.2115  1.0035
          μ[11]    3.8111   0.3755    0.0059  0.0058  3906.9576  0.9996
          μ[12]    2.0742   0.2940    0.0046  0.0048  4350.2472  0.9997
          μ[13]    3.9327   0.4426    0.0070  0.0068  4062.9915  0.9999
          μ[14]    3.6872   0.3501    0.0055  0.0052  3971.6142  1.0001
              γ    0.1132   0.0683    0.0011  0.0014  3980.7969  1.0015
              τ   54.4981  17.5050    0.2768  0.2810  3759.2791  1.0007
              ϕ    6.8784   0.5566    0.0088  0.0078  4017.5627  1.0000
   ifr_noise[1]    0.9994   0.1006    0.0016  0.0014  4337.3600  1.0002
   ifr_noise[2]    0.9957   0.0996    0.0016  0.0018  3229.4271  1.0008
   ifr_noise[3]    0.9927   0.1001    0.0016  0.0013  4205.8756  0.9997
   ifr_noise[4]    1.0019   0.0981    0.0016  0.0016  3779.6148  0.9994
   ifr_noise[5]    0.9973   0.1002    0.0016  0.0015  4230.6973  1.0002
   ifr_noise[6]    0.9901   0.0997    0.0016  0.0014  4019.0526  0.9992
   ifr_noise[7]    0.9977   0.0985    0.0016  0.0019  4102.5786  0.9997
   ifr_noise[8]    0.9926   0.0989    0.0016  0.0014  4172.9264  0.9998
   ifr_noise[9]    1.0024   0.0998    0.0016  0.0015  4036.0007  1.0003
  ifr_noise[10]    1.0143   0.1004    0.0016  0.0020  3965.4960  1.0003
  ifr_noise[11]    0.9940   0.0984    0.0016  0.0014  4248.2237  0.9999
  ifr_noise[12]    1.0104   0.0978    0.0015  0.0016  4037.6589  1.0012
  ifr_noise[13]    0.9997   0.0999    0.0016  0.0016  3775.1249  1.0007
  ifr_noise[14]    1.0048   0.0990    0.0016  0.0016  4019.4484  0.9996
              κ    1.1204   0.2167    0.0034  0.0029  4136.1687  0.9996
    lockdown[1]    0.0034   0.1096    0.0017  0.0012  4217.7275  0.9991
    lockdown[2]   -0.0194   0.0852    0.0013  0.0014  4045.8681  1.0009
    lockdown[3]   -0.0171   0.1053    0.0017  0.0019  4125.5208  1.0011
    lockdown[4]    0.1309   0.1242    0.0020  0.0023  4149.1488  1.0018
    lockdown[5]    0.0144   0.1114    0.0018  0.0020  4275.9326  1.0002
    lockdown[6]   -0.0287   0.0933    0.0015  0.0012  4116.3446  1.0001
    lockdown[7]   -0.0197   0.1247    0.0020  0.0021  4076.6525  1.0002
    lockdown[8]   -0.0800   0.1130    0.0018  0.0019  3866.1604  1.0006
    lockdown[9]   -0.0104   0.1047    0.0017  0.0016  4021.3347  0.9997
   lockdown[10]    0.0026   0.1326    0.0021  0.0023  4007.4693  0.9997
   lockdown[11]    0.0121   0.1079    0.0017  0.0019  3829.4277  0.9996
   lockdown[12]    0.0030   0.1271    0.0020  0.0018  4228.0928  1.0003
   lockdown[13]   -0.0019   0.1141    0.0018  0.0016  4215.2192  0.9997
   lockdown[14]    0.0548   0.1179    0.0019  0.0020  3988.7643  1.0006
           y[1]   47.1930  23.4949    0.3715  0.3560  4301.2466  0.9999
           y[2]   39.9589  13.3690    0.2114  0.2264  3840.8341  1.0004
           y[3]   20.2291   9.8615    0.1559  0.1618  3984.8827  1.0001
           y[4]   74.6538  33.9382    0.5366  0.6232  4021.1495  1.0018
           y[5]   44.3600  17.6755    0.2795  0.3848  3408.4552  1.0043
           y[6]    9.5225   4.5031    0.0712  0.0750  3902.1911  1.0008
           y[7]   30.0746  17.9098    0.2832  0.2778  3956.5131  1.0009
           y[8]   17.3519  11.2451    0.1778  0.1606  3384.7290  0.9995
           y[9]   75.4817  36.1157    0.5710  0.5745  4155.4331  1.0010
          y[10]  144.5704  54.9286    0.8685  0.9158  4175.9150  1.0001
          y[11]   26.1128  13.4270    0.2123  0.2135  3739.8586  0.9996
          y[12]   84.6856  44.8467    0.7091  0.6679  4167.7817  0.9995
          y[13]   55.2918  25.9756    0.4107  0.4109  4327.8064  0.9999
          y[14]   83.2622  36.3821    0.5753  0.5105  3890.7244  1.0000

Quantiles
     parameters     2.5%     25.0%     50.0%     75.0%     97.5%
  ─────────────  ───────  ────────  ────────  ────────  ────────
      α_hier[1]   0.0000    0.0000    0.0018    0.0244    0.1820
      α_hier[2]   0.0000    0.0000    0.0024    0.0313    0.2057
      α_hier[3]   0.0946    0.3853    0.4948    0.5975    0.7926
      α_hier[4]   0.0000    0.0000    0.0010    0.0126    0.1224
      α_hier[5]   0.8434    1.0235    1.1289    1.2272    1.4198
      α_hier[6]   0.0000    0.0001    0.0103    0.0903    0.3542
           μ[1]   3.1090    3.6397    3.9181    4.2532    4.9781
           μ[2]   3.2701    3.4824    3.5906    3.7117    3.9333
           μ[3]   3.5392    3.9578    4.1962    4.4800    5.1477
           μ[4]   3.9023    4.2706    4.4931    4.7583    5.3515
           μ[5]   3.4586    3.7031    3.8641    4.0777    4.5887
           μ[6]   4.3074    4.7095    4.9339    5.1434    5.5663
           μ[7]   2.8756    3.4622    3.8022    4.1684    4.9753
           μ[8]   4.9469    5.8267    6.2903    6.7636    7.7464
           μ[9]   3.3888    3.9792    4.2975    4.6499    5.4316
          μ[10]   2.0541    2.2494    2.3785    2.5382    2.9642
          μ[11]   3.1351    3.5524    3.7874    4.0452    4.5922
          μ[12]   1.5522    1.8702    2.0543    2.2570    2.7023
          μ[13]   3.1392    3.6240    3.9055    4.2166    4.8550
          μ[14]   3.0547    3.4411    3.6641    3.9070    4.4457
              γ   0.0106    0.0621    0.1066    0.1540    0.2669
              τ  28.3554   41.8978   51.6206   64.4602   95.8893
              ϕ   5.8450    6.4945    6.8693    7.2375    8.0241
   ifr_noise[1]   0.8053    0.9319    0.9994    1.0669    1.1991
   ifr_noise[2]   0.8027    0.9289    0.9982    1.0624    1.1919
   ifr_noise[3]   0.8002    0.9254    0.9940    1.0584    1.1875
   ifr_noise[4]   0.8146    0.9355    1.0002    1.0669    1.1992
   ifr_noise[5]   0.8044    0.9283    0.9971    1.0648    1.1926
   ifr_noise[6]   0.7977    0.9221    0.9916    1.0580    1.1871
   ifr_noise[7]   0.7976    0.9337    0.9976    1.0632    1.1926
   ifr_noise[8]   0.7980    0.9262    0.9929    1.0585    1.1868
   ifr_noise[9]   0.8115    0.9365    1.0023    1.0712    1.1955
  ifr_noise[10]   0.8129    0.9487    1.0128    1.0832    1.2092
  ifr_noise[11]   0.7985    0.9277    0.9939    1.0599    1.1874
  ifr_noise[12]   0.8173    0.9461    1.0107    1.0743    1.2046
  ifr_noise[13]   0.8069    0.9315    1.0002    1.0663    1.2020
  ifr_noise[14]   0.8168    0.9357    1.0049    1.0718    1.1968
              κ   0.7446    0.9697    1.1048    1.2558    1.5970
    lockdown[1]  -0.2211   -0.0529    0.0012    0.0552    0.2476
    lockdown[2]  -0.2064   -0.0681   -0.0127    0.0270    0.1537
    lockdown[3]  -0.2501   -0.0689   -0.0097    0.0368    0.1982
    lockdown[4]  -0.0409    0.0309    0.1091    0.2083    0.4163
    lockdown[5]  -0.2099   -0.0406    0.0063    0.0678    0.2665
    lockdown[6]  -0.2389   -0.0807   -0.0173    0.0255    0.1494
    lockdown[7]  -0.2983   -0.0748   -0.0083    0.0442    0.2140
    lockdown[8]  -0.3452   -0.1409   -0.0560   -0.0025    0.0978
    lockdown[9]  -0.2333   -0.0598   -0.0036    0.0415    0.2027
   lockdown[10]  -0.2747   -0.0594    0.0012    0.0615    0.2855
   lockdown[11]  -0.2111   -0.0428    0.0049    0.0654    0.2543
   lockdown[12]  -0.2539   -0.0534    0.0010    0.0600    0.2765
   lockdown[13]  -0.2374   -0.0579   -0.0012    0.0530    0.2304
   lockdown[14]  -0.1415   -0.0145    0.0319    0.1134    0.3319
           y[1]  15.0725   30.7683   42.5110   58.6852  108.5279
           y[2]  20.0808   30.2341   38.0373   47.2979   71.8859
           y[3]   7.0457   13.3609   18.2912   24.7683   45.4752
           y[4]  25.4333   50.1704   68.8542   92.8525  155.6052
           y[5]  17.5663   31.6674   41.9898   54.2124   85.7669
           y[6]   3.5671    6.3678    8.5704   11.6961   20.4845
           y[7]   7.6940   17.3636   25.8101   37.9979   74.9977
           y[8]   4.6864    9.8616   14.5959   21.2624   47.3559
           y[9]  27.8821   50.0205   68.1117   93.5616  165.9393
          y[10]  59.6325  104.7132  136.6978  177.1941  270.4725
          y[11]   8.3990   16.7150   23.4562   32.1587   59.1546
          y[12]  25.3671   53.5384   74.8896  106.1230  199.7460
          y[13]  19.4379   36.8008   50.4436   68.4129  119.8110
          y[14]  30.3896   57.3074   76.9474  101.9789  170.3966
</code></pre></div></div>

</details>

<h3 id="load">Load</h3>

<p>Unfortunately the resulting chains, each with 3000 steps, take up a fair bit of space and are thus too large to include in the Github repository. As a temporary hack around this, you can find download the chains from <a href="https://drive.google.com/open?id=16PomGVnjPI1Q4KLdA9gRloVolfRmrhPP">this link</a>. Then you simply navigate to the project-directory and unpack.</p>

<p>With that, we can load the chains from disk:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">filenames</span> <span class="o">=</span> <span class="x">[</span>
    <span class="n">relpath</span><span class="x">(</span><span class="n">outdir</span><span class="x">(</span><span class="n">s</span><span class="x">))</span> <span class="k">for</span> <span class="n">s</span> <span class="k">in</span> <span class="n">readdir</span><span class="x">(</span><span class="n">outdir</span><span class="x">())</span>
    <span class="k">if</span> <span class="n">occursin</span><span class="x">(</span><span class="n">savename</span><span class="x">(</span><span class="n">parameters</span><span class="x">),</span> <span class="n">s</span><span class="x">)</span> <span class="o">&amp;&amp;</span> <span class="n">occursin</span><span class="x">(</span><span class="s">"seed"</span><span class="x">,</span> <span class="n">s</span><span class="x">)</span>
<span class="x">]</span>
<span class="n">length</span><span class="x">(</span><span class="n">filenames</span><span class="x">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>4
</code></pre></div></div>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chains_posterior_vec</span> <span class="o">=</span> <span class="x">[</span><span class="n">read</span><span class="x">(</span><span class="n">fname</span><span class="x">,</span> <span class="n">Chains</span><span class="x">)</span> <span class="k">for</span> <span class="n">fname</span> <span class="k">in</span> <span class="n">filenames</span><span class="x">];</span> <span class="c"># Read the different chains</span>
<span class="n">chains_posterior</span> <span class="o">=</span> <span class="n">chainscat</span><span class="x">(</span><span class="n">chains_posterior_vec</span><span class="o">...</span><span class="x">);</span> <span class="c"># Concatenate them</span>
<span class="n">chains_posterior</span> <span class="o">=</span> <span class="n">chains_posterior</span><span class="x">[</span><span class="mi">1</span><span class="o">:</span><span class="mi">3</span><span class="o">:</span><span class="k">end</span><span class="x">]</span> <span class="c"># &lt;= Thin so we're left with 1000 samples</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Object of type Chains, with data of type 1000×78×4 Array{Float64,3}

Iterations        = 1:2998
Thinning interval = 3
Chains            = 1, 2, 3, 4
Samples per chain = 1000
internals         = acceptance_rate, hamiltonian_energy, hamiltonian_energy_error, is_accept, log_density, lp, max_hamiltonian_energy_error, n_steps, nom_step_size, numerical_error, step_size, tree_depth
parameters        = ifr_noise[1], ifr_noise[2], ifr_noise[3], ifr_noise[4], ifr_noise[5], ifr_noise[6], ifr_noise[7], ifr_noise[8], ifr_noise[9], ifr_noise[10], ifr_noise[11], ifr_noise[12], ifr_noise[13], ifr_noise[14], lockdown[1], lockdown[2], lockdown[3], lockdown[4], lockdown[5], lockdown[6], lockdown[7], lockdown[8], lockdown[9], lockdown[10], lockdown[11], lockdown[12], lockdown[13], lockdown[14], y[1], y[2], y[3], y[4], y[5], y[6], y[7], y[8], y[9], y[10], y[11], y[12], y[13], y[14], α_hier[1], α_hier[2], α_hier[3], α_hier[4], α_hier[5], α_hier[6], γ, κ, μ[1], μ[2], μ[3], μ[4], μ[5], μ[6], μ[7], μ[8], μ[9], μ[10], μ[11], μ[12], μ[13], μ[14], τ, ϕ

2-element Array{ChainDataFrame,1}

Summary Statistics
     parameters      mean      std  naive_se    mcse        ess   r_hat
  ─────────────  ────────  ───────  ────────  ──────  ─────────  ──────
   ifr_noise[1]    0.9993   0.1018    0.0016  0.0016  4000.7654  1.0007
   ifr_noise[2]    1.0000   0.0985    0.0016  0.0016  4130.0153  0.9994
   ifr_noise[3]    0.9943   0.0986    0.0016  0.0017  4009.9552  0.9995
   ifr_noise[4]    1.0014   0.0996    0.0016  0.0019  4073.9127  1.0006
   ifr_noise[5]    0.9975   0.1017    0.0016  0.0017  3997.8443  1.0000
   ifr_noise[6]    0.9919   0.0971    0.0015  0.0013  4183.1643  0.9994
   ifr_noise[7]    0.9935   0.1000    0.0016  0.0016  3754.0585  1.0013
   ifr_noise[8]    0.9906   0.1019    0.0016  0.0019  3764.0323  1.0002
   ifr_noise[9]    1.0022   0.0983    0.0016  0.0017  3271.0573  1.0000
  ifr_noise[10]    1.0143   0.0979    0.0015  0.0015  3713.8604  0.9999
  ifr_noise[11]    0.9958   0.0990    0.0016  0.0015  4070.7331  1.0007
  ifr_noise[12]    1.0031   0.1001    0.0016  0.0015  4062.0625  0.9994
  ifr_noise[13]    1.0020   0.0983    0.0016  0.0017  3878.4554  1.0003
  ifr_noise[14]    1.0051   0.0977    0.0015  0.0016  3411.2449  1.0003
    lockdown[1]   -0.0015   0.1038    0.0016  0.0017  3351.5301  0.9992
    lockdown[2]   -0.0189   0.0837    0.0013  0.0016  2301.1025  1.0007
    lockdown[3]   -0.0172   0.0994    0.0016  0.0018  3307.7319  1.0002
    lockdown[4]    0.1181   0.1197    0.0019  0.0047   755.5366  1.0098
    lockdown[5]    0.0104   0.1056    0.0017  0.0021  2241.6092  1.0013
    lockdown[6]   -0.0276   0.0903    0.0014  0.0017  1854.2957  1.0007
    lockdown[7]   -0.0183   0.1154    0.0018  0.0022  3101.1043  1.0002
    lockdown[8]   -0.0733   0.1121    0.0018  0.0029  1655.2705  1.0012
    lockdown[9]   -0.0018   0.0992    0.0016  0.0015  3282.0295  0.9999
   lockdown[10]   -0.0010   0.1272    0.0020  0.0021  3686.0479  0.9998
   lockdown[11]    0.0078   0.1006    0.0016  0.0015  3682.6438  0.9996
   lockdown[12]    0.0038   0.1192    0.0019  0.0022  3075.1532  0.9999
   lockdown[13]   -0.0012   0.1068    0.0017  0.0022  3103.5187  1.0022
   lockdown[14]    0.0455   0.1113    0.0018  0.0024  2079.7790  1.0017
           y[1]   46.4670  23.1671    0.3663  0.3993  3051.0661  0.9997
           y[2]   38.6229  13.0809    0.2068  0.2614  2396.3508  0.9998
           y[3]   19.1768   9.4607    0.1496  0.2225  1618.4441  1.0019
           y[4]   73.7456  33.8283    0.5349  1.0255  1217.8814  1.0047
           y[5]   42.5408  17.5320    0.2772  0.3567  1816.6638  1.0023
           y[6]    9.1561   4.2267    0.0668  0.1047  1837.3744  1.0000
           y[7]   29.0679  17.4434    0.2758  0.2492  3195.2010  0.9993
           y[8]   16.4302  10.7746    0.1704  0.2680  1734.9104  1.0005
           y[9]   71.7330  33.2071    0.5251  0.6524  2360.5565  1.0006
          y[10]  140.8989  52.9734    0.8376  1.2555  1807.0170  1.0019
          y[11]   26.0038  13.2449    0.2094  0.2405  2349.8714  0.9997
          y[12]   82.8426  43.6475    0.6901  0.8820  2657.5728  1.0006
          y[13]   53.4443  25.2102    0.3986  0.4923  2491.2797  0.9997
          y[14]   81.7510  35.6084    0.5630  0.9667  1599.3832  1.0005
      α_hier[1]    0.0250   0.0519    0.0008  0.0009  3402.8745  1.0003
      α_hier[2]    0.0307   0.0571    0.0009  0.0011  2997.5497  1.0022
      α_hier[3]    0.4780   0.1807    0.0029  0.0084   292.5909  1.0134
      α_hier[4]    0.0167   0.0355    0.0006  0.0006  2836.6323  1.0003
      α_hier[5]    1.1276   0.1476    0.0023  0.0045  1166.6317  1.0024
      α_hier[6]    0.0776   0.1171    0.0019  0.0045   447.5792  1.0111
              γ    0.1047   0.0666    0.0011  0.0031   514.1243  1.0154
              κ    1.1469   0.2330    0.0037  0.0048  1953.9740  1.0004
           μ[1]    3.9794   0.4695    0.0074  0.0092  2078.0005  0.9996
           μ[2]    3.6130   0.1697    0.0027  0.0039  1763.3903  1.0002
           μ[3]    4.3002   0.4351    0.0069  0.0158   589.1497  1.0091
           μ[4]    4.5535   0.3895    0.0062  0.0130   824.9565  1.0066
           μ[5]    3.9472   0.3079    0.0049  0.0094   829.6550  1.0073
           μ[6]    4.9544   0.3259    0.0052  0.0089  1325.4430  1.0008
           μ[7]    3.8631   0.5352    0.0085  0.0114  1943.5804  1.0003
           μ[8]    6.3826   0.7272    0.0115  0.0213  1225.8573  1.0003
           μ[9]    4.3782   0.5184    0.0082  0.0118  1846.1891  0.9997
          μ[10]    2.4349   0.2378    0.0038  0.0070   931.9334  1.0053
          μ[11]    3.8172   0.3753    0.0059  0.0099  1458.7896  1.0011
          μ[12]    2.0997   0.3078    0.0049  0.0078  1545.5404  1.0019
          μ[13]    3.9692   0.4579    0.0072  0.0119  1471.6664  1.0000
          μ[14]    3.7025   0.3535    0.0056  0.0112  1150.7984  1.0006
              τ   53.0052  17.4602    0.2761  0.3973  1613.3580  1.0005
              ϕ    6.8730   0.5511    0.0087  0.0089  3726.1288  1.0002

Quantiles
     parameters     2.5%     25.0%     50.0%     75.0%     97.5%
  ─────────────  ───────  ────────  ────────  ────────  ────────
   ifr_noise[1]   0.8033    0.9298    0.9989    1.0688    1.1966
   ifr_noise[2]   0.8116    0.9329    1.0000    1.0656    1.1942
   ifr_noise[3]   0.8007    0.9265    0.9955    1.0611    1.1846
   ifr_noise[4]   0.8028    0.9335    1.0026    1.0698    1.1942
   ifr_noise[5]   0.7999    0.9292    0.9974    1.0659    1.1977
   ifr_noise[6]   0.8074    0.9268    0.9895    1.0580    1.1852
   ifr_noise[7]   0.7950    0.9274    0.9921    1.0589    1.1930
   ifr_noise[8]   0.7890    0.9226    0.9914    1.0563    1.1945
   ifr_noise[9]   0.8106    0.9353    1.0015    1.0666    1.1948
  ifr_noise[10]   0.8290    0.9479    1.0148    1.0791    1.2145
  ifr_noise[11]   0.7956    0.9296    0.9975    1.0649    1.1865
  ifr_noise[12]   0.8111    0.9339    1.0009    1.0706    1.2025
  ifr_noise[13]   0.8095    0.9360    1.0020    1.0699    1.1932
  ifr_noise[14]   0.8156    0.9396    1.0055    1.0715    1.1985
    lockdown[1]  -0.2208   -0.0530   -0.0022    0.0481    0.2256
    lockdown[2]  -0.2049   -0.0622   -0.0104    0.0249    0.1430
    lockdown[3]  -0.2412   -0.0645   -0.0087    0.0320    0.1893
    lockdown[4]  -0.0408    0.0218    0.0927    0.1907    0.4060
    lockdown[5]  -0.2022   -0.0411    0.0042    0.0572    0.2512
    lockdown[6]  -0.2405   -0.0711   -0.0158    0.0203    0.1414
    lockdown[7]  -0.2870   -0.0666   -0.0074    0.0361    0.2043
    lockdown[8]  -0.3473   -0.1313   -0.0471   -0.0005    0.1028
    lockdown[9]  -0.2196   -0.0470   -0.0004    0.0467    0.2105
   lockdown[10]  -0.2818   -0.0537   -0.0004    0.0509    0.2774
   lockdown[11]  -0.2034   -0.0401    0.0027    0.0551    0.2276
   lockdown[12]  -0.2539   -0.0480    0.0010    0.0562    0.2582
   lockdown[13]  -0.2182   -0.0528   -0.0010    0.0491    0.2289
   lockdown[14]  -0.1552   -0.0158    0.0228    0.0969    0.3229
           y[1]  14.9179   30.0247   41.9126   58.3610  101.7665
           y[2]  19.5299   29.0981   36.6782   45.5189   70.1557
           y[3]   6.2077   12.4272   17.2003   24.0866   42.8143
           y[4]  23.8405   49.3363   68.8392   92.3015  153.7364
           y[5]  15.3591   30.0828   40.2003   52.3791   83.7325
           y[6]   3.4499    6.2449    8.2618   11.1259   19.4929
           y[7]   7.9239   16.9180   24.7996   36.2075   75.5797
           y[8]   4.3036    9.2674   13.7824   20.2839   46.1405
           y[9]  25.7094   47.7998   65.8459   88.0414  153.9687
          y[10]  58.3771  103.2094  134.1771  171.8739  264.0741
          y[11]   8.7082   16.5333   23.4436   32.4592   58.9983
          y[12]  23.2083   51.9796   74.6536  104.0517  191.2370
          y[13]  18.2376   35.3789   49.1850   65.7620  116.0045
          y[14]  30.5740   55.7063   75.7009  101.0443  167.4224
      α_hier[1]   0.0000    0.0000    0.0019    0.0242    0.1824
      α_hier[2]   0.0000    0.0000    0.0036    0.0332    0.2080
      α_hier[3]   0.0026    0.3730    0.4905    0.5978    0.7993
      α_hier[4]   0.0000    0.0000    0.0012    0.0144    0.1276
      α_hier[5]   0.8306    1.0298    1.1296    1.2270    1.4153
      α_hier[6]   0.0000    0.0003    0.0150    0.1156    0.4115
              γ   0.0081    0.0523    0.0975    0.1456    0.2550
              κ   0.7561    0.9801    1.1271    1.2899    1.6530
           μ[1]   3.1409    3.6544    3.9459    4.2684    4.9864
           μ[2]   3.2826    3.4992    3.6051    3.7255    3.9561
           μ[3]   3.5900    3.9988    4.2449    4.5507    5.3007
           μ[4]   3.9220    4.2754    4.5081    4.7815    5.4161
           μ[5]   3.4703    3.7330    3.8936    4.1225    4.6746
           μ[6]   4.3393    4.7278    4.9528    5.1696    5.6089
           μ[7]   2.9072    3.4929    3.8364    4.1970    5.0471
           μ[8]   4.9653    5.8929    6.3766    6.8616    7.8508
           μ[9]   3.4333    4.0293    4.3408    4.6990    5.5073
          μ[10]   2.0695    2.2673    2.3974    2.5695    2.9983
          μ[11]   3.1598    3.5554    3.7920    4.0572    4.5967
          μ[12]   1.5810    1.8869    2.0716    2.2842    2.7769
          μ[13]   3.1791    3.6543    3.9293    4.2499    4.9921
          μ[14]   3.0808    3.4508    3.6740    3.9262    4.4323
              τ  26.6958   40.4641   50.7268   62.4155   94.9594
              ϕ   5.8429    6.5022    6.8514    7.2332    8.0291
</code></pre></div></div>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span><span class="x">(</span><span class="n">chains_posterior</span><span class="x">[[</span><span class="o">:</span><span class="n">κ</span><span class="x">,</span> <span class="o">:</span><span class="n">ϕ</span><span class="x">,</span> <span class="o">:</span><span class="n">τ</span><span class="x">]];</span> <span class="n">α</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="x">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="x">)</span>
</code></pre></div></div>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/uk-posterior-kappa-phi-tau-sample-plot.png" alt="nil" /></p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Compute generated quantities for the chains pooled together</span>
<span class="n">pooled_chains</span> <span class="o">=</span> <span class="n">MCMCChains</span><span class="o">.</span><span class="n">pool_chain</span><span class="x">(</span><span class="n">chains_posterior</span><span class="x">)</span>
<span class="n">generated_posterior</span> <span class="o">=</span> <span class="n">vectup2tupvec</span><span class="x">(</span><span class="n">generated_quantities</span><span class="x">(</span><span class="n">m</span><span class="x">,</span> <span class="n">pooled_chains</span><span class="x">));</span>

<span class="n">daily_cases_posterior</span><span class="x">,</span> <span class="n">daily_deaths_posterior</span><span class="x">,</span> <span class="n">Rt_posterior</span><span class="x">,</span> <span class="n">Rt_adj_posterior</span> <span class="o">=</span> <span class="n">generated_posterior</span><span class="x">;</span>
</code></pre></div></div>

<p>The posterior predictive distribution:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">country_prediction_plot</span><span class="x">(</span><span class="n">uk_index</span><span class="x">,</span> <span class="n">daily_cases_posterior</span><span class="x">,</span> <span class="n">daily_deaths_posterior</span><span class="x">,</span> <span class="n">Rt_posterior</span><span class="x">;</span> <span class="n">main_title</span> <span class="o">=</span> <span class="s">"(posterior)"</span><span class="x">)</span>
</code></pre></div></div>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/uk-predictive-posterior-Rt.png" alt="nil" /></p>

<p>and with the adjusted \(R_t\):</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">country_prediction_plot</span><span class="x">(</span><span class="n">uk_index</span><span class="x">,</span> <span class="n">daily_cases_posterior</span><span class="x">,</span> <span class="n">daily_deaths_posterior</span><span class="x">,</span> <span class="n">Rt_adj_posterior</span><span class="x">;</span> <span class="n">main_title</span> <span class="o">=</span> <span class="s">"(posterior)"</span><span class="x">)</span>
</code></pre></div></div>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/uk-predictive-posterior-Rt-adjusted.png" alt="nil" /></p>

<h2 id="all-countries-prior-vs-posterior-predictive">All countries: prior vs. posterior predictive</h2>

<p>For the sake of completeness, here are the prior and posterior predictive distributions for all the 14 countries in a side-by-side comparison.</p>

<div class="two-by-two ">
<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-prior-predictive-01.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-posterior-predictive-01.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-prior-predictive-02.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-posterior-predictive-02.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-prior-predictive-03.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-posterior-predictive-03.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-prior-predictive-04.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-posterior-predictive-04.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-prior-predictive-05.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-posterior-predictive-05.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-prior-predictive-06.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-posterior-predictive-06.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-prior-predictive-07.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-posterior-predictive-07.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-prior-predictive-08.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-posterior-predictive-08.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-prior-predictive-09.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-posterior-predictive-09.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-prior-predictive-10.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-posterior-predictive-10.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-prior-predictive-11.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-posterior-predictive-11.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-prior-predictive-12.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-posterior-predictive-12.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-prior-predictive-13.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-posterior-predictive-13.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-prior-predictive-14.png" alt="nil" /></p>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/country-posterior-predictive-14.png" alt="nil" /></p>

</div>

<h2 id="what-if-we-didnt-do-anycertain-interventions">What if we didn’t do any/certain interventions?</h2>

<p>One interesting thing one can do after obtaining estimates for the effect of each of the interventions is to run the model but now <em>without</em> all or a subset of the interventions performed. Thus allowing us to get a sense of what the outcome would have been without those interventions, and also whether or not the interventions have the wanted effect.</p>

<p><code class="highlighter-rouge">data.covariates[m]</code> is a binary matrix for each <code class="highlighter-rouge">m</code> (country index), with <code class="highlighter-rouge">data.covariate[m][:, k]</code> then being a binary vector representing the time-series for the k-th covariate: <code class="highlighter-rouge">0</code> means the intervention has is not implemented, <code class="highlighter-rouge">1</code> means that the intervention is implemented. As an example, if schools and universites were closed after the 45th day for country <code class="highlighter-rouge">m</code>, then <code class="highlighter-rouge">data.covariate[m][1:45, k]</code> are all zeros and <code class="highlighter-rouge">data.covariate[m][45:end, k]</code> are all ones.</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Get the index of schools and univerities closing</span>
<span class="n">schools_universities_closed_index</span> <span class="o">=</span> <span class="n">findfirst</span><span class="x">(</span><span class="o">==</span><span class="x">(</span><span class="s">"schools_universities"</span><span class="x">),</span> <span class="n">names_covariates</span><span class="x">)</span>
<span class="c"># Time-series for UK</span>
<span class="n">data</span><span class="o">.</span><span class="n">covariates</span><span class="x">[</span><span class="n">uk_index</span><span class="x">][</span><span class="o">:</span><span class="x">,</span> <span class="n">schools_universities_closed_index</span><span class="x">]</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>100-element Array{Float64,1}:
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 0.0
 ⋮
 1.0
 1.0
 1.0
 1.0
 1.0
 1.0
 1.0
 1.0
 1.0
 1.0
 1.0
 1.0
</code></pre></div></div>

<p>Notice that the above assumes that not only are schools and universities closed <em>at some point</em>, but rather that they also stay closed in the future (at the least the future that we are considering).</p>

<p>Therefore we can for example simulate “what happens if we never closed schools and universities?” by instead setting this entire vector to <code class="highlighter-rouge">0</code> and re-run the model on the infererred parameters, similar to what we did before to compute the “generated quantities”, e.g. \(R_t\).</p>

<details><summary><p>Convenience function for zeroing out subsets of the interventions</p>
</summary>
<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">"""
    zero_covariates(xs::AbstractMatrix{&lt;:Real}; remove=[], keep=[])

Allows you to zero out covariates if the name of the covariate is in `remove` or NOT zero out those in `keep`.
Note that only `remove` xor `keep` can be non-empty.

Useful when instantiating counter-factual models, as it allows one to remove/keep a subset of the covariates.
"""</span>
<span class="n">zero_covariates</span><span class="x">(</span><span class="n">xs</span><span class="o">::</span><span class="kt">AbstractMatrix</span><span class="x">{</span><span class="o">&lt;:</span><span class="kt">Real</span><span class="x">};</span> <span class="n">kwargs</span><span class="o">...</span><span class="x">)</span> <span class="o">=</span> <span class="n">zero_covariates</span><span class="x">(</span><span class="n">xs</span><span class="x">,</span> <span class="n">names_covariates</span><span class="x">;</span> <span class="n">kwargs</span><span class="o">...</span><span class="x">)</span>
<span class="k">function</span><span class="nf"> zero_covariates</span><span class="x">(</span><span class="n">xs</span><span class="o">::</span><span class="kt">AbstractMatrix</span><span class="x">{</span><span class="o">&lt;:</span><span class="kt">Real</span><span class="x">},</span> <span class="n">names_covariates</span><span class="x">;</span> <span class="n">remove</span><span class="o">=</span><span class="x">[],</span> <span class="n">keep</span><span class="o">=</span><span class="x">[])</span>
    <span class="nd">@assert</span> <span class="x">(</span><span class="n">isempty</span><span class="x">(</span><span class="n">remove</span><span class="x">)</span> <span class="o">||</span> <span class="n">isempty</span><span class="x">(</span><span class="n">keep</span><span class="x">))</span> <span class="s">"only `remove` or `keep` can be non-empty"</span>

    <span class="k">if</span> <span class="n">isempty</span><span class="x">(</span><span class="n">keep</span><span class="x">)</span>
        <span class="k">return</span> <span class="n">mapreduce</span><span class="x">(</span><span class="n">hcat</span><span class="x">,</span> <span class="n">enumerate</span><span class="x">(</span><span class="n">eachcol</span><span class="x">(</span><span class="n">xs</span><span class="x">)))</span> <span class="k">do</span> <span class="x">(</span><span class="n">i</span><span class="x">,</span> <span class="n">c</span><span class="x">)</span>
            <span class="x">(</span><span class="n">names_covariates</span><span class="x">[</span><span class="n">i</span><span class="x">]</span> <span class="n">∈</span> <span class="n">remove</span> <span class="o">?</span> <span class="n">zeros</span><span class="x">(</span><span class="n">eltype</span><span class="x">(</span><span class="n">c</span><span class="x">),</span> <span class="n">length</span><span class="x">(</span><span class="n">c</span><span class="x">))</span> <span class="o">:</span> <span class="n">c</span><span class="x">)</span>
        <span class="k">end</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="n">mapreduce</span><span class="x">(</span><span class="n">hcat</span><span class="x">,</span> <span class="n">enumerate</span><span class="x">(</span><span class="n">eachcol</span><span class="x">(</span><span class="n">xs</span><span class="x">)))</span> <span class="k">do</span> <span class="x">(</span><span class="n">i</span><span class="x">,</span> <span class="n">c</span><span class="x">)</span>
            <span class="x">(</span><span class="n">names_covariates</span><span class="x">[</span><span class="n">i</span><span class="x">]</span> <span class="n">∈</span> <span class="n">keep</span> <span class="o">?</span> <span class="n">c</span> <span class="o">:</span> <span class="n">zeros</span><span class="x">(</span><span class="n">eltype</span><span class="x">(</span><span class="n">c</span><span class="x">),</span> <span class="n">length</span><span class="x">(</span><span class="n">c</span><span class="x">)))</span> 
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zero_covariates (generic function with 2 methods)
</code></pre></div></div>

</details>

<p>Now we can consider simulation under the posterior with <em>no</em> intervention, and we’re going to visualize the respective <em>portions</em> of the population by rescaling by total population:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># What happens if we don't do anything?</span>
<span class="n">m_counterfactual</span> <span class="o">=</span> <span class="n">model_def</span><span class="x">(</span>
    <span class="n">data</span><span class="o">.</span><span class="n">num_impute</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">num_total_days</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">cases</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">deaths</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="nb">π</span><span class="x">,</span>
    <span class="x">[</span><span class="n">zeros</span><span class="x">(</span><span class="n">size</span><span class="x">(</span><span class="n">c</span><span class="x">))</span> <span class="k">for</span> <span class="n">c</span> <span class="k">in</span> <span class="n">data</span><span class="o">.</span><span class="n">covariates</span><span class="x">],</span> <span class="c"># &lt;= remove ALL covariates</span>
    <span class="n">data</span><span class="o">.</span><span class="n">epidemic_start</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">population</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">serial_intervals</span><span class="x">,</span>
    <span class="n">lockdown_index</span><span class="x">,</span>
    <span class="nb">true</span> <span class="c"># &lt;= use full model</span>
<span class="x">);</span>

<span class="c"># Compute the "generated quantities" for the "counter-factual" model</span>
<span class="n">generated_counterfactual</span> <span class="o">=</span> <span class="n">vectup2tupvec</span><span class="x">(</span><span class="n">generated_quantities</span><span class="x">(</span><span class="n">m_counterfactual</span><span class="x">,</span> <span class="n">pooled_chains</span><span class="x">));</span>
<span class="n">daily_cases_counterfactual</span><span class="x">,</span> <span class="n">daily_deaths_counterfactual</span><span class="x">,</span> <span class="n">Rt_counterfactual</span><span class="x">,</span> <span class="n">Rt_adj_counterfactual</span> <span class="o">=</span> <span class="n">generated_counterfactual</span><span class="x">;</span>
<span class="n">country_prediction_plot</span><span class="x">(</span><span class="mi">5</span><span class="x">,</span> <span class="n">daily_cases_counterfactual</span><span class="x">,</span> <span class="n">daily_deaths_counterfactual</span><span class="x">,</span> <span class="n">Rt_adj_counterfactual</span><span class="x">;</span> <span class="n">normalize_pop</span> <span class="o">=</span> <span class="nb">true</span><span class="x">)</span>
</code></pre></div></div>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/counterfactual-remove-all.png" alt="nil" /></p>

<p>We can also consider the cases where we only do <em>some</em> of the interventions, e.g. we never do a full lockdown (<code class="highlighter-rouge">lockdown</code>) or close schools and universities (<code class="highlighter-rouge">schools_universities</code>):</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># What happens if we never close schools nor do a lockdown?</span>
<span class="n">m_counterfactual</span> <span class="o">=</span> <span class="n">model_def</span><span class="x">(</span>
    <span class="n">data</span><span class="o">.</span><span class="n">num_impute</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">num_total_days</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">cases</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">deaths</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="nb">π</span><span class="x">,</span>
    <span class="x">[</span><span class="n">zero_covariates</span><span class="x">(</span><span class="n">c</span><span class="x">;</span> <span class="n">remove</span> <span class="o">=</span> <span class="x">[</span><span class="s">"lockdown"</span><span class="x">,</span> <span class="s">"schools_universities"</span><span class="x">])</span> <span class="k">for</span> <span class="n">c</span> <span class="k">in</span> <span class="n">data</span><span class="o">.</span><span class="n">covariates</span><span class="x">],</span> <span class="c"># &lt;= remove covariates</span>
    <span class="n">data</span><span class="o">.</span><span class="n">epidemic_start</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">population</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">serial_intervals</span><span class="x">,</span>
    <span class="n">lockdown_index</span><span class="x">,</span>
    <span class="nb">true</span> <span class="c"># &lt;= use full model</span>
<span class="x">);</span>

<span class="c"># Compute the "generated quantities" for the "counter-factual" model</span>
<span class="n">generated_counterfactual</span> <span class="o">=</span> <span class="n">vectup2tupvec</span><span class="x">(</span><span class="n">generated_quantities</span><span class="x">(</span><span class="n">m_counterfactual</span><span class="x">,</span> <span class="n">pooled_chains</span><span class="x">));</span>
<span class="n">daily_cases_counterfactual</span><span class="x">,</span> <span class="n">daily_deaths_counterfactual</span><span class="x">,</span> <span class="n">Rt_counterfactual</span><span class="x">,</span> <span class="n">Rt_adj_counterfactual</span> <span class="o">=</span> <span class="n">generated_counterfactual</span><span class="x">;</span>
<span class="n">country_prediction_plot</span><span class="x">(</span><span class="n">uk_index</span><span class="x">,</span> <span class="n">daily_cases_counterfactual</span><span class="x">,</span> <span class="n">daily_deaths_counterfactual</span><span class="x">,</span> <span class="n">Rt_adj_counterfactual</span><span class="x">;</span> <span class="n">normalize_pop</span> <span class="o">=</span> <span class="nb">true</span><span class="x">)</span>
</code></pre></div></div>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/counterfactual-remove-lockdown-and-schools.png" alt="nil" /></p>

<p>As mentioned, this assumes that we will stay in lockdown and schools and universities will be closed in the future. We can also consider, say, removing the lockdown, i.e. opening up, at some future point in time:</p>

<div class="language-julia highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lift_lockdown_time</span> <span class="o">=</span> <span class="mi">75</span>

<span class="n">new_covariates</span> <span class="o">=</span> <span class="x">[</span><span class="n">copy</span><span class="x">(</span><span class="n">c</span><span class="x">)</span> <span class="k">for</span> <span class="n">c</span> <span class="k">in</span> <span class="n">data</span><span class="o">.</span><span class="n">covariates</span><span class="x">]</span> <span class="c"># &lt;= going to do inplace manipulations so we copy</span>
<span class="k">for</span> <span class="n">covariates_m</span> <span class="n">∈</span> <span class="n">new_covariates</span>
    <span class="n">covariates_m</span><span class="x">[</span><span class="n">lift_lockdown_time</span><span class="o">:</span><span class="k">end</span><span class="x">,</span> <span class="n">lockdown_index</span><span class="x">]</span> <span class="o">.=</span> <span class="mi">0</span>
<span class="k">end</span>

<span class="c"># What happens if we never close schools nor do a lockdown?</span>
<span class="n">m_counterfactual</span> <span class="o">=</span> <span class="n">model_def</span><span class="x">(</span>
    <span class="n">data</span><span class="o">.</span><span class="n">num_impute</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">num_total_days</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">cases</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">deaths</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="nb">π</span><span class="x">,</span>
    <span class="n">new_covariates</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">epidemic_start</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">population</span><span class="x">,</span>
    <span class="n">data</span><span class="o">.</span><span class="n">serial_intervals</span><span class="x">,</span>
    <span class="n">lockdown_index</span><span class="x">,</span>
    <span class="nb">true</span> <span class="c"># &lt;= use full model</span>
<span class="x">);</span>

<span class="c"># Compute the "generated quantities" for the "counter-factual" model</span>
<span class="n">generated_counterfactual</span> <span class="o">=</span> <span class="n">vectup2tupvec</span><span class="x">(</span><span class="n">generated_quantities</span><span class="x">(</span><span class="n">m_counterfactual</span><span class="x">,</span> <span class="n">pooled_chains</span><span class="x">));</span>
<span class="n">daily_cases_counterfactual</span><span class="x">,</span> <span class="n">daily_deaths_counterfactual</span><span class="x">,</span> <span class="n">Rt_counterfactual</span><span class="x">,</span> <span class="n">Rt_adj_counterfactual</span> <span class="o">=</span> <span class="n">generated_counterfactual</span><span class="x">;</span>
<span class="n">country_prediction_plot</span><span class="x">(</span><span class="n">uk_index</span><span class="x">,</span> <span class="n">daily_cases_counterfactual</span><span class="x">,</span> <span class="n">daily_deaths_counterfactual</span><span class="x">,</span> <span class="n">Rt_adj_counterfactual</span><span class="x">;</span> <span class="n">normalize_pop</span> <span class="o">=</span> <span class="nb">true</span><span class="x">)</span>
</code></pre></div></div>

<p><img src="../assets/figures/2020-05-04-Imperial-Report13-analysis/counterfactual-remove-lockdown-after-a-while.png" alt="nil" /></p>

<h1 id="conclusion">Conclusion</h1>

<p>Well, there isn’t one. As stated before, drawing conclusions is not the purpose of this document. With that being said, we <em>are</em> working on exploring this and other models further, e.g. relaxing certain assumptions, model validation &amp; comparison, but this will hopefully be available in a more technical and formal report sometime in the near future after proper validation and analysis. But since time is of the essence in these situations, we thought it was important to make the above and related code available to the public immediately. At the very least it should be comforting to know that two different PPLs both produce the same inference results when the model might be used to inform policy decisions on a national level.</p>

<p>If you have any questions or comments, feel free to reach out either on the <a href="https://github.com/TuringLang/Covid19">Github repo</a> or to any of us personally.</p>

<!----- Footnotes ----->

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:fn1" role="doc-endnote">
      <p>The issue with <em>not</em> having the <code class="highlighter-rouge">max</code> is that it’s possible to obtain a negative \(R_t\) which is bad for two reasons: 1) it doesn’t make sense with negative spreading of the virus, 2) it leads to invalid parameterization for <code class="highlighter-rouge">NegativeBinomial2</code>. In Stan a invalid parameterization will be considered a rejected sample, and thus these samples will be rejected. In the case of <code class="highlighter-rouge">Turing.jl</code>, if \(R_t = 0\), then observing a <em>positive</em> number for daily deaths will result in <code class="highlighter-rouge">-Inf</code> added to the log-pdf and so the sample will also be rejected. Hence, both PPLs will arrive at “correct” inference but with different processes. <a href="#fnref:fn1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:fn3" role="doc-endnote">
      <p>Recently one of our team-members joined as a maintainer of <a href="https://github.com/JuliaDiff/ReverseDiff.jl">ReverseDiff.jl</a> to make sure that <code class="highlighter-rouge">Turing.jl</code> also has fast and reliable reverse-mode differentiation. ReverseDiff.jl is already compatible with <code class="highlighter-rouge">Turing.jl</code>, but we hope that this will help make if much, much faster. <a href="#fnref:fn3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>


    
    <!-- this will parse through the header fields and add a button to open
     an issue / ask a question on Github. The editable field should be in
     the post frontend matter, and refer to the label to open the issue for -->

<style>
.more {
    float:right;
    font-size: 1.0rem !important;
}
.more:hover {
    color: cornflowerblue !important;
}

.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-content {
    display: none;
    position: absolute;
    background-color: #f9f9f9;
    min-width: 160px;
    font-weight: 200;
    box-shadow: 0px 8px 6px 0px rgba(0,0,0,0.2);
    padding: 0px 10px;
    z-index: 1;
}

.dropdown:hover .dropdown-content {
    display: block;
}
</style>


    </article>
</div>      

                </div>
            </div>
        </main>
    </div>

    <footer class="c-footer md-footer-nav">
  <div class="md-footer-copyright__highlight">
    
    Turing is created by <a style="color:inherit; text-decoration: underline;" href="http://mlg.eng.cam.ac.uk/hong/">Hong Ge</a>, 
    and lovingly maintained by the <a style="color:inherit; text-decoration: underline;" href="https://github.com/TuringLang/Turing.jl/graphs/contributors">core team</a> of volunteers.

    <br><br>
    
    The contents of this website are
© 2020 under the terms of the <a style="color:inherit; text-decoration: underline;" href="https://github.com/TuringLang/Turing.jl/blob/master/LICENCE">MIT License</a>.
    
  </div>  
</footer>


    <script src="/dev/assets/js/application.js"></script>
    
    <script>console.log('3')</script>
    <script>app.initialize({version:"0.17.4", url:{base:'/dev'}})</script>

    
    <script src="/dev/assets/js/version-switch.js"></script>

    <script>
var headers = ["h1", "h2", "h3", "h4"]
var colors = ["red", "orange", "green", "blue"]

$.each(headers, function(i, header){
    var color = colors[i];
    $(header).each(function () {
        var href=$(this).attr("id");
        $(this).append('<a class="headerlink" style="color:' + color + '" href="#' + href + '" title="Permanent link">¶</a>')
    });
})

// Ensure that sidebar on left has arrows
$(".pancakes-parent").on('click', function(){
    console.log($(this).next());
    $(this).next().find('.pancakes-child').toggle();
    if ($(this).hasClass('open-parent')){
        $(this).removeClass('open-parent');
    } else {
        $(this).addClass('open-parent');
    }
})

$(".pancakes-parent-mobile").on('click', function(){
    var nav = $(this).next();
     nav.addClass('mobile-sub-navbar-display');
})

$(".mobile-navbar-back").on('click', function(){
    var nav = $(this).parent();
    nav.removeClass('mobile-sub-navbar-display');
})

</script>
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

    <script>
$('h1').first().append('<div></div>')</script>

    <style>
#scrolltop {
  display: none; /* Hidden by default */
  position: fixed; /* Fixed/sticky position */
  bottom: 20px; /* Place the button at the bottom of the page */
  right: 30px; /* Place the button 30px from the right */
  z-index: 99; /* Make sure it does not overlap */
  border: none; /* Remove borders */
  outline: none; /* Remove outline */
  background-color: #d2e6f5; /* Set a background color */
  color: white; /* Text color */
  cursor: pointer; /* Add a mouse pointer on hover */
  padding: 10px 15px; /* Some padding */
  border-radius: 100px; /* Rounded corners */
  font-size: 18px; /* Increase font size */
  font-weight: 600;
}

#scrolltop:hover {
  background-color: #555; /* Add a dark-grey background on hover */
}
</style>
<button onclick="topFunction()" id="scrolltop" title="Go to top">🔝</button>

<script>
// When the user scrolls down 20px from the top of the document, show the button
window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
    document.getElementById("scrolltop").style.display = "block";
  } else {
    document.getElementById("scrolltop").style.display = "none";
  }
}

// When the user clicks on the button, scroll to the top of the document
function topFunction() {
  document.body.scrollTop = 0; // For Safari
  document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
}
</script>

    


  </body>
</html>
