{"config":{"lang":["en"],"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location": "/archive/", "text": "news archive2020 may 4 2020 replication study estimating number of inections and impact of npis on covid 19 in european countries imperial report 13 feb 12 2020 google summer of code julia summer of code 2019 dec 14 2019 turing s blog", "title": "Articles"},{"location": "/feed.xml", "text": "turing jl turing a robust efficient and modular library for general purpose probabilistic programming dev mon 04 may 2020 20 52 11 0000 mon 04 may 2020 20 52 11 0000 jekyll v4 0 0 replication study estimating number of inections and impact of npis on covid 19 in european countries imperial report 13 lt style gt div two by two height 100 display flex flex direction row flex wrap wrap div two by two gt p width 45 margin 0 auto lt style gt lt p gt we i e the lt a href quot https turing ml dev team quot gt turinglang team lt a gt are currently exploring cooperation with other researchers in attempt to help with the ongoing crisis as preparation for this and to get our feet wet we decided it would be useful to do a replication study of the lt a href quot https www imperial ac uk mrc global infectious disease analysis covid 19 report 13 europe npi impact quot gt imperial report 13 lt a gt we figured it might be useful for the public in particular other researchers working on the same or similar models to see the results of this analysis and thus decided to make it available here lt p gt lt p gt we want to emphasize that you should look to the original paper rather than this post for developments and analysis of the model we are not aiming to make any claims about the validity or the implications of the model and refer to lt a href quot https www imperial ac uk mrc global infectious disease analysis covid 19 report 13 europe npi impact quot gt imperial report 13 lt a gt for details on the model itself this post s purpose is only to add tiny bit of validation to the lt em gt inference lt em gt performed in the paper by obtaining the same results using a different probabilistic programming language ppl and to explore whether or not lt code class quot highlighter rouge quot gt turing jl lt code gt can be useful for researchers working on these problems lt p gt lt div id quot plot 3 quot class quot plotly quot gt lt div gt lt script gt plotly d3 json quot assets figures 2020 05 04 imperial report13 analysis plot2 json quot function err fig plotly plot quot plot 3 quot fig data fig layout responsive true lt script gt lt p gt all code and inference results shown in this post can be found lt a href quot https github com turinglang covid19 quot gt here lt a gt lt p gt lt h1 id quot setup quot gt setup lt h1 gt lt p gt this is all assuming that you re in the project directory of lt a href quot https github com turinglang covid19 quot gt lt code class quot highlighter rouge quot gt covid19 jl lt code gt lt a gt a small package where we gather most of our ongoing work lt p gt lt p gt in the project we use lt a href quot https github com juliadynamics drwatson jl quot gt lt code class quot highlighter rouge quot gt drwatson jl lt code gt lt a gt which provides a lot of convenient functionality for well working with a project the below code will activate the lt code class quot highlighter rouge quot gt covid19 jl lt code gt project to ensure that we re using correct versions of all the dependencies i e code is reproducible it s basically just doing lt code class quot highlighter rouge quot gt activate lt code gt but with a few bells and whistles that we ll use later lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot k quot gt using lt span gt lt span class quot n quot gt drwatson lt span gt lt span class quot n quot gt quickactivate lt span gt lt span class quot x quot gt lt span gt lt span class quot nd quot gt dir lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt with the project activate we can import the lt code class quot highlighter rouge quot gt covid19 jl lt code gt package lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot c quot gt loading the project https github com turinglang covid19 lt span gt lt span class quot k quot gt using lt span gt lt span class quot n quot gt covid19 lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot c quot gt some other packages we ll need lt span gt lt span class quot k quot gt using lt span gt lt span class quot n quot gt random lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt dates lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt turing lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt bijectors lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt and we ll be using the new lt a href quot https julialang org blog 2019 07 multithreading quot gt multithreading functionality in julia lt a gt to speed things up so we need the lt code class quot highlighter rouge quot gt base threads lt code gt package lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot k quot gt using lt span gt lt span class quot n quot gt base lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt threads lt span gt lt span class quot n quot gt nthreads lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt 4 lt code gt lt pre gt lt div gt lt div gt lt p gt here s a summary of the setup lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot k quot gt using lt span gt lt span class quot n quot gt pkg lt span gt lt span class quot n quot gt pkg lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt status lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt project covid19 v0 1 0status projects mine covid19 project toml dce04be8 argcheck v2 0 0 c7e460c6 argparse v1 1 0 131c737c arviz v0 4 1 76274a88 bijectors v0 6 7 tor using bijectors in link and invlink https github com turinglang bijectors jl git 336ed68f csv v0 6 1 a93c6f00 dataframes v0 20 2 31c24e10 distributions v0 23 2 ced4e74d distributionsad v0 4 10 634d3b9d drwatson v1 10 2 1a297f60 fillarrays v0 8 7 58dd65bb plotly v0 3 0 f0f68f2c plotlyjs v0 13 1 91a5bcdd plots v1 1 2 438e738f pycall v1 91 4 d330b81b pyplot v2 9 0 df47a6cb rdata v0 7 1 2913bbd2 statsbase v0 33 0 f3b207a7 statsplots v0 14 5 fce5fe82 turing v0 11 0 tor modelling temporary https github com turinglang turing jl git 9a3f8284 random 10745b16 statistics lt code gt lt pre gt lt div gt lt div gt lt p gt in the github project you will find a lt code class quot highlighter rouge quot gt manifest toml lt code gt this means that if you re working directory is the project directory and you do lt code class quot highlighter rouge quot gt julia project lt code gt followed by lt code class quot highlighter rouge quot gt instantiate lt code gt you will have lt em gt exactly lt em gt the same enviroment as we had when performing this analysis lt p gt lt details gt lt summary gt lt p gt overloading some functionality in lt code class quot highlighter rouge quot gt drwatson jl lt code gt lt p gt lt summary gt lt p gt as mentioned lt code class quot highlighter rouge quot gt drwatson jl lt code gt provides a lot of convenience functions for working in a project and one of them is lt code class quot highlighter rouge quot gt projectdir args lt code gt which will resolve join the lt code class quot highlighter rouge quot gt args lt code gt to the absolute path of the project directory in similar fashion it provides a lt code class quot highlighter rouge quot gt datadir lt code gt method which defaults to lt code class quot highlighter rouge quot gt projectdir quot data quot lt code gt but to remove the possibility of making a type later on when writing lt code class quot highlighter rouge quot gt datadir quot imperial report13 quot lt code gt we ll overload this method for this notebook lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot k quot gt import lt span gt lt span class quot n quot gt drwatson lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt datadir lt span gt lt span class quot n quot gt outdir lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt projectdir lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot out quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt outdir lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt args lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt projectdir lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot out quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt args lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt datadir lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt projectdir lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot data quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot imperial report13 quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt datadir lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt s lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt projectdir lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot data quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot imperial report13 quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt s lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt datadir generic function with 2 methods lt code gt lt pre gt lt div gt lt div gt lt details gt lt h1 id quot data quot gt data lt h1 gt lt p gt to ensure consistency with the original model from the paper and to stay up to date with the changes made we preprocessed the data using the lt code class quot highlighter rouge quot gt base r lt code gt script from the lt a href quot https github com imperialcollegelondon covid19model tree 6ee3010a58a57cc14a16545ae897ca668b7c9096 quot gt original repository 6ee3010 lt a gt and store the processed data in a lt code class quot highlighter rouge quot gt processed rds lt code gt file to load this rds file obtained from the r script we make use of the rdata jl package which allows us to load the rds file into a julia lt code class quot highlighter rouge quot gt dict lt code gt lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot k quot gt using lt span gt lt span class quot n quot gt rdata lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt rdata full lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt load lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt datadir lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot processed rds quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rdata lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt rdata full lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot stan data quot lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt keys lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rdata full lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt base keyset for a dict string int64 with 4 entries keys quot reported cases quot quot stan data quot quot deaths by country quot quot dates quot lt code gt lt pre gt lt div gt lt div gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt country to dates lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt dict lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt k lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rdata full lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot dates quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt k lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt k lt span gt lt span class quot k quot gt in lt span gt lt span class quot n quot gt keys lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rdata full lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot dates quot lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt dict string array date 1 with 14 entries quot sweden quot amp gt date 2020 02 18 2020 02 19 2020 02 20 2020 02 21 2020 quot belgium quot amp gt date 2020 02 18 2020 02 19 2020 02 20 2020 02 21 2020 quot greece quot amp gt date 2020 02 19 2020 02 20 2020 02 21 2020 02 22 2020 quot switzerland quot amp gt date 2020 02 14 2020 02 15 2020 02 16 2020 02 17 2020 quot germany quot amp gt date 2020 02 15 2020 02 16 2020 02 17 2020 02 18 2020 quot united kingdom quot amp gt date 2020 02 12 2020 02 13 2020 02 14 2020 02 15 2020 quot denmark quot amp gt date 2020 02 21 2020 02 22 2020 02 23 2020 02 24 2020 quot norway quot amp gt date 2020 02 24 2020 02 25 2020 02 26 2020 02 27 2020 quot france quot amp gt date 2020 02 07 2020 02 08 2020 02 09 2020 02 10 2020 quot portugal quot amp gt date 2020 02 21 2020 02 22 2020 02 23 2020 02 24 2020 quot spain quot amp gt date 2020 02 09 2020 02 10 2020 02 11 2020 02 12 2020 quot netherlands quot amp gt date 2020 02 14 2020 02 15 2020 02 16 2020 02 17 2020 quot italy quot amp gt date 2020 01 27 2020 01 28 2020 01 29 2020 01 30 2020 quot austria quot amp gt date 2020 02 22 2020 02 23 2020 02 24 2020 02 25 2020 lt code gt lt pre gt lt div gt lt div gt lt p gt since the data format is not native julia there might be some discrepancies in the lt em gt types lt em gt of the some data fields and so we need to do some type conversion of the loaded lt code class quot highlighter rouge quot gt rdata lt code gt we also rename a lot of the fields to make it more understandable and for an easier mapping to our implementation of the model feel free to skip this snippet lt p gt lt details gt lt summary gt lt p gt data wrangling lt p gt lt summary gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot c quot gt convert some misparsed fields lt span gt lt span class quot n quot gt rdata lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot n2 quot lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt int lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rdata lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot n2 quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rdata lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot n0 quot lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt int lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rdata lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot n0 quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rdata lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot epidemicstart quot lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt int lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rdata lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot epidemicstart quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rdata lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot cases quot lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt int lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rdata lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot cases quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rdata lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot deaths quot lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt int lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rdata lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot deaths quot lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt stan will fail if these are nothing so we make them empty arrays lt span gt lt span class quot n quot gt rdata lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot x quot lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rdata lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot features quot lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt countries lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot denmark quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot italy quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot germany quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot spain quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot united kingdom quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot france quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot norway quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot belgium quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot austria quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot sweden quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot switzerland quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot greece quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot portugal quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot netherlands quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt length lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt names covariates lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot schools universities quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot self isolating if ill quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot public events quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot any quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot lockdown quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot social distancing encouraged quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lockdown index lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt findfirst lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot lockdown quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt names covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt function lt span gt lt span class quot nf quot gt rename lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt names lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt pair lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt check that keys are not yet present before updating d lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt k new lt span gt lt span class quot k quot gt in lt span gt lt span class quot n quot gt values lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt names lt span gt lt span class quot x quot gt lt span gt lt span class quot nd quot gt assert lt span gt lt span class quot n quot gt k new lt span gt lt span class quot n quot gt lt span gt lt span class quot n quot gt keys lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot lt span gt lt span class quot si quot gt k new lt span gt lt span class quot s quot gt already in dictionary quot lt span gt lt span class quot k quot gt end lt span gt lt span class quot k quot gt for lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt k old lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt k new lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt in lt span gt lt span class quot n quot gt names lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt k new lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt pop lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt k old lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt end lt span gt lt span class quot k quot gt return lt span gt lt span class quot n quot gt d lt span gt lt span class quot k quot gt end lt span gt lt span class quot c quot gt rdata is a dictofvector so we convert to a simple dict for simplicity lt span gt lt span class quot n quot gt d lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt dict lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt k lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rdata lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt k lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt k lt span gt lt span class quot k quot gt in lt span gt lt span class quot n quot gt keys lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rdata lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt values df and keys df have different ordering so don t do dict keys df values df lt span gt lt span class quot c quot gt rename some columns lt span gt lt span class quot n quot gt rename lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot f quot lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot s quot gt quot quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot si quot lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot s quot gt quot serial intervals quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot pop quot lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot s quot gt quot population quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot m quot lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot s quot gt quot num countries quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot n0 quot lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot s quot gt quot num impute quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot n quot lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot s quot gt quot num obs countries quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot n2 quot lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot s quot gt quot num total days quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot epidemicstart quot lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot s quot gt quot epidemic start quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot x quot lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot s quot gt quot covariates quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot p quot lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot s quot gt quot num covariates quot lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt add some type information to arrays and replace 1 with missing as 1 is supposed to represent well missing data lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot deaths quot lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt int lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot deaths quot lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt d quot deaths quot replace d quot deaths quot 1 amp gt missing lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot deaths quot lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt collect lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt eachcol lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot deaths quot lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt convert into array of arrays instead of matrix lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot cases quot lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt int lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot cases quot lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt d quot cases quot replace d quot cases quot 1 amp gt missing lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot cases quot lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt collect lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt eachcol lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot cases quot lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt convert into array of arrays instead of matrix lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot num covariates quot lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt int lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot num covariates quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot num countries quot lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt int lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot num countries quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot num total days quot lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt int lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot num total days quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot num impute quot lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt int lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot num impute quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot num obs countries quot lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt int lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot num obs countries quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot epidemic start quot lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt int lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot epidemic start quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot population quot lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt int lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot population quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot quot lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt collect lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt eachcol lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot quot lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt convert into array of arrays instead of matrix lt span gt lt span class quot c quot gt convert 3d array into array matrix lt span gt lt span class quot n quot gt covariates lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rdata lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot x quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt m lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt k lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot kt quot gt string lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt k lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt k lt span gt lt span class quot k quot gt in lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num obs countries lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num total days lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cases lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt epidemic start lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt population lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt serial intervals lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt merge lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt covariates lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt can deal with ragged arrays so we can shave off unobserved data future which are just filled with 1 lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt merge lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cases lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num obs countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt m lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt deaths lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num obs countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt m lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt details gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt 14 lt code gt lt pre gt lt div gt lt div gt lt p gt because it s a bit much to visualize 14 countries at each step we re going to use uk as an example throughout lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt uk index lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt findfirst lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot united kingdom quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt countries lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt 5 lt code gt lt pre gt lt div gt lt div gt lt p gt it s worth noting that the data user here is not quite up to date for uk because on lt span class quot timestamp wrapper quot gt lt span class quot timestamp quot gt amp lt 2020 04 30 to amp gt lt span gt lt span gt they updated their lt em gt past lt em gt numbers by including deaths from care and nursing homes data source lt a href quot https www ecdc europa eu en quot gt ecdc lt a gt thus if you compare the prediction of the model to real numbers it s likely that the real numbers will be a bit higher than what the model predicts lt p gt lt h1 id quot model quot gt model lt h1 gt lt p gt for a thorough description of the model and the assumptions that have gone into it we recommend looking at the lt a href quot https www imperial ac uk mrc global infectious disease analysis covid 19 report 13 europe npi impact quot gt original paper lt a gt or their very nice lt a href quot https github com imperialcollegelondon covid19model tree 6ee3010a58a57cc14a16545ae897ca668b7c9096 technical description of imperial covid 19 model pdf quot gt techical report from the repository lt a gt the model described here is the one corresponding to the technical report linked the link points to the correct commit id and so should be consistent with this post despite potential changes to the official model made in the future lt p gt lt p gt for the sake of exposition we present a compact version of the model here lt p gt lt p gt begin align tau amp amp sim mathrm exponential 1 0 03 lt br gt y m amp amp sim mathrm exponential tau quad amp amp text for quad m 1 dots m lt br gt kappa amp amp sim mathcal n 0 0 5 lt br gt mu m amp amp sim mathcal n 3 28 kappa quad amp amp text for quad m 1 dots m lt br gt gamma amp amp sim mathcal n 0 0 2 lt br gt beta m amp amp sim mathcal n 0 gamma quad amp amp text for quad m 1 dots m lt br gt tilde alpha k amp amp sim mathrm gamma 0 1667 1 quad amp amp text for quad k 1 dots k lt br gt alpha k amp amp tilde alpha k frac log 1 05 6 quad amp amp text for quad k 1 dots k lt br gt r t m amp amp mu m exp beta m x k text ld sum k 1 k alpha k x k quad amp amp text for quad m 1 dots m t 1 dots t lt br gt tilde r t m amp amp 1 frac 1 p m sum tau 1 t 1 c tau m quad amp amp text for quad m 1 dots m t t text impute 1 dots t lt br gt c t m amp amp y m quad amp amp text for quad m 1 dots m t 1 dots t text impute lt br gt c t m amp amp tilde r t m sum tau 1 t 1 c tau m s t tau quad amp amp text for quad m 1 dots m t t text impute 1 dots t lt br gt varepsilon m text ifr amp amp sim mathcal n 1 0 1 quad amp amp text for quad m 1 dots m lt br gt mathrm ifr m amp amp sim mathrm ifr m cdot varepsilon m text ifr quad amp amp text for quad m 1 dots m lt br gt d t m amp amp mathrm ifr m sum tau 1 t 1 c tau m pi t tau quad amp amp text for quad m 1 dots m t 1 dots t lt br gt phi amp amp sim mathcal n 0 5 lt br gt d t m amp amp sim mathrm negativebinomial d t m phi quad amp amp text for quad m 1 dots m t 1 dots t end align lt p gt lt p gt where lt p gt lt ul gt lt li gt it s assumed that seeding of new infections begins 30 days before the day after a country has cumulative observed 10 deaths lt li gt lt li gt m denotes the number of countries lt li gt lt li gt t the total number of time steps lt li gt lt li gt t text impute the time steps to lt em gt impute lt em gt values for the first 6 of the 30 days we impute the number and then we simulate the rest lt li gt lt li gt alpha k denotes the weights for the k th intervention covariate lt li gt lt li gt beta m denotes the weight for the lt code class quot highlighter rouge quot gt lockdown lt code gt intervention whose index we denote by k text ld lt ul gt lt li gt note that there is also a alpha k text ld which is shared between all the m countries lt li gt lt li gt in contrast the beta m weight is local to the country with index m lt li gt lt li gt this is a sort of way to try and deal with the fact that lt code class quot highlighter rouge quot gt lockdown lt code gt means different things in different countries e g lt code class quot highlighter rouge quot gt lockdown lt code gt in uk is much more severe than lockdown in norway lt li gt lt ul gt lt li gt lt li gt mu m represents the r 0 value for country m i e r t without any interventions lt li gt lt li gt r t m denotes the lt strong gt reproduction number lt strong gt at time t for country m lt li gt lt li gt tilde r t m denotes the lt strong gt adjusted reproduction number lt strong gt at time t for country m lt em gt adjusted lt em gt in the sense that it s rescaled wrt what proportion of the population is susceptible for infection assuming infected people cannot get the virus again within the near future lt li gt lt li gt p m denotes the lt strong gt total initial population lt strong gt for country m lt li gt lt li gt mathrm ifr m denotes the lt strong gt infection fatality ratio lt strong gt for country m and mathrm ifr m the lt em gt adjusted lt em gt infection fatality ratio see paper lt li gt lt li gt varepsilon m text ifr denotes the noise for the multiplicative noise for the mathrm ifr m lt li gt lt li gt lt p gt pi denotes the lt strong gt time from infection to death lt strong gt and is assumed to be a sum of two independent random times the incubation period lt em gt infection to onset lt em gt and time between onset of symptoms and death lt em gt onset to death lt em gt lt p gt lt p gt begin equation pi sim mathrm gamma 5 1 0 86 mathrm gamma 18 8 0 45 end equation lt p gt lt p gt where in this case the mathrm gamma is parameterized by its mean and coefficient of variation in the model this is a lt em gt precomputed lt em gt quantity and not something to be inferred though in an ideal world this would also be included in the model lt p gt lt li gt lt li gt lt p gt pi t then denotes a discretized version of the pdf for pi the reasoning behind the discretization is that if we assume d m t to be a continuous random variable denoting the death rate at any time t then it would be given by lt p gt lt p gt begin equation d m t mathrm ifr m int 0 t c m tau pi t tau dt end equation lt p gt lt p gt i e the convolution of the number of cases observed at time time tau c m tau and the lt em gt probability lt em gt of death at prior to time t for the new cases observed at time tau pi t tau assuming stationarity of pi t thus c m tau pi t tau can be interpreted as the portion people who got the virus at time tau have died at time t or rather have died after having the virus for t tau time with t amp gt tau discretizing then results in the above model lt p gt lt li gt lt li gt s t denotes the lt strong gt serial intervals lt strong gt i e the time between successive cases in a chain of transmission also a precomputed quantity lt li gt lt li gt c t m denotes the lt strong gt expected daily cases lt strong gt at time t for country m lt li gt lt li gt c t m denotes the lt strong gt cumulative cases lt strong gt prior to time t for country m lt li gt lt li gt d t m denotes the lt strong gt expected daily deaths lt strong gt at time t for country m lt li gt lt li gt d t m denotes the lt strong gt daily deaths lt strong gt at time t for country m in our case this is the lt strong gt likelihood lt strong gt note that here we re using the mean and variance coefficient parameterization of mathrm negativebinomial lt li gt lt ul gt lt p gt to see the reasoning for the choices of distributions and parameters for the priors see the either the paper or the lt a href quot https github com imperialcollegelondon covid19model tree 6ee3010a58a57cc14a16545ae897ca668b7c9096 technical description of imperial covid 19 model pdf quot gt techical report from the repository lt a gt lt p gt lt h2 id quot code quot gt code lt h2 gt lt p gt in lt code class quot highlighter rouge quot gt turing jl lt code gt a sample statement is defined by lt code class quot highlighter rouge quot gt x distribution lt code gt therefore the priors used in the model can be written within a turing jl lt code class quot highlighter rouge quot gt model lt code gt as lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt exponential lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot mf quot gt 0 03 lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt exponential has inverse parameterization of the one in stan lt span gt lt span class quot n quot gt y lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt filldist lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt exponential lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt truncated lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normal lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 5 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt inf lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt truncated lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normal lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 0 5 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt inf lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt filldist lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt truncated lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normal lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 3 28 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt inf lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt hier lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt filldist lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt gamma lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1667 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt hier lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt log lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 1 05 lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot mf quot gt 6 lt span gt lt span class quot n quot gt ifr noise lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt filldist lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt truncated lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normal lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 0 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt inf lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt lockdown related lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt truncated lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normal lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 0 2 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt inf lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lockdown lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt filldist lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normal lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt the lt code class quot highlighter rouge quot gt filldist lt code gt function in the above snippet is a function used to construct a lt code class quot highlighter rouge quot gt distribution lt code gt from which we can obtain i i d samples from a univariate distribution using vectorization lt p gt lt p gt and the full model is defined lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot nd quot gt model lt span gt lt span class quot k quot gt function lt span gt lt span class quot nf quot gt model v2 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt int num of days for which to impute infections lt span gt lt span class quot n quot gt num total days lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt int days of observed data num of days to forecast lt span gt lt span class quot n quot gt cases lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt abstractvector amp lt abstractvector amp lt int reported cases lt span gt lt span class quot n quot gt deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt abstractvector amp lt abstractvector amp lt int reported deaths rows indexed by i amp gt n contain 1 and should be ignored lt span gt lt span class quot nb quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt abstractvector amp lt abstractvector amp lt real h s lt span gt lt span class quot n quot gt covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt vector amp lt abstractmatrix lt span gt lt span class quot n quot gt epidemic start lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt abstractvector amp lt int lt span gt lt span class quot n quot gt population lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt abstractvector amp lt real lt span gt lt span class quot n quot gt serial intervals lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt abstractvector amp lt real fixed pre calculated serial interval si using empirical data from neil lt span gt lt span class quot n quot gt lockdown index lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt int the index for the lockdown covariate in covariates lt span gt lt span class quot n quot gt predict lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt false lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt bool if false will only compute what s needed to observe but not more lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt type lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt vector lt span gt lt span class quot x quot gt lt span gt lt span class quot kt quot gt float64 lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt where lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt covariates should be of length num countries and each entry correspond to a matrix of size num total days num covariates lt span gt lt span class quot n quot gt num covariates lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt size lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 2 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt length lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num obs countries lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt length lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt if we don t want to predict the future we only need to compute up to time step num obs countries m lt span gt lt span class quot n quot gt last time steps lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt predict lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt fill lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num total days lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num obs countries lt span gt lt span class quot c quot gt latent variables lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt exponential lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot mf quot gt 0 03 lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt exponential has inverse parameterization of the one in stan lt span gt lt span class quot n quot gt y lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt filldist lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt exponential lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt truncated lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normal lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 5 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt inf lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt truncated lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normal lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 0 5 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt inf lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt filldist lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt truncated lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normal lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 3 28 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt inf lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt hier lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt filldist lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt gamma lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1667 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt hier lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt log lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 1 05 lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot mf quot gt 6 lt span gt lt span class quot n quot gt ifr noise lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt filldist lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt truncated lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normal lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 0 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt inf lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt lockdown related lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt truncated lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normal lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 0 2 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt inf lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lockdown lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt filldist lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normal lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt initialization of some quantities lt span gt lt span class quot n quot gt expected daily cases lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt undef lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt last time steps lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt m lt span gt lt span class quot k quot gt in lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases pred lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt undef lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt last time steps lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt m lt span gt lt span class quot k quot gt in lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily deaths lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt undef lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt last time steps lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt m lt span gt lt span class quot k quot gt in lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt undef lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt last time steps lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt m lt span gt lt span class quot k quot gt in lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt adj lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt undef lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt last time steps lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt m lt span gt lt span class quot k quot gt in lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt loops over countries and perform independent computations for each country lt span gt lt span class quot c quot gt since this model does not include any notion of migration across borders lt span gt lt span class quot c quot gt amp gt might has well wrap it in a threads to perform the computation in parallel lt span gt lt span class quot nd quot gt threads lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt m lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot c quot gt country specific parameters lt span gt lt span class quot n quot gt m lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt pop m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt population lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily cases m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt expected daily cases lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases pred m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cases pred lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily deaths m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt expected daily deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt rt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt adj m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt rt adj lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt last time step lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt last time steps lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt imputation of num impute days lt span gt lt span class quot n quot gt expected daily cases m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt y lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases pred m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt zero lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases pred m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases pred m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 2 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cumsum lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily cases m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt xs lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt last time step lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt extract covariates for the wanted time steps and country m lt span gt lt span class quot n quot gt rt m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt exp lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt xs lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt lockdown lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt xs lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lockdown index lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt adjusts for portion of pop that are susceptible lt span gt lt span class quot n quot gt rt adj m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt max lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt pop m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cases pred m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt zero lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases pred m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt pop m lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt rt m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt t lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt last time step lt span gt lt span class quot c quot gt update cumulative cases lt span gt lt span class quot n quot gt cases pred m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cases pred m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt expected daily cases m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt adjusts for portion of pop that are susceptible lt span gt lt span class quot n quot gt rt adj m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt max lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt pop m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cases pred m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt zero lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases pred m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt pop m lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt rt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily cases m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt rt adj m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt sum lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily cases m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt serial intervals lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt end lt span gt lt span class quot n quot gt expected daily deaths m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot mf quot gt 1e 15 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt expected daily cases m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt t lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 2 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt last time step lt span gt lt span class quot n quot gt expected daily deaths m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt sum lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily cases m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt ifr noise lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt end lt span gt lt span class quot k quot gt end lt span gt lt span class quot c quot gt observe lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt m lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot c quot gt extract the estimated expected daily deaths for country m lt span gt lt span class quot n quot gt expected daily deaths m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt expected daily deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt extract time steps for which we have observations lt span gt lt span class quot n quot gt ts lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt epidemic start lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num obs countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt observe lt span gt lt span class quot n quot gt deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt ts lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt arraydist lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt negativebinomial2 lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily deaths m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt ts lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt end lt span gt lt span class quot k quot gt return lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily cases lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt expected daily cases lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily deaths lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt expected daily deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt rt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt adjusted lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt rt adj lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt end lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt two things worth noting is the use of the lt code class quot highlighter rouge quot gt tv lt code gt variable to instantiate some internal variables and the use of lt code class quot highlighter rouge quot gt threads lt code gt lt p gt lt p gt as you can see in the arguments for the model lt code class quot highlighter rouge quot gt tv lt code gt refers to a lt em gt type lt em gt and will be recognized as such by the lt code class quot highlighter rouge quot gt model lt code gt macro when transforming the model code this is used to ensure lt em gt type stability lt em gt of the model lt p gt lt details gt lt summary gt lt p gt more detailed explanation of lt code class quot highlighter rouge quot gt tv lt code gt lt p gt lt summary gt lt p gt a default execution of the model will then use lt code class quot highlighter rouge quot gt tv lt code gt as lt code class quot highlighter rouge quot gt vector float64 lt code gt thus making statements like lt code class quot highlighter rouge quot gt tv undef n lt code gt result in a lt code class quot highlighter rouge quot gt vector float64 lt code gt with lt code class quot highlighter rouge quot gt undef lt code gt uninitialized values and length lt code class quot highlighter rouge quot gt n lt code gt but in case we use a sampler that requires automatic differentiation ad tv will be will be replaced with the ad type corresponding to a lt code class quot highlighter rouge quot gt vector lt code gt e g lt code class quot highlighter rouge quot gt trackedvector lt code gt in the case of lt a href quot https github com fluxml tracker jl quot gt lt code class quot highlighter rouge quot gt tracker jl lt code gt lt a gt lt p gt lt details gt lt p gt the use of lt code class quot highlighter rouge quot gt threads lt code gt means that inside each execution of the lt code class quot highlighter rouge quot gt model lt code gt this loop will be performed in parallel where the number of threads are specified by the enviroment variable lt code class quot highlighter rouge quot gt julia num threads lt code gt this is thanks to the really nice multithreading functionality lt a href quot https julialang org blog 2019 07 multithreading quot gt introduced in julia 1 3 lt a gt and so this also requires julia 1 3 or higher to run the code note that the inside the loop is independent of each other and each lt code class quot highlighter rouge quot gt m lt code gt will be seen by only one thread hence it s threadsafe lt p gt lt p gt this model is basically identitical to the one defined in lt a href quot https github com imperialcollegelondon covid19model blob 6ee3010a58a57cc14a16545ae897ca668b7c9096 stan models base stan quot gt stan models base stan 6ee3010 lt a gt with the exception of two points lt p gt lt ul gt lt li gt in this model we use lt code class quot highlighter rouge quot gt truncatednormal lt code gt for normally distributed variables which are positively constrained instead of sampling from a lt code class quot highlighter rouge quot gt normal lt code gt and then taking the absolute value these approaches are equivalent from a modelling perspective lt li gt lt li gt we ve added the use of lt code class quot highlighter rouge quot gt max pop m cases pred m t 0 lt code gt in computing the lt em gt adjusted lt em gt r t lt code class quot highlighter rouge quot gt rt adj lt code gt to ensure that in the case where the entire populations has died there the adjusted r t is set to 0 i e if everyone in the country passed away then there is no spread of the virus this does not affect correctness of inference lt sup id quot fnref fn1 quot role quot doc noteref quot gt lt a href quot fn fn1 quot class quot footnote quot gt 1 lt a gt lt sup gt lt li gt lt li gt the lt code class quot highlighter rouge quot gt cases lt code gt and lt code class quot highlighter rouge quot gt deaths lt code gt arguments are arrays of arrays instead of 3d arrays therefore we don t need to fill the future days with lt code class quot highlighter rouge quot gt 1 lt code gt as is done in the original model lt li gt lt ul gt lt h3 id quot multithreaded observe quot gt multithreaded observe lt h3 gt lt p gt we can also make the lt code class quot highlighter rouge quot gt observe lt code gt statements parallel but because the lt code class quot highlighter rouge quot gt lt code gt is not yet threadsafe we unfortunately have to touch some of the internals of lt code class quot highlighter rouge quot gt turing jl lt code gt but for observations it s very straight forward instead of observing by the following piece of code lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt m lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot c quot gt extract the estimated expected daily deaths for country m lt span gt lt span class quot n quot gt expected daily deaths m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt expected daily deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt extract time steps for which we have observations lt span gt lt span class quot n quot gt ts lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt epidemic start lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num obs countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt observe lt span gt lt span class quot n quot gt deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt ts lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt arraydist lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt negativebinomial2 lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily deaths m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt ts lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt end lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt we can use the following lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot c quot gt doing observations in parallel provides a small speedup lt span gt lt span class quot n quot gt logps lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt undef lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot nd quot gt threads lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt m lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot c quot gt extract the estimated expected daily deaths for country m lt span gt lt span class quot n quot gt expected daily deaths m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt expected daily deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt extract time steps for which we have observations lt span gt lt span class quot n quot gt ts lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt epidemic start lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num obs countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt observe lt span gt lt span class quot n quot gt logps lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt logpdf lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt arraydist lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt negativebinomial2 lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily deaths m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt ts lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt ts lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt end lt span gt lt span class quot n quot gt turing lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt acclogp lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt varinfo lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt sum lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt logps lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt details gt lt summary gt lt p gt explanation of what we just did lt p gt lt summary gt lt p gt it might be worth explaining a bit about what s going on here first we should explain what the deal is with lt code class quot highlighter rouge quot gt varinfo lt code gt lt code class quot highlighter rouge quot gt varinfo lt code gt is basically the object used internally in turing to track the sampled variables and the log pdf lt em gt for a particular evaluation lt em gt of the model and so lt code class quot highlighter rouge quot gt acclogp varinfo lp lt code gt will increment the log pdf stored in lt code class quot highlighter rouge quot gt varinfo lt code gt by lt code class quot highlighter rouge quot gt lp lt code gt with that we can explain what happens to lt code class quot highlighter rouge quot gt lt code gt inside the lt code class quot highlighter rouge quot gt macro lt code gt using the old observe snippet as an example the lt code class quot highlighter rouge quot gt model lt code gt macro replaces lt code class quot highlighter rouge quot gt lt code gt with lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt acclogp lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt varinfo lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt logpdf lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt arraydist lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt negativebinomial2 lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily deaths m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt ts lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt ts lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt but we re iterating through lt code class quot highlighter rouge quot gt m lt code gt so this would not be thread safe since you might be two threads attempting to mutate lt code class quot highlighter rouge quot gt varinfo lt code gt simultaneously fn2 therefore since no threads sees the same lt code class quot highlighter rouge quot gt m lt code gt delaying the accumulation to after having computed all the log pdf in parallel leaves us with equivalent code that is threadsafe lt p gt lt p gt you can read more about the lt code class quot highlighter rouge quot gt macro lt code gt and its internals lt a href quot https turing ml dev docs for developers compiler model macro and modelgen quot gt here lt a gt lt p gt lt details gt lt h3 id quot final model quot gt final model lt h3 gt lt p gt this results in the following model definition lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot nd quot gt model lt span gt lt span class quot k quot gt function lt span gt lt span class quot nf quot gt model v2 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt int num of days for which to impute infections lt span gt lt span class quot n quot gt num total days lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt int days of observed data num of days to forecast lt span gt lt span class quot n quot gt cases lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt abstractvector amp lt abstractvector amp lt int reported cases lt span gt lt span class quot n quot gt deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt abstractvector amp lt abstractvector amp lt int reported deaths rows indexed by i amp gt n contain 1 and should be ignored lt span gt lt span class quot nb quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt abstractvector amp lt abstractvector amp lt real h s lt span gt lt span class quot n quot gt covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt vector amp lt abstractmatrix lt span gt lt span class quot n quot gt epidemic start lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt abstractvector amp lt int lt span gt lt span class quot n quot gt population lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt abstractvector amp lt real lt span gt lt span class quot n quot gt serial intervals lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt abstractvector amp lt real fixed pre calculated serial interval si using empirical data from neil lt span gt lt span class quot n quot gt lockdown index lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt int the index for the lockdown covariate in covariates lt span gt lt span class quot n quot gt predict lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt false lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt bool if false will only compute what s needed to observe but not more lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt type lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt vector lt span gt lt span class quot x quot gt lt span gt lt span class quot kt quot gt float64 lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt where lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt covariates should be of length num countries and each entry correspond to a matrix of size num total days num covariates lt span gt lt span class quot n quot gt num covariates lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt size lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 2 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt length lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num obs countries lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt length lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt if we don t want to predict the future we only need to compute up to time step num obs countries m lt span gt lt span class quot n quot gt last time steps lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt predict lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt fill lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num total days lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num obs countries lt span gt lt span class quot c quot gt latent variables lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt exponential lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot mf quot gt 0 03 lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt exponential has inverse parameterization of the one in stan lt span gt lt span class quot n quot gt y lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt filldist lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt exponential lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt truncated lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normal lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 5 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt inf lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt truncated lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normal lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 0 5 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt inf lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt filldist lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt truncated lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normal lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 3 28 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt inf lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt hier lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt filldist lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt gamma lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1667 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt hier lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt log lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 1 05 lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot mf quot gt 6 lt span gt lt span class quot n quot gt ifr noise lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt filldist lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt truncated lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normal lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 0 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt inf lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt lockdown related lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt truncated lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normal lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 0 2 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt inf lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lockdown lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt filldist lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normal lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt initialization of some quantities lt span gt lt span class quot n quot gt expected daily cases lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt undef lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt last time steps lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt m lt span gt lt span class quot k quot gt in lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases pred lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt undef lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt last time steps lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt m lt span gt lt span class quot k quot gt in lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily deaths lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt undef lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt last time steps lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt m lt span gt lt span class quot k quot gt in lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt undef lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt last time steps lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt m lt span gt lt span class quot k quot gt in lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt adj lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt undef lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt last time steps lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt m lt span gt lt span class quot k quot gt in lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt loops over countries and perform independent computations for each country lt span gt lt span class quot c quot gt since this model does not include any notion of migration across borders lt span gt lt span class quot c quot gt amp gt might has well wrap it in a threads to perform the computation in parallel lt span gt lt span class quot nd quot gt threads lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt m lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot c quot gt country specific parameters lt span gt lt span class quot n quot gt m lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt pop m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt population lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily cases m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt expected daily cases lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases pred m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cases pred lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily deaths m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt expected daily deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt rt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt adj m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt rt adj lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt last time step lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt last time steps lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt imputation of num impute days lt span gt lt span class quot n quot gt expected daily cases m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt y lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases pred m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt zero lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases pred m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases pred m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 2 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cumsum lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily cases m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt xs lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt last time step lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt extract covariates for the wanted time steps and country m lt span gt lt span class quot n quot gt rt m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt exp lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt xs lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt lockdown lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt xs lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lockdown index lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt adjusts for portion of pop that are susceptible lt span gt lt span class quot n quot gt rt adj m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt max lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt pop m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cases pred m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt zero lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases pred m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt pop m lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt rt m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt t lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt last time step lt span gt lt span class quot c quot gt update cumulative cases lt span gt lt span class quot n quot gt cases pred m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cases pred m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt expected daily cases m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt adjusts for portion of pop that are susceptible lt span gt lt span class quot n quot gt rt adj m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt max lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt pop m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cases pred m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt zero lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases pred m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt pop m lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt rt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily cases m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt rt adj m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt sum lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily cases m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt serial intervals lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt end lt span gt lt span class quot n quot gt expected daily deaths m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot mf quot gt 1e 15 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt expected daily cases m lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt t lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 2 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt last time step lt span gt lt span class quot n quot gt expected daily deaths m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt sum lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily cases m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt ifr noise lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt end lt span gt lt span class quot k quot gt end lt span gt lt span class quot c quot gt observe lt span gt lt span class quot c quot gt doing observations in parallel provides a small speedup lt span gt lt span class quot n quot gt logps lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt tv lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt undef lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot x quot gt lt span gt lt span class quot nd quot gt threads lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt m lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num countries lt span gt lt span class quot c quot gt extract the estimated expected daily deaths for country m lt span gt lt span class quot n quot gt expected daily deaths m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt expected daily deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt extract time steps for which we have observations lt span gt lt span class quot n quot gt ts lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt epidemic start lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num obs countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt observe lt span gt lt span class quot n quot gt logps lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt logpdf lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt arraydist lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt negativebinomial2 lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily deaths m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt ts lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt ts lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt end lt span gt lt span class quot n quot gt turing lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt acclogp lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt varinfo lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt sum lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt logps lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt return lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily cases lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt expected daily cases lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt expected daily deaths lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt expected daily deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt rt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt adjusted lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt rt adj lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt end lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt warning you are using the internal variable varinfo dynamicppl homes tef30 julia packages dynamicppl 3jy49 src compiler jl 175 lt code gt lt pre gt lt div gt lt div gt lt p gt we define an alias lt code class quot highlighter rouge quot gt model def lt code gt so that if we want to try out a different model there s only one point in the notebook which we need to change lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt model def lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt model v2 lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt the input data have up to 30 40 days of unobserved future data which we might want to predict on but during sampling we don t want to waste computation on sampling for the future for which we do not have any observations therefore we have an argument lt code class quot highlighter rouge quot gt predict bool lt code gt in the model which allows us to specify whether or not to generate future quantities lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot c quot gt model instantance used to for inference lt span gt lt span class quot n quot gt m no pred lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt model def lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num total days lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cases lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt epidemic start lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt population lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt serial intervals lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lockdown index lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt false lt span gt lt span class quot c quot gt amp lt don t predict lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot c quot gt model instance used for prediction lt span gt lt span class quot n quot gt m lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt model def lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num total days lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cases lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt epidemic start lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt population lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt serial intervals lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lockdown index lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt true lt span gt lt span class quot c quot gt amp lt predict lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt just to make sure everything is working we can evaluate the model to obtain a sample from the prior lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt res lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt res lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt expected daily cases lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt uk index lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt 100 element array float64 1 0 2978422827487166 0 2978422827487166 0 2978422827487166 0 2978422827487166 0 2978422827487166 0 2978422827487166 0 832817101553483 1 0346063917235566 1 3678178161493468 1 8604943842674377 2 546129501657631 3 4852378065416523 4 768875412263893 0 24406116233616038 0 17186744515247868 0 1208474970159245 0 08485139699103932 0 05949579772505278 0 04166274540068994 0 029138775736189983 0 02035555519759347 0 014203911930339133 0 009900796534873262 0 00689432670057081 0 004796166095549548 lt code gt lt pre gt lt div gt lt div gt lt h1 id quot visualization utilities quot gt visualization utilities lt h1 gt lt p gt for visualisation we of course use lt a href quot https github com juliaplots plots jl quot gt plots jl lt a gt and in this case we re going to use the lt code class quot highlighter rouge quot gt pyplot lt code gt backend which uses python s matplotlib under the hood lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot k quot gt using lt span gt lt span class quot n quot gt plots lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt statsplots lt span gt lt code gt lt pre gt lt div gt lt div gt lt details gt lt summary gt lt p gt method definition for plotting the predictive distribution lt p gt lt summary gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot c quot gt ehh this can be made nicer lt span gt lt span class quot k quot gt function lt span gt lt span class quot nf quot gt country prediction plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt predictions country lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt abstractmatrix lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt e deaths country lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt abstractmatrix lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt country lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt abstractmatrix lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normalize pop lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt bool lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt false lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt main title lt span gt lt span class quot o quot gt lt span gt lt span class quot s quot gt quot quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt pop lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt population lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num total days lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num total days lt span gt lt span class quot n quot gt num observed days lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt length lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cases lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country name lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt start date lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt first lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country to dates lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country name lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt dates lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cumsum lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt fill lt span gt lt span class quot x quot gt lt span gt lt span class quot kt quot gt day lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num total days lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt start date lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt day lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt date strings lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt dates lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt format lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt dates lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot y mm dd quot lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt a tiny bit of preprocessing of the data lt span gt lt span class quot n quot gt preproc lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt x lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt normalize pop lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt x lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt pop lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt x lt span gt lt span class quot n quot gt daily deaths lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily cases lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cases lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt p1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt xaxis lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt false lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt legend lt span gt lt span class quot o quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt topleft lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt bar lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt preproc lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt label lt span gt lt span class quot o quot gt lt span gt lt span class quot s quot gt quot observed daily deaths quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt title lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt replace lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country name lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot quot lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot s quot gt quot quot lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot s quot gt quot quot lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt main title lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt vline lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt epidemic start lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt label lt span gt lt span class quot o quot gt lt span gt lt span class quot s quot gt quot epidemic start quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt linewidth lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 2 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt vline lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num observed days lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt label lt span gt lt span class quot o quot gt lt span gt lt span class quot s quot gt quot end of observations quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt linewidth lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 2 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt xlims lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num total days lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt p2 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt legend lt span gt lt span class quot o quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt topleft lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt xaxis lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt false lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt plot confidence timeseries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt p2 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt preproc lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt e deaths country lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt label lt span gt lt span class quot o quot gt lt span gt lt span class quot s quot gt quot expected daily deaths quot lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt title quot expected daily deaths pred quot lt span gt lt span class quot n quot gt bar lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt preproc lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt label lt span gt lt span class quot o quot gt lt span gt lt span class quot s quot gt quot recorded daily deaths observed quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt alpha lt span gt lt span class quot o quot gt lt span gt lt span class quot mf quot gt 0 5 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt p3 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt legend lt span gt lt span class quot o quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt bottomleft lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt xaxis lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt false lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt plot confidence timeseries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt p3 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt country lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt no label lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt true lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c idx lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c time lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt in lt span gt lt span class quot n quot gt enumerate lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt findfirst lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt eachcol lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt if lt span gt lt span class quot n quot gt c time lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt nothing lt span gt lt span class quot n quot gt c name lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt names covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c idx lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt if lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c name lt span gt lt span class quot o quot gt lt span gt lt span class quot s quot gt quot any quot lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt don t add the quot any intervention quot stuff lt span gt lt span class quot n quot gt vline lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c time lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt label lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt c name lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt end lt span gt lt span class quot k quot gt end lt span gt lt span class quot k quot gt end lt span gt lt span class quot n quot gt title lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot rt quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt qs lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt quantile lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt v lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 0 025 lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 0 975 lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt v lt span gt lt span class quot k quot gt in lt span gt lt span class quot n quot gt eachrow lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt country lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lq lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt hq lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt eachrow lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt hcat lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt qs lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt ylims lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt maximum lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt hq lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot mf quot gt 0 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt p4 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt legend lt span gt lt span class quot o quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt topleft lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt xaxis lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt false lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt plot confidence timeseries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt p4 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt preproc lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt predictions country lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt label lt span gt lt span class quot o quot gt lt span gt lt span class quot s quot gt quot expected daily cases quot lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt title quot expected daily cases pred quot lt span gt lt span class quot n quot gt bar lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt preproc lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily cases lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt label lt span gt lt span class quot o quot gt lt span gt lt span class quot s quot gt quot recorded daily cases observed quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt alpha lt span gt lt span class quot o quot gt lt span gt lt span class quot mf quot gt 0 5 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt vals lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt preproc lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cumsum lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt e deaths country lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt dims lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt p5 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt legend lt span gt lt span class quot o quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt topleft lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt xaxis lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt false lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt plot confidence timeseries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt p5 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt vals lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt label lt span gt lt span class quot o quot gt lt span gt lt span class quot s quot gt quot expected deaths quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt preproc lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cumsum lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt label lt span gt lt span class quot o quot gt lt span gt lt span class quot s quot gt quot recorded deaths observed quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt color lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt red lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt title quot expected deaths pred quot lt span gt lt span class quot n quot gt vals lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt preproc lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cumsum lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt predictions country lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt dims lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt p6 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt legend lt span gt lt span class quot o quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt topleft lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt plot confidence timeseries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt p6 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt vals lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt label lt span gt lt span class quot o quot gt lt span gt lt span class quot s quot gt quot expected cases quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt preproc lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily cases lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt label lt span gt lt span class quot o quot gt lt span gt lt span class quot s quot gt quot recorded cases observed quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt color lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt red lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt title quot expected cases pred quot lt span gt lt span class quot n quot gt p lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt p1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt p3 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt p2 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt p4 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt p5 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt p6 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt layout lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 6 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt size lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 900 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1200 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt sharex lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt true lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt xticks lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 3 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num total days lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt date strings lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 3 lt span gt lt span class quot o quot gt lt span gt lt span class quot k quot gt end lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt xrotation lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 45 lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt return lt span gt lt span class quot n quot gt p lt span gt lt span class quot k quot gt end lt span gt lt span class quot k quot gt function lt span gt lt span class quot nf quot gt country prediction plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt e deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt kwargs lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt n lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt length lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt e deaths country lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt hcat lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt e deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt t lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt n lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt country lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt hcat lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt t lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt n lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt predictions country lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt hcat lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cases lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt t lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt n lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt return lt span gt lt span class quot n quot gt country prediction plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt predictions country lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt e deaths country lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt country lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt kwargs lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt end lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt country prediction plot generic function with 2 methods lt code gt lt pre gt lt div gt lt div gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot k quot gt function lt span gt lt span class quot nf quot gt arrarrarr2arr lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt a lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt abstractvector lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt amp lt lt span gt lt span class quot kt quot gt abstractvector lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt amp lt lt span gt lt span class quot kt quot gt abstractvector lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt where lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot o quot gt amp lt lt span gt lt span class quot kt quot gt real lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt n1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt n2 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt n3 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt length lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt a lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt length lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt first lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt a lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt length lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt first lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt first lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt a lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt a lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt zeros lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt n1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt n2 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt n3 lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt i lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt n1 lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt j lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt n2 lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt k lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt n3 lt span gt lt span class quot n quot gt a lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt i lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt j lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt k lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt a lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt i lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt j lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt k lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt end lt span gt lt span class quot k quot gt end lt span gt lt span class quot k quot gt end lt span gt lt span class quot k quot gt return lt span gt lt span class quot n quot gt a lt span gt lt span class quot k quot gt end lt span gt lt span class quot k quot gt function lt span gt lt span class quot nf quot gt country cumulative prediction lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt vals lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt abstractarray lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt amp lt lt span gt lt span class quot kt quot gt real lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 3 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normalize pop lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt false lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt no label lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt false lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt kwargs lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lqs lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt mqs lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt hqs lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt labels lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot k quot gt in lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt length lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt val lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt vals lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt n lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt size lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt val lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt pop lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt population lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt num total days lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num total days lt span gt lt span class quot n quot gt num observed days lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt length lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cases lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country name lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt a tiny bit of preprocessing of the data lt span gt lt span class quot n quot gt preproc lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt x lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt normalize pop lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt x lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt pop lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt x lt span gt lt span class quot n quot gt tmp lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt preproc lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt cumsum lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt val lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt dims lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt qs lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt quantile lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt tmp lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt t lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 0 025 lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 0 5 lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 0 975 lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt t lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt n lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lq lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt mq lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt hq lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt eachrow lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt hcat lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt qs lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt push lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lqs lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lq lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt push lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt mqs lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt mq lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt push lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt hqs lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt hq lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt push lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt labels lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country name lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt end lt span gt lt span class quot n quot gt lqs lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt reduce lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt hcat lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt collect lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lqs lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt mqs lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt reduce lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt hcat lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt collect lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt mqs lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt hqs lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt reduce lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt hcat lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt collect lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt hqs lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt p lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt kwargs lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot k quot gt in lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt length lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt countries lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt label lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt no label lt span gt lt span class quot o quot gt lt span gt lt span class quot s quot gt quot quot lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt labels lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt mqs lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt ribbon lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt mqs lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt lqs lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt hqs lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt mqs lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country idx lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt label lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt label lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt end lt span gt lt span class quot k quot gt return lt span gt lt span class quot n quot gt p lt span gt lt span class quot k quot gt end lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt country cumulative prediction generic function with 1 method lt code gt lt pre gt lt div gt lt div gt lt details gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt daily deaths arr lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt arrarrarr2arr lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily deaths posterior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily deaths arr lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt permutedims lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily deaths arr lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 2 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 3 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily cases arr lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt arrarrarr2arr lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily cases posterior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily cases arr lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt permutedims lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily cases arr lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 2 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 3 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt 14 100 4000 array float64 3 1 31 6314 31 6314 31 6314 31 6314 156 61 151 178 35 2791 35 2791 35 2791 35 2791 3646 08 3431 64 5 82819 5 82819 5 82819 5 82819 6416 22 6282 52 32 4507 32 4507 32 4507 32 4507 9749 19 9408 06 33 8585 33 8585 33 8585 33 8585 6107 9 5812 33 14 4027 14 4027 14 4027 14 4027 13849 1 13444 2 13 4485 13 4485 13 4485 13 4485 73 396 70 6272 5 32057 5 32057 5 32057 5 32057 45867 8 45212 0 31 3424 31 3424 31 3424 31 3424 191 955 186 097 93 6691 93 6691 93 6691 93 6691 53568 5 53719 7 25 9993 25 9993 25 9993 25 9993 130 31 122 522 63 4528 63 4528 63 4528 63 4528 0 135277 0 120549 30 3088 30 3088 30 3088 30 3088 86 6885 82 4991 58 7329 58 7329 58 7329 58 7329 364 967 341 81 2 21 8248 21 8248 21 8248 21 8248 59 4495 56 6651 17 6305 17 6305 17 6305 17 6305 2751 21 2577 23 17 5398 17 5398 17 5398 17 5398 2514 87 2422 85 39 3773 39 3773 39 3773 39 3773 2572 54 2435 6 13 8745 13 8745 13 8745 13 8745 7143 99 6796 27 2 43846 2 43846 2 43846 2 43846 21861 8 21394 1 16 6948 16 6948 16 6948 16 6948 12 4779 11 7615 7 64907 7 64907 7 64907 7 64907 43911 9 43155 0 54 9893 54 9893 54 9893 54 9893 164 217 158 063 96 3331 96 3331 96 3331 96 3331 52492 8 52575 9 6 69537 6 69537 6 69537 6 69537 291 955 278 593 41 8925 41 8925 41 8925 41 8925 0 0549723 0 0484776 10 4633 10 4633 10 4633 10 4633 1133 48 1110 4 53 9036 53 9036 53 9036 53 9036 285 281 266 222 3 45 2317 45 2317 45 2317 45 2317 61 406 58 6976 29 357 29 357 29 357 29 357 3176 11 2995 15 30 394 30 394 30 394 30 394 1196 45 1139 83 125 299 125 299 125 299 125 299 6239 52 5961 07 36 4959 36 4959 36 4959 36 4959 4289 44 4052 54 19 2367 19 2367 19 2367 19 2367 19999 4 19513 5 16 405 16 405 16 405 16 405 13 0237 12 2817 15 1937 15 1937 15 1937 15 1937 36906 7 36324 8 47 9864 47 9864 47 9864 47 9864 198 327 192 355 145 876 145 876 145 876 145 876 95512 4 93517 3 12 7606 12 7606 12 7606 12 7606 140 283 132 076 84 0577 84 0577 84 0577 84 0577 0 0887854 0 078702 66 317 66 317 66 317 66 317 26 8103 25 0513 50 1513 50 1513 50 1513 50 1513 385 437 362 086 3998 40 6005 40 6005 40 6005 40 6005 41 3201 39 257 37 4406 37 4406 37 4406 37 4406 5168 87 4928 88 6 66627 6 66627 6 66627 6 66627 1796 71 1724 79 19 2496 19 2496 19 2496 19 2496 2893 68 2735 41 21 6056 21 6056 21 6056 21 6056 13520 2 13034 5 4 69097 4 69097 4 69097 4 69097 12729 8 12386 1 42 8182 42 8182 42 8182 42 8182 326 627 322 394 7 19116 7 19116 7 19116 7 19116 50203 4 49797 1 26 3942 26 3942 26 3942 26 3942 263 88 256 656 53 6565 53 6565 53 6565 53 6565 83072 5 82676 3 24 4936 24 4936 24 4936 24 4936 153 229 144 346 46 8848 46 8848 46 8848 46 8848 3 16499 2 94815 74 0729 74 0729 74 0729 74 0729 34 9909 32 6986 84 5948 84 5948 84 5948 84 5948 600 202 567 397 3999 17 5754 17 5754 17 5754 17 5754 246 31 239 819 46 9688 46 9688 46 9688 46 9688 2641 87 2474 16 5 1029 5 1029 5 1029 5 1029 2141 21 2071 62 30 5983 30 5983 30 5983 30 5983 2429 53 2299 52 15 1354 15 1354 15 1354 15 1354 15339 1 14856 2 12 5852 12 5852 12 5852 12 5852 19716 9 19184 8 20 7569 20 7569 20 7569 20 7569 198 359 193 751 9 44519 9 44519 9 44519 9 44519 67919 1 66470 7 46 0889 46 0889 46 0889 46 0889 106 309 102 061 87 7028 87 7028 87 7028 87 7028 103695 0 102949 0 34 3861 34 3861 34 3861 34 3861 299 303 285 163 114 996 114 996 114 996 114 996 0 367775 0 332197 51 0231 51 0231 51 0231 51 0231 306 67 296 26 95 074 95 074 95 074 95 074 683 525 647 794 4000 41 9978 41 9978 41 9978 41 9978 267 147 260 315 29 6776 29 6776 29 6776 29 6776 6149 86 5851 81 45 4262 45 4262 45 4262 45 4262 2766 05 2682 29 67 3271 67 3271 67 3271 67 3271 3339 49 3174 33 72 374 72 374 72 374 72 374 13353 4 12889 1 5 65709 5 65709 5 65709 5 65709 39438 8 38904 1 17 4738 17 4738 17 4738 17 4738 49 7947 47 6519 16 4718 16 4718 16 4718 16 4718 33295 2 32990 2 65 9772 65 9772 65 9772 65 9772 199 27 193 239 87 5592 87 5592 87 5592 87 5592 32651 7 32673 7 11 5608 11 5608 11 5608 11 5608 480 357 461 34 88 1057 88 1057 88 1057 88 1057 0 0795788 0 070559 27 258 27 258 27 258 27 258 97 7505 92 8548 28 6621 28 6621 28 6621 28 6621 577 574 545 546 lt code gt lt pre gt lt div gt lt div gt lt p gt to make the plots interactive we re going to use the lt a href quot https github com sglyon plotlyjs jl quot gt lt code class quot highlighter rouge quot gt plotlyjs jl lt code gt lt a gt backend which generates lt a href quot https github com plotly plotly js quot gt plotly js lt a gt plots under the hood lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt plotlyjs lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt plots plotlyjsbackend lt code gt lt pre gt lt div gt lt div gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt country cumulative prediction lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily deaths arr lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt size lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 800 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 300 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt title lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot expected deaths 95 intervals quot lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div id quot plot1 quot class quot plotly quot gt lt div gt lt script gt plotly d3 json quot assets figures 2020 05 04 imperial report13 analysis plot1 json quot function err fig plotly plot quot plot1 quot fig data fig layout responsive true lt script gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt country cumulative prediction lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily deaths arr lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normalize pop lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt true lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt size lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 800 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 300 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt title lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot expected deaths population 95 intervals quot lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div id quot plot2 quot class quot plotly quot gt lt div gt lt script gt plotly d3 json quot assets figures 2020 05 04 imperial report13 analysis plot2 json quot function err fig plotly plot quot plot2 quot fig data fig layout responsive true lt script gt lt p gt in the following sections we re instead going to use lt code class quot highlighter rouge quot gt pyplot jl lt code gt as backend which uses python s lt code class quot highlighter rouge quot gt matplotlib lt code gt under the hood instead of lt code class quot highlighter rouge quot gt plotly js lt code gt since too many lt code class quot highlighter rouge quot gt plotly js lt code gt plots can slow down even the finest of computers lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt pyplot lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt plots pyplotbackend lt code gt lt pre gt lt div gt lt div gt lt h1 id quot prior quot gt prior lt h1 gt lt p gt before we do any inference it can be useful to inspect the lt em gt prior lt em gt distribution in particular if you are working with a hierarchical model where the dependencies in the prior might lead to some unexpected behavior in turing jl you can sample a chain from the prior using lt code class quot highlighter rouge quot gt sample lt code gt much in the same way as you would sample from the posterior lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt chain prior lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt sample lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt turing lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt inference lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt priorsampler lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 000 lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt chain prior lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 5 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt linewidth lt span gt lt span class quot o quot gt lt span gt lt span class quot mf quot gt 1 5 lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis uk prior kappa phi tau sample plot png quot alt quot nil quot gt lt p gt lt p gt for the same reasons it can be very useful to inspect the lt em gt prior predictive lt em gt distribution lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot c quot gt compute the quot generated quantities quot for the prior lt span gt lt span class quot n quot gt generated prior lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt vectup2tupvec lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt generated quantities lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt chain prior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily cases prior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily deaths prior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt prior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt adj prior lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt generated prior lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt country prediction plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt uk index lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily cases prior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily deaths prior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt prior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt main title lt span gt lt span class quot o quot gt lt span gt lt span class quot s quot gt quot prior quot lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis uk predictive prior rt png quot alt quot nil quot gt lt p gt lt p gt and with the rt lt em gt adjusted for remaining population lt em gt lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt country prediction plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt uk index lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily cases prior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily deaths prior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt adj prior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt main title lt span gt lt span class quot o quot gt lt span gt lt span class quot s quot gt quot prior quot lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt at this point it might be useful to remind ourselves of the total population of uk is lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt population lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt uk index lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt 67886004 lt code gt lt pre gt lt div gt lt div gt lt p gt as we can see from the figures the prior allows scenarios such as lt p gt lt ul gt lt li gt lt em gt all lt em gt of the uk being infected lt li gt lt li gt effects of interventions e g lt code class quot highlighter rouge quot gt lockdown lt code gt having a lt em gt negative lt em gt effect on lt code class quot highlighter rouge quot gt rt lt code gt in the sense that it can actually lt em gt increase lt em gt the spread of the virus you can see this from the fact that the 95 confidence interval widens after one of the interventions lt li gt lt ul gt lt p gt but at the same time it s clear that a very sudden increase from 0 to 100 of the population being infected is almost impossible under the prior all in all the model prior seems a reasonable choice it allows for extreme situations without putting too much probabilty mass on those while still encoding some structure in the model lt p gt lt h1 id quot posterior inference quot gt posterior inference lt h1 gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt parameters lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt warmup lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1000 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt steps lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 3000 lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt h2 id quot inference quot gt inference lt h2 gt lt h3 id quot run quot gt run lt h3 gt lt p gt to perform inference for the model we would simply run the code below lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt chains posterior lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt sample lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m no pred lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt nuts lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt parameters lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt warmup lt span gt lt span class quot x quot gt lt span gt lt span class quot mf quot gt 0 95 lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 10 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt parameters lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt steps lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt parameters lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt warmup lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt lt em gt but lt em gt unfortunately it takes quite a while to run performing inference using lt code class quot highlighter rouge quot gt nuts lt code gt with lt code class quot highlighter rouge quot gt 1000 lt code gt steps for adaptation warmup and lt code class quot highlighter rouge quot gt 3000 lt code gt sample steps takes 2hrs on a 6 core computer with lt code class quot highlighter rouge quot gt julia num threads 6 lt code gt and so we re instead going to load in the chains needed lt p gt lt p gt in contrast lt code class quot highlighter rouge quot gt stan lt code gt only takes roughly 1hr lt em gt on a single thread lt em gt using the base model from the repository on a single thread lt code class quot highlighter rouge quot gt turing jl lt code gt is 4 5x slower for this model which is quite signficant lt p gt lt p gt this generally means that if you have a clear model in mind or you re already very familiar with lt code class quot highlighter rouge quot gt stan lt code gt you probably want to use lt code class quot highlighter rouge quot gt stan lt code gt for these kind of models on the other hand if you re in the process of heavily tweaking your model and need to be able to do lt code class quot highlighter rouge quot gt m model data m lt code gt to check if it works or you want more flexibility in what you can do with your model e g discrete variables lt code class quot highlighter rouge quot gt turing jl lt code gt might be a good option lt p gt lt p gt and this is an additional reason why we wanted to perform this replication study we want lt code class quot highlighter rouge quot gt turing jl lt code gt to be lt em gt useful lt em gt and the way to check this is by applying lt code class quot highlighter rouge quot gt turing jl lt code gt to real world problem rather than lt em gt just lt em gt benchmarks though those are important too lt p gt lt p gt and regarding the performance difference it really comes down to the difference in implementation of automatic differentation ad lt code class quot highlighter rouge quot gt turing jl lt code gt allows you to choose from the goto ad packages in julia e g in our runs we used lt a href quot https github com juliadiff forwarddiff jl quot gt forwarddiff jl lt a gt while lt code class quot highlighter rouge quot gt stan lt code gt as a very very fast ad implementation written exclusively for lt code class quot highlighter rouge quot gt stan lt code gt this difference becomes very clear in models such as this one where we have a lot of for loops and recursive relationships because this means that we can t easily vectorize for loops in julia are generally blazingly fast but with ad there s a bit of overhead but that also means that in lt code class quot highlighter rouge quot gt turing jl lt code gt you have the ability to choose between different approaches to ad i e forward mode or reverse mode each with their different tradeoffs and thus will benefit from potentially interesting future work e g source to source ad using lt a href quot https github com fluxml zygote jl quot gt zygote jl lt a gt lt sup id quot fnref fn3 quot role quot doc noteref quot gt lt a href quot fn fn3 quot class quot footnote quot gt 2 lt a gt lt sup gt lt p gt lt p gt and one interesting tidbit is that you can very easily use lt code class quot highlighter rouge quot gt pystan lt code gt within lt code class quot highlighter rouge quot gt pycall jl lt code gt to sample from a lt code class quot highlighter rouge quot gt stan lt code gt model and then convert the results into a lt a href quot https github com turinglang mcmcchains jl quot gt mcmcchains jl lt a gt this has some nice implications lt p gt lt ul gt lt li gt we can use all the convenient posterior analysis tools available in mcmcchains jl to analyze chains from lt code class quot highlighter rouge quot gt stan lt code gt lt li gt lt li gt we can use the lt code class quot highlighter rouge quot gt generated quantities lt code gt method in this notebook to execute the lt code class quot highlighter rouge quot gt turing jl lt code gt lt code class quot highlighter rouge quot gt model lt code gt on the samples obtain using lt code class quot highlighter rouge quot gt stan lt code gt lt li gt lt ul gt lt p gt this was quite useful for us to be able validate the results from lt code class quot highlighter rouge quot gt turing jl lt code gt against those from lt code class quot highlighter rouge quot gt stan lt code gt and made it very easy to check that indeed lt code class quot highlighter rouge quot gt turing jl lt code gt and lt code class quot highlighter rouge quot gt stan lt code gt produce the same results you can find examples of this in the lt a href quot https github com turinglang covid19 quot gt notebooks in our repository lt a gt lt p gt lt details gt lt summary gt lt p gt sampling from lt code class quot highlighter rouge quot gt stan lt code gt in julia using lt code class quot highlighter rouge quot gt pystan lt code gt lt p gt lt summary gt lt p gt first we import lt code class quot highlighter rouge quot gt pycall lt code gt allowing us to call python code from within julia lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot k quot gt using lt span gt lt span class quot n quot gt pycall lt span gt lt span class quot k quot gt using lt span gt lt span class quot n quot gt pycall lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt pyimport lt span gt lt span class quot n quot gt pystan lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt pyimport lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot pystan quot lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt then we define the stan model as a string lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt model str lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt raw lt span gt lt span class quot s quot gt quot quot quot data int amp lt lower 1 amp gt m number of countries int amp lt lower 1 amp gt p number of covariates int amp lt lower 1 amp gt n0 number of days for which to impute infections int amp lt lower 1 amp gt n m days of observed data for country m each entry must be amp lt n2 int amp lt lower 1 amp gt n2 days of observed data of days to forecast int cases n2 m reported cases int deaths n2 m reported deaths the rows with i amp gt n contain 1 and should be ignored matrix n2 m f h s matrix n2 p x m features matrix int epidemicstart m real pop m real si n2 fixed pre calculated si using emprical data from neil transformed data vector n2 si rev si in reverse order vector n2 f rev m f in reversed order for i in 1 n2 si rev i si n2 i 1 for m in 1 m for i in 1 n2 f rev m i f n2 i 1 m parameters real amp lt lower 0 amp gt mu m intercept for rt real amp lt lower 0 amp gt alpha hier p sudo parameter for the hier term for alpha real amp lt lower 0 amp gt gamma vector m lockdown real amp lt lower 0 amp gt kappa real amp lt lower 0 amp gt y m real amp lt lower 0 amp gt phi real amp lt lower 0 amp gt tau real amp lt lower 0 amp gt ifr noise m transformed parameters vector p alpha matrix n2 m prediction rep matrix 0 n2 m matrix n2 m e deaths rep matrix 0 n2 m matrix n2 m rt rep matrix 0 n2 m matrix n2 m rt adj rt matrix n2 m cumm sum rep matrix 0 n2 m for i in 1 p alpha i alpha hier i log 1 05 6 0 for m in 1 m prediction 1 n0 m rep vector y m n0 learn the number of cases in the first n0 days cumm sum 2 n0 m cumulative sum prediction 2 n0 m rt m mu m exp x m alpha x m 5 lockdown m rt adj 1 n0 m rt 1 n0 m for i in n0 1 n2 real convolution dot product sub col prediction 1 m i 1 tail si rev i 1 cumm sum i m cumm sum i 1 m prediction i 1 m rt adj i m pop m cumm sum i m pop m rt i m prediction i m rt adj i m convolution e deaths 1 m 1e 15 prediction 1 m for i in 2 n2 e deaths i m ifr noise m dot product sub col prediction 1 m i 1 tail f rev m i 1 model tau exponential 0 03 for m in 1 m y m exponential 1 tau gamma normal 0 2 lockdown normal 0 gamma phi normal 0 5 kappa normal 0 0 5 mu normal 3 28 kappa citation https academic oup com jtm article 27 2 taaa021 5735319 alpha hier gamma 1667 1 ifr noise normal 1 0 1 for m in 1 m deaths epidemicstart m n m m neg binomial 2 e deaths epidemicstart m n m m phi generated quantities matrix n2 m prediction0 rep matrix 0 n2 m matrix n2 m e deaths0 rep matrix 0 n2 m matrix n2 m cumm sum0 rep matrix 0 n2 m for m in 1 m for i in 2 n0 cumm sum0 i m cumm sum0 i 1 m y m prediction0 1 n0 m rep vector y m n0 for i in n0 1 n2 real convolution0 dot product sub col prediction0 1 m i 1 tail si rev i 1 cumm sum0 i m cumm sum0 i 1 m prediction0 i 1 m prediction0 i m pop m cumm sum0 i m pop m mu m convolution0 e deaths0 1 m 1e 15 prediction0 1 m for i in 2 n2 e deaths0 i m ifr noise m dot product sub col prediction0 1 m i 1 tail f rev m i 1 quot quot quot lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt we need the data to be in a format compatible with the stan model which we can accomplish by converting lt code class quot highlighter rouge quot gt rdata lt code gt into a lt code class quot highlighter rouge quot gt dict lt code gt lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt d lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt dict lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt k lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rdata lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt k lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt k lt span gt lt span class quot k quot gt in lt span gt lt span class quot n quot gt keys lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rdata lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt values df and keys df have different ordering so don t do dict keys df values df lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt then we can compile the lt code class quot highlighter rouge quot gt stan lt code gt model lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt sm lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt pystan lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt stanmodel lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt model code lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt model str lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt and finally fit lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt fit stan lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt n iters lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 300 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt warmup lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 100 lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt sm lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt sampling lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt d lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt iter lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt n iters lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt chains lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt warmup lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt warmup lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt algorithm lt span gt lt span class quot o quot gt lt span gt lt span class quot s quot gt quot nuts quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt control lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt dict lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot adapt delta quot lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot mf quot gt 0 95 lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot max treedepth quot lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot mi quot gt 10 lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt f lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt fit stan lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt parameters lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt steps lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt parameters lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt warmup lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt parameters lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt warmup lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt from the fit we can extract the inferred parameters lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt la lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt f lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt extract lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt permuted lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt true lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt or if you ve done this before and saved the results using lt code class quot highlighter rouge quot gt serialization jl lt code gt you can load the results lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot k quot gt using lt span gt lt span class quot n quot gt serialization lt span gt lt span class quot n quot gt stan chain fname lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt first lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt s lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt s lt span gt lt span class quot k quot gt in lt span gt lt span class quot n quot gt readdir lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt outdir lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt if lt span gt lt span class quot n quot gt occursin lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot stan quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt s lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt la lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt open lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt io lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot n quot gt deserialize lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt io lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt outdir lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt stan chain fname lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot r quot lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt dict any any with 17 entries quot e deaths quot amp gt 6 52866e 14 5 9334e 7 2 40106 2 31387 4 77975e 14 3 5296 quot ifr noise quot amp gt 0 890352 1 05228 1 19123 0 833645 0 723459 1 03243 0 8 quot alpha quot amp gt 0 00813169 0 00812908 0 723476 0 00112684 0 237363 0 quot e deaths0 quot amp gt 6 52866e 14 5 9334e 7 83 0411 71 0609 4 77975e 14 3 5296 quot tau quot amp gt 53 4179 96 0101 38 1312 68 78 49 8292 45 3714 80 3358 quot rt adj quot amp gt 3 69848 3 69848 0 762185 0 762171 4 19599 4 19599 0 77 quot mu quot amp gt 3 69848 3 8664 3 68493 4 11784 4 19599 3 8219 4 09925 quot prediction0 quot amp gt 65 2866 65 2866 1 56204 1 22123 47 7975 47 7975 0 1296 quot lp quot amp gt 560668 0 560680 0 560685 0 560670 0 560671 0 560694 0 quot kappa quot amp gt 1 05947 0 913342 1 05901 1 17966 1 12473 1 21213 0 99 quot alpha hier quot amp gt 1 73288e 16 2 6161e 6 0 731608 0 00700485 0 245495 0 023 quot prediction quot amp gt 65 2866 65 2866 106 091 102 225 47 7975 47 7975 206 13 quot phi quot amp gt 6 8105 7 36518 6 41771 7 13139 6 70706 7 06452 7 0425 quot gamma quot amp gt 0 107149 0 129599 0 118666 0 274338 0 179847 0 0386703 quot lockdown quot amp gt 0 0199127 0 0841175 0 0854961 0 245588 0 00700599 0 02 quot rt quot amp gt 3 69848 3 69848 0 770378 0 770378 4 19599 4 19599 0 78 quot y quot amp gt 65 2866 22 1974 75 7377 63 0177 47 7975 27 7832 48 400 lt code gt lt pre gt lt div gt lt div gt lt p gt and if we want to compare it with the results from lt code class quot highlighter rouge quot gt turing jl lt code gt it can be convenient to rename some of the variables lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt rename lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt la lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot alpha quot lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot s quot gt quot quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot alpha hier quot lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot s quot gt quot hier quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot kappa quot lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot s quot gt quot quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot gamma quot lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot s quot gt quot quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot mu quot lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot s quot gt quot quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot phi quot lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot s quot gt quot quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot tau quot lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot s quot gt quot quot lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt dict any any with 17 entries quot hier quot amp gt 1 73288e 16 2 6161e 6 0 731608 0 00700485 0 245495 0 023 quot quot amp gt 3 69848 3 8664 3 68493 4 11784 4 19599 3 8219 4 09925 quot e deaths quot amp gt 6 52866e 14 5 9334e 7 2 40106 2 31387 4 77975e 14 3 5296 quot ifr noise quot amp gt 0 890352 1 05228 1 19123 0 833645 0 723459 1 03243 0 8 quot quot amp gt 6 8105 7 36518 6 41771 7 13139 6 70706 7 06452 7 0425 quot e deaths0 quot amp gt 6 52866e 14 5 9334e 7 83 0411 71 0609 4 77975e 14 3 5296 quot quot amp gt 0 00813169 0 00812908 0 723476 0 00112684 0 237363 0 quot quot amp gt 1 05947 0 913342 1 05901 1 17966 1 12473 1 21213 0 99 quot rt adj quot amp gt 3 69848 3 69848 0 762185 0 762171 4 19599 4 19599 0 77 quot quot amp gt 0 107149 0 129599 0 118666 0 274338 0 179847 0 0386703 quot prediction0 quot amp gt 65 2866 65 2866 1 56204 1 22123 47 7975 47 7975 0 1296 quot quot amp gt 53 4179 96 0101 38 1312 68 78 49 8292 45 3714 80 3358 quot lp quot amp gt 560668 0 560680 0 560685 0 560670 0 560671 0 560694 0 quot prediction quot amp gt 65 2866 65 2866 106 091 102 225 47 7975 47 7975 206 13 quot lockdown quot amp gt 0 0199127 0 0841175 0 0854961 0 245588 0 00700599 0 02 quot rt quot amp gt 3 69848 3 69848 0 770378 0 770378 4 19599 4 19599 0 78 quot y quot amp gt 65 2866 22 1974 75 7377 63 0177 47 7975 27 7832 48 400 lt code gt lt pre gt lt div gt lt div gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot c quot gt extract a subset of the variables since we don t want everything in a chains object lt span gt lt span class quot n quot gt la subset lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt dict lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt k lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot n quot gt la lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt k lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt k lt span gt lt span class quot k quot gt in lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot y quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot hier quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot ifr noise quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot lockdown quot lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt dict string array float64 n where n with 9 entries quot hier quot amp gt 1 73288e 16 2 6161e 6 0 731608 0 00700485 0 245495 0 02364 quot quot amp gt 3 69848 3 8664 3 68493 4 11784 4 19599 3 8219 4 09925 3 quot quot amp gt 0 107149 0 129599 0 118666 0 274338 0 179847 0 0386703 quot quot amp gt 53 4179 96 0101 38 1312 68 78 49 8292 45 3714 80 3358 quot quot amp gt 6 8105 7 36518 6 41771 7 13139 6 70706 7 06452 7 04253 quot ifr noise quot amp gt 0 890352 1 05228 1 19123 0 833645 0 723459 1 03243 0 892 quot quot amp gt 1 05947 0 913342 1 05901 1 17966 1 12473 1 21213 0 9978 quot lockdown quot amp gt 0 0199127 0 0841175 0 0854961 0 245588 0 00700599 0 0258 quot y quot amp gt 65 2866 22 1974 75 7377 63 0177 47 7975 27 7832 48 4006 lt code gt lt pre gt lt div gt lt div gt lt p gt in lt code class quot highlighter rouge quot gt covid19 jl lt code gt we ve added a constructor for lt code class quot highlighter rouge quot gt mcmcchains chains lt code gt which takes a lt code class quot highlighter rouge quot gt dict lt code gt as an argument easily allowing us to convert the lt code class quot highlighter rouge quot gt la lt code gt from lt code class quot highlighter rouge quot gt stan lt code gt into a lt code class quot highlighter rouge quot gt chains lt code gt object lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot k quot gt function lt span gt lt span class quot nf quot gt mcmcchains lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cat lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt val lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 3 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt chains lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt args lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt chains lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt check inputs lt span gt lt span class quot n quot gt rng lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt range lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c1 lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt or not he he he lt span gt lt span class quot c quot gt all c amp gt range c rng args throw argumenterror quot chain ranges differ quot lt span gt lt span class quot n quot gt nms lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt names lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c1 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt all lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot n quot gt names lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt nms lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt args lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt throw lt span gt lt span class quot x quot gt lt span gt lt span class quot kt quot gt argumenterror lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot chain names differ quot lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt concatenate all chains lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt mapreduce lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot n quot gt c lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt value lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt x lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt y lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt amp gt lt span gt lt span class quot n quot gt cat lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt x lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt y lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt dims lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 3 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt args lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt init lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt c1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt value lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt value lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt mcmcchains lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt axisarray lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt iter lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt rng lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt var lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt nms lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt chain lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt size lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 3 lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt return lt span gt lt span class quot n quot gt chains lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt value lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt missing lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt name map lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt info lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt end lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt stan chain lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt chains lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt la subset lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt amp lt results in all chains being concatenated together so we need to manually quot separate quot them lt span gt lt span class quot n quot gt steps per chain lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt parameters lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt steps lt span gt lt span class quot n quot gt num chains lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt int lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt length lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt stan chain lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt steps per chain lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt stan chains lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt stan chain lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt i lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt steps per chain lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt i lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt steps per chain lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt i lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num chains lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt stan chains lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt chainscat lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt stan chains lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt stan chains lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt stan chains lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 3 lt span gt lt span class quot o quot gt lt span gt lt span class quot k quot gt end lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt thin lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt object of type chains with data of type 1000 66 4 array float64 3 iterations 1 2998thinning interval 3chains 1 2 3 4samples per chain 1000parameters hier 1 hier 2 hier 3 hier 4 hier 5 hier 6 1 2 3 4 5 6 7 8 9 10 11 12 13 14 ifr noise 1 ifr noise 2 ifr noise 3 ifr noise 4 ifr noise 5 ifr noise 6 ifr noise 7 ifr noise 8 ifr noise 9 ifr noise 10 ifr noise 11 ifr noise 12 ifr noise 13 ifr noise 14 lockdown 1 lockdown 2 lockdown 3 lockdown 4 lockdown 5 lockdown 6 lockdown 7 lockdown 8 lockdown 9 lockdown 10 lockdown 11 lockdown 12 lockdown 13 lockdown 14 y 1 y 2 y 3 y 4 y 5 y 6 y 7 y 8 y 9 y 10 y 11 y 12 y 13 y 14 2 element array chaindataframe 1 summary statistics parameters mean std naive se mcse ess r hat hier 1 0 0250 0 0509 0 0008 0 0009 3762 6907 0 9994 hier 2 0 0294 0 0562 0 0009 0 0010 4096 3296 1 0021 hier 3 0 4865 0 1666 0 0026 0 0031 3769 7698 1 0021 hier 4 0 0150 0 0322 0 0005 0 0005 3963 6029 1 0003 hier 5 1 1267 0 1498 0 0024 0 0022 3990 6714 0 9996 hier 6 0 0647 0 1037 0 0016 0 0024 4037 5795 1 0053 1 3 9594 0 4722 0 0075 0 0075 4064 2020 0 9996 2 3 5951 0 1701 0 0027 0 0029 3684 0289 1 0005 3 4 2405 0 4080 0 0065 0 0092 4232 5667 1 0054 4 4 5359 0 3732 0 0059 0 0078 4075 5280 1 0031 5 3 9081 0 2873 0 0045 0 0076 4106 5761 1 0080 6 4 9298 0 3241 0 0051 0 0050 3850 5272 1 0009 7 3 8319 0 5364 0 0085 0 0075 3956 2449 0 9997 8 6 3026 0 7068 0 0112 0 0106 3641 7136 1 0005 9 4 3273 0 5181 0 0082 0 0077 4059 0140 1 0002 10 2 4113 0 2297 0 0036 0 0049 4080 2115 1 0035 11 3 8111 0 3755 0 0059 0 0058 3906 9576 0 9996 12 2 0742 0 2940 0 0046 0 0048 4350 2472 0 9997 13 3 9327 0 4426 0 0070 0 0068 4062 9915 0 9999 14 3 6872 0 3501 0 0055 0 0052 3971 6142 1 0001 0 1132 0 0683 0 0011 0 0014 3980 7969 1 0015 54 4981 17 5050 0 2768 0 2810 3759 2791 1 0007 6 8784 0 5566 0 0088 0 0078 4017 5627 1 0000 ifr noise 1 0 9994 0 1006 0 0016 0 0014 4337 3600 1 0002 ifr noise 2 0 9957 0 0996 0 0016 0 0018 3229 4271 1 0008 ifr noise 3 0 9927 0 1001 0 0016 0 0013 4205 8756 0 9997 ifr noise 4 1 0019 0 0981 0 0016 0 0016 3779 6148 0 9994 ifr noise 5 0 9973 0 1002 0 0016 0 0015 4230 6973 1 0002 ifr noise 6 0 9901 0 0997 0 0016 0 0014 4019 0526 0 9992 ifr noise 7 0 9977 0 0985 0 0016 0 0019 4102 5786 0 9997 ifr noise 8 0 9926 0 0989 0 0016 0 0014 4172 9264 0 9998 ifr noise 9 1 0024 0 0998 0 0016 0 0015 4036 0007 1 0003 ifr noise 10 1 0143 0 1004 0 0016 0 0020 3965 4960 1 0003 ifr noise 11 0 9940 0 0984 0 0016 0 0014 4248 2237 0 9999 ifr noise 12 1 0104 0 0978 0 0015 0 0016 4037 6589 1 0012 ifr noise 13 0 9997 0 0999 0 0016 0 0016 3775 1249 1 0007 ifr noise 14 1 0048 0 0990 0 0016 0 0016 4019 4484 0 9996 1 1204 0 2167 0 0034 0 0029 4136 1687 0 9996 lockdown 1 0 0034 0 1096 0 0017 0 0012 4217 7275 0 9991 lockdown 2 0 0194 0 0852 0 0013 0 0014 4045 8681 1 0009 lockdown 3 0 0171 0 1053 0 0017 0 0019 4125 5208 1 0011 lockdown 4 0 1309 0 1242 0 0020 0 0023 4149 1488 1 0018 lockdown 5 0 0144 0 1114 0 0018 0 0020 4275 9326 1 0002 lockdown 6 0 0287 0 0933 0 0015 0 0012 4116 3446 1 0001 lockdown 7 0 0197 0 1247 0 0020 0 0021 4076 6525 1 0002 lockdown 8 0 0800 0 1130 0 0018 0 0019 3866 1604 1 0006 lockdown 9 0 0104 0 1047 0 0017 0 0016 4021 3347 0 9997 lockdown 10 0 0026 0 1326 0 0021 0 0023 4007 4693 0 9997 lockdown 11 0 0121 0 1079 0 0017 0 0019 3829 4277 0 9996 lockdown 12 0 0030 0 1271 0 0020 0 0018 4228 0928 1 0003 lockdown 13 0 0019 0 1141 0 0018 0 0016 4215 2192 0 9997 lockdown 14 0 0548 0 1179 0 0019 0 0020 3988 7643 1 0006 y 1 47 1930 23 4949 0 3715 0 3560 4301 2466 0 9999 y 2 39 9589 13 3690 0 2114 0 2264 3840 8341 1 0004 y 3 20 2291 9 8615 0 1559 0 1618 3984 8827 1 0001 y 4 74 6538 33 9382 0 5366 0 6232 4021 1495 1 0018 y 5 44 3600 17 6755 0 2795 0 3848 3408 4552 1 0043 y 6 9 5225 4 5031 0 0712 0 0750 3902 1911 1 0008 y 7 30 0746 17 9098 0 2832 0 2778 3956 5131 1 0009 y 8 17 3519 11 2451 0 1778 0 1606 3384 7290 0 9995 y 9 75 4817 36 1157 0 5710 0 5745 4155 4331 1 0010 y 10 144 5704 54 9286 0 8685 0 9158 4175 9150 1 0001 y 11 26 1128 13 4270 0 2123 0 2135 3739 8586 0 9996 y 12 84 6856 44 8467 0 7091 0 6679 4167 7817 0 9995 y 13 55 2918 25 9756 0 4107 0 4109 4327 8064 0 9999 y 14 83 2622 36 3821 0 5753 0 5105 3890 7244 1 0000quantiles parameters 2 5 25 0 50 0 75 0 97 5 hier 1 0 0000 0 0000 0 0018 0 0244 0 1820 hier 2 0 0000 0 0000 0 0024 0 0313 0 2057 hier 3 0 0946 0 3853 0 4948 0 5975 0 7926 hier 4 0 0000 0 0000 0 0010 0 0126 0 1224 hier 5 0 8434 1 0235 1 1289 1 2272 1 4198 hier 6 0 0000 0 0001 0 0103 0 0903 0 3542 1 3 1090 3 6397 3 9181 4 2532 4 9781 2 3 2701 3 4824 3 5906 3 7117 3 9333 3 3 5392 3 9578 4 1962 4 4800 5 1477 4 3 9023 4 2706 4 4931 4 7583 5 3515 5 3 4586 3 7031 3 8641 4 0777 4 5887 6 4 3074 4 7095 4 9339 5 1434 5 5663 7 2 8756 3 4622 3 8022 4 1684 4 9753 8 4 9469 5 8267 6 2903 6 7636 7 7464 9 3 3888 3 9792 4 2975 4 6499 5 4316 10 2 0541 2 2494 2 3785 2 5382 2 9642 11 3 1351 3 5524 3 7874 4 0452 4 5922 12 1 5522 1 8702 2 0543 2 2570 2 7023 13 3 1392 3 6240 3 9055 4 2166 4 8550 14 3 0547 3 4411 3 6641 3 9070 4 4457 0 0106 0 0621 0 1066 0 1540 0 2669 28 3554 41 8978 51 6206 64 4602 95 8893 5 8450 6 4945 6 8693 7 2375 8 0241 ifr noise 1 0 8053 0 9319 0 9994 1 0669 1 1991 ifr noise 2 0 8027 0 9289 0 9982 1 0624 1 1919 ifr noise 3 0 8002 0 9254 0 9940 1 0584 1 1875 ifr noise 4 0 8146 0 9355 1 0002 1 0669 1 1992 ifr noise 5 0 8044 0 9283 0 9971 1 0648 1 1926 ifr noise 6 0 7977 0 9221 0 9916 1 0580 1 1871 ifr noise 7 0 7976 0 9337 0 9976 1 0632 1 1926 ifr noise 8 0 7980 0 9262 0 9929 1 0585 1 1868 ifr noise 9 0 8115 0 9365 1 0023 1 0712 1 1955 ifr noise 10 0 8129 0 9487 1 0128 1 0832 1 2092 ifr noise 11 0 7985 0 9277 0 9939 1 0599 1 1874 ifr noise 12 0 8173 0 9461 1 0107 1 0743 1 2046 ifr noise 13 0 8069 0 9315 1 0002 1 0663 1 2020 ifr noise 14 0 8168 0 9357 1 0049 1 0718 1 1968 0 7446 0 9697 1 1048 1 2558 1 5970 lockdown 1 0 2211 0 0529 0 0012 0 0552 0 2476 lockdown 2 0 2064 0 0681 0 0127 0 0270 0 1537 lockdown 3 0 2501 0 0689 0 0097 0 0368 0 1982 lockdown 4 0 0409 0 0309 0 1091 0 2083 0 4163 lockdown 5 0 2099 0 0406 0 0063 0 0678 0 2665 lockdown 6 0 2389 0 0807 0 0173 0 0255 0 1494 lockdown 7 0 2983 0 0748 0 0083 0 0442 0 2140 lockdown 8 0 3452 0 1409 0 0560 0 0025 0 0978 lockdown 9 0 2333 0 0598 0 0036 0 0415 0 2027 lockdown 10 0 2747 0 0594 0 0012 0 0615 0 2855 lockdown 11 0 2111 0 0428 0 0049 0 0654 0 2543 lockdown 12 0 2539 0 0534 0 0010 0 0600 0 2765 lockdown 13 0 2374 0 0579 0 0012 0 0530 0 2304 lockdown 14 0 1415 0 0145 0 0319 0 1134 0 3319 y 1 15 0725 30 7683 42 5110 58 6852 108 5279 y 2 20 0808 30 2341 38 0373 47 2979 71 8859 y 3 7 0457 13 3609 18 2912 24 7683 45 4752 y 4 25 4333 50 1704 68 8542 92 8525 155 6052 y 5 17 5663 31 6674 41 9898 54 2124 85 7669 y 6 3 5671 6 3678 8 5704 11 6961 20 4845 y 7 7 6940 17 3636 25 8101 37 9979 74 9977 y 8 4 6864 9 8616 14 5959 21 2624 47 3559 y 9 27 8821 50 0205 68 1117 93 5616 165 9393 y 10 59 6325 104 7132 136 6978 177 1941 270 4725 y 11 8 3990 16 7150 23 4562 32 1587 59 1546 y 12 25 3671 53 5384 74 8896 106 1230 199 7460 y 13 19 4379 36 8008 50 4436 68 4129 119 8110 y 14 30 3896 57 3074 76 9474 101 9789 170 3966 lt code gt lt pre gt lt div gt lt div gt lt details gt lt h3 id quot load quot gt load lt h3 gt lt p gt unfortunately the resulting chains each with 3000 steps take up a fair bit of space and are thus too large to include in the github repository as a temporary hack around this you can find download the chains from lt a href quot https drive google com open id 16pomgvnjpi1q4klda9grlovolfrmrhpp quot gt this link lt a gt then you simply navigate to the project directory and unpack lt p gt lt p gt with that we can load the chains from disk lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt filenames lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt relpath lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt outdir lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt s lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt s lt span gt lt span class quot k quot gt in lt span gt lt span class quot n quot gt readdir lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt outdir lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt if lt span gt lt span class quot n quot gt occursin lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt savename lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt parameters lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt s lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt amp amp amp amp lt span gt lt span class quot n quot gt occursin lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot seed quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt s lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt length lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt filenames lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt 4 lt code gt lt pre gt lt div gt lt div gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt chains posterior vec lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt read lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt fname lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt chains lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt fname lt span gt lt span class quot k quot gt in lt span gt lt span class quot n quot gt filenames lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt read the different chains lt span gt lt span class quot n quot gt chains posterior lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt chainscat lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt chains posterior vec lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt concatenate them lt span gt lt span class quot n quot gt chains posterior lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt chains posterior lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 1 lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 3 lt span gt lt span class quot o quot gt lt span gt lt span class quot k quot gt end lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt amp lt thin so we re left with 1000 samples lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt object of type chains with data of type 1000 78 4 array float64 3 iterations 1 2998thinning interval 3chains 1 2 3 4samples per chain 1000internals acceptance rate hamiltonian energy hamiltonian energy error is accept log density lp max hamiltonian energy error n steps nom step size numerical error step size tree depthparameters ifr noise 1 ifr noise 2 ifr noise 3 ifr noise 4 ifr noise 5 ifr noise 6 ifr noise 7 ifr noise 8 ifr noise 9 ifr noise 10 ifr noise 11 ifr noise 12 ifr noise 13 ifr noise 14 lockdown 1 lockdown 2 lockdown 3 lockdown 4 lockdown 5 lockdown 6 lockdown 7 lockdown 8 lockdown 9 lockdown 10 lockdown 11 lockdown 12 lockdown 13 lockdown 14 y 1 y 2 y 3 y 4 y 5 y 6 y 7 y 8 y 9 y 10 y 11 y 12 y 13 y 14 hier 1 hier 2 hier 3 hier 4 hier 5 hier 6 1 2 3 4 5 6 7 8 9 10 11 12 13 14 2 element array chaindataframe 1 summary statistics parameters mean std naive se mcse ess r hat ifr noise 1 0 9993 0 1018 0 0016 0 0016 4000 7654 1 0007 ifr noise 2 1 0000 0 0985 0 0016 0 0016 4130 0153 0 9994 ifr noise 3 0 9943 0 0986 0 0016 0 0017 4009 9552 0 9995 ifr noise 4 1 0014 0 0996 0 0016 0 0019 4073 9127 1 0006 ifr noise 5 0 9975 0 1017 0 0016 0 0017 3997 8443 1 0000 ifr noise 6 0 9919 0 0971 0 0015 0 0013 4183 1643 0 9994 ifr noise 7 0 9935 0 1000 0 0016 0 0016 3754 0585 1 0013 ifr noise 8 0 9906 0 1019 0 0016 0 0019 3764 0323 1 0002 ifr noise 9 1 0022 0 0983 0 0016 0 0017 3271 0573 1 0000 ifr noise 10 1 0143 0 0979 0 0015 0 0015 3713 8604 0 9999 ifr noise 11 0 9958 0 0990 0 0016 0 0015 4070 7331 1 0007 ifr noise 12 1 0031 0 1001 0 0016 0 0015 4062 0625 0 9994 ifr noise 13 1 0020 0 0983 0 0016 0 0017 3878 4554 1 0003 ifr noise 14 1 0051 0 0977 0 0015 0 0016 3411 2449 1 0003 lockdown 1 0 0015 0 1038 0 0016 0 0017 3351 5301 0 9992 lockdown 2 0 0189 0 0837 0 0013 0 0016 2301 1025 1 0007 lockdown 3 0 0172 0 0994 0 0016 0 0018 3307 7319 1 0002 lockdown 4 0 1181 0 1197 0 0019 0 0047 755 5366 1 0098 lockdown 5 0 0104 0 1056 0 0017 0 0021 2241 6092 1 0013 lockdown 6 0 0276 0 0903 0 0014 0 0017 1854 2957 1 0007 lockdown 7 0 0183 0 1154 0 0018 0 0022 3101 1043 1 0002 lockdown 8 0 0733 0 1121 0 0018 0 0029 1655 2705 1 0012 lockdown 9 0 0018 0 0992 0 0016 0 0015 3282 0295 0 9999 lockdown 10 0 0010 0 1272 0 0020 0 0021 3686 0479 0 9998 lockdown 11 0 0078 0 1006 0 0016 0 0015 3682 6438 0 9996 lockdown 12 0 0038 0 1192 0 0019 0 0022 3075 1532 0 9999 lockdown 13 0 0012 0 1068 0 0017 0 0022 3103 5187 1 0022 lockdown 14 0 0455 0 1113 0 0018 0 0024 2079 7790 1 0017 y 1 46 4670 23 1671 0 3663 0 3993 3051 0661 0 9997 y 2 38 6229 13 0809 0 2068 0 2614 2396 3508 0 9998 y 3 19 1768 9 4607 0 1496 0 2225 1618 4441 1 0019 y 4 73 7456 33 8283 0 5349 1 0255 1217 8814 1 0047 y 5 42 5408 17 5320 0 2772 0 3567 1816 6638 1 0023 y 6 9 1561 4 2267 0 0668 0 1047 1837 3744 1 0000 y 7 29 0679 17 4434 0 2758 0 2492 3195 2010 0 9993 y 8 16 4302 10 7746 0 1704 0 2680 1734 9104 1 0005 y 9 71 7330 33 2071 0 5251 0 6524 2360 5565 1 0006 y 10 140 8989 52 9734 0 8376 1 2555 1807 0170 1 0019 y 11 26 0038 13 2449 0 2094 0 2405 2349 8714 0 9997 y 12 82 8426 43 6475 0 6901 0 8820 2657 5728 1 0006 y 13 53 4443 25 2102 0 3986 0 4923 2491 2797 0 9997 y 14 81 7510 35 6084 0 5630 0 9667 1599 3832 1 0005 hier 1 0 0250 0 0519 0 0008 0 0009 3402 8745 1 0003 hier 2 0 0307 0 0571 0 0009 0 0011 2997 5497 1 0022 hier 3 0 4780 0 1807 0 0029 0 0084 292 5909 1 0134 hier 4 0 0167 0 0355 0 0006 0 0006 2836 6323 1 0003 hier 5 1 1276 0 1476 0 0023 0 0045 1166 6317 1 0024 hier 6 0 0776 0 1171 0 0019 0 0045 447 5792 1 0111 0 1047 0 0666 0 0011 0 0031 514 1243 1 0154 1 1469 0 2330 0 0037 0 0048 1953 9740 1 0004 1 3 9794 0 4695 0 0074 0 0092 2078 0005 0 9996 2 3 6130 0 1697 0 0027 0 0039 1763 3903 1 0002 3 4 3002 0 4351 0 0069 0 0158 589 1497 1 0091 4 4 5535 0 3895 0 0062 0 0130 824 9565 1 0066 5 3 9472 0 3079 0 0049 0 0094 829 6550 1 0073 6 4 9544 0 3259 0 0052 0 0089 1325 4430 1 0008 7 3 8631 0 5352 0 0085 0 0114 1943 5804 1 0003 8 6 3826 0 7272 0 0115 0 0213 1225 8573 1 0003 9 4 3782 0 5184 0 0082 0 0118 1846 1891 0 9997 10 2 4349 0 2378 0 0038 0 0070 931 9334 1 0053 11 3 8172 0 3753 0 0059 0 0099 1458 7896 1 0011 12 2 0997 0 3078 0 0049 0 0078 1545 5404 1 0019 13 3 9692 0 4579 0 0072 0 0119 1471 6664 1 0000 14 3 7025 0 3535 0 0056 0 0112 1150 7984 1 0006 53 0052 17 4602 0 2761 0 3973 1613 3580 1 0005 6 8730 0 5511 0 0087 0 0089 3726 1288 1 0002quantiles parameters 2 5 25 0 50 0 75 0 97 5 ifr noise 1 0 8033 0 9298 0 9989 1 0688 1 1966 ifr noise 2 0 8116 0 9329 1 0000 1 0656 1 1942 ifr noise 3 0 8007 0 9265 0 9955 1 0611 1 1846 ifr noise 4 0 8028 0 9335 1 0026 1 0698 1 1942 ifr noise 5 0 7999 0 9292 0 9974 1 0659 1 1977 ifr noise 6 0 8074 0 9268 0 9895 1 0580 1 1852 ifr noise 7 0 7950 0 9274 0 9921 1 0589 1 1930 ifr noise 8 0 7890 0 9226 0 9914 1 0563 1 1945 ifr noise 9 0 8106 0 9353 1 0015 1 0666 1 1948 ifr noise 10 0 8290 0 9479 1 0148 1 0791 1 2145 ifr noise 11 0 7956 0 9296 0 9975 1 0649 1 1865 ifr noise 12 0 8111 0 9339 1 0009 1 0706 1 2025 ifr noise 13 0 8095 0 9360 1 0020 1 0699 1 1932 ifr noise 14 0 8156 0 9396 1 0055 1 0715 1 1985 lockdown 1 0 2208 0 0530 0 0022 0 0481 0 2256 lockdown 2 0 2049 0 0622 0 0104 0 0249 0 1430 lockdown 3 0 2412 0 0645 0 0087 0 0320 0 1893 lockdown 4 0 0408 0 0218 0 0927 0 1907 0 4060 lockdown 5 0 2022 0 0411 0 0042 0 0572 0 2512 lockdown 6 0 2405 0 0711 0 0158 0 0203 0 1414 lockdown 7 0 2870 0 0666 0 0074 0 0361 0 2043 lockdown 8 0 3473 0 1313 0 0471 0 0005 0 1028 lockdown 9 0 2196 0 0470 0 0004 0 0467 0 2105 lockdown 10 0 2818 0 0537 0 0004 0 0509 0 2774 lockdown 11 0 2034 0 0401 0 0027 0 0551 0 2276 lockdown 12 0 2539 0 0480 0 0010 0 0562 0 2582 lockdown 13 0 2182 0 0528 0 0010 0 0491 0 2289 lockdown 14 0 1552 0 0158 0 0228 0 0969 0 3229 y 1 14 9179 30 0247 41 9126 58 3610 101 7665 y 2 19 5299 29 0981 36 6782 45 5189 70 1557 y 3 6 2077 12 4272 17 2003 24 0866 42 8143 y 4 23 8405 49 3363 68 8392 92 3015 153 7364 y 5 15 3591 30 0828 40 2003 52 3791 83 7325 y 6 3 4499 6 2449 8 2618 11 1259 19 4929 y 7 7 9239 16 9180 24 7996 36 2075 75 5797 y 8 4 3036 9 2674 13 7824 20 2839 46 1405 y 9 25 7094 47 7998 65 8459 88 0414 153 9687 y 10 58 3771 103 2094 134 1771 171 8739 264 0741 y 11 8 7082 16 5333 23 4436 32 4592 58 9983 y 12 23 2083 51 9796 74 6536 104 0517 191 2370 y 13 18 2376 35 3789 49 1850 65 7620 116 0045 y 14 30 5740 55 7063 75 7009 101 0443 167 4224 hier 1 0 0000 0 0000 0 0019 0 0242 0 1824 hier 2 0 0000 0 0000 0 0036 0 0332 0 2080 hier 3 0 0026 0 3730 0 4905 0 5978 0 7993 hier 4 0 0000 0 0000 0 0012 0 0144 0 1276 hier 5 0 8306 1 0298 1 1296 1 2270 1 4153 hier 6 0 0000 0 0003 0 0150 0 1156 0 4115 0 0081 0 0523 0 0975 0 1456 0 2550 0 7561 0 9801 1 1271 1 2899 1 6530 1 3 1409 3 6544 3 9459 4 2684 4 9864 2 3 2826 3 4992 3 6051 3 7255 3 9561 3 3 5900 3 9988 4 2449 4 5507 5 3007 4 3 9220 4 2754 4 5081 4 7815 5 4161 5 3 4703 3 7330 3 8936 4 1225 4 6746 6 4 3393 4 7278 4 9528 5 1696 5 6089 7 2 9072 3 4929 3 8364 4 1970 5 0471 8 4 9653 5 8929 6 3766 6 8616 7 8508 9 3 4333 4 0293 4 3408 4 6990 5 5073 10 2 0695 2 2673 2 3974 2 5695 2 9983 11 3 1598 3 5554 3 7920 4 0572 4 5967 12 1 5810 1 8869 2 0716 2 2842 2 7769 13 3 1791 3 6543 3 9293 4 2499 4 9921 14 3 0808 3 4508 3 6740 3 9262 4 4323 26 6958 40 4641 50 7268 62 4155 94 9594 5 8429 6 5022 6 8514 7 2332 8 0291 lt code gt lt pre gt lt div gt lt div gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt chains posterior lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 5 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt linewidth lt span gt lt span class quot o quot gt lt span gt lt span class quot mf quot gt 1 5 lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis uk posterior kappa phi tau sample plot png quot alt quot nil quot gt lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot c quot gt compute generated quantities for the chains pooled together lt span gt lt span class quot n quot gt pooled chains lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt mcmcchains lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt pool chain lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt chains posterior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt generated posterior lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt vectup2tupvec lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt generated quantities lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt pooled chains lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily cases posterior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily deaths posterior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt posterior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt adj posterior lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt generated posterior lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt the posterior predictive distribution lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt country prediction plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt uk index lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily cases posterior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily deaths posterior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt posterior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt main title lt span gt lt span class quot o quot gt lt span gt lt span class quot s quot gt quot posterior quot lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis uk predictive posterior rt png quot alt quot nil quot gt lt p gt lt p gt and with the adjusted r t lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt country prediction plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt uk index lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily cases posterior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily deaths posterior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt adj posterior lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt main title lt span gt lt span class quot o quot gt lt span gt lt span class quot s quot gt quot posterior quot lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis uk predictive posterior rt adjusted png quot alt quot nil quot gt lt p gt lt h2 id quot all countries prior vs posterior predictive quot gt all countries prior vs posterior predictive lt h2 gt lt p gt for the sake of completeness here are the prior and posterior predictive distributions for all the 14 countries in a side by side comparison lt p gt lt div class quot two by two quot gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country prior predictive 01 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country posterior predictive 01 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country prior predictive 02 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country posterior predictive 02 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country prior predictive 03 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country posterior predictive 03 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country prior predictive 04 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country posterior predictive 04 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country prior predictive 05 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country posterior predictive 05 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country prior predictive 06 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country posterior predictive 06 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country prior predictive 07 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country posterior predictive 07 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country prior predictive 08 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country posterior predictive 08 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country prior predictive 09 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country posterior predictive 09 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country prior predictive 10 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country posterior predictive 10 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country prior predictive 11 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country posterior predictive 11 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country prior predictive 12 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country posterior predictive 12 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country prior predictive 13 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country posterior predictive 13 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country prior predictive 14 png quot alt quot nil quot gt lt p gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis country posterior predictive 14 png quot alt quot nil quot gt lt p gt lt div gt lt h2 id quot what if we didnt do anycertain interventions quot gt what if we didn t do any certain interventions lt h2 gt lt p gt one interesting thing one can do after obtaining estimates for the effect of each of the interventions is to run the model but now lt em gt without lt em gt all or a subset of the interventions performed thus allowing us to get a sense of what the outcome would have been without those interventions and also whether or not the interventions have the wanted effect lt p gt lt p gt lt code class quot highlighter rouge quot gt data covariates m lt code gt is a binary matrix for each lt code class quot highlighter rouge quot gt m lt code gt country index with lt code class quot highlighter rouge quot gt data covariate m k lt code gt then being a binary vector representing the time series for the k th covariate lt code class quot highlighter rouge quot gt 0 lt code gt means the intervention has is not implemented lt code class quot highlighter rouge quot gt 1 lt code gt means that the intervention is implemented as an example if schools and universites were closed after the 45th day for country lt code class quot highlighter rouge quot gt m lt code gt then lt code class quot highlighter rouge quot gt data covariate m 1 45 k lt code gt are all zeros and lt code class quot highlighter rouge quot gt data covariate m 45 end k lt code gt are all ones lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot c quot gt get the index of schools and univerities closing lt span gt lt span class quot n quot gt schools universities closed index lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt findfirst lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot schools universities quot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt names covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt time series for uk lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt uk index lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt schools universities closed index lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt 100 element array float64 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 lt code gt lt pre gt lt div gt lt div gt lt p gt notice that the above assumes that not only are schools and universities closed lt em gt at some point lt em gt but rather that they also stay closed in the future at the least the future that we are considering lt p gt lt p gt therefore we can for example simulate what happens if we never closed schools and universities by instead setting this entire vector to lt code class quot highlighter rouge quot gt 0 lt code gt and re run the model on the infererred parameters similar to what we did before to compute the generated quantities e g r t lt p gt lt details gt lt summary gt lt p gt convenience function for zeroing out subsets of the interventions lt p gt lt summary gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot s quot gt quot quot quot zero covariates xs abstractmatrix amp lt real remove keep allows you to zero out covariates if the name of the covariate is in remove or not zero out those in keep note that only remove xor keep can be non empty useful when instantiating counter factual models as it allows one to remove keep a subset of the covariates quot quot quot lt span gt lt span class quot n quot gt zero covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt xs lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt abstractmatrix lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt amp lt lt span gt lt span class quot kt quot gt real lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt kwargs lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt zero covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt xs lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt names covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt kwargs lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt function lt span gt lt span class quot nf quot gt zero covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt xs lt span gt lt span class quot o quot gt lt span gt lt span class quot kt quot gt abstractmatrix lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt amp lt lt span gt lt span class quot kt quot gt real lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt names covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt remove lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt keep lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot nd quot gt assert lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt isempty lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt remove lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt isempty lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt keep lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot only remove or keep can be non empty quot lt span gt lt span class quot k quot gt if lt span gt lt span class quot n quot gt isempty lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt keep lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt return lt span gt lt span class quot n quot gt mapreduce lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt hcat lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt enumerate lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt eachcol lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt xs lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt do lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt i lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt names covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt i lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot n quot gt remove lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt zeros lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt eltype lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt length lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt c lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt end lt span gt lt span class quot k quot gt else lt span gt lt span class quot k quot gt return lt span gt lt span class quot n quot gt mapreduce lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt hcat lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt enumerate lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt eachcol lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt xs lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt do lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt i lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt names covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt i lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lt span gt lt span class quot n quot gt keep lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt c lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt zeros lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt eltype lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt length lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt end lt span gt lt span class quot k quot gt end lt span gt lt span class quot k quot gt end lt span gt lt code gt lt pre gt lt div gt lt div gt lt div class quot highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt zero covariates generic function with 2 methods lt code gt lt pre gt lt div gt lt div gt lt details gt lt p gt now we can consider simulation under the posterior with lt em gt no lt em gt intervention and we re going to visualize the respective lt em gt portions lt em gt of the population by rescaling by total population lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot c quot gt what happens if we don t do anything lt span gt lt span class quot n quot gt m counterfactual lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt model def lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num total days lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cases lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt zeros lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt size lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt c lt span gt lt span class quot k quot gt in lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt amp lt remove all covariates lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt epidemic start lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt population lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt serial intervals lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lockdown index lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt true lt span gt lt span class quot c quot gt amp lt use full model lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt compute the quot generated quantities quot for the quot counter factual quot model lt span gt lt span class quot n quot gt generated counterfactual lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt vectup2tupvec lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt generated quantities lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt pooled chains lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily cases counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily deaths counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt adj counterfactual lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt generated counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country prediction plot lt span gt lt span class quot x quot gt lt span gt lt span class quot mi quot gt 5 lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily cases counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily deaths counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt adj counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normalize pop lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt true lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis counterfactual remove all png quot alt quot nil quot gt lt p gt lt p gt we can also consider the cases where we only do lt em gt some lt em gt of the interventions e g we never do a full lockdown lt code class quot highlighter rouge quot gt lockdown lt code gt or close schools and universities lt code class quot highlighter rouge quot gt schools universities lt code gt lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot c quot gt what happens if we never close schools nor do a lockdown lt span gt lt span class quot n quot gt m counterfactual lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt model def lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num total days lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cases lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt zero covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt remove lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot lockdown quot lt span gt lt span class quot x quot gt lt span gt lt span class quot s quot gt quot schools universities quot lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt c lt span gt lt span class quot k quot gt in lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt amp lt remove covariates lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt epidemic start lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt population lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt serial intervals lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lockdown index lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt true lt span gt lt span class quot c quot gt amp lt use full model lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt compute the quot generated quantities quot for the quot counter factual quot model lt span gt lt span class quot n quot gt generated counterfactual lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt vectup2tupvec lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt generated quantities lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt pooled chains lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily cases counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily deaths counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt adj counterfactual lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt generated counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country prediction plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt uk index lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily cases counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily deaths counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt adj counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normalize pop lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt true lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis counterfactual remove lockdown and schools png quot alt quot nil quot gt lt p gt lt p gt as mentioned this assumes that we will stay in lockdown and schools and universities will be closed in the future we can also consider say removing the lockdown i e opening up at some future point in time lt p gt lt div class quot language julia highlighter rouge quot gt lt div class quot highlight quot gt lt pre class quot highlight quot gt lt code gt lt span class quot n quot gt lift lockdown time lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 75 lt span gt lt span class quot n quot gt new covariates lt span gt lt span class quot o quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt copy lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt c lt span gt lt span class quot x quot gt lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt c lt span gt lt span class quot k quot gt in lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt amp lt going to do inplace manipulations so we copy lt span gt lt span class quot k quot gt for lt span gt lt span class quot n quot gt covariates m lt span gt lt span class quot n quot gt lt span gt lt span class quot n quot gt new covariates lt span gt lt span class quot n quot gt covariates m lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lift lockdown time lt span gt lt span class quot o quot gt lt span gt lt span class quot k quot gt end lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lockdown index lt span gt lt span class quot x quot gt lt span gt lt span class quot o quot gt lt span gt lt span class quot mi quot gt 0 lt span gt lt span class quot k quot gt end lt span gt lt span class quot c quot gt what happens if we never close schools nor do a lockdown lt span gt lt span class quot n quot gt m counterfactual lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt model def lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num impute lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt num total days lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt cases lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt deaths lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt new covariates lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt epidemic start lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt population lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt data lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt serial intervals lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt lockdown index lt span gt lt span class quot x quot gt lt span gt lt span class quot nb quot gt true lt span gt lt span class quot c quot gt amp lt use full model lt span gt lt span class quot x quot gt lt span gt lt span class quot c quot gt compute the quot generated quantities quot for the quot counter factual quot model lt span gt lt span class quot n quot gt generated counterfactual lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt vectup2tupvec lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt generated quantities lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt m counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt pooled chains lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily cases counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily deaths counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt adj counterfactual lt span gt lt span class quot o quot gt lt span gt lt span class quot n quot gt generated counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt country prediction plot lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt uk index lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily cases counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt daily deaths counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt rt adj counterfactual lt span gt lt span class quot x quot gt lt span gt lt span class quot n quot gt normalize pop lt span gt lt span class quot o quot gt lt span gt lt span class quot nb quot gt true lt span gt lt span class quot x quot gt lt span gt lt code gt lt pre gt lt div gt lt div gt lt p gt lt img src quot assets figures 2020 05 04 imperial report13 analysis counterfactual remove lockdown after a while png quot alt quot nil quot gt lt p gt lt h1 id quot conclusion quot gt conclusion lt h1 gt lt p gt well there isn t one as stated before drawing conclusions is not the purpose of this document with that being said we lt em gt are lt em gt working on exploring this and other models further e g relaxing certain assumptions model validation amp amp comparison but this will hopefully be available in a more technical and formal report sometime in the near future after proper validation and analysis but since time is of the essence in these situations we thought it was important to make the above and related code available to the public immediately at the very least it should be comforting to know that two different ppls both produce the same inference results when the model might be used to inform policy decisions on a national level lt p gt lt p gt if you have any questions or comments feel free to reach out either on the lt a href quot https github com turinglang covid19 quot gt github repo lt a gt or to any of us personally lt p gt lt footnotes gt lt div class quot footnotes quot role quot doc endnotes quot gt lt ol gt lt li id quot fn fn1 quot role quot doc endnote quot gt lt p gt the issue with lt em gt not lt em gt having the lt code class quot highlighter rouge quot gt max lt code gt is that it s possible to obtain a negative r t which is bad for two reasons 1 it doesn t make sense with negative spreading of the virus 2 it leads to invalid parameterization for lt code class quot highlighter rouge quot gt negativebinomial2 lt code gt in stan a invalid parameterization will be considered a rejected sample and thus these samples will be rejected in the case of lt code class quot highlighter rouge quot gt turing jl lt code gt if r t 0 then observing a lt em gt positive lt em gt number for daily deaths will result in lt code class quot highlighter rouge quot gt inf lt code gt added to the log pdf and so the sample will also be rejected hence both ppls will arrive at correct inference but with different processes lt a href quot fnref fn1 quot class quot reversefootnote quot role quot doc backlink quot gt amp 8617 lt a gt lt p gt lt li gt lt li id quot fn fn3 quot role quot doc endnote quot gt lt p gt recently one of our team members joined as a maintainer of lt a href quot https github com juliadiff reversediff jl quot gt reversediff jl lt a gt to make sure that lt code class quot highlighter rouge quot gt turing jl lt code gt also has fast and reliable reverse mode differentiation reversediff jl is already compatible with lt code class quot highlighter rouge quot gt turing jl lt code gt but we hope that this will help make if much much faster lt a href quot fnref fn3 quot class quot reversefootnote quot role quot doc backlink quot gt amp 8617 lt a gt lt p gt lt li gt lt ol gt lt div gt mon 04 may 2020 00 00 00 0000 dev posts 2020 05 04 imperial report13 analysis dev posts 2020 05 04 imperial report13 analysis google summer of code julia summer of code lt p gt last year turing participated in the google summer of code gsoc through the julia language organization it was a fun time and the project was better for it turing plans to participate in the upcoming gsoc and we wanted to outline some potential projects and expectations we have for applicants lt p gt lt p gt if you are not aware google provides funds to students around the world to develop a project of their choice over the summer students receive funds from google and spend three months on any open source project lt p gt lt p gt the turing development team has prepared a list of possible projects that we have deemed valuable to the project and easy enough that it could feasibly be created in the three month limit this list is not exlusive if you have a good idea you can write it up in your proposal though it is recommend that you reach out to any of the turing team on julia s lt a href quot https julialang slack com quot gt slack lt a gt you can get an invite lt a href quot https slackinvite julialang org quot gt here lt a gt or lt a href quot https discourse julialang org c domain probprog quot gt discourse lt a gt messages on discourse should be posted to the probabilistic programming category we ll find you lt p gt lt p gt possible project ideas lt p gt lt ul gt lt li gt lt strong gt benchmarking lt strong gt turing s performance has been sporadically benchmarked against various other probabilistic programming languages e g turing stan pymc3 tensorflow prob but a systemic approach to studying where turing excels and where it falls short would be useful a gsoc student would implement identical models in many ppls and build tools to benchmark all ppls against one another lt li gt lt li gt lt strong gt nested sampling integration lt strong gt turing focuses on modularity in inference methods and the development team would like to see more inference methods particularly the popular nested sampling method a julia package lt a href quot https github com mileslucas nestedsamplers jl quot gt nestedsamplers jl lt a gt but it is not hooked up to turing and does not currently have a stable api a gsoc student would either integrate that package or construct their own nested sampling method and build it into turing lt li gt lt li gt lt strong gt automated function memoization by model annotation lt strong gt function memoization is a way to reduce costly function evaluation by caching the output when the same inputs are given turing s gibbs sampler often ends up lt a href quot https turing ml dev docs using turing performancetips reuse computations in gibbs sampling quot gt rerunning expensive functions lt a gt multiple times and it would be a significant performance improvement to allow turing s model compiler to automatically memoize functions where appropriate a student working on this project would become intimately familiar with turing s model compiler and build in various automated improvements lt li gt lt li gt lt strong gt making distributions gpu compatible lt strong gt julia s gpu tooling is generally quite good but currently turing is not able to reliably use gpus while sampling because lt a href quot https github com juliastats distributions jl quot gt distributions jl lt a gt is not gpu compatible a student on this project would work with the turing developers and the distributions developers to allow the use of gpu parallelism where possible in turing lt li gt lt li gt lt strong gt static distributions lt strong gt small fixed size vectors and matrices are fairly common in turing models this means that sampling in turing can probably benefit from using statically sized vectors and matrices from lt a href quot https github com juliaarrays staticarrays jl quot gt staticarrays jl lt a gt instead of the dynamic normal julia arrays beside the often superior performance of small static vectors and matrices static arrays are also automatically compatible with the gpu stack in julia currently the main obstacle to using staticarrays jl is that distributions in lt a href quot https github com juliastats distributions jl quot gt distributions jl lt a gt are not compatible with staticarrays a gsoc student would adapt the multivariate and matrix variate distributions as well as the univariate distribution with vector parameters in distributions jl to make a spin off package called staticdistributions jl the student would then benchmark staticdistributions jl against distributions jl and showcase an example of using staticdistributions jl together with lt a href quot https github com juliagpu cuarrays jl quot gt cuarrays jl lt a gt and or lt a href quot https github com juliagpu cudanative jl quot gt cudanative jl lt a gt for gpu acceleration lt li gt lt li gt lt strong gt gpnet extensions lt strong gt one of turing s sattelite packages lt a href quot https github com turinglang gpnet jl quot gt gpnet lt a gt is designed to provide a comprehensive suite of gaussian process tools see lt a href quot https github com turinglang gpnet jl issues 2 quot gt this issue lt a gt for potential tasks there s a lot of interesting stuff going on with gps and this task in particular may have some creative freedom to it lt li gt lt li gt lt strong gt better chains and model diagnostics lt strong gt one package that turing and many others rely on heavily is lt a href quot https github com turinglang mcmcchains jl quot gt mcmcchains jl lt a gt a package designed to format store and analyze parameter samples generated during mcmc inference mcmcchains is currently showing its age a little and has many lt a href quot https github com turinglang mcmcchains jl issues 171 quot gt bad design choices lt a gt that need to be fixed alternatively a student could contstruct a far more lightweight chain system lt li gt lt li gt lt strong gt model comparison tools lt strong gt turing and its sattelite packages do not currently provide a comprehensive suite of model comparison tools a critical tool for the applied statistician a student who worked on this project would implement various model comparison tools like lt a href quot https mc stan org loo quot gt loo and waic lt a gt among others lt li gt lt li gt lt strong gt mle map tools lt strong gt lt a href quot https en wikipedia org wiki maximum likelihood estimation quot gt maximum likelihood estimates lt a gt mle and lt a href quot https en wikipedia org wiki maximum a posteriori estimation quot gt maximum a posteriori lt a gt map estimates can currently only be done by users through a lt a href quot https turing ml dev docs using turing advanced maximum a posteriori estimation quot gt clunky set of workarounds lt a gt a streamlined function like lt code class quot highlighter rouge quot gt mle model lt code gt or lt code class quot highlighter rouge quot gt map model lt code gt would be very useful for many of turing s users who want to see what the mle or map estimates look like and it may be valuable to allow for functionality that allows mcmc sampling to begin from the mle or map estimates students working on this project will work with optimization packages such as lt a href quot https github com julianlsolvers optim jl quot gt optim jl lt a gt to make mle and map estimation straightforward for turing models lt li gt lt li gt lt strong gt particle sampler improvements lt strong gt turing s development team has spent a lot of time and energy to make inference methods more modular but turing s particle samplers have not yet been modernized and spun off into a separate package two packages that resulted from this were lt a href quot https github com turinglang advancedhmc jl quot gt advancedhmc lt a gt for hamiltonian mcmc methods and lt a href quot https github com turinglang advancedmh jl quot gt advancedmh lt a gt for metropolis hastings style inference methods a student who worked on this project would become very familiar with turing s inference backend and with particle sampling methods this is a good project for people who love making things efficient and easily extendable lt li gt lt ul gt lt p gt other projects are welcome but we do strongly recommend discussing any potential projects with members of the turing team as they will end up mentoring gsoc students for the duration of the project lt p gt lt p gt we re looking forward to what people are interested in lt p gt wed 12 feb 2020 00 00 00 0000 dev posts 2020 02 12 jsoc dev posts 2020 02 12 jsoc turing s blog lt p gt all good open source projects should have a blog and turing is one such project later on members of the turing team may be populating this feed with posts on topics like lt p gt lt ul gt lt li gt interesting things you can do with turing or interesting things we have seen others do lt li gt lt li gt development updates and major release announcements lt li gt lt li gt research updates lt li gt lt li gt explorations of turing s internals lt li gt lt li gt updates to turing s sattelite projects lt a href quot https github com turinglang advancedhmc jl quot gt advancedhmc jl lt a gt or lt a href quot https github com turinglang bijectors jl quot gt bijectors jl lt a gt lt li gt lt ul gt lt p gt stay tuned lt p gt sat 14 dec 2019 00 00 00 0000 dev posts 2019 12 14 initial post dev posts 2019 12 14 initial post", "title": ""},{"location": "/", "text": "turing jl bayesian inference with probabilistic programming intuitive turing models are easy to read and write models work the way you write them general purpose turing supports models with discrete parameters and stochastic control flow specify complex models quickly and easily modular turing is modular written fully in julia and can be modified to suit your needs hello world in turing linear gaussian model turing s modelling syntax allows you to specify a model quickly and easily straightforward models can be expressed in the same way as complex hierarchical models with stochastic control flow quick start model gdemo x y begin assumptions inversegamma 2 3 normal 0 sqrt observations x normal sqrt y normal sqrt end news feed replication study estimating number of inections and impact of npis on covid 19 in european countries imperial report 13 may 04 2020 google summer of code julia summer of code february 12 2020 turing s blog december 14 2019 news advanced markov chain monte carlo samplers turing provides hamiltonian monte carlo sampling for differentiable posterior distributions particle mcmc sampling for complex posterior distributions involving discrete variables and stochastic control flow and gibbs sampling which combines particle mcmc hmc and many other mcmc algorithms samplers interoperable with deep learning libraries turing supports julia s flux package for automatic differentiation combine turing and flux to construct probabalistic variants of traditional machine learning models bayesian neural network tutorial community join the turing community to contribute learn and get your questions answered github report bugs request features discuss issues and more go to github turing jl discuss browse and join discussions on turing go to turing jl discuss slack discuss advanced topics request access here go to slack ecosystem explore a rich ecosystem of libraries tools and more to support development advancedhmc robust modular and efficient implementation of advanced hamiltonian monte carlo algorithms go to advancedhmc mcmcchains chain types and utility functions for mcmc simulations go to mcmcchains bijectors automatic transformations for constrained random variables go to bijectors", "title": "Turing.jl - Turing.jl"},{"location": "/news/", "text": "newssubscribe with rss to keep up with the latest news about turing google summer of code julia summer of code february 12 2020 last year turing participated in the google summer of code gsoc through the julia language organization it was a fun time and the project was better for it turing plans to participate in the upcoming gsoc and we wanted to outline some potential projects and expectations we have for applicants read more turing s blog december 14 2019 all good open source projects should have a blog and turing is one such project later on members of the turing team may be populating this feed with posts on topics like read more want to see more see the news archive", "title": "News"},{"location": "/search/search_index.json", "text": "config lang en prebuild index false separator s docs for page in site pages unless page excluded in search if added endif assign added false location page url text page content strip html strip newlines slugify ascii replace title page title assign added true endunless endfor for post in site posts unless page excluded in search if added endif assign added false location post url text post content strip html strip newlines slugify ascii replace title post title assign added true endunless endfor for doc in site docs unless doc excluded in search if added endif assign added false location doc url text doc content strip html strip newlines slugify ascii replace title doc title assign added true endunless endfor", "title": ""},{"location": "/sitemap.xml", "text": "now date y m d daily for section in site data toc site baseurl section url now date y m d daily endfor", "title": ""},{"location": "/robots.txt", "text": "sitemap sitemap xml absolute url", "title": ""},{"location": "/feed.xml", "text": "if page xsl endif jekyll site time date to xmlschema page url absolute url xml escape assign title site title default site name if page collection posts assign collection page collection capitalize assign title title append append collection endif if page category assign category page category capitalize assign title title append append category endif if title title smartify xml escape endif if site description site description xml escape endif if site author site author name default site author xml escape if site author email site author email xml escape endif if site author uri site author uri xml escape endif endif assign posts site page collection where exp post post draft true sort date reverse if page category assign posts posts where category page category endif for post in posts limit 10 post title smartify strip html normalize whitespace xml escape post date date to xmlschema post last modified at default post date date to xmlschema post id absolute url xml escape assign excerpt only post feed excerpt only default site feed excerpt only unless excerpt only post content strip xml escape endunless assign post author post author default post authors 0 default site author assign post author site data authors post author default post author assign post author email post author email default nil assign post author uri post author uri default nil assign post author name post author name default post author post author name default xml escape if post author email post author email xml escape endif if post author uri post author uri xml escape endif if post category endif for tag in post tags endfor if post excerpt and post excerpt empty post excerpt strip html normalize whitespace xml escape endif assign post image post image path default post image if post image unless post image contains assign post image post image absolute url endunless endif endfor", "title": ""},{"location": "/posts/2020-05-04-Imperial-Report13-analysis", "text": "we i e the turinglang team are currently exploring cooperation with other researchers in attempt to help with the ongoing crisis as preparation for this and to get our feet wet we decided it would be useful to do a replication study of the imperial report 13 we figured it might be useful for the public in particular other researchers working on the same or similar models to see the results of this analysis and thus decided to make it available here we want to emphasize that you should look to the original paper rather than this post for developments and analysis of the model we are not aiming to make any claims about the validity or the implications of the model and refer to imperial report 13 for details on the model itself this post s purpose is only to add tiny bit of validation to the inference performed in the paper by obtaining the same results using a different probabilistic programming language ppl and to explore whether or not turing jl can be useful for researchers working on these problems all code and inference results shown in this post can be found here setupthis is all assuming that you re in the project directory of covid19 jl a small package where we gather most of our ongoing work in the project we use drwatson jl which provides a lot of convenient functionality for well working with a project the below code will activate the covid19 jl project to ensure that we re using correct versions of all the dependencies i e code is reproducible it s basically just doing activate but with a few bells and whistles that we ll use later using drwatsonquickactivate dir with the project activate we can import the covid19 jl package loading the project https github com turinglang covid19 using covid19 some other packages we ll needusing random dates turing bijectorsand we ll be using the new multithreading functionality in julia to speed things up so we need the base threads package using base threadsnthreads 4here s a summary of the setup using pkgpkg status project covid19 v0 1 0status projects mine covid19 project toml dce04be8 argcheck v2 0 0 c7e460c6 argparse v1 1 0 131c737c arviz v0 4 1 76274a88 bijectors v0 6 7 tor using bijectors in link and invlink https github com turinglang bijectors jl git 336ed68f csv v0 6 1 a93c6f00 dataframes v0 20 2 31c24e10 distributions v0 23 2 ced4e74d distributionsad v0 4 10 634d3b9d drwatson v1 10 2 1a297f60 fillarrays v0 8 7 58dd65bb plotly v0 3 0 f0f68f2c plotlyjs v0 13 1 91a5bcdd plots v1 1 2 438e738f pycall v1 91 4 d330b81b pyplot v2 9 0 df47a6cb rdata v0 7 1 2913bbd2 statsbase v0 33 0 f3b207a7 statsplots v0 14 5 fce5fe82 turing v0 11 0 tor modelling temporary https github com turinglang turing jl git 9a3f8284 random 10745b16 statistics in the github project you will find a manifest toml this means that if you re working directory is the project directory and you do julia project followed by instantiate you will have exactly the same enviroment as we had when performing this analysis overloading some functionality in drwatson jlas mentioned drwatson jl provides a lot of convenience functions for working in a project and one of them is projectdir args which will resolve join the args to the absolute path of the project directory in similar fashion it provides a datadir method which defaults to projectdir data but to remove the possibility of making a type later on when writing datadir imperial report13 we ll overload this method for this notebook import drwatson datadiroutdir projectdir out outdir args projectdir out args datadir projectdir data imperial report13 datadir s projectdir data imperial report13 s datadir generic function with 2 methods datato ensure consistency with the original model from the paper and to stay up to date with the changes made we preprocessed the data using the base r script from the original repository 6ee3010 and store the processed data in a processed rds file to load this rds file obtained from the r script we make use of the rdata jl package which allows us to load the rds file into a julia dict using rdatardata full load datadir processed rds rdata rdata full stan data keys rdata full base keyset for a dict string int64 with 4 entries keys reported cases stan data deaths by country dates country to dates d dict k rdata full dates k for k in keys rdata full dates dict string array date 1 with 14 entries sweden gt date 2020 02 18 2020 02 19 2020 02 20 2020 02 21 2020 belgium gt date 2020 02 18 2020 02 19 2020 02 20 2020 02 21 2020 greece gt date 2020 02 19 2020 02 20 2020 02 21 2020 02 22 2020 switzerland gt date 2020 02 14 2020 02 15 2020 02 16 2020 02 17 2020 germany gt date 2020 02 15 2020 02 16 2020 02 17 2020 02 18 2020 united kingdom gt date 2020 02 12 2020 02 13 2020 02 14 2020 02 15 2020 denmark gt date 2020 02 21 2020 02 22 2020 02 23 2020 02 24 2020 norway gt date 2020 02 24 2020 02 25 2020 02 26 2020 02 27 2020 france gt date 2020 02 07 2020 02 08 2020 02 09 2020 02 10 2020 portugal gt date 2020 02 21 2020 02 22 2020 02 23 2020 02 24 2020 spain gt date 2020 02 09 2020 02 10 2020 02 11 2020 02 12 2020 netherlands gt date 2020 02 14 2020 02 15 2020 02 16 2020 02 17 2020 italy gt date 2020 01 27 2020 01 28 2020 01 29 2020 01 30 2020 austria gt date 2020 02 22 2020 02 23 2020 02 24 2020 02 25 2020 since the data format is not native julia there might be some discrepancies in the types of the some data fields and so we need to do some type conversion of the loaded rdata we also rename a lot of the fields to make it more understandable and for an easier mapping to our implementation of the model feel free to skip this snippet data wrangling convert some misparsed fieldsrdata n2 int rdata n2 rdata n0 int rdata n0 rdata epidemicstart int rdata epidemicstart rdata cases int rdata cases rdata deaths int rdata deaths stan will fail if these are nothing so we make them empty arraysrdata x rdata features countries denmark italy germany spain united kingdom france norway belgium austria sweden switzerland greece portugal netherlands num countries length countries names covariates schools universities self isolating if ill public events any lockdown social distancing encouraged lockdown index findfirst lockdown names covariates function rename d names pair check that keys are not yet present before updating d for k new in values names assert k new keys d k new already in dictionary end for k old k new in names d k new pop d k old end return dend rdata is a dictofvector so we convert to a simple dict for simplicityd dict k rdata k for k in keys rdata values df and keys df have different ordering so don t do dict keys df values df rename some columnsrename d f gt si gt serial intervals pop gt population m gt num countries n0 gt num impute n gt num obs countries n2 gt num total days epidemicstart gt epidemic start x gt covariates p gt num covariates add some type information to arrays and replace 1 with missing as 1 is supposed to represent well missing data d deaths int d deaths d deaths replace d deaths 1 gt missing d deaths collect eachcol d deaths convert into array of arrays instead of matrixd cases int d cases d cases replace d cases 1 gt missing d cases collect eachcol d cases convert into array of arrays instead of matrixd num covariates int d num covariates d num countries int d num countries d num total days int d num total days d num impute int d num impute d num obs countries int d num obs countries d epidemic start int d epidemic start d population int d population d collect eachcol d convert into array of arrays instead of matrix convert 3d array into array matrix covariates rdata x m for m 1 num countries data k gt d string k for k in num countries num impute num obs countries num total days cases deaths epidemic start population serial intervals data merge data covariates covariates can deal with ragged arrays so we can shave off unobserved data future which are just filled with 1data merge data cases data cases m 1 data num obs countries m for m 1 data num countries deaths data deaths m 1 data num obs countries m for m 1 data num countries data num countries14because it s a bit much to visualize 14 countries at each step we re going to use uk as an example throughout uk index findfirst united kingdom countries 5it s worth noting that the data user here is not quite up to date for uk because on lt 2020 04 30 to gt they updated their past numbers by including deaths from care and nursing homes data source ecdc thus if you compare the prediction of the model to real numbers it s likely that the real numbers will be a bit higher than what the model predicts modelfor a thorough description of the model and the assumptions that have gone into it we recommend looking at the original paper or their very nice techical report from the repository the model described here is the one corresponding to the technical report linked the link points to the correct commit id and so should be consistent with this post despite potential changes to the official model made in the future for the sake of exposition we present a compact version of the model here begin align tau amp sim mathrm exponential 1 0 03 y m amp sim mathrm exponential tau quad amp text for quad m 1 dots m kappa amp sim mathcal n 0 0 5 mu m amp sim mathcal n 3 28 kappa quad amp text for quad m 1 dots m gamma amp sim mathcal n 0 0 2 beta m amp sim mathcal n 0 gamma quad amp text for quad m 1 dots m tilde alpha k amp sim mathrm gamma 0 1667 1 quad amp text for quad k 1 dots k alpha k amp tilde alpha k frac log 1 05 6 quad amp text for quad k 1 dots k r t m amp mu m exp beta m x k text ld sum k 1 k alpha k x k quad amp text for quad m 1 dots m t 1 dots t tilde r t m amp 1 frac 1 p m sum tau 1 t 1 c tau m quad amp text for quad m 1 dots m t t text impute 1 dots t c t m amp y m quad amp text for quad m 1 dots m t 1 dots t text impute c t m amp tilde r t m sum tau 1 t 1 c tau m s t tau quad amp text for quad m 1 dots m t t text impute 1 dots t varepsilon m text ifr amp sim mathcal n 1 0 1 quad amp text for quad m 1 dots m mathrm ifr m amp sim mathrm ifr m cdot varepsilon m text ifr quad amp text for quad m 1 dots m d t m amp mathrm ifr m sum tau 1 t 1 c tau m pi t tau quad amp text for quad m 1 dots m t 1 dots t phi amp sim mathcal n 0 5 d t m amp sim mathrm negativebinomial d t m phi quad amp text for quad m 1 dots m t 1 dots t end align where it s assumed that seeding of new infections begins 30 days before the day after a country has cumulative observed 10 deaths m denotes the number of countries t the total number of time steps t text impute the time steps to impute values for the first 6 of the 30 days we impute the number and then we simulate the rest alpha k denotes the weights for the k th intervention covariate beta m denotes the weight for the lockdown intervention whose index we denote by k text ld note that there is also a alpha k text ld which is shared between all the m countries in contrast the beta m weight is local to the country with index m this is a sort of way to try and deal with the fact that lockdown means different things in different countries e g lockdown in uk is much more severe than lockdown in norway mu m represents the r 0 value for country m i e r t without any interventions r t m denotes the reproduction number at time t for country m tilde r t m denotes the adjusted reproduction number at time t for country m adjusted in the sense that it s rescaled wrt what proportion of the population is susceptible for infection assuming infected people cannot get the virus again within the near future p m denotes the total initial population for country m mathrm ifr m denotes the infection fatality ratio for country m and mathrm ifr m the adjusted infection fatality ratio see paper varepsilon m text ifr denotes the noise for the multiplicative noise for the mathrm ifr m pi denotes the time from infection to death and is assumed to be a sum of two independent random times the incubation period infection to onset and time between onset of symptoms and death onset to death begin equation pi sim mathrm gamma 5 1 0 86 mathrm gamma 18 8 0 45 end equation where in this case the mathrm gamma is parameterized by its mean and coefficient of variation in the model this is a precomputed quantity and not something to be inferred though in an ideal world this would also be included in the model pi t then denotes a discretized version of the pdf for pi the reasoning behind the discretization is that if we assume d m t to be a continuous random variable denoting the death rate at any time t then it would be given by begin equation d m t mathrm ifr m int 0 t c m tau pi t tau dt end equation i e the convolution of the number of cases observed at time time tau c m tau and the probability of death at prior to time t for the new cases observed at time tau pi t tau assuming stationarity of pi t thus c m tau pi t tau can be interpreted as the portion people who got the virus at time tau have died at time t or rather have died after having the virus for t tau time with t gt tau discretizing then results in the above model s t denotes the serial intervals i e the time between successive cases in a chain of transmission also a precomputed quantity c t m denotes the expected daily cases at time t for country m c t m denotes the cumulative cases prior to time t for country m d t m denotes the expected daily deaths at time t for country m d t m denotes the daily deaths at time t for country m in our case this is the likelihood note that here we re using the mean and variance coefficient parameterization of mathrm negativebinomial to see the reasoning for the choices of distributions and parameters for the priors see the either the paper or the techical report from the repository codein turing jl a sample statement is defined by x distribution therefore the priors used in the model can be written within a turing jl model as exponential 1 0 03 exponential has inverse parameterization of the one in stany filldist exponential num countries truncated normal 0 5 0 inf truncated normal 0 0 5 0 inf filldist truncated normal 3 28 0 inf num countries hier filldist gamma 1667 1 num covariates hier log 1 05 6 ifr noise filldist truncated normal 1 0 1 0 inf num countries lockdown related truncated normal 0 0 2 0 inf lockdown filldist normal 0 num countries the filldist function in the above snippet is a function used to construct a distribution from which we can obtain i i d samples from a univariate distribution using vectorization and the full model is defined model function model v2 num impute int num of days for which to impute infections num total days int days of observed data num of days to forecast cases abstractvector lt abstractvector lt int reported cases deaths abstractvector lt abstractvector lt int reported deaths rows indexed by i gt n contain 1 and should be ignored abstractvector lt abstractvector lt real h s covariates vector lt abstractmatrix epidemic start abstractvector lt int population abstractvector lt real serial intervals abstractvector lt real fixed pre calculated serial interval si using empirical data from neil lockdown index int the index for the lockdown covariate in covariates predict false bool if false will only compute what s needed to observe but not more type tv vector float64 where tv covariates should be of length num countries and each entry correspond to a matrix of size num total days num covariates num covariates size covariates 1 2 num countries length cases num obs countries length cases if we don t want to predict the future we only need to compute up to time step num obs countries m last time steps predict fill num total days num countries num obs countries latent variables exponential 1 0 03 exponential has inverse parameterization of the one in stan y filldist exponential num countries truncated normal 0 5 0 inf truncated normal 0 0 5 0 inf filldist truncated normal 3 28 0 inf num countries hier filldist gamma 1667 1 num covariates hier log 1 05 6 ifr noise filldist truncated normal 1 0 1 0 inf num countries lockdown related truncated normal 0 0 2 0 inf lockdown filldist normal 0 num countries initialization of some quantities expected daily cases tv tv undef last time steps m for m in 1 num countries cases pred tv tv undef last time steps m for m in 1 num countries expected daily deaths tv tv undef last time steps m for m in 1 num countries rt tv tv undef last time steps m for m in 1 num countries rt adj tv tv undef last time steps m for m in 1 num countries loops over countries and perform independent computations for each country since this model does not include any notion of migration across borders gt might has well wrap it in a threads to perform the computation in parallel threads for m 1 num countries country specific parameters m m pop m population m expected daily cases m expected daily cases m cases pred m cases pred m expected daily deaths m expected daily deaths m rt m rt m rt adj m rt adj m last time step last time steps m imputation of num impute days expected daily cases m 1 num impute y m cases pred m 1 zero cases pred m 1 cases pred m 2 num impute cumsum expected daily cases m 1 num impute 1 xs covariates m 1 last time step extract covariates for the wanted time steps and country m rt m m exp xs lockdown m xs lockdown index adjusts for portion of pop that are susceptible rt adj m 1 num impute max pop m cases pred m 1 num impute zero cases pred m 1 pop m rt m 1 num impute for t num impute 1 last time step update cumulative cases cases pred m t cases pred m t 1 expected daily cases m t 1 adjusts for portion of pop that are susceptible rt adj m t max pop m cases pred m t zero cases pred m t pop m rt m t expected daily cases m t rt adj m t sum expected daily cases m serial intervals t for 1 t 1 end expected daily deaths m 1 1e 15 expected daily cases m 1 for t 2 last time step expected daily deaths m t sum expected daily cases m m t ifr noise m for 1 t 1 end end observe for m 1 num countries extract the estimated expected daily deaths for country m expected daily deaths m expected daily deaths m extract time steps for which we have observations ts epidemic start m num obs countries m observe deaths m ts arraydist negativebinomial2 expected daily deaths m ts end return expected daily cases expected daily cases expected daily deaths expected daily deaths rt rt rt adjusted rt adj end two things worth noting is the use of the tv variable to instantiate some internal variables and the use of threads as you can see in the arguments for the model tv refers to a type and will be recognized as such by the model macro when transforming the model code this is used to ensure type stability of the model more detailed explanation of tva default execution of the model will then use tv as vector float64 thus making statements like tv undef n result in a vector float64 with undef uninitialized values and length n but in case we use a sampler that requires automatic differentiation ad tv will be will be replaced with the ad type corresponding to a vector e g trackedvector in the case of tracker jl the use of threads means that inside each execution of the model this loop will be performed in parallel where the number of threads are specified by the enviroment variable julia num threads this is thanks to the really nice multithreading functionality introduced in julia 1 3 and so this also requires julia 1 3 or higher to run the code note that the inside the loop is independent of each other and each m will be seen by only one thread hence it s threadsafe this model is basically identitical to the one defined in stan models base stan 6ee3010 with the exception of two points in this model we use truncatednormal for normally distributed variables which are positively constrained instead of sampling from a normal and then taking the absolute value these approaches are equivalent from a modelling perspective we ve added the use of max pop m cases pred m t 0 in computing the adjusted r t rt adj to ensure that in the case where the entire populations has died there the adjusted r t is set to 0 i e if everyone in the country passed away then there is no spread of the virus this does not affect correctness of inference 1 the cases and deaths arguments are arrays of arrays instead of 3d arrays therefore we don t need to fill the future days with 1 as is done in the original model multithreaded observewe can also make the observe statements parallel but because the is not yet threadsafe we unfortunately have to touch some of the internals of turing jl but for observations it s very straight forward instead of observing by the following piece of codefor m 1 num countries extract the estimated expected daily deaths for country m expected daily deaths m expected daily deaths m extract time steps for which we have observations ts epidemic start m num obs countries m observe deaths m ts arraydist negativebinomial2 expected daily deaths m ts endwe can use the following doing observations in parallel provides a small speeduplogps tv undef num countries threads for m 1 num countries extract the estimated expected daily deaths for country m expected daily deaths m expected daily deaths m extract time steps for which we have observations ts epidemic start m num obs countries m observe logps m logpdf arraydist negativebinomial2 expected daily deaths m ts deaths m ts endturing acclogp varinfo sum logps explanation of what we just didit might be worth explaining a bit about what s going on here first we should explain what the deal is with varinfo varinfo is basically the object used internally in turing to track the sampled variables and the log pdf for a particular evaluation of the model and so acclogp varinfo lp will increment the log pdf stored in varinfo by lp with that we can explain what happens to inside the macro using the old observe snippet as an example the model macro replaces withacclogp varinfo logpdf arraydist negativebinomial2 expected daily deaths m ts deaths m ts but we re iterating through m so this would not be thread safe since you might be two threads attempting to mutate varinfo simultaneously fn2 therefore since no threads sees the same m delaying the accumulation to after having computed all the log pdf in parallel leaves us with equivalent code that is threadsafe you can read more about the macro and its internals here final modelthis results in the following model definition model function model v2 num impute int num of days for which to impute infections num total days int days of observed data num of days to forecast cases abstractvector lt abstractvector lt int reported cases deaths abstractvector lt abstractvector lt int reported deaths rows indexed by i gt n contain 1 and should be ignored abstractvector lt abstractvector lt real h s covariates vector lt abstractmatrix epidemic start abstractvector lt int population abstractvector lt real serial intervals abstractvector lt real fixed pre calculated serial interval si using empirical data from neil lockdown index int the index for the lockdown covariate in covariates predict false bool if false will only compute what s needed to observe but not more type tv vector float64 where tv covariates should be of length num countries and each entry correspond to a matrix of size num total days num covariates num covariates size covariates 1 2 num countries length cases num obs countries length cases if we don t want to predict the future we only need to compute up to time step num obs countries m last time steps predict fill num total days num countries num obs countries latent variables exponential 1 0 03 exponential has inverse parameterization of the one in stan y filldist exponential num countries truncated normal 0 5 0 inf truncated normal 0 0 5 0 inf filldist truncated normal 3 28 0 inf num countries hier filldist gamma 1667 1 num covariates hier log 1 05 6 ifr noise filldist truncated normal 1 0 1 0 inf num countries lockdown related truncated normal 0 0 2 0 inf lockdown filldist normal 0 num countries initialization of some quantities expected daily cases tv tv undef last time steps m for m in 1 num countries cases pred tv tv undef last time steps m for m in 1 num countries expected daily deaths tv tv undef last time steps m for m in 1 num countries rt tv tv undef last time steps m for m in 1 num countries rt adj tv tv undef last time steps m for m in 1 num countries loops over countries and perform independent computations for each country since this model does not include any notion of migration across borders gt might has well wrap it in a threads to perform the computation in parallel threads for m 1 num countries country specific parameters m m pop m population m expected daily cases m expected daily cases m cases pred m cases pred m expected daily deaths m expected daily deaths m rt m rt m rt adj m rt adj m last time step last time steps m imputation of num impute days expected daily cases m 1 num impute y m cases pred m 1 zero cases pred m 1 cases pred m 2 num impute cumsum expected daily cases m 1 num impute 1 xs covariates m 1 last time step extract covariates for the wanted time steps and country m rt m m exp xs lockdown m xs lockdown index adjusts for portion of pop that are susceptible rt adj m 1 num impute max pop m cases pred m 1 num impute zero cases pred m 1 pop m rt m 1 num impute for t num impute 1 last time step update cumulative cases cases pred m t cases pred m t 1 expected daily cases m t 1 adjusts for portion of pop that are susceptible rt adj m t max pop m cases pred m t zero cases pred m t pop m rt m t expected daily cases m t rt adj m t sum expected daily cases m serial intervals t for 1 t 1 end expected daily deaths m 1 1e 15 expected daily cases m 1 for t 2 last time step expected daily deaths m t sum expected daily cases m m t ifr noise m for 1 t 1 end end observe doing observations in parallel provides a small speedup logps tv undef num countries threads for m 1 num countries extract the estimated expected daily deaths for country m expected daily deaths m expected daily deaths m extract time steps for which we have observations ts epidemic start m num obs countries m observe logps m logpdf arraydist negativebinomial2 expected daily deaths m ts deaths m ts end turing acclogp varinfo sum logps return expected daily cases expected daily cases expected daily deaths expected daily deaths rt rt rt adjusted rt adj end warning you are using the internal variable varinfo dynamicppl homes tef30 julia packages dynamicppl 3jy49 src compiler jl 175we define an alias model def so that if we want to try out a different model there s only one point in the notebook which we need to change model def model v2 the input data have up to 30 40 days of unobserved future data which we might want to predict on but during sampling we don t want to waste computation on sampling for the future for which we do not have any observations therefore we have an argument predict bool in the model which allows us to specify whether or not to generate future quantities model instantance used to for inferencem no pred model def data num impute data num total days data cases data deaths data data covariates data epidemic start data population data serial intervals lockdown index false lt don t predict model instance used for predictionm model def data num impute data num total days data cases data deaths data data covariates data epidemic start data population data serial intervals lockdown index true lt predict just to make sure everything is working we can evaluate the model to obtain a sample from the prior res m res expected daily cases uk index 100 element array float64 1 0 2978422827487166 0 2978422827487166 0 2978422827487166 0 2978422827487166 0 2978422827487166 0 2978422827487166 0 832817101553483 1 0346063917235566 1 3678178161493468 1 8604943842674377 2 546129501657631 3 4852378065416523 4 768875412263893 0 24406116233616038 0 17186744515247868 0 1208474970159245 0 08485139699103932 0 05949579772505278 0 04166274540068994 0 029138775736189983 0 02035555519759347 0 014203911930339133 0 009900796534873262 0 00689432670057081 0 004796166095549548visualization utilitiesfor visualisation we of course use plots jl and in this case we re going to use the pyplot backend which uses python s matplotlib under the hood using plots statsplotsmethod definition for plotting the predictive distribution ehh this can be made nicer function country prediction plot country idx predictions country abstractmatrix e deaths country abstractmatrix rt country abstractmatrix normalize pop bool false main title pop data population country idx num total days data num total days num observed days length data cases country idx country name countries country idx start date first country to dates country name dates cumsum fill day 1 data num total days start date day 1 date strings dates format dates y mm dd a tiny bit of preprocessing of the data preproc x normalize pop x pop x daily deaths data deaths country idx daily cases data cases country idx p1 plot xaxis false legend topleft bar preproc daily deaths label observed daily deaths title replace country name gt main title vline data epidemic start country idx label epidemic start linewidth 2 vline num observed days label end of observations linewidth 2 xlims 0 num total days p2 plot legend topleft xaxis false plot confidence timeseries p2 preproc e deaths country label expected daily deaths title expected daily deaths pred bar preproc daily deaths label recorded daily deaths observed alpha 0 5 p3 plot legend bottomleft xaxis false plot confidence timeseries p3 rt country no label true for c idx c time in enumerate findfirst 1 eachcol data covariates country idx if c time nothing c name names covariates c idx if c name any don t add the any intervention stuff vline c time 1 label c name end end end title rt qs quantile v 0 025 0 975 for v in eachrow rt country lq hq eachrow hcat qs ylims 0 maximum hq 0 1 p4 plot legend topleft xaxis false plot confidence timeseries p4 preproc predictions country label expected daily cases title expected daily cases pred bar preproc daily cases label recorded daily cases observed alpha 0 5 vals preproc cumsum e deaths country dims 1 p5 plot legend topleft xaxis false plot confidence timeseries p5 vals label expected deaths plot preproc cumsum daily deaths label recorded deaths observed color red title expected deaths pred vals preproc cumsum predictions country dims 1 p6 plot legend topleft plot confidence timeseries p6 vals label expected cases plot preproc daily cases label recorded cases observed color red title expected cases pred p plot p1 p3 p2 p4 p5 p6 layout 6 1 size 900 1200 sharex true xticks 1 3 num total days date strings 1 3 end xrotation 45 return pendfunction country prediction plot country idx cases e deaths rt kwargs n length cases e deaths country hcat e deaths t country idx for t 1 n rt country hcat rt t country idx for t 1 n predictions country hcat cases t country idx for t 1 n return country prediction plot country idx predictions country e deaths country rt country kwargs endcountry prediction plot generic function with 2 methods function arrarrarr2arr a abstractvector lt abstractvector lt abstractvector t where t lt real n1 n2 n3 length a length first a length first first a a zeros t n1 n2 n3 for i 1 n1 for j 1 n2 for k 1 n3 a i j k a i j k end end end return aendfunction country cumulative prediction vals abstractarray lt real 3 normalize pop false no label false kwargs lqs mqs hqs labels for country idx in 1 length countries val vals country idx n size val 1 pop data population country idx num total days data num total days num observed days length data cases country idx country name countries country idx a tiny bit of preprocessing of the data preproc x normalize pop x pop x tmp preproc cumsum val dims 1 qs quantile tmp t 0 025 0 5 0 975 for t 1 n lq mq hq eachrow hcat qs push lqs lq push mqs mq push hqs hq push labels country name end lqs reduce hcat collect lqs mqs reduce hcat collect mqs hqs reduce hcat collect hqs p plot kwargs for country idx in 1 length countries label no label labels country idx plot mqs country idx ribbon mqs country idx lqs country idx hqs country idx mqs country idx label label end return pendcountry cumulative prediction generic function with 1 method daily deaths arr arrarrarr2arr daily deaths posterior daily deaths arr permutedims daily deaths arr 2 3 1 daily cases arr arrarrarr2arr daily cases posterior daily cases arr permutedims daily cases arr 2 3 1 14 100 4000 array float64 3 1 31 6314 31 6314 31 6314 31 6314 156 61 151 178 35 2791 35 2791 35 2791 35 2791 3646 08 3431 64 5 82819 5 82819 5 82819 5 82819 6416 22 6282 52 32 4507 32 4507 32 4507 32 4507 9749 19 9408 06 33 8585 33 8585 33 8585 33 8585 6107 9 5812 33 14 4027 14 4027 14 4027 14 4027 13849 1 13444 2 13 4485 13 4485 13 4485 13 4485 73 396 70 6272 5 32057 5 32057 5 32057 5 32057 45867 8 45212 0 31 3424 31 3424 31 3424 31 3424 191 955 186 097 93 6691 93 6691 93 6691 93 6691 53568 5 53719 7 25 9993 25 9993 25 9993 25 9993 130 31 122 522 63 4528 63 4528 63 4528 63 4528 0 135277 0 120549 30 3088 30 3088 30 3088 30 3088 86 6885 82 4991 58 7329 58 7329 58 7329 58 7329 364 967 341 81 2 21 8248 21 8248 21 8248 21 8248 59 4495 56 6651 17 6305 17 6305 17 6305 17 6305 2751 21 2577 23 17 5398 17 5398 17 5398 17 5398 2514 87 2422 85 39 3773 39 3773 39 3773 39 3773 2572 54 2435 6 13 8745 13 8745 13 8745 13 8745 7143 99 6796 27 2 43846 2 43846 2 43846 2 43846 21861 8 21394 1 16 6948 16 6948 16 6948 16 6948 12 4779 11 7615 7 64907 7 64907 7 64907 7 64907 43911 9 43155 0 54 9893 54 9893 54 9893 54 9893 164 217 158 063 96 3331 96 3331 96 3331 96 3331 52492 8 52575 9 6 69537 6 69537 6 69537 6 69537 291 955 278 593 41 8925 41 8925 41 8925 41 8925 0 0549723 0 0484776 10 4633 10 4633 10 4633 10 4633 1133 48 1110 4 53 9036 53 9036 53 9036 53 9036 285 281 266 222 3 45 2317 45 2317 45 2317 45 2317 61 406 58 6976 29 357 29 357 29 357 29 357 3176 11 2995 15 30 394 30 394 30 394 30 394 1196 45 1139 83 125 299 125 299 125 299 125 299 6239 52 5961 07 36 4959 36 4959 36 4959 36 4959 4289 44 4052 54 19 2367 19 2367 19 2367 19 2367 19999 4 19513 5 16 405 16 405 16 405 16 405 13 0237 12 2817 15 1937 15 1937 15 1937 15 1937 36906 7 36324 8 47 9864 47 9864 47 9864 47 9864 198 327 192 355 145 876 145 876 145 876 145 876 95512 4 93517 3 12 7606 12 7606 12 7606 12 7606 140 283 132 076 84 0577 84 0577 84 0577 84 0577 0 0887854 0 078702 66 317 66 317 66 317 66 317 26 8103 25 0513 50 1513 50 1513 50 1513 50 1513 385 437 362 086 3998 40 6005 40 6005 40 6005 40 6005 41 3201 39 257 37 4406 37 4406 37 4406 37 4406 5168 87 4928 88 6 66627 6 66627 6 66627 6 66627 1796 71 1724 79 19 2496 19 2496 19 2496 19 2496 2893 68 2735 41 21 6056 21 6056 21 6056 21 6056 13520 2 13034 5 4 69097 4 69097 4 69097 4 69097 12729 8 12386 1 42 8182 42 8182 42 8182 42 8182 326 627 322 394 7 19116 7 19116 7 19116 7 19116 50203 4 49797 1 26 3942 26 3942 26 3942 26 3942 263 88 256 656 53 6565 53 6565 53 6565 53 6565 83072 5 82676 3 24 4936 24 4936 24 4936 24 4936 153 229 144 346 46 8848 46 8848 46 8848 46 8848 3 16499 2 94815 74 0729 74 0729 74 0729 74 0729 34 9909 32 6986 84 5948 84 5948 84 5948 84 5948 600 202 567 397 3999 17 5754 17 5754 17 5754 17 5754 246 31 239 819 46 9688 46 9688 46 9688 46 9688 2641 87 2474 16 5 1029 5 1029 5 1029 5 1029 2141 21 2071 62 30 5983 30 5983 30 5983 30 5983 2429 53 2299 52 15 1354 15 1354 15 1354 15 1354 15339 1 14856 2 12 5852 12 5852 12 5852 12 5852 19716 9 19184 8 20 7569 20 7569 20 7569 20 7569 198 359 193 751 9 44519 9 44519 9 44519 9 44519 67919 1 66470 7 46 0889 46 0889 46 0889 46 0889 106 309 102 061 87 7028 87 7028 87 7028 87 7028 103695 0 102949 0 34 3861 34 3861 34 3861 34 3861 299 303 285 163 114 996 114 996 114 996 114 996 0 367775 0 332197 51 0231 51 0231 51 0231 51 0231 306 67 296 26 95 074 95 074 95 074 95 074 683 525 647 794 4000 41 9978 41 9978 41 9978 41 9978 267 147 260 315 29 6776 29 6776 29 6776 29 6776 6149 86 5851 81 45 4262 45 4262 45 4262 45 4262 2766 05 2682 29 67 3271 67 3271 67 3271 67 3271 3339 49 3174 33 72 374 72 374 72 374 72 374 13353 4 12889 1 5 65709 5 65709 5 65709 5 65709 39438 8 38904 1 17 4738 17 4738 17 4738 17 4738 49 7947 47 6519 16 4718 16 4718 16 4718 16 4718 33295 2 32990 2 65 9772 65 9772 65 9772 65 9772 199 27 193 239 87 5592 87 5592 87 5592 87 5592 32651 7 32673 7 11 5608 11 5608 11 5608 11 5608 480 357 461 34 88 1057 88 1057 88 1057 88 1057 0 0795788 0 070559 27 258 27 258 27 258 27 258 97 7505 92 8548 28 6621 28 6621 28 6621 28 6621 577 574 545 546to make the plots interactive we re going to use the plotlyjs jl backend which generates plotly js plots under the hood plotlyjs plots plotlyjsbackend country cumulative prediction daily deaths arr size 800 300 title expected deaths 95 intervals country cumulative prediction daily deaths arr normalize pop true size 800 300 title expected deaths population 95 intervals in the following sections we re instead going to use pyplot jl as backend which uses python s matplotlib under the hood instead of plotly js since too many plotly js plots can slow down even the finest of computers pyplot plots pyplotbackend priorbefore we do any inference it can be useful to inspect the prior distribution in particular if you are working with a hierarchical model where the dependencies in the prior might lead to some unexpected behavior in turing jl you can sample a chain from the prior using sample much in the same way as you would sample from the posterior chain prior sample m turing inference priorsampler 1 000 plot chain prior 5 linewidth 1 5 for the same reasons it can be very useful to inspect the prior predictive distribution compute the generated quantities for the priorgenerated prior vectup2tupvec generated quantities m chain prior daily cases prior daily deaths prior rt prior rt adj prior generated prior country prediction plot uk index daily cases prior daily deaths prior rt prior main title prior and with the rt adjusted for remaining population country prediction plot uk index daily cases prior daily deaths prior rt adj prior main title prior at this point it might be useful to remind ourselves of the total population of uk is data population uk index 67886004as we can see from the figures the prior allows scenarios such as all of the uk being infected effects of interventions e g lockdown having a negative effect on rt in the sense that it can actually increase the spread of the virus you can see this from the fact that the 95 confidence interval widens after one of the interventionsbut at the same time it s clear that a very sudden increase from 0 to 100 of the population being infected is almost impossible under the prior all in all the model prior seems a reasonable choice it allows for extreme situations without putting too much probabilty mass on those while still encoding some structure in the model posterior inferenceparameters warmup 1000 steps 3000 inferencerunto perform inference for the model we would simply run the code below chains posterior sample m no pred nuts parameters warmup 0 95 10 parameters steps parameters warmup but unfortunately it takes quite a while to run performing inference using nuts with 1000 steps for adaptation warmup and 3000 sample steps takes 2hrs on a 6 core computer with julia num threads 6 and so we re instead going to load in the chains needed in contrast stan only takes roughly 1hr on a single thread using the base model from the repository on a single thread turing jl is 4 5x slower for this model which is quite signficant this generally means that if you have a clear model in mind or you re already very familiar with stan you probably want to use stan for these kind of models on the other hand if you re in the process of heavily tweaking your model and need to be able to do m model data m to check if it works or you want more flexibility in what you can do with your model e g discrete variables turing jl might be a good option and this is an additional reason why we wanted to perform this replication study we want turing jl to be useful and the way to check this is by applying turing jl to real world problem rather than just benchmarks though those are important too and regarding the performance difference it really comes down to the difference in implementation of automatic differentation ad turing jl allows you to choose from the goto ad packages in julia e g in our runs we used forwarddiff jl while stan as a very very fast ad implementation written exclusively for stan this difference becomes very clear in models such as this one where we have a lot of for loops and recursive relationships because this means that we can t easily vectorize for loops in julia are generally blazingly fast but with ad there s a bit of overhead but that also means that in turing jl you have the ability to choose between different approaches to ad i e forward mode or reverse mode each with their different tradeoffs and thus will benefit from potentially interesting future work e g source to source ad using zygote jl 2and one interesting tidbit is that you can very easily use pystan within pycall jl to sample from a stan model and then convert the results into a mcmcchains jl this has some nice implications we can use all the convenient posterior analysis tools available in mcmcchains jl to analyze chains from stan we can use the generated quantities method in this notebook to execute the turing jl model on the samples obtain using stanthis was quite useful for us to be able validate the results from turing jl against those from stan and made it very easy to check that indeed turing jl and stan produce the same results you can find examples of this in the notebooks in our repository sampling from stan in julia using pystanfirst we import pycall allowing us to call python code from within julia using pycallusing pycall pyimportpystan pyimport pystan then we define the stan model as a stringmodel str raw data int lt lower 1 gt m number of countries int lt lower 1 gt p number of covariates int lt lower 1 gt n0 number of days for which to impute infections int lt lower 1 gt n m days of observed data for country m each entry must be lt n2 int lt lower 1 gt n2 days of observed data of days to forecast int cases n2 m reported cases int deaths n2 m reported deaths the rows with i gt n contain 1 and should be ignored matrix n2 m f h s matrix n2 p x m features matrix int epidemicstart m real pop m real si n2 fixed pre calculated si using emprical data from neil transformed data vector n2 si rev si in reverse order vector n2 f rev m f in reversed order for i in 1 n2 si rev i si n2 i 1 for m in 1 m for i in 1 n2 f rev m i f n2 i 1 m parameters real lt lower 0 gt mu m intercept for rt real lt lower 0 gt alpha hier p sudo parameter for the hier term for alpha real lt lower 0 gt gamma vector m lockdown real lt lower 0 gt kappa real lt lower 0 gt y m real lt lower 0 gt phi real lt lower 0 gt tau real lt lower 0 gt ifr noise m transformed parameters vector p alpha matrix n2 m prediction rep matrix 0 n2 m matrix n2 m e deaths rep matrix 0 n2 m matrix n2 m rt rep matrix 0 n2 m matrix n2 m rt adj rt matrix n2 m cumm sum rep matrix 0 n2 m for i in 1 p alpha i alpha hier i log 1 05 6 0 for m in 1 m prediction 1 n0 m rep vector y m n0 learn the number of cases in the first n0 days cumm sum 2 n0 m cumulative sum prediction 2 n0 m rt m mu m exp x m alpha x m 5 lockdown m rt adj 1 n0 m rt 1 n0 m for i in n0 1 n2 real convolution dot product sub col prediction 1 m i 1 tail si rev i 1 cumm sum i m cumm sum i 1 m prediction i 1 m rt adj i m pop m cumm sum i m pop m rt i m prediction i m rt adj i m convolution e deaths 1 m 1e 15 prediction 1 m for i in 2 n2 e deaths i m ifr noise m dot product sub col prediction 1 m i 1 tail f rev m i 1 model tau exponential 0 03 for m in 1 m y m exponential 1 tau gamma normal 0 2 lockdown normal 0 gamma phi normal 0 5 kappa normal 0 0 5 mu normal 3 28 kappa citation https academic oup com jtm article 27 2 taaa021 5735319 alpha hier gamma 1667 1 ifr noise normal 1 0 1 for m in 1 m deaths epidemicstart m n m m neg binomial 2 e deaths epidemicstart m n m m phi generated quantities matrix n2 m prediction0 rep matrix 0 n2 m matrix n2 m e deaths0 rep matrix 0 n2 m matrix n2 m cumm sum0 rep matrix 0 n2 m for m in 1 m for i in 2 n0 cumm sum0 i m cumm sum0 i 1 m y m prediction0 1 n0 m rep vector y m n0 for i in n0 1 n2 real convolution0 dot product sub col prediction0 1 m i 1 tail si rev i 1 cumm sum0 i m cumm sum0 i 1 m prediction0 i 1 m prediction0 i m pop m cumm sum0 i m pop m mu m convolution0 e deaths0 1 m 1e 15 prediction0 1 m for i in 2 n2 e deaths0 i m ifr noise m dot product sub col prediction0 1 m i 1 tail f rev m i 1 we need the data to be in a format compatible with the stan model which we can accomplish by converting rdata into a dict d dict k rdata k for k in keys rdata values df and keys df have different ordering so don t do dict keys df values df then we can compile the stan modelsm pystan stanmodel model code model str and finally fit fit stan n iters 300 warmup 100 sm sampling data d iter n iters chains 1 warmup warmup algorithm nuts control dict adapt delta gt 0 95 max treedepth gt 10 f fit stan parameters steps parameters warmup parameters warmup from the fit we can extract the inferred parameters la f extract permuted true or if you ve done this before and saved the results using serialization jl you can load the results using serializationstan chain fname first s for s in readdir outdir if occursin stan s la open io gt deserialize io outdir stan chain fname r dict any any with 17 entries e deaths gt 6 52866e 14 5 9334e 7 2 40106 2 31387 4 77975e 14 3 5296 ifr noise gt 0 890352 1 05228 1 19123 0 833645 0 723459 1 03243 0 8 alpha gt 0 00813169 0 00812908 0 723476 0 00112684 0 237363 0 e deaths0 gt 6 52866e 14 5 9334e 7 83 0411 71 0609 4 77975e 14 3 5296 tau gt 53 4179 96 0101 38 1312 68 78 49 8292 45 3714 80 3358 rt adj gt 3 69848 3 69848 0 762185 0 762171 4 19599 4 19599 0 77 mu gt 3 69848 3 8664 3 68493 4 11784 4 19599 3 8219 4 09925 prediction0 gt 65 2866 65 2866 1 56204 1 22123 47 7975 47 7975 0 1296 lp gt 560668 0 560680 0 560685 0 560670 0 560671 0 560694 0 kappa gt 1 05947 0 913342 1 05901 1 17966 1 12473 1 21213 0 99 alpha hier gt 1 73288e 16 2 6161e 6 0 731608 0 00700485 0 245495 0 023 prediction gt 65 2866 65 2866 106 091 102 225 47 7975 47 7975 206 13 phi gt 6 8105 7 36518 6 41771 7 13139 6 70706 7 06452 7 0425 gamma gt 0 107149 0 129599 0 118666 0 274338 0 179847 0 0386703 lockdown gt 0 0199127 0 0841175 0 0854961 0 245588 0 00700599 0 02 rt gt 3 69848 3 69848 0 770378 0 770378 4 19599 4 19599 0 78 y gt 65 2866 22 1974 75 7377 63 0177 47 7975 27 7832 48 400 and if we want to compare it with the results from turing jl it can be convenient to rename some of the variablesrename la alpha gt alpha hier gt hier kappa gt gamma gt mu gt phi gt tau gt dict any any with 17 entries hier gt 1 73288e 16 2 6161e 6 0 731608 0 00700485 0 245495 0 023 gt 3 69848 3 8664 3 68493 4 11784 4 19599 3 8219 4 09925 e deaths gt 6 52866e 14 5 9334e 7 2 40106 2 31387 4 77975e 14 3 5296 ifr noise gt 0 890352 1 05228 1 19123 0 833645 0 723459 1 03243 0 8 gt 6 8105 7 36518 6 41771 7 13139 6 70706 7 06452 7 0425 e deaths0 gt 6 52866e 14 5 9334e 7 83 0411 71 0609 4 77975e 14 3 5296 gt 0 00813169 0 00812908 0 723476 0 00112684 0 237363 0 gt 1 05947 0 913342 1 05901 1 17966 1 12473 1 21213 0 99 rt adj gt 3 69848 3 69848 0 762185 0 762171 4 19599 4 19599 0 77 gt 0 107149 0 129599 0 118666 0 274338 0 179847 0 0386703 prediction0 gt 65 2866 65 2866 1 56204 1 22123 47 7975 47 7975 0 1296 gt 53 4179 96 0101 38 1312 68 78 49 8292 45 3714 80 3358 lp gt 560668 0 560680 0 560685 0 560670 0 560671 0 560694 0 prediction gt 65 2866 65 2866 106 091 102 225 47 7975 47 7975 206 13 lockdown gt 0 0199127 0 0841175 0 0854961 0 245588 0 00700599 0 02 rt gt 3 69848 3 69848 0 770378 0 770378 4 19599 4 19599 0 78 y gt 65 2866 22 1974 75 7377 63 0177 47 7975 27 7832 48 400 extract a subset of the variables since we don t want everything in a chains objectla subset dict k gt la k for k in y hier ifr noise lockdown dict string array float64 n where n with 9 entries hier gt 1 73288e 16 2 6161e 6 0 731608 0 00700485 0 245495 0 02364 gt 3 69848 3 8664 3 68493 4 11784 4 19599 3 8219 4 09925 3 gt 0 107149 0 129599 0 118666 0 274338 0 179847 0 0386703 gt 53 4179 96 0101 38 1312 68 78 49 8292 45 3714 80 3358 gt 6 8105 7 36518 6 41771 7 13139 6 70706 7 06452 7 04253 ifr noise gt 0 890352 1 05228 1 19123 0 833645 0 723459 1 03243 0 892 gt 1 05947 0 913342 1 05901 1 17966 1 12473 1 21213 0 9978 lockdown gt 0 0199127 0 0841175 0 0854961 0 245588 0 00700599 0 0258 y gt 65 2866 22 1974 75 7377 63 0177 47 7975 27 7832 48 4006 in covid19 jl we ve added a constructor for mcmcchains chains which takes a dict as an argument easily allowing us to convert the la from stan into a chains object function mcmcchains cat val 3 c1 chains args chains check inputs rng range c1 or not he he he all c gt range c rng args throw argumenterror chain ranges differ nms names c1 all c gt names c nms args throw argumenterror chain names differ concatenate all chains data mapreduce c gt c value data x y gt cat x y dims 3 args init c1 value data value mcmcchains axisarray data iter rng var nms chain 1 size data 3 return chains value missing c1 name map c1 info endstan chain chains la subset lt results in all chains being concatenated together so we need to manually separate themsteps per chain parameters stepsnum chains int length stan chain steps per chain stan chains stan chain 1 i 1 steps per chain i steps per chain for i 1 num chains stan chains chainscat stan chains stan chains stan chains 1 3 end thinobject of type chains with data of type 1000 66 4 array float64 3 iterations 1 2998thinning interval 3chains 1 2 3 4samples per chain 1000parameters hier 1 hier 2 hier 3 hier 4 hier 5 hier 6 1 2 3 4 5 6 7 8 9 10 11 12 13 14 ifr noise 1 ifr noise 2 ifr noise 3 ifr noise 4 ifr noise 5 ifr noise 6 ifr noise 7 ifr noise 8 ifr noise 9 ifr noise 10 ifr noise 11 ifr noise 12 ifr noise 13 ifr noise 14 lockdown 1 lockdown 2 lockdown 3 lockdown 4 lockdown 5 lockdown 6 lockdown 7 lockdown 8 lockdown 9 lockdown 10 lockdown 11 lockdown 12 lockdown 13 lockdown 14 y 1 y 2 y 3 y 4 y 5 y 6 y 7 y 8 y 9 y 10 y 11 y 12 y 13 y 14 2 element array chaindataframe 1 summary statistics parameters mean std naive se mcse ess r hat hier 1 0 0250 0 0509 0 0008 0 0009 3762 6907 0 9994 hier 2 0 0294 0 0562 0 0009 0 0010 4096 3296 1 0021 hier 3 0 4865 0 1666 0 0026 0 0031 3769 7698 1 0021 hier 4 0 0150 0 0322 0 0005 0 0005 3963 6029 1 0003 hier 5 1 1267 0 1498 0 0024 0 0022 3990 6714 0 9996 hier 6 0 0647 0 1037 0 0016 0 0024 4037 5795 1 0053 1 3 9594 0 4722 0 0075 0 0075 4064 2020 0 9996 2 3 5951 0 1701 0 0027 0 0029 3684 0289 1 0005 3 4 2405 0 4080 0 0065 0 0092 4232 5667 1 0054 4 4 5359 0 3732 0 0059 0 0078 4075 5280 1 0031 5 3 9081 0 2873 0 0045 0 0076 4106 5761 1 0080 6 4 9298 0 3241 0 0051 0 0050 3850 5272 1 0009 7 3 8319 0 5364 0 0085 0 0075 3956 2449 0 9997 8 6 3026 0 7068 0 0112 0 0106 3641 7136 1 0005 9 4 3273 0 5181 0 0082 0 0077 4059 0140 1 0002 10 2 4113 0 2297 0 0036 0 0049 4080 2115 1 0035 11 3 8111 0 3755 0 0059 0 0058 3906 9576 0 9996 12 2 0742 0 2940 0 0046 0 0048 4350 2472 0 9997 13 3 9327 0 4426 0 0070 0 0068 4062 9915 0 9999 14 3 6872 0 3501 0 0055 0 0052 3971 6142 1 0001 0 1132 0 0683 0 0011 0 0014 3980 7969 1 0015 54 4981 17 5050 0 2768 0 2810 3759 2791 1 0007 6 8784 0 5566 0 0088 0 0078 4017 5627 1 0000 ifr noise 1 0 9994 0 1006 0 0016 0 0014 4337 3600 1 0002 ifr noise 2 0 9957 0 0996 0 0016 0 0018 3229 4271 1 0008 ifr noise 3 0 9927 0 1001 0 0016 0 0013 4205 8756 0 9997 ifr noise 4 1 0019 0 0981 0 0016 0 0016 3779 6148 0 9994 ifr noise 5 0 9973 0 1002 0 0016 0 0015 4230 6973 1 0002 ifr noise 6 0 9901 0 0997 0 0016 0 0014 4019 0526 0 9992 ifr noise 7 0 9977 0 0985 0 0016 0 0019 4102 5786 0 9997 ifr noise 8 0 9926 0 0989 0 0016 0 0014 4172 9264 0 9998 ifr noise 9 1 0024 0 0998 0 0016 0 0015 4036 0007 1 0003 ifr noise 10 1 0143 0 1004 0 0016 0 0020 3965 4960 1 0003 ifr noise 11 0 9940 0 0984 0 0016 0 0014 4248 2237 0 9999 ifr noise 12 1 0104 0 0978 0 0015 0 0016 4037 6589 1 0012 ifr noise 13 0 9997 0 0999 0 0016 0 0016 3775 1249 1 0007 ifr noise 14 1 0048 0 0990 0 0016 0 0016 4019 4484 0 9996 1 1204 0 2167 0 0034 0 0029 4136 1687 0 9996 lockdown 1 0 0034 0 1096 0 0017 0 0012 4217 7275 0 9991 lockdown 2 0 0194 0 0852 0 0013 0 0014 4045 8681 1 0009 lockdown 3 0 0171 0 1053 0 0017 0 0019 4125 5208 1 0011 lockdown 4 0 1309 0 1242 0 0020 0 0023 4149 1488 1 0018 lockdown 5 0 0144 0 1114 0 0018 0 0020 4275 9326 1 0002 lockdown 6 0 0287 0 0933 0 0015 0 0012 4116 3446 1 0001 lockdown 7 0 0197 0 1247 0 0020 0 0021 4076 6525 1 0002 lockdown 8 0 0800 0 1130 0 0018 0 0019 3866 1604 1 0006 lockdown 9 0 0104 0 1047 0 0017 0 0016 4021 3347 0 9997 lockdown 10 0 0026 0 1326 0 0021 0 0023 4007 4693 0 9997 lockdown 11 0 0121 0 1079 0 0017 0 0019 3829 4277 0 9996 lockdown 12 0 0030 0 1271 0 0020 0 0018 4228 0928 1 0003 lockdown 13 0 0019 0 1141 0 0018 0 0016 4215 2192 0 9997 lockdown 14 0 0548 0 1179 0 0019 0 0020 3988 7643 1 0006 y 1 47 1930 23 4949 0 3715 0 3560 4301 2466 0 9999 y 2 39 9589 13 3690 0 2114 0 2264 3840 8341 1 0004 y 3 20 2291 9 8615 0 1559 0 1618 3984 8827 1 0001 y 4 74 6538 33 9382 0 5366 0 6232 4021 1495 1 0018 y 5 44 3600 17 6755 0 2795 0 3848 3408 4552 1 0043 y 6 9 5225 4 5031 0 0712 0 0750 3902 1911 1 0008 y 7 30 0746 17 9098 0 2832 0 2778 3956 5131 1 0009 y 8 17 3519 11 2451 0 1778 0 1606 3384 7290 0 9995 y 9 75 4817 36 1157 0 5710 0 5745 4155 4331 1 0010 y 10 144 5704 54 9286 0 8685 0 9158 4175 9150 1 0001 y 11 26 1128 13 4270 0 2123 0 2135 3739 8586 0 9996 y 12 84 6856 44 8467 0 7091 0 6679 4167 7817 0 9995 y 13 55 2918 25 9756 0 4107 0 4109 4327 8064 0 9999 y 14 83 2622 36 3821 0 5753 0 5105 3890 7244 1 0000quantiles parameters 2 5 25 0 50 0 75 0 97 5 hier 1 0 0000 0 0000 0 0018 0 0244 0 1820 hier 2 0 0000 0 0000 0 0024 0 0313 0 2057 hier 3 0 0946 0 3853 0 4948 0 5975 0 7926 hier 4 0 0000 0 0000 0 0010 0 0126 0 1224 hier 5 0 8434 1 0235 1 1289 1 2272 1 4198 hier 6 0 0000 0 0001 0 0103 0 0903 0 3542 1 3 1090 3 6397 3 9181 4 2532 4 9781 2 3 2701 3 4824 3 5906 3 7117 3 9333 3 3 5392 3 9578 4 1962 4 4800 5 1477 4 3 9023 4 2706 4 4931 4 7583 5 3515 5 3 4586 3 7031 3 8641 4 0777 4 5887 6 4 3074 4 7095 4 9339 5 1434 5 5663 7 2 8756 3 4622 3 8022 4 1684 4 9753 8 4 9469 5 8267 6 2903 6 7636 7 7464 9 3 3888 3 9792 4 2975 4 6499 5 4316 10 2 0541 2 2494 2 3785 2 5382 2 9642 11 3 1351 3 5524 3 7874 4 0452 4 5922 12 1 5522 1 8702 2 0543 2 2570 2 7023 13 3 1392 3 6240 3 9055 4 2166 4 8550 14 3 0547 3 4411 3 6641 3 9070 4 4457 0 0106 0 0621 0 1066 0 1540 0 2669 28 3554 41 8978 51 6206 64 4602 95 8893 5 8450 6 4945 6 8693 7 2375 8 0241 ifr noise 1 0 8053 0 9319 0 9994 1 0669 1 1991 ifr noise 2 0 8027 0 9289 0 9982 1 0624 1 1919 ifr noise 3 0 8002 0 9254 0 9940 1 0584 1 1875 ifr noise 4 0 8146 0 9355 1 0002 1 0669 1 1992 ifr noise 5 0 8044 0 9283 0 9971 1 0648 1 1926 ifr noise 6 0 7977 0 9221 0 9916 1 0580 1 1871 ifr noise 7 0 7976 0 9337 0 9976 1 0632 1 1926 ifr noise 8 0 7980 0 9262 0 9929 1 0585 1 1868 ifr noise 9 0 8115 0 9365 1 0023 1 0712 1 1955 ifr noise 10 0 8129 0 9487 1 0128 1 0832 1 2092 ifr noise 11 0 7985 0 9277 0 9939 1 0599 1 1874 ifr noise 12 0 8173 0 9461 1 0107 1 0743 1 2046 ifr noise 13 0 8069 0 9315 1 0002 1 0663 1 2020 ifr noise 14 0 8168 0 9357 1 0049 1 0718 1 1968 0 7446 0 9697 1 1048 1 2558 1 5970 lockdown 1 0 2211 0 0529 0 0012 0 0552 0 2476 lockdown 2 0 2064 0 0681 0 0127 0 0270 0 1537 lockdown 3 0 2501 0 0689 0 0097 0 0368 0 1982 lockdown 4 0 0409 0 0309 0 1091 0 2083 0 4163 lockdown 5 0 2099 0 0406 0 0063 0 0678 0 2665 lockdown 6 0 2389 0 0807 0 0173 0 0255 0 1494 lockdown 7 0 2983 0 0748 0 0083 0 0442 0 2140 lockdown 8 0 3452 0 1409 0 0560 0 0025 0 0978 lockdown 9 0 2333 0 0598 0 0036 0 0415 0 2027 lockdown 10 0 2747 0 0594 0 0012 0 0615 0 2855 lockdown 11 0 2111 0 0428 0 0049 0 0654 0 2543 lockdown 12 0 2539 0 0534 0 0010 0 0600 0 2765 lockdown 13 0 2374 0 0579 0 0012 0 0530 0 2304 lockdown 14 0 1415 0 0145 0 0319 0 1134 0 3319 y 1 15 0725 30 7683 42 5110 58 6852 108 5279 y 2 20 0808 30 2341 38 0373 47 2979 71 8859 y 3 7 0457 13 3609 18 2912 24 7683 45 4752 y 4 25 4333 50 1704 68 8542 92 8525 155 6052 y 5 17 5663 31 6674 41 9898 54 2124 85 7669 y 6 3 5671 6 3678 8 5704 11 6961 20 4845 y 7 7 6940 17 3636 25 8101 37 9979 74 9977 y 8 4 6864 9 8616 14 5959 21 2624 47 3559 y 9 27 8821 50 0205 68 1117 93 5616 165 9393 y 10 59 6325 104 7132 136 6978 177 1941 270 4725 y 11 8 3990 16 7150 23 4562 32 1587 59 1546 y 12 25 3671 53 5384 74 8896 106 1230 199 7460 y 13 19 4379 36 8008 50 4436 68 4129 119 8110 y 14 30 3896 57 3074 76 9474 101 9789 170 3966loadunfortunately the resulting chains each with 3000 steps take up a fair bit of space and are thus too large to include in the github repository as a temporary hack around this you can find download the chains from this link then you simply navigate to the project directory and unpack with that we can load the chains from disk filenames relpath outdir s for s in readdir outdir if occursin savename parameters s amp amp occursin seed s length filenames 4chains posterior vec read fname chains for fname in filenames read the different chainschains posterior chainscat chains posterior vec concatenate themchains posterior chains posterior 1 3 end lt thin so we re left with 1000 samplesobject of type chains with data of type 1000 78 4 array float64 3 iterations 1 2998thinning interval 3chains 1 2 3 4samples per chain 1000internals acceptance rate hamiltonian energy hamiltonian energy error is accept log density lp max hamiltonian energy error n steps nom step size numerical error step size tree depthparameters ifr noise 1 ifr noise 2 ifr noise 3 ifr noise 4 ifr noise 5 ifr noise 6 ifr noise 7 ifr noise 8 ifr noise 9 ifr noise 10 ifr noise 11 ifr noise 12 ifr noise 13 ifr noise 14 lockdown 1 lockdown 2 lockdown 3 lockdown 4 lockdown 5 lockdown 6 lockdown 7 lockdown 8 lockdown 9 lockdown 10 lockdown 11 lockdown 12 lockdown 13 lockdown 14 y 1 y 2 y 3 y 4 y 5 y 6 y 7 y 8 y 9 y 10 y 11 y 12 y 13 y 14 hier 1 hier 2 hier 3 hier 4 hier 5 hier 6 1 2 3 4 5 6 7 8 9 10 11 12 13 14 2 element array chaindataframe 1 summary statistics parameters mean std naive se mcse ess r hat ifr noise 1 0 9993 0 1018 0 0016 0 0016 4000 7654 1 0007 ifr noise 2 1 0000 0 0985 0 0016 0 0016 4130 0153 0 9994 ifr noise 3 0 9943 0 0986 0 0016 0 0017 4009 9552 0 9995 ifr noise 4 1 0014 0 0996 0 0016 0 0019 4073 9127 1 0006 ifr noise 5 0 9975 0 1017 0 0016 0 0017 3997 8443 1 0000 ifr noise 6 0 9919 0 0971 0 0015 0 0013 4183 1643 0 9994 ifr noise 7 0 9935 0 1000 0 0016 0 0016 3754 0585 1 0013 ifr noise 8 0 9906 0 1019 0 0016 0 0019 3764 0323 1 0002 ifr noise 9 1 0022 0 0983 0 0016 0 0017 3271 0573 1 0000 ifr noise 10 1 0143 0 0979 0 0015 0 0015 3713 8604 0 9999 ifr noise 11 0 9958 0 0990 0 0016 0 0015 4070 7331 1 0007 ifr noise 12 1 0031 0 1001 0 0016 0 0015 4062 0625 0 9994 ifr noise 13 1 0020 0 0983 0 0016 0 0017 3878 4554 1 0003 ifr noise 14 1 0051 0 0977 0 0015 0 0016 3411 2449 1 0003 lockdown 1 0 0015 0 1038 0 0016 0 0017 3351 5301 0 9992 lockdown 2 0 0189 0 0837 0 0013 0 0016 2301 1025 1 0007 lockdown 3 0 0172 0 0994 0 0016 0 0018 3307 7319 1 0002 lockdown 4 0 1181 0 1197 0 0019 0 0047 755 5366 1 0098 lockdown 5 0 0104 0 1056 0 0017 0 0021 2241 6092 1 0013 lockdown 6 0 0276 0 0903 0 0014 0 0017 1854 2957 1 0007 lockdown 7 0 0183 0 1154 0 0018 0 0022 3101 1043 1 0002 lockdown 8 0 0733 0 1121 0 0018 0 0029 1655 2705 1 0012 lockdown 9 0 0018 0 0992 0 0016 0 0015 3282 0295 0 9999 lockdown 10 0 0010 0 1272 0 0020 0 0021 3686 0479 0 9998 lockdown 11 0 0078 0 1006 0 0016 0 0015 3682 6438 0 9996 lockdown 12 0 0038 0 1192 0 0019 0 0022 3075 1532 0 9999 lockdown 13 0 0012 0 1068 0 0017 0 0022 3103 5187 1 0022 lockdown 14 0 0455 0 1113 0 0018 0 0024 2079 7790 1 0017 y 1 46 4670 23 1671 0 3663 0 3993 3051 0661 0 9997 y 2 38 6229 13 0809 0 2068 0 2614 2396 3508 0 9998 y 3 19 1768 9 4607 0 1496 0 2225 1618 4441 1 0019 y 4 73 7456 33 8283 0 5349 1 0255 1217 8814 1 0047 y 5 42 5408 17 5320 0 2772 0 3567 1816 6638 1 0023 y 6 9 1561 4 2267 0 0668 0 1047 1837 3744 1 0000 y 7 29 0679 17 4434 0 2758 0 2492 3195 2010 0 9993 y 8 16 4302 10 7746 0 1704 0 2680 1734 9104 1 0005 y 9 71 7330 33 2071 0 5251 0 6524 2360 5565 1 0006 y 10 140 8989 52 9734 0 8376 1 2555 1807 0170 1 0019 y 11 26 0038 13 2449 0 2094 0 2405 2349 8714 0 9997 y 12 82 8426 43 6475 0 6901 0 8820 2657 5728 1 0006 y 13 53 4443 25 2102 0 3986 0 4923 2491 2797 0 9997 y 14 81 7510 35 6084 0 5630 0 9667 1599 3832 1 0005 hier 1 0 0250 0 0519 0 0008 0 0009 3402 8745 1 0003 hier 2 0 0307 0 0571 0 0009 0 0011 2997 5497 1 0022 hier 3 0 4780 0 1807 0 0029 0 0084 292 5909 1 0134 hier 4 0 0167 0 0355 0 0006 0 0006 2836 6323 1 0003 hier 5 1 1276 0 1476 0 0023 0 0045 1166 6317 1 0024 hier 6 0 0776 0 1171 0 0019 0 0045 447 5792 1 0111 0 1047 0 0666 0 0011 0 0031 514 1243 1 0154 1 1469 0 2330 0 0037 0 0048 1953 9740 1 0004 1 3 9794 0 4695 0 0074 0 0092 2078 0005 0 9996 2 3 6130 0 1697 0 0027 0 0039 1763 3903 1 0002 3 4 3002 0 4351 0 0069 0 0158 589 1497 1 0091 4 4 5535 0 3895 0 0062 0 0130 824 9565 1 0066 5 3 9472 0 3079 0 0049 0 0094 829 6550 1 0073 6 4 9544 0 3259 0 0052 0 0089 1325 4430 1 0008 7 3 8631 0 5352 0 0085 0 0114 1943 5804 1 0003 8 6 3826 0 7272 0 0115 0 0213 1225 8573 1 0003 9 4 3782 0 5184 0 0082 0 0118 1846 1891 0 9997 10 2 4349 0 2378 0 0038 0 0070 931 9334 1 0053 11 3 8172 0 3753 0 0059 0 0099 1458 7896 1 0011 12 2 0997 0 3078 0 0049 0 0078 1545 5404 1 0019 13 3 9692 0 4579 0 0072 0 0119 1471 6664 1 0000 14 3 7025 0 3535 0 0056 0 0112 1150 7984 1 0006 53 0052 17 4602 0 2761 0 3973 1613 3580 1 0005 6 8730 0 5511 0 0087 0 0089 3726 1288 1 0002quantiles parameters 2 5 25 0 50 0 75 0 97 5 ifr noise 1 0 8033 0 9298 0 9989 1 0688 1 1966 ifr noise 2 0 8116 0 9329 1 0000 1 0656 1 1942 ifr noise 3 0 8007 0 9265 0 9955 1 0611 1 1846 ifr noise 4 0 8028 0 9335 1 0026 1 0698 1 1942 ifr noise 5 0 7999 0 9292 0 9974 1 0659 1 1977 ifr noise 6 0 8074 0 9268 0 9895 1 0580 1 1852 ifr noise 7 0 7950 0 9274 0 9921 1 0589 1 1930 ifr noise 8 0 7890 0 9226 0 9914 1 0563 1 1945 ifr noise 9 0 8106 0 9353 1 0015 1 0666 1 1948 ifr noise 10 0 8290 0 9479 1 0148 1 0791 1 2145 ifr noise 11 0 7956 0 9296 0 9975 1 0649 1 1865 ifr noise 12 0 8111 0 9339 1 0009 1 0706 1 2025 ifr noise 13 0 8095 0 9360 1 0020 1 0699 1 1932 ifr noise 14 0 8156 0 9396 1 0055 1 0715 1 1985 lockdown 1 0 2208 0 0530 0 0022 0 0481 0 2256 lockdown 2 0 2049 0 0622 0 0104 0 0249 0 1430 lockdown 3 0 2412 0 0645 0 0087 0 0320 0 1893 lockdown 4 0 0408 0 0218 0 0927 0 1907 0 4060 lockdown 5 0 2022 0 0411 0 0042 0 0572 0 2512 lockdown 6 0 2405 0 0711 0 0158 0 0203 0 1414 lockdown 7 0 2870 0 0666 0 0074 0 0361 0 2043 lockdown 8 0 3473 0 1313 0 0471 0 0005 0 1028 lockdown 9 0 2196 0 0470 0 0004 0 0467 0 2105 lockdown 10 0 2818 0 0537 0 0004 0 0509 0 2774 lockdown 11 0 2034 0 0401 0 0027 0 0551 0 2276 lockdown 12 0 2539 0 0480 0 0010 0 0562 0 2582 lockdown 13 0 2182 0 0528 0 0010 0 0491 0 2289 lockdown 14 0 1552 0 0158 0 0228 0 0969 0 3229 y 1 14 9179 30 0247 41 9126 58 3610 101 7665 y 2 19 5299 29 0981 36 6782 45 5189 70 1557 y 3 6 2077 12 4272 17 2003 24 0866 42 8143 y 4 23 8405 49 3363 68 8392 92 3015 153 7364 y 5 15 3591 30 0828 40 2003 52 3791 83 7325 y 6 3 4499 6 2449 8 2618 11 1259 19 4929 y 7 7 9239 16 9180 24 7996 36 2075 75 5797 y 8 4 3036 9 2674 13 7824 20 2839 46 1405 y 9 25 7094 47 7998 65 8459 88 0414 153 9687 y 10 58 3771 103 2094 134 1771 171 8739 264 0741 y 11 8 7082 16 5333 23 4436 32 4592 58 9983 y 12 23 2083 51 9796 74 6536 104 0517 191 2370 y 13 18 2376 35 3789 49 1850 65 7620 116 0045 y 14 30 5740 55 7063 75 7009 101 0443 167 4224 hier 1 0 0000 0 0000 0 0019 0 0242 0 1824 hier 2 0 0000 0 0000 0 0036 0 0332 0 2080 hier 3 0 0026 0 3730 0 4905 0 5978 0 7993 hier 4 0 0000 0 0000 0 0012 0 0144 0 1276 hier 5 0 8306 1 0298 1 1296 1 2270 1 4153 hier 6 0 0000 0 0003 0 0150 0 1156 0 4115 0 0081 0 0523 0 0975 0 1456 0 2550 0 7561 0 9801 1 1271 1 2899 1 6530 1 3 1409 3 6544 3 9459 4 2684 4 9864 2 3 2826 3 4992 3 6051 3 7255 3 9561 3 3 5900 3 9988 4 2449 4 5507 5 3007 4 3 9220 4 2754 4 5081 4 7815 5 4161 5 3 4703 3 7330 3 8936 4 1225 4 6746 6 4 3393 4 7278 4 9528 5 1696 5 6089 7 2 9072 3 4929 3 8364 4 1970 5 0471 8 4 9653 5 8929 6 3766 6 8616 7 8508 9 3 4333 4 0293 4 3408 4 6990 5 5073 10 2 0695 2 2673 2 3974 2 5695 2 9983 11 3 1598 3 5554 3 7920 4 0572 4 5967 12 1 5810 1 8869 2 0716 2 2842 2 7769 13 3 1791 3 6543 3 9293 4 2499 4 9921 14 3 0808 3 4508 3 6740 3 9262 4 4323 26 6958 40 4641 50 7268 62 4155 94 9594 5 8429 6 5022 6 8514 7 2332 8 0291plot chains posterior 5 linewidth 1 5 compute generated quantities for the chains pooled togetherpooled chains mcmcchains pool chain chains posterior generated posterior vectup2tupvec generated quantities m pooled chains daily cases posterior daily deaths posterior rt posterior rt adj posterior generated posterior the posterior predictive distribution country prediction plot uk index daily cases posterior daily deaths posterior rt posterior main title posterior and with the adjusted r t country prediction plot uk index daily cases posterior daily deaths posterior rt adj posterior main title posterior all countries prior vs posterior predictivefor the sake of completeness here are the prior and posterior predictive distributions for all the 14 countries in a side by side comparison what if we didn t do any certain interventions one interesting thing one can do after obtaining estimates for the effect of each of the interventions is to run the model but now without all or a subset of the interventions performed thus allowing us to get a sense of what the outcome would have been without those interventions and also whether or not the interventions have the wanted effect data covariates m is a binary matrix for each m country index with data covariate m k then being a binary vector representing the time series for the k th covariate 0 means the intervention has is not implemented 1 means that the intervention is implemented as an example if schools and universites were closed after the 45th day for country m then data covariate m 1 45 k are all zeros and data covariate m 45 end k are all ones get the index of schools and univerities closingschools universities closed index findfirst schools universities names covariates time series for ukdata covariates uk index schools universities closed index 100 element array float64 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0notice that the above assumes that not only are schools and universities closed at some point but rather that they also stay closed in the future at the least the future that we are considering therefore we can for example simulate what happens if we never closed schools and universities by instead setting this entire vector to 0 and re run the model on the infererred parameters similar to what we did before to compute the generated quantities e g r t convenience function for zeroing out subsets of the interventions zero covariates xs abstractmatrix lt real remove keep allows you to zero out covariates if the name of the covariate is in remove or not zero out those in keep note that only remove xor keep can be non empty useful when instantiating counter factual models as it allows one to remove keep a subset of the covariates zero covariates xs abstractmatrix lt real kwargs zero covariates xs names covariates kwargs function zero covariates xs abstractmatrix lt real names covariates remove keep assert isempty remove isempty keep only remove or keep can be non empty if isempty keep return mapreduce hcat enumerate eachcol xs do i c names covariates i remove zeros eltype c length c c end else return mapreduce hcat enumerate eachcol xs do i c names covariates i keep c zeros eltype c length c end endendzero covariates generic function with 2 methods now we can consider simulation under the posterior with no intervention and we re going to visualize the respective portions of the population by rescaling by total population what happens if we don t do anything m counterfactual model def data num impute data num total days data cases data deaths data zeros size c for c in data covariates lt remove all covariates data epidemic start data population data serial intervals lockdown index true lt use full model compute the generated quantities for the counter factual modelgenerated counterfactual vectup2tupvec generated quantities m counterfactual pooled chains daily cases counterfactual daily deaths counterfactual rt counterfactual rt adj counterfactual generated counterfactual country prediction plot 5 daily cases counterfactual daily deaths counterfactual rt adj counterfactual normalize pop true we can also consider the cases where we only do some of the interventions e g we never do a full lockdown lockdown or close schools and universities schools universities what happens if we never close schools nor do a lockdown m counterfactual model def data num impute data num total days data cases data deaths data zero covariates c remove lockdown schools universities for c in data covariates lt remove covariates data epidemic start data population data serial intervals lockdown index true lt use full model compute the generated quantities for the counter factual modelgenerated counterfactual vectup2tupvec generated quantities m counterfactual pooled chains daily cases counterfactual daily deaths counterfactual rt counterfactual rt adj counterfactual generated counterfactual country prediction plot uk index daily cases counterfactual daily deaths counterfactual rt adj counterfactual normalize pop true as mentioned this assumes that we will stay in lockdown and schools and universities will be closed in the future we can also consider say removing the lockdown i e opening up at some future point in time lift lockdown time 75new covariates copy c for c in data covariates lt going to do inplace manipulations so we copyfor covariates m new covariates covariates m lift lockdown time end lockdown index 0end what happens if we never close schools nor do a lockdown m counterfactual model def data num impute data num total days data cases data deaths data new covariates data epidemic start data population data serial intervals lockdown index true lt use full model compute the generated quantities for the counter factual modelgenerated counterfactual vectup2tupvec generated quantities m counterfactual pooled chains daily cases counterfactual daily deaths counterfactual rt counterfactual rt adj counterfactual generated counterfactual country prediction plot uk index daily cases counterfactual daily deaths counterfactual rt adj counterfactual normalize pop true conclusionwell there isn t one as stated before drawing conclusions is not the purpose of this document with that being said we are working on exploring this and other models further e g relaxing certain assumptions model validation amp comparison but this will hopefully be available in a more technical and formal report sometime in the near future after proper validation and analysis but since time is of the essence in these situations we thought it was important to make the above and related code available to the public immediately at the very least it should be comforting to know that two different ppls both produce the same inference results when the model might be used to inform policy decisions on a national level if you have any questions or comments feel free to reach out either on the github repo or to any of us personally the issue with not having the max is that it s possible to obtain a negative r t which is bad for two reasons 1 it doesn t make sense with negative spreading of the virus 2 it leads to invalid parameterization for negativebinomial2 in stan a invalid parameterization will be considered a rejected sample and thus these samples will be rejected in the case of turing jl if r t 0 then observing a positive number for daily deaths will result in inf added to the log pdf and so the sample will also be rejected hence both ppls will arrive at correct inference but with different processes 8617 recently one of our team members joined as a maintainer of reversediff jl to make sure that turing jl also has fast and reliable reverse mode differentiation reversediff jl is already compatible with turing jl but we hope that this will help make if much much faster 8617", "title": "Replication study: Estimating number of inections and impact of NPIs on COVID-19 in European countries (Imperial Report 13)"},{"location": "/posts/2020-02-12-jsoc", "text": "last year turing participated in the google summer of code gsoc through the julia language organization it was a fun time and the project was better for it turing plans to participate in the upcoming gsoc and we wanted to outline some potential projects and expectations we have for applicants if you are not aware google provides funds to students around the world to develop a project of their choice over the summer students receive funds from google and spend three months on any open source project the turing development team has prepared a list of possible projects that we have deemed valuable to the project and easy enough that it could feasibly be created in the three month limit this list is not exlusive if you have a good idea you can write it up in your proposal though it is recommend that you reach out to any of the turing team on julia s slack you can get an invite here or discourse messages on discourse should be posted to the probabilistic programming category we ll find you possible project ideas benchmarking turing s performance has been sporadically benchmarked against various other probabilistic programming languages e g turing stan pymc3 tensorflow prob but a systemic approach to studying where turing excels and where it falls short would be useful a gsoc student would implement identical models in many ppls and build tools to benchmark all ppls against one another nested sampling integration turing focuses on modularity in inference methods and the development team would like to see more inference methods particularly the popular nested sampling method a julia package nestedsamplers jl but it is not hooked up to turing and does not currently have a stable api a gsoc student would either integrate that package or construct their own nested sampling method and build it into turing automated function memoization by model annotation function memoization is a way to reduce costly function evaluation by caching the output when the same inputs are given turing s gibbs sampler often ends up rerunning expensive functions multiple times and it would be a significant performance improvement to allow turing s model compiler to automatically memoize functions where appropriate a student working on this project would become intimately familiar with turing s model compiler and build in various automated improvements making distributions gpu compatible julia s gpu tooling is generally quite good but currently turing is not able to reliably use gpus while sampling because distributions jl is not gpu compatible a student on this project would work with the turing developers and the distributions developers to allow the use of gpu parallelism where possible in turing static distributions small fixed size vectors and matrices are fairly common in turing models this means that sampling in turing can probably benefit from using statically sized vectors and matrices from staticarrays jl instead of the dynamic normal julia arrays beside the often superior performance of small static vectors and matrices static arrays are also automatically compatible with the gpu stack in julia currently the main obstacle to using staticarrays jl is that distributions in distributions jl are not compatible with staticarrays a gsoc student would adapt the multivariate and matrix variate distributions as well as the univariate distribution with vector parameters in distributions jl to make a spin off package called staticdistributions jl the student would then benchmark staticdistributions jl against distributions jl and showcase an example of using staticdistributions jl together with cuarrays jl and or cudanative jl for gpu acceleration gpnet extensions one of turing s sattelite packages gpnet is designed to provide a comprehensive suite of gaussian process tools see this issue for potential tasks there s a lot of interesting stuff going on with gps and this task in particular may have some creative freedom to it better chains and model diagnostics one package that turing and many others rely on heavily is mcmcchains jl a package designed to format store and analyze parameter samples generated during mcmc inference mcmcchains is currently showing its age a little and has many bad design choices that need to be fixed alternatively a student could contstruct a far more lightweight chain system model comparison tools turing and its sattelite packages do not currently provide a comprehensive suite of model comparison tools a critical tool for the applied statistician a student who worked on this project would implement various model comparison tools like loo and waic among others mle map tools maximum likelihood estimates mle and maximum a posteriori map estimates can currently only be done by users through a clunky set of workarounds a streamlined function like mle model or map model would be very useful for many of turing s users who want to see what the mle or map estimates look like and it may be valuable to allow for functionality that allows mcmc sampling to begin from the mle or map estimates students working on this project will work with optimization packages such as optim jl to make mle and map estimation straightforward for turing models particle sampler improvements turing s development team has spent a lot of time and energy to make inference methods more modular but turing s particle samplers have not yet been modernized and spun off into a separate package two packages that resulted from this were advancedhmc for hamiltonian mcmc methods and advancedmh for metropolis hastings style inference methods a student who worked on this project would become very familiar with turing s inference backend and with particle sampling methods this is a good project for people who love making things efficient and easily extendable other projects are welcome but we do strongly recommend discussing any potential projects with members of the turing team as they will end up mentoring gsoc students for the duration of the project we re looking forward to what people are interested in", "title": "Google Summer of Code/Julia Summer of Code"},{"location": "/posts/2019-12-14-initial-post", "text": "all good open source projects should have a blog and turing is one such project later on members of the turing team may be populating this feed with posts on topics like interesting things you can do with turing or interesting things we have seen others do development updates and major release announcements research updates explorations of turing s internals updates to turing s sattelite projects advancedhmc jl or bijectors jl stay tuned", "title": "Turing's Blog"},{"location": "/docs/contributing/guide", "text": "contributingturing is an open source project if you feel that you have some relevant skills and are interested in contributing then please do get in touch you can contribute by opening issues on github or implementing things yourself and making a pull request we would also appreciate example models written using turing turing has a style guide it is not strictly necessary to review it before making a pull request but you may be asked to change portions of your code to conform with the style guide before it is merged how to contributegetting started fork this repository clone your fork on your local machine git clone https github com your username turing jl add a remote corresponding to this repository git remote add upstream https github com turinglang turing jl what can i do look at the issues page to find an outstanding issue for instance you could implement new features fix bugs or write example models git workflowfor more information on how the git workflow typically functions please see the github s introduction or julia s contribution guide", "title": "Contributing"},{"location": "/docs/contributing/style-guide", "text": "style guidethis style guide is adapted from invenia s style guide we would like to thank them for allowing us to access and use it please don t let not having read it stop you from contributing to turing no one will be annoyed if you open a pr whose style doesn t follow these conventions we will just help you correct it before it gets merged these conventions were originally written at invenia taking inspiration from a variety of sources including python s pep8 julia s notes for contributors and julia s style guide what follows is a mixture of a verbatim copy of invenia s original guide and some of our own modifications a word on consistencywhen adhering to this style it s important to realize that these are guidelines and not rules this is stated best in the pep8 a style guide is about consistency consistency with this style guide is important consistency within a project is more important consistency within one module or function is most important but most importantly know when to be inconsistent sometimes the style guide just doesn t apply when in doubt use your best judgment look at other examples and decide what looks best and don t hesitate to ask synopsisattempt to follow both the julia contribution guidelines the julia style guide and this guide when convention guidelines conflict this guide takes precedence known conflicts will be noted in this guide use 4 spaces per indentation level no tabs try to adhere to a 92 character line length limit use upper camel case convention for modules and types use lower case with underscores for method names note julia code likes to use lower case without underscores comments are good try to explain the intentions of the code use whitespace to make the code more readable no whitespace at the end of a line trailing whitespace avoid padding brackets with spaces ex int64 value preferred over int64 value editor configurationsublime text settingsif you are a user of sublime text we recommend that you have the following options in your julia syntax specific settings to modify these settings first open any julia file jl in sublime text then navigate to preferences gt settings more gt syntax specific user translate tabs to spaces true tab size 4 trim trailing white space on save true ensure newline at eof on save true rulers 92 vim settingsif you are a user of vim we recommend that you add the following options to your vimrc file set tabstop 4 sets tabstops to a width of four columns set softtabstop 4 determines the behaviour of tab and backspace keys with expandtab set shiftwidth 4 determines the results of gt gt lt lt and au filetype julia setlocal expandtab replaces tabs with spaces au filetype julia setlocal colorcolumn 93 highlights column 93 to help maintain the 92 character line limit by default vim seems to guess that jl files are written in lisp to ensure that vim recognizes julia files you can manually have it check for the jl extension but a better solution is to install julia vim which also includes proper syntax highlighting and a few cool other features atom settingsatom defaults preferred line length to 80 characters we want that at 92 for julia to change it go to atom gt preferences gt packages search for the language julia package and open the settings for it find preferred line length under julia grammar and change it to 92 code formattingfunction namingnames of functions should describe an action or property irrespective of the type of the argument the argument s type provides this information instead for example buyfood food should be buy food food names of functions should usually be limited to one or two lowercase words ideally write buyfood not buy food but if you are writing a function whose name is hard to read without underscores then please do use them method definitionsonly use short form function definitions when they fit on a single line yes foo x int64 abs x 3 no foobar array data abstractarray t item t where t lt int64 t abs x abs item 3 for x in array data no foobar array data abstractarray t item t where t lt int64 t abs x abs item 3 for x in array data yes function foobar array data abstractarray t item t where t lt int64 return t abs x abs item 3 for x in array data endwhen using long form functions always use the return keyword yes function fnc x result zero x result fna x return resultend no function fnc x result zero x result fna x end yes function foo x y return new x y end no function foo x y new x y endfunctions definitions with parameter lines which exceed 92 characters should separate each parameter by a newline and indent by one level yes function foobar df dataframe id symbol variable symbol value abstractstring prefix abstractstring codeend ok function foobar df dataframe id symbol variable symbol value abstractstring prefix abstractstring codeend no function foobar df dataframe id symbol variable symbol value abstractstring prefix abstractstring codeend no function foobar df dataframe id symbol variable symbol value abstractstring prefix abstractstring codeendkeyword argumentswhen calling a function always separate your keyword arguments from your positional arguments with a semicolon this avoids mistakes in ambiguous cases such as splatting a dict yes xy foo x y 3 no xy foo x y 3 whitespaceavoid extraneous whitespace in the following situations immediately inside parentheses square brackets or braces yes spam ham 1 eggs no spam ham 1 eggs immediately before a comma or semicolon yes if x 4 show x y x y y x endno if x 4 show x y x y y x end when using ranges unless additional operators are used yes ham 1 9 ham 1 3 9 ham 1 3 end no ham 1 9 ham 1 3 9 yes ham lower upper ham lower step upper yes ham lower offset upper offset yes ham lower offset upper offset no ham lower offset upper offset more than one space around an assignment or other operator to align it with another yes x 1y 2long variable 3 no x 1y 2long variable 3 when using parametric types yes f a abstractarray t n where t lt real n g a abstractarray lt real n where n no f a abstractarray t n where t lt real n g a abstractarray lt real n where n always surround these binary operators with a single space on either side assignment updating operators etc numeric comparisons operators lt gt etc note that this guideline does not apply when performing assignment in method definitions yes i i 1no i i 1yes submitted 1no submitted 1yes x 2 lt yno x 2 lt y assignments using expanded array tuple or function notation should have the first open bracket on the same line assignment operator and the closing bracket should match the indentation level of the assignment alternatively you can perform assignments on a single line when they are short yes arr 1 2 3 arr 1 2 3 result function arg1 arg2 arr 1 2 3 no arr 1 2 3 arr 1 2 3 arr 1 2 3 nested array or tuples that are in expanded notation should have the opening and closing brackets at the same indentation level yes x 1 2 3 hello world a b c no y 1 2 3 hello world z 1 2 3 hello world always include the trailing comma when working with expanded arrays tuples or functions notation this allows future edits to easily move elements around or add additional elements the trailing comma should be excluded when the notation is only on a single line yes arr 1 2 3 result function arg1 arg2 arr 1 2 3 no arr 1 2 3 result function arg1 arg2 arr 1 2 3 triple quotes use the indentation of the lowest indented line excluding the opening triple quote this means the closing triple quote should be aligned to least indented line in the string triple backticks should also follow this style even though the indentation does not matter for them yes str hello world str hello world cmd program flag value parameter no str hello world commentscomments should be used to state the intended behaviour of code this is especially important when the code is doing something clever that may not be obvious upon first inspection avoid writing comments that state exactly what the code obviously does yes x x 1 compensate for border no x x 1 increment xcomments that contradict the code are much worse than no comments always make a priority of keeping the comments up to date with code changes comments should be complete sentences if a comment is a phrase or sentence its first word should be capitalized unless it is an identifier that begins with a lower case letter never alter the case of identifiers if a comment is short the period at the end can be omitted block comments generally consist of one or more paragraphs built out of complete sentences and each sentence should end in a period comments should be separated by at least two spaces from the expression and have a single space after the when referencing julia in documentation note that julia refers to the programming language while julia typically in backticks e g julia refers to the executable a commmentcode another commentmore codetododocumentationit is recommended that most modules types and functions should have docstrings that being said only exported functions are required to be documented avoid documenting methods like as the built in docstring for the function already covers the details well try to document a function and not individual methods where possible as typically all methods will have similar docstrings if you are adding a method to a function which was defined in base or another package only add a docstring if the behaviour of your function deviates from the existing docstring docstrings are written in markdown and should be concise docstring lines should be wrapped at 92 characters bar x y compute the bar index between x and y if y is missing compute the bar index betweenall pairs of columns of x function bar x y when types or methods have lots of parameters it may not be feasible to write a concise docstring in these cases it is recommended you use the templates below note if a section doesn t apply or is overly verbose for example throws if your function doesn t throw an exception it can be excluded it is recommended that you have a blank line between the headings and the content when the content is of sufficient length try to be consistent within a docstring whether you use this additional whitespace note that the additional space is only for reading raw markdown and does not effect the rendered version type template should be skipped if is redundant with the constructor s docstring myarray t n my super awesome array wrapper fields data abstractarray t n stores the array being wrapped metadata dict stores metadata about the array struct myarray t n lt abstractarray t n data abstractarray t n metadata dictendfunction template only required for exported functions mysearch array myarray t val t verbose true where t gt intsearches the array for the val for some reason we don t want to use julia sbuiltin search arguments array myarray t the array to search val t the value to search for keywords verbose bool true print out progress details returns int the index where val is located in the array throws notfounderror i guess we could throw an error if val isn t found function mysearch array abstractarray t val t where t endif your method contains lots of arguments or keywords you may want to exclude them from the method signature on the first line and instead use args and or kwargs manager args kwargs gt managera cluster manager which spawns workers arguments min workers integer the minimum number of workers to spawn or an exception is thrown max workers integer the requested number of worker to spawn keywords definition abstractstring name of the job definition to use defaults to the definition used within the current instance name abstractstring queue abstractstring function manager endfeel free to document multiple methods for a function within the same docstring be careful to only do this for functions you have defined manager max workers kwargs manager min workers max workers kwargs manager min workers max workers kwargs a cluster manager which spawns workers arguments min workers int the minimum number of workers to spawn or an exception is thrown max workers int the number of requested workers to spawn keywords definition abstractstring name of the job definition to use defaults to the definition used within the current instance name abstractstring queue abstractstring function manager endif the documentation for bullet point exceeds 92 characters the line should be wrapped and slightly indented avoid aligning the text to the keywords definition abstractstring name of the job definition to use defaults to the definition used within the current instance for additional details on documenting in julia see the official documentation test formattingtestsetsjulia provides test sets which allows developers to group tests into logical groupings test sets can be nested and ideally packages should only have a single root test set it is recommended that the runtests jl file contains the root test set which contains the remainder of the tests testset pkgextreme begin include arithmetic jl include utils jl endthe file structure of the test folder should mirror that of the src folder every file in src should have a complementary file in the test folder containing tests relevant to that file s contents comparisonsmost tests are written in the form test x y since the function doesn t take types into account tests like the following are valid test 1 0 1 avoid adding visual noise into test comparisons yes test value 0 no test value 0 0in cases where you are checking the numerical validity of a model s parameter estimates please use the check numerical function found in test test utils numerical tests jl this function will evaluate a model s parameter estimates using tolerance levels atol and rtol testing will only be performed if you are running the test suite locally or if travis is executing the numerical testing stage here is an example of usage check that m and s are plus or minus one from 1 5 and 2 2 respectively check numerical chain m s 1 5 2 2 atol 1 0 checks the estimates for a default gdemo model using values 1 5 and 2 0 check gdemo chain atol 0 1 checks the estimates for a default mog model check mogtest default chain atol 0 1", "title": "Style Guide"},{"location": "/docs/for-developers/compiler", "text": "in this section i will describe the current design of turing s model compiler which enables turing to perform various types of bayesian inference without changing the model definition what we call compiler is essentially just a macro that transforms the user s code to something that julia s dispatch can operate on and that julia s compiler can successfully do type inference on for efficient machine code generation overviewthe following terminology will be used in this section d observed data variables conditioned upon in the posterior p parameter variables distributed according to the prior distributions these will also be referred to as random variables model a fully defined probabilistic model with input data and modelgen a model generator function that can be used to instantiate a model instance by inputing data d turing s model macro defines a modelgen that can be used to instantiate a model by passing in the observed data d model macro and modelgenthe following are the main jobs of the model macro parse and lines e g y normal c x 1 0 figure out if a variable belongs to the data d and or to the parameters p enable the handling of missing data variables in d when defining a model and treating them as parameter variables in p instead enable the tracking of random variables using the data structures varname and varinfo change lines with a variable in p on the lhs to a call to an assume dot assume block change lines with a variable in d on the lhs to a call to an observe dot observe block enable type stable automatic differentiation of the model using type parameterslet s take the following model as an example model gauss x missing y 1 0 type tv vector float64 where tv lt abstractvector begin if x missing x tv undef 3 end p tv undef 2 p 1 inversegamma 2 3 p 2 normal 0 1 0 x 1 2 normal p 2 sqrt p 1 x 3 normal y normal p 2 sqrt p 1 endthe above call of the model macro defines an instance of modelgen called gauss a model model can be defined using gauss rand 3 1 0 or gauss x rand 3 y 1 0 while constructing the model if an argument is not passed in it gets assigned to its default value if there is no default value given an error is thrown if an argument has a default value missing when not passed in it is treated as a random variable for variables which require an intialization because we need to loop or broadcast over its elements such as x above the following needs to be done if x missing x endif x is sampled as a whole from a multivariate distribution e g x mvnormal there is no need to initialize it in an if block modelgen is defined as struct modelgen targs f tdefaults lt function f f defaults tdefaultsendmodelgen targs args where targs modelgen targs typeof args args m modelgen args kwargs m f args kwargs targs is the tuple of the symbols of the model s arguments x y tv defaults is the namedtuple of default values x missing y 1 0 tv vector float64 the model macro is defined as macro model input expr build model info input expr gt replace tilde gt replace vi gt replace logpdf gt replace sampler gt build outputendbuild model infothe first stop that the model definition takes is build model info this function extracts some information from the model definition such as name the model name main body the model body excluding the header and end arg syms the argument symbols e g x y tv above args a modified version of the arguments changing type tv vector float64 and where tv lt abstractvector to tv type lt abstractvector vector float64 this is x missing y 1 0 tv type lt abstractvector vector float64 in the example above args nt an expression constructing a namedtuple of the input arguments e g x x y y tv tv in the example above defaults nt an expression constructing a namedtuple of the default values of the input arguments if any e g x missing y 1 tv vector float64 in the example above and returns it as a dictionary called model info replace tilde after some model information have been extracted replace tilde replaces the l r lines in the model with the output of core tilde l r model info where l and r are either expressions or symbols l can also be a constant literal the replace tilde function also replaces expressions of the form l r with the output of dot tilde l r model info in the above example p 1 inversegamma 2 3 is replaced with temp right inversegamma 2 3 turing core assert dist temp right msg preprocessed turing core preprocess val x y t turing getmissing model p 1 if preprocessed isa tuple vn inds preprocessed out turing inference tilde ctx sampler temp right vn inds vi p 1 out 1 acclogp vi out 2 else lp turing inference tilde ctx sampler temp right preprocessed vi acclogp vi lp endwhere ctx abstractcontext sampler abstractsampler and vi varinfo will be discussed later assert dist will check that the rhs of is a distribution otherwise an error is thrown the preprocess macro here checks if the symbol on the lhs of p in this case is in the arguments to the model x y t or not if it isn t then p 1 will be treated as a random variable if it is in the arguments but was among the arguments with a value of missing obtained using getmissing model then p 1 is also treated as a random variable if neither of the above is true but the value of p 1 is missing then p 1 will still be treated as a random variable otherwise p 1 is treated as an observation if preprocess treats p 1 as a random variable it will return a 2 tuple of 1 a variable identifier vn varname turing varname p 1 and 2 a tuple of tuples of the indices used in vn 1 in this example otherwise preprocess returns the value of p 1 turing varname and varname wil be explained later the above checks by preprocess were carefully written to make sure that the julia compiler can compile them away so no checks happen at runtime and only the correct branch is run straight away when the output of preprocess is a tuple i e p 1 is a random variable the turing inference tilde function will dispatch to a different method than when the output is of another type i e p 1 is an observation in the former case turing inference tilde returns 2 outputs the value of the random variable and the log probability while in the latter case only the log probability is returned the log probabilities then get accumulated and if p 1 is a random variable the first returned output by turing inference tilde gets assigned to it note that core tilde is different from inference tilde core tilde returns the expression block that will be run instead of the line a part of this expression block is a call to inference tilde as shown above core tilde is defined in the compiler jl file while inference tilde is defined in the inference jl file the dot tilde function does something similar for expressions of the form l r and l r in julia 1 1 and above let s take x 1 2 normal p 2 sqrt p 1 as an example this expressions replaced with temp right normal p 2 sqrt p 1 turing core assert dist temp right msg preprocessed turing core preprocess val x y t turing getmissing model x 1 2 if preprocessed isa tuple vn inds preprocessed temp left x 1 2 out turing inference dot tilde ctx sampler temp right temp left vn inds vi left out 1 acclogp vi out 2 else temp left preprocessed x 1 2 lp turing inference dot tilde ctx sampler temp right temp left vi acclogp vi lp endthe main difference in the expanded code between l r and l r is that the former doesn t assume l to be defined it can be a new julia variable in the scope while the latter assumes l already exists l is also always input to the dot tilde function but not the tilde function replace vi replace logpdf and replace sampler using varinfo inside the model body will give the user access to the vi varinfo object used inside the model the function replace vi therefore finds and replaces every use of varinfo with the handle to the varinfo instance used inside the model the logpdf macro will return vi logp which is the accumumlated log probability that the model is computing what this means can change depending on the context ctx used when running the model finally replace sampler will replace sampler with the sampler input to the model turing modelevery model model can be called as a function with arguments vi varinfo spl abstractsampler and ctx abstractcontext vi is a data structure that stores information about random variables in p spl includes the choice of the mcmc algorithm e g metropolis hastings importance sampling or hamiltonian monte carlo hmc ctx is used to modify the behaviour of the logp accumulator accumulating different variants of it for example if ctx isa likelihoodcontext only the log likelihood will be accumulated in vi logp by default ctx isa defaultcontext which accumulates the log joint probability of p and d the inference tilde and inference dot tilde functions will do something different for different subtypes of abstractsampler to facilitate the sampling process the model struct is defined as follows struct model f targs lt namedtuple tmodelgen tmissings lt val f f args targs modelgen tmodelgen missings tmissingsendmodel f args namedtuple modelgen model f args modelgen getmissing args model model vi model vi samplefromprior model model vi spl model vi spl defaultcontext model model args kwargs model f args model kwargs model f is an internal function that is called when model is called where model model when model is called model itself is passed as an argument to model f because we need to access model args among other things inside f model args is a namedtuple of all the arguments that were passed to the model generating function when constructing an instance of model modelgen is the instance of modelgen that was used to construct model missings is an instance of val e g val a b getmissings returns a val instance of all the symbols in args with a value missing this is the default definition of missings all variables in missings are treated as random variables rather than observations in some non traditional use cases missings is defined differently e g when computing the log joint probability of the random variables and only some observations simultaneously possibly conditioned on the remaining observations an example using the model above is logprob x rand 3 p rand 2 model gauss y nothing to evaluate this the model argument x on the lhs of is treated as a random variable leading to a call to the assume or dot assume function in place of the or expressions respectively the model is then run in the priorcontext which ignores the observe and dot observe functions and only runs the assume and dot assume ones this returns the correct log probability the reason why a model input argument such as x cannot be initialized to missing when on the lhs of is somewhat subtle in the model body before calling sometimes there would be a call to length x iterating over the elements of x in a loop calling on each element of x if x is initialized to missing this will error because length missing is not defined moreover it is not intuitive to require the user to handle the x missing case because the user never assigned x to be missing in the first place missing is merely an implementation detail in this case that the users need not concern themselves with therefore in this case it makes sense to de couple the missings field from the values of the arguments build outputnow that we have all the information we need in the model macro we can start building the model generator function the model generator function gauss will be defined as function outer function x missing y 1 0 tv type lt abstractvector vector float64 return outer function x y tv endfunction outer function x missing y 1 0 tv type lt abstractvector vector float64 function inner function vi turing varinfo sampler turing abstractsampler ctx abstractcontext model end return turing model inner function x x y y tv tv turing core modelgen x y tv outer function x missing y 1 0 tv vector float64 endgauss turing core modelgen x y tv outer function x missing y 1 0 tv vector float64 the above 2 methods enable constructing the model using positional or keyword arguments the second argument to the turing model constructor is the expression called args nt stored in model info the second argument to the modelgen constructor inside outer function and outside is the expression called defaults nt stored in model info the body of the inner function is explained below inner functionthe main method of inner function does some pre processing defining all the input variables from the model definition x y and tv in the example above then the rest of the model body is run as normal julia code with the l r and l r lines replaced with the calls to inference tilde and inference dot tilde respectively as shown earlier function inner function vi turing varinfo sampler turing abstractsampler ctx abstractcontext model temp x model args x xt typeof temp x if temp x isa turing core floatorarraytype x turing core get matching type sampler vi temp x elseif turing core hasmissing xt x turing core get matching type sampler vi xt temp x else x temp x end the code above is repeated for the other 2 variables y and tv reset the logp accumulator resetlogp vi main model bodyendas one can see above x y and tv are defined in the method body using an if block followed by the rest of the code the first branch of this if block is run if the variable is a number or array type such as tv vector float64 one of the purposes of get matching type is to check if sampler requires automatic differentiation and to modify tv accordingly for example when using forwarddiff for automatic differentiation tv will be defined as some concrete subtype of vector lt forwarddiff dual this same function is also used to replace array with libtask tarray types when a particle sampler is used the second branch of the if block is to handle partially missing data converting the type of the input vector to another type befitting of the sampler used whether it is for automatic differentiation or for particle samplers finally the third branch is the one that will be run for x and y above simply assigning these names to model args x and model args y respectively the main model body is then the same model body passed in by the user after replacing l r l r varinfo and logpdf as explained eariler varnamein order to track random variables in the sampling process turing uses the struct varname sym which acts as a random variable identifier generated at runtime the varname of a random variable is generated from the expression on the lhs of a statement when the symbol on the lhs is in p every vn varname sym has a symbol sym which is the symbol of the julia variable in the model that the random variable belongs to for example x 1 normal will generate an instance of varname x assuming x is in p every vn varname also has a field indexing which stores the indices requires to access the random variable from the julia variable indicated by sym for example x 1 normal will generate a vn varname x with vn indexing 1 varname also supports hierarchical arrays and range indexing some more examples x 1 normal will generate a varname x with indexing 1 x 1 mvnormal zeros 2 will generate a varname x with indexing colon 1 x 1 2 normal will generate a varname x with indexing colon 1 2 varinfooverviewvarinfo is the data structure in turing that facilitates tracking random variables and certain metadata about them that are required for sampling for instance the distribution of every random variable is stored in varinfo because we need to know the support of every random variable when sampling using hmc for example random variables whose distributions have a constrained support are transformed using a bijector from bijectors jl so that the sampling happens in the unconstrained space different samplers require different metadata about the random variables the definition of varinfo in turing is struct varinfo tmeta tlogp lt abstractvarinfo metadata tmeta logp base refvalue tlogp num produce base refvalue int endbased on the type of metadata the varinfo is either aliased untypedvarinfo or typedvarinfo metadata can be either a subtype of the union type metadata or a namedtuple of multiple such subtypes let vi be an instance of varinfo if vi isa varinfo lt metadata then it is called an untypedvarinfo if vi isa varinfo lt namedtuple then vi metadata would be a namedtuple mapping each symbol in p to an instance of metadata vi would then be called a typedvarinfo the other fields of varinfo include logp which is used to accumulate the log probability or log probability density of the variables in p and d num produce keeps track of how many observations have been made in the model so far this is incremented when running a statement when the symbol on the lhs is in d metadatathe metadata struct stores some metadata about the random variables sampled this helps query certain information about a variable such as its distribution which samplers sample this variable its value and whether this value is transformed to real space or not let md be an instance of metadata md vns is the vector of all varname instances let vn be an arbitrary element of md vns md idcs is the dictionary that maps each varname instance to its index inmd vns md ranges md dists md orders and md flags md vns md idcs vn vn md dists md idcs vn is the distribution of vn md gids md idcs vn is the set of algorithms used to sample vn this is used inthe gibbs sampling process md orders md idcs vn is the number of observe statements before vn is sampled md ranges md idcs vn is the index range of vn in md vals md vals md ranges md idcs vn is the linearized vector of values of corresponding to vn md flags is a dictionary of true false flags md flags flag md idcs vn is thevalue of flag corresponding to vn note that in order to make md metadata type stable all the md vns must have the same symbol and distribution type however one can have a single julia variable e g x that is a matrix or a hierarchical array sampled in partitions e g x 1 mvnormal zeros 2 1 0 x 2 mvnormal ones 2 1 0 the symbol x can still be managed by a single md metadata without hurting the type stability since all the distributions on the rhs of are of the same type however in turing models one cannot have this restriction so we must use a type unstable metadata if we want to use one metadata instance for the whole model this is what untypedvarinfo does a type unstable metadata will still work but will have inferior performance to strike a balance between flexibility and performance when constructing the spl sampler instance the model is first run by sampling the parameters in p from their priors using an untypedvarinfo i e a type unstable metadata is used for all the variables then once all the symbols and distribution types have been identified a vi typedvarinfo is constructed where vi metadata is a namedtuple mapping each symbol in p to a specialized instance of metadata so as long as each symbol in p is sampled from only one type of distributions vi typedvarinfo will have fully concretely typed fields which brings out the peak performance of julia", "title": "Turing Compiler Design"},{"location": "/docs/for-developers/interface", "text": "the sampling interfaceturing implements a sampling interface hosted at abstractmcmc that is intended to provide a common framework for markov chain monte carlo samplers the interface presents several structures and functions that one needs to overload in order to implement an interface compatible sampler this guide will demonstrate how to implement the interface without turing interface overviewany implementation of an inference method that uses the abstractmcmc interface should implement a subset of the following types and functions a subtype of abstractsampler defined as a mutable struct containing state information or sampler parameters a function sample init which performs any necessary set up default do not perform any set up a function step which returns a transition that represents a single draw from the sampler a function transitions init which returns a container for the transitions obtained from the sampler default return a vector t of length n where t is the type of the transition obtained in the first step and n is the number of requested samples a function transitions save which saves transitions to the container default save the transition of iteration i at position i in the vector of transitions a function sample end which handles any sampler wrap up default do not perform any wrap up a function bundle samples which accepts the container of transitions and returns a collection of samples default return the vector of transitions the interface methods with exclamation points are those that are intended to allow for state mutation any mutating function is meant to allow mutation where needed you might use sample init to run some kind of sampler preparation before sampling begins this could mutate a sampler s state step might mutate a sampler flag after each sample sample end contains any wrap up you might need to do if you were sampling in a transformed space this might be where you convert everything back to a constrained space why do you have an interface the motivation for the interface is to allow julia s fantastic probabilistic programming language community to have a set of standards and common implementations so we can all thrive together markov chain monte carlo methods tend to have a very similar framework to one another and so a common interface should help more great inference methods built in single purpose packages to experience more use among the community implementing metropolis hastings without turingmetropolis hastings is often the first sampling method that people are exposed to it is a very straightforward algorithm and is accordingly the easiest to implement so it makes for a good example in this section you will learn how to use the types and functions listed above to implement the metropolis hastings sampler using the mcmc interface the full code for this implementation is housed in advancedmh jl importslet s begin by importing the relevant libraries we ll import abstracmcmc which contains the interface framework we ll fill out we also need distributions and random import the relevant libraries import abstractmcmcusing distributionsusing randoman interface extension like the one we re writing right now typically requires that you overload or implement several functions specifically you should import the functions you intend to overload this next code block accomplishes that from distributions we need sampleable variateform and valuesupport three abstract types that define a distribution models in the interface are assumed to be subtypes of sampleable variateform valuesupport in this section our model is going be be extremely simple so we will not end up using these except to make sure that the inference functions are dispatching correctly samplerlet s begin our sampler definition by defining a sampler called metropolishastings which is a subtype of abstractsampler correct typing is very important for proper interface implementation if you are missing a subtype your method may not be dispatched to when you call sample define a sampler type struct metropolishastings t d lt abstractmcmc abstractsampler init t proposal dend default constructors metropolishastings init real metropolishastings init normal 0 1 metropolishastings init vector lt real metropolishastings init mvnormal length init 1 above we have defined a sampler that stores the initial parameterization of the prior and a distribution object from which proposals are drawn you can have a struct that has no fields and simply use it for dispatching onto the relevant functions or you can store a large amount of state information in your sampler the general intuition for what to store in your sampler struct is that anything you may need to perform inference between samples but you don t want to store in a transition should go into the sampler struct it s the only way you can carry non sample related state information between step calls modelnext we need to have a model of some kind a model is a struct that s a subtype of abstractmodel that contains whatever information is necessary to perform inference on your problem in our case we want to know the mean and variance parameters for a standard normal distribution so we can keep our model to the log density of a normal note that we only have to do this because we are not yet integrating the sampler with turing turing has a very sophisticated modelling engine that removes the need to define custom model structs define a model type stores the log density function struct densitymodel f lt function lt abstractmcmc abstractmodel fendtransitionthe next step is to define some transition which we will return from each step call we ll keep it simple by just defining a wrapper struct that contains the parameter draws and the log density of that draw create a very basic transition type only stores the parameter draws and the log probability of the draw struct transition t l t lp lend store the new draw and its log density transition model densitymodel transition model transition can now store any type of parameter whether it s a vector of draws from multiple parameters or a single univariate draw metropolis hastingsnow it s time to get into the actual inference we ve defined all of the core pieces we need but we need to implement the step function which actually performs inference as a refresher metropolis hastings implements a very basic algorithm pick some initial state theta 0 for t in 1 n do a generate a proposal parameterization t sim q theta t mid theta t 1 b calculate the acceptance probability alpha text min big 1 frac pi t pi theta t 1 frac q t 1 mid t q t mid t 1 big c if u le where u sim 0 1 then theta t theta t otherwise theta t theta t 1 of course it s much easier to do this in the log space so the acceptance probability is more commonly written as alpha min big log pi t log pi t 1 log q t 1 mid t log q t mid t 1 0 big in interface terms we should do the following make a new transition containing a proposed sample calculate the acceptance probability if we accept return the new transition otherwise return the old one stepsthe step function is the function that performs the bulk of your inference in our case we will implement two step functions one for the very first iteration and one for every subsequent iteration define the first step function which is called at the beginning of sampling return the initial parameter used to define the sampler function abstractmcmc step rng abstractrng model densitymodel spl metropolishastings n integer nothing kwargs return transition model spl init endthe first step function just packages up the initial parameterization inside the sampler and returns it we implicity accept the very first parameterization the other step function performs the usual steps from metropolis hastings included are several helper functions proposal and q which are designed to replicate the functions in the pseudocode above proposal generates a new proposal in the form of a transition which can be univariate if the value passed in is univariate or it can be multivariate if the transition given is multivariate proposals use a basic normal or mvnormal proposal distribution q returns the log density of one parameterization conditional on another according to the proposal distribution step generates a new proposal checks the acceptance probability and then returns either the previous transition or the proposed transition define a function that makes a basic proposal depending on a univariate parameterization or a multivariate parameterization propose spl metropolishastings model densitymodel real transition model rand spl proposal propose spl metropolishastings model densitymodel vector lt real transition model rand spl proposal propose spl metropolishastings model densitymodel t transition propose spl model t calculates the probability q cond using the proposal distribution spl proposal q spl metropolishastings real cond real logpdf spl proposal cond q spl metropolishastings vector lt real cond vector lt real logpdf spl proposal cond q spl metropolishastings t1 transition t2 transition q spl t1 t2 calculate the density of the model given some parameterization model densitymodel model model densitymodel t transition t lp define the other step function returns a transition containing either a new proposal if accepted or the previous proposal if not accepted function abstractmcmc step rng abstractrng model densitymodel spl metropolishastings integer prev transition kwargs generate a new proposal propose spl model prev calculate the log acceptance probability model model prev q spl prev q spl prev decide whether to return the previous or the new one if log rand rng lt min 0 0 return else return prev endendchainsin the default implementation sample just returns a vector of all transitions if instead you would like to obtain a chains object e g to simplify downstream analysis you have to implement the bundle samples function as well it accepts the vector of transitions and returns a collection of samples fortunately our transition is incredibly simple and we only need to build a little bit of functionality to accept custom parameter names passed in by the user a basic chains constructor that works with the transition struct we defined function abstractmcmc bundle samples rng abstractrng densitymodel s metropolishastings n integer ts vector lt transition chain type type any param names missing kwargs turn all the transitions into a vector of vectors vals copy reduce hcat vcat t t lp for t in ts check if we received any parameter names if ismissing param names param names parameter i for i in 1 length first vals 1 end add the log density field to the parameter names push param names lp bundle everything up and return a chains struct return chains vals param names internals lp endall done you can even implement different output formats by implementing bundle samples for different chain types which can be provided as keyword argument to sample as default sample uses chain type any testing the implementationnow that we have all the pieces we should test the implementation by defining a model to calculate the mean and variance parameters of a normal distribution we can do this by constructing a target density function providing a sample of data and then running the sampler with sample generate a set of data from the posterior we want to estimate data rand normal 5 3 30 define the components of a basic model insupport 2 gt 0dist normal 1 2 density insupport sum logpdf dist data inf construct a densitymodel model densitymodel density set up our sampler with initial parameters spl metropolishastings 0 0 0 0 sample from the posterior chain sample model spl 100000 param names if all the interface functions have been extended properly you should get an output from display chain that looks something like this object of type chains with data of type 100000 3 1 array float64 3 iterations 1 100000thinning interval 1chains 1samples per chain 100000internals lpparameters 2 element array chaindataframe 1 summary statistics row parameters mean std naive se mcse ess r hat symbol float64 float64 float64 float64 any any 1 5 33157 0 854193 0 0027012 0 00893069 8344 75 1 00009 2 4 54992 0 632916 0 00200146 0 00534942 14260 8 1 00005 quantiles row parameters 2 5 25 0 50 0 75 0 97 5 symbol float64 float64 float64 float64 float64 1 3 6595 4 77754 5 33182 5 89509 6 99651 2 3 5097 4 09732 4 47805 4 93094 5 96821 it looks like we re extremely close to our true parameters of normal 5 3 though with a fairly high variance due to the low sample size conclusionwe ve seen how to implement the sampling interface for general projects turing s interface methods are ever evolving so please open an issue at abstractmcmc with feature requests or problems", "title": "Interface Guide"},{"location": "/docs/for-developers/variational_inference", "text": "overviewin this post we ll have a look at what s know as variational inference vi a family of approximate bayesian inference methods in particular we will focus on one of the more standard vi methods called automatic differentation variational inference advi ifhere we ll have a look at the theory behind vi but if you re interested in how to use advi in turing jl checkout this tutorial motivationin bayesian inference one usually specifies a model as follows given data x i i 1 n begin align text prior quad z amp sim p z text likelihood quad x i amp overset text i i d sim p x mid z quad text where quad i 1 dots n end align where overset text i i d sim denotes that the samples are identically independently distributed our goal in bayesian inference is then to find the posterior p z mid x i i 1 n prod i 1 n p z mid x i in general one cannot obtain a closed form expression for p z mid x i i 1 n but one might still be able to sample from p z mid x i i 1 n with guarantees of converging to the target posterior p z mid x i i 1 n as the number of samples go to infty e g mcmc as you are hopefully already aware turing jl provides a lot of different methods with asymptotic exactness guarantees that we can apply to such a problem unfortunately these unbiased samplers can be prohibitively expensive to run as the model p increases in complexity the convergence of these unbiased samplers can slow down dramatically still in the infinite limit these methods should converge to the true posterior but infinity is fairly large like at least more than 12 so this might take a while in such a case it might be desirable to sacrifice some of these asymptotic guarantees and instead approximate the posterior p z mid x i i 1 n using some other model which we ll denote q z there are multiple approaches to take in this case one of which is variational inference vi variational inference vi in vi we re looking to approximate p z mid x i i 1 n using some approximate or variational posterior q z to approximate something you need a notion of what close means in the context of probability densities a standard such measure of closeness is the kullback leibler kl divergence though this is far from the only one the kl divergence is defined between two densities q z and p z mid x i i 1 n as begin align mathrm d kl big q z p z mid x i i 1 n big amp int log bigg frac q z prod i 1 n p z mid x i bigg q z mathrm d z amp mathbb e z sim q z big log q z sum i 1 n log p z mid x i big amp mathbb e z sim q z big log q z big sum i 1 n mathbb e z sim q z big log p z mid x i big end align it s worth noting that unfortunately the kl divergence is not a metric distance in the analysis sense due to its lack of symmetry on the other hand it turns out that minimizing the kl divergence that it s actually equivalent to maximizing the log likelihood also under reasonable restrictions on the densities at hand mathrm d kl big q z p z mid x i i 1 n big 0 quad iff quad p z p z mid x i i 1 n quad forall z therefore one could and we will attempt to approximate p z mid x i i 1 n using a density q z by minimizing the kl divergence between these two one can also show that mathrm d kl ge 0 which we ll need later finally notice that the kl divergence is only well defined when in fact q z is zero everywhere p z mid x i i 1 n is zero i e mathrm supp big q z big subseteq mathrm supp big p z mid x big otherwise there might be a point z 0 sim q z such that p z 0 mid x i i 1 n 0 resulting in log big frac q z 0 big which doesn t make sense one major problem as we can see in the definition of the kl divergence we need p z mid x i i 1 n for any z if we want to compute the kl divergence between this and q z we don t have that the entire reason we even do bayesian inference is that we don t know the posterior cleary this isn t going to work or is it computing kl divergence without knowing the posteriorfirst off recall that p z mid x i frac p x i z p x i so we can write begin align mathrm d kl big q z p z mid x i i 1 n big amp mathbb e z sim q z big log q z big sum i 1 n mathbb e z sim q z big log p x i z log p x i big amp mathbb e z sim q z big log q z big sum i 1 n mathbb e z sim q z big log p x i z big sum i 1 n mathbb e z sim q z big log p x i big amp mathbb e z sim q z big log q z big sum i 1 n mathbb e z sim q z big log p x i z big sum i 1 n log p x i end align where in the last equality we used the fact that p x i is independent of z now you re probably thinking oh great now you ve introduced p x i which we also can t compute in general woah calm down human let s do some more algebra the above expression can be rearranged to mathrm d kl big q z p z mid x i i 1 n big underbrace sum i 1 n mathbb e z sim q z big log p x i z big mathbb e z sim q z big log q z big mathrm elbo q underbrace sum i 1 n mathbb e z sim q z big log p x i big text constant see the left hand side is constant and as we mentioned before mathrm d kl ge 0 what happens if we try to maximize the term we just gave the completely arbitrary name mathrm elbo well if mathrm elbo goes up while p x i stays constant then mathrm d kl has to go down that is the q z which minimizes the kl divergence is the same q z which maximizes mathrm elbo q underset q mathrm argmin mathrm d kl big q z p z mid x i i 1 n big underset q mathrm argmax mathrm elbo q where begin align mathrm elbo q amp bigg sum i 1 n mathbb e z sim q z big log p x i z big bigg mathbb e z sim q z big log q z big amp bigg sum i 1 n mathbb e z sim q z big log p x i z big bigg mathbb h big q z big end align and mathbb h big q z big denotes the differential entropy of q z assuming joint p x i z and the entropy mathbb h big q z big are both tractable we can use a monte carlo for the remaining expectation this leaves us with the following tractable expression underset q mathrm argmin mathrm d kl big q z p z mid x i i 1 n big approx underset q mathrm argmax widehat mathrm elbo q where widehat mathrm elbo q frac 1 m bigg sum k 1 m sum i 1 n log p x i z k bigg mathbb h big q z big quad text where quad z k sim q z quad forall k 1 dots m hence as long as we can sample from q z somewhat efficiently we can indeed minimize the kl divergence neat eh sidenote in the case where q z is tractable but mathbb h big q z big is not we can use an monte carlo estimate for this term too but this generally results in a higher variance estimate also i fooled you real good the elbo isn t an arbitrary name hah in fact it s an abbreviation for the expected lower bound elbo because it uhmm well it s the expected lower bound remember mathrm d kl ge 0 yup maximizing the elbofinding the optimal q over all possible densities of course isn t feasible instead we consider a family of parameterized densities mathscr d theta where theta denotes the space of possible parameters each density in this family q theta in mathscr d theta is parameterized by a unique theta in theta moreover we ll assume q theta z i e evaluating the probability density q at any point z is differentiable z sim q theta z i e the process of sampling from q theta z is differentiable 1 is fairly straight forward but 2 is a bit tricky what does it even mean for a sampling process to be differentiable this is quite an interesting problem in its own right and would require something like a 50 page paper to properly review the different approaches highly recommended read we re going to make use of a particular such approach which goes under a bunch of different names reparametrization trick path derivative etc this refers to making the assumption that all elements q theta in mathscr q theta can be considered as reparameterizations of some base density say bar q z that is if q theta in mathscr q theta then z sim q theta z quad iff quad z g theta tilde z quad text where quad bar z sim bar q z for some function g theta differentiable wrt theta so all q theta in mathscr q theta are using the same reparameterization function g but each q theta correspond to different choices of theta for f theta under this assumption we can differentiate the sampling process by taking the derivative of g theta wrt theta and thus we can differentiate the entire widehat mathrm elbo q theta wrt theta with the gradient available we can either try to solve for optimality either by setting the gradient equal to zero or maximize widehat mathrm elbo q theta stepwise by traversing mathscr q theta in the direction of steepest ascent for the sake of generality we re going to go with the stepwise approach with all this nailed down we eventually reach the section on automatic differentiation variational inference advi automatic differentiation variational inference advi so let s revisit the assumptions we ve made at this point the variational posterior q theta is in a parameterized family of densities denoted mathscr q theta with theta in theta mathscr q theta is a space of reparameterizable densities with bar q z as the base density the parameterization function g theta is differentiable wrt theta evaluation of the probability density q theta z is differentiable wrt theta mathbb h big q theta z big is tractable evaluation of the joint density p x z is tractable and differentiable wrt z the support of p z mid x is a subspace of the support of q z mathrm supp big p z mid x big subseteq mathrm supp big q z big all of these are not necessary to do vi but they are very convenient and results in a fairly flexible approach one distribution which has a density satisfying all of the above assumptions except 7 we ll get back to this in second for any tractable and differentiable p z mid x i i 1 n is the good ole gaussian normal distribution z sim mathcal n mu sigma quad iff quad z g mu l bar z mu l t tilde z quad text where quad bar z sim bar q z mathcal n 1 d i d times d where sigma l l t with l obtained from the cholesky decomposition abusing notation a bit we re going to write theta mu sigma mu 1 dots mu d l 11 dots l 1 d l 2 1 dots l 2 d dots l d 1 dots l d d with this assumption we finally have a tractable expression for widehat mathrm elbo q mu sigma well assuming 7 is holds since a gaussian has non zero probability on the entirety of mathbb r d we also require p z mid x i i 1 n to have non zero probability on all of mathbb r d though not necessary we ll often make a mean field assumption for the variational posterior q z i e assume independence between the latent variables in this case we ll write theta mu sigma 2 mu 1 dots mu d sigma 1 2 dots sigma d 2 examplesas a trivial example we could apply the approach described above to is the following generative model for p z mid x i i 1 n begin align m amp sim mathcal n 0 1 x i amp overset text i i d mathcal n m 1 quad i 1 dots n end align in this case z m and we have the posterior defined p m mid x i i 1 n p m prod i 1 n p x i mid m then the variational posterior would be q mu sigma mathcal n mu sigma 2 quad text where quad mu in mathbb r sigma 2 in mathbb r and since prior of m mathcal n 0 1 has non zero probability on the entirety of mathbb r same as q m i e assumption 7 above holds everything is fine and life is good but what about this generative model for p z mid x i i 1 n begin align s amp sim mathrm inversegamma 2 3 m amp sim mathcal n 0 s x i amp overset text i i d mathcal n m s quad i 1 dots n end align with posterior p s m mid x i i 1 n p s p m mid s prod i 1 n p x i mid s m and the mean field variational posterior q s m will be q mu 1 mu 2 sigma 1 2 sigma 2 2 s m p mathcal n mu 1 sigma 1 2 s p mathcal n mu 2 sigma 2 2 m where we ve denoted the evaluation of the probability density of a gaussian as p mathcal n mu sigma 2 x observe that mathrm inversegamma 2 3 has non zero probability only on mathbb r 0 infty which is clearly not all of mathbb r like q s m has i e mathrm supp big q s m big not subseteq mathrm supp big p z mid x i i 1 n big recall from the definition of the kl divergence that when this is the case the kl divergence isn t well defined this gets us to the automatic part of advi automatic how for a lot of the standard continuous densities p we can actually construct a probability density tilde p with non zero probability on all of mathbb r by transforming the constrained probability density p to tilde p in fact in these cases this is a one to one relationship as we ll see this helps solve the support issue we ve been going on and on about transforming densities using change of variablesif we want to compute the probability of x taking a value in some set a subseteq mathrm supp big p x big we have to integrate p x over a i e mathbb p p x in a int a p x mathrm d x this means that if we have a differentiable bijection f mathrm supp big q x big to mathbb r d with differentiable inverse f 1 mathbb r d to mathrm supp big p x big we can perform a change of variables mathbb p p x in a int f 1 a p big f 1 y big big det mathcal j f 1 y big mathrm d y where mathcal j f 1 x denotes the jacobian of f 1 evaluted at x observe that this defines a probability distribution mathbb p tilde p big y in f 1 a big int f 1 a tilde p y mathrm d y since f 1 big mathrm supp p x big mathbb r d which has probability 1 this probability distribution has density tilde p y with mathrm supp big tilde p y big mathbb r d defined tilde p y p big f 1 y big big det mathcal j f 1 y big or equivalently tilde p big f x big frac p x big det mathcal j f x big due to the fact that big det mathcal j f 1 y big big det mathcal j f x big 1 note it s also necessary that the log abs det jacobian term is non vanishing this can for example be accomplished by assuming f to also be elementwise monotonic back to viso why is this is useful well we re looking to generalize our approach using a normal distribution to cases where the supports don t match up how about defining q z by begin align eta amp sim mathcal n mu sigma z amp f 1 eta end align where f 1 mathbb r d to mathrm supp big p z mid x big is a differentiable bijection with differentiable inverse then z sim q mu sigma z implies z in mathrm supp big p z mid x big as we wanted the resulting variational density is q mu sigma z p mathcal n mu sigma big f z big big det mathcal j f z big note that the way we ve constructed q z here is basically a reverse of the approach we described above here we sample from a distribution with support on mathbb r and transform to mathrm supp big p z mid x big if we want to write the elbo explicitly in terms of eta rather than z the first term in the elbo becomes begin align mathbb e z sim q mu sigma z big log p x i z big amp mathbb e eta sim mathcal n mu sigma bigg log frac p big x i f 1 eta big big det mathcal j f 1 eta big bigg amp mathbb e eta sim mathcal n mu sigma big log p big x i f 1 eta big big mathbb e eta sim mathcal n mu sigma big big det mathcal j f 1 eta big big end align the entropy is invariant under change of variables thus mathbb h big q mu sigma z big is simply the entropy of the normal distribution which is known analytically hence the resulting empirical estimate of the elbo is begin align widehat mathrm elbo q mu sigma amp frac 1 m bigg sum k 1 m sum i 1 n big log p big x i f 1 eta k big log big det mathcal j f 1 eta k big big bigg mathbb h big p mathcal n mu sigma z big amp text where quad z k sim mathcal n mu sigma quad forall k 1 dots m end align and maximizing this wrt mu and sigma is what s referred to as automatic differentation variational inference advi now if you want to try it out check out the tutorial on how to use advi in turing jl", "title": "Variational Inference"},{"location": "/docs/library/advancedhmc/", "text": "index advancedhmc abstractproposal advancedhmc abstracttrajectory advancedhmc abstracttrajectorysampler advancedhmc binarytree advancedhmc multinomialts advancedhmc multinomialts advancedhmc multinomialts advancedhmc nuts advancedhmc nuts advancedhmc nuts advancedhmc slicets advancedhmc slicets advancedhmc slicets advancedhmc termination advancedhmc termination advancedhmc termination advancedhmc transition advancedhmc a advancedhmc build tree advancedhmc combine advancedhmc find good stepsize advancedhmc isterminated advancedhmc isterminated advancedhmc maxabs advancedhmc mh accept ratio advancedhmc nom step size advancedhmc pm next advancedhmc simple pm next advancedhmc step size advancedhmc temper advancedhmc transitionfunctions advancedhmc find good stepsize method find a good initial leap frog step size via heuristic search statsbase sample method sample rng abstractrng h hamiltonian abstractproposal abstractvecormat t n samples int adaptor abstractadaptor noadaptation n adapts int min div n samples 10 1 000 drop warmup bool false verbose bool true progress bool false sample n samples samples using the proposal under hamiltonian h the randomness is controlled by rng if rng is not provided global rng will be used the initial point is given by the adaptor is set by adaptor for which the default is no adaptation it will perform n adapts steps of adaptation for which the default is the minimum of 1 000 and 10 of n samples drop warmup controls to drop the samples during adaptation phase or not verbose controls the verbosity progress controls whether to show the progress meter or not advancedhmc a method a single hamiltonian integration step note this function is intended to be used in find good stepsize only advancedhmc build tree method recursivly build a tree for a given depth j advancedhmc combine method combine treeleft binarytree treeright binarytree merge a left tree treeleft and a right tree treeright under given hamiltonian h then draw a new candidate sample and update related statistics for the resulting tree advancedhmc isterminated method isterminated h hamiltonian t binarytree lt classicnouturn detect u turn for two phase points zleft and zright under given hamiltonian h using the original no u turn cirterion ref https arxiv org abs 1111 4246 https arxiv org abs 1701 02434 advancedhmc isterminated method isterminated h hamiltonian t binarytree lt generalisednouturn detect u turn for two phase points zleft and zright under given hamiltonian h using the generalised no u turn criterion ref https arxiv org abs 1701 02434 advancedhmc maxabs method maxabs a b return the value with the largest absolute value advancedhmc mh accept ratio method perform mh acceptance based on energy i e negative log probability advancedhmc nom step size method nom step size abstractintegrator get the nominal integration step size the current integration step size may differ from this for example if the step size is jittered nominal step size is usually used in adaptation advancedhmc pm next method progress meter update with all trajectory stats iteration number and metric shown advancedhmc simple pm next method simple progress meter update without any show values advancedhmc step size function step size abstractintegrator get the current integration step size advancedhmc temper method temper lf temperedleapfrog r step namedtuple i is half lt tuple integer bool n steps int tempering step step is a named tuple with i being the current leapfrog iteration and is half indicating whether or not it s the first half momentum tempering step advancedhmc transition method transition abstracttrajectory i h hamiltonian z phasepoint make a mcmc transition from phase point z using the trajectory under hamiltonian h note this is a rng implicit fallback function for transition global rng h z types advancedhmc multinomialts type multinomialts f lt abstractfloat lt abstracttrajectorysamplermultinomial trajectory sampler carried during the building of the tree it contains the weight of the tree defined as the total probabilities of the leaves advancedhmc multinomialts method multinomialts s multinomialts h0 abstractfloat zcand phasepoint multinomial sampler for a trajectory consisting only a leaf node tree weight is the unnormalised energy of the leaf advancedhmc multinomialts method multinomial sampler for the starting single leaf tree log weights for leaf nodes are their unnormalised hamiltonian energies ref https github com stan dev stan blob develop src stan mcmc hmc nuts base nuts hpp l226 advancedhmc nuts type dynamic trajectory hmc using the no u turn termination criteria algorithm advancedhmc nuts method nuts args nuts multinomialts generalisednouturn args create an instance for the no u turn sampling algorithm with multinomial sampling and original no u turn criterion below is the doc for nuts s c nuts s c integrator i max depth int 10 max f 1000 0 where i lt abstractintegrator f lt abstractfloat s lt abstracttrajectorysampler c lt abstractterminationcriterion create an instance for the no u turn sampling algorithm advancedhmc nuts method nuts s c integrator i max depth int 10 max f 1000 0 where i lt abstractintegrator f lt abstractfloat s lt abstracttrajectorysampler c lt abstractterminationcriterion create an instance for the no u turn sampling algorithm advancedhmc slicets type slicets f lt abstractfloat lt abstracttrajectorysamplertrajectory slice sampler carried during the building of the tree it contains the slice variable and the number of acceptable condidates in the tree advancedhmc slicets method slice sampler for the starting single leaf tree slice variable is initialized advancedhmc slicets method slicets s slicets h0 abstractfloat zcand phasepoint create a slice sampler for a single leaf tree the slice variable is copied from the passed in sampler s and the number of acceptable candicates is computed by comparing the slice variable against the current energy advancedhmc abstractproposal type abstract markov chain monte carlo proposal advancedhmc abstracttrajectory type hamiltonian dynamics numerical simulation trajectories advancedhmc abstracttrajectorysampler type sampler carried during the building of the tree advancedhmc binarytree type a full binary tree trajectory with only necessary leaves and information stored advancedhmc termination type terminationtermination reasons dynamic due to stoping criteria numerical due to large energy deviation from starting possibly numerical errors advancedhmc termination method termination s multinomialts nt nuts h0 f h f where f lt abstractfloat check termination of a hamiltonian trajectory advancedhmc termination method termination s slicets nt nuts h0 f h f where f lt abstractfloat check termination of a hamiltonian trajectory advancedhmc transition type a transition that contains the phase point and other statistics of the transition", "title": "AdvancedHMC"},{"location": "/docs/library/", "text": "index turing binomiallogit turing flat turing flatpos turing orderedlogistic turing inference gibbs turing inference hmc turing inference hmcda turing inference is turing inference nuts turing inference pg turing inference smc libtask tarray libtask tzerosmodelling dynamicppl model macro model body macro to specify a probabilistic model example model definition model model generator x default x y begin endto generate a model call model generator x value samplers dynamicppl sampler type sampler t generic interface for implementing inference algorithms an implementation of an algorithm should include the following a type specifying the algorithm and its parameters derived from inferencealgorithm a method of sample function that produces results of inference which is where actual inference happens dynamicppl translates models to chunks that call the modelling functions at specified points the dispatch is based on the value of a sampler variable to include a new inference algorithm implements the requirements mentioned above in a separate file then include that file at the end of this one turing inference gibbs type gibbs algs compositional mcmc interface gibbs sampling combines one or more sampling algorithms each of which samples from a different set of variables in a model example model gibbs example x begin v1 normal 0 1 v2 categorical 5 enduse pg for a v2 variable and use hmc for the v1 variable note that v2 is discrete so the pg sampler is more appropriatethan is hmc alg gibbs hmc 0 2 3 v1 pg 20 v2 tips hmc and nuts are fast samplers and can throw off particle basedmethods like particle gibbs you can increase the effectiveness of particle sampling by including more particles in the particle sampler source turing inference hmc type hmc float64 n leapfrog int hamiltonian monte carlo sampler with static trajectory arguments float64 the leapfrog step size to use n leapfrog int the number of leapfrop steps to use usage hmc 0 05 10 tips if you are receiving gradient errors when using hmc try reducing thestep size parameter e g original step sizesample gdemo 1 5 2 hmc 0 1 10 1000 reduced step size sample gdemo 1 5 2 hmc 0 01 10 1000 source turing inference hmcda type hmcda n adapts int float64 float64 float64 0 0 hamiltonian monte carlo sampler with dual averaging algorithm usage hmcda 200 0 65 0 3 arguments n adapts int numbers of samples to use for adaptation float64 target acceptance rate 65 is often recommended float64 target leapfrop length float64 0 0 inital step size 0 means automatically search by turing for more information please view the following paper arxiv link hoffman matthew d and andrew gelman the no u turn sampler adaptively setting path lengths in hamiltonian monte carlo journal of machine learning research 15 no 1 2014 1593 1623 source turing inference is type is importance sampling algorithm note that this method is particle based and arrays of variables must be stored in a tarray object usage is example define a simple normal model with unknown mean and variance model gdemo x begin s inversegamma 2 3 m normal 0 sqrt s x 1 normal m sqrt s x 2 normal m sqrt s return s mendsample gdemo 1 5 2 is 1000 source warning missing docstring missing docstring for mh check documenter s build log for details turing inference nuts type nuts n adapts int float64 max depth int 5 max float64 1000 0 float64 0 0 no u turn sampler nuts sampler usage nuts use default nuts configuration nuts 1000 0 65 use 1000 adaption steps and target accept ratio 0 65 arguments n adapts int the number of samples to use with adaptation float64 target acceptance rate for dual averaging max depth float64 maximum doubling tree depth max float64 maximum divergence during doubling tree float64 inital step size 0 means automatically searching using a heuristic procedure source turing inference pg type pg n particles int particle gibbs sampler note that this method is particle based and arrays of variables must be stored in a tarray object usage pg 100 100 source turing inference smc type struct smc space r lt turing inference particleinferencesequential monte carlo sampler fields resampler anysourcedistributions turing flat type flat lt continuousunivariatedistributiona distribution with support and density of one everywhere source turing flatpos type flatpos l real a distribution with a lower bound of l and a density of one at every x above l source turing binomiallogit type binomiallogit n lt real i lt integer a univariate binomial logit distribution source warning missing docstring missing docstring for vecbinomiallogit check documenter s build log for details turing orderedlogistic type orderedlogistic any cutpoints lt abstractvector an ordered logistic distribution sourcedata structures libtask tarray type tarray t dims implementation of data structures that automatically perform copy on write after task copying if current task is an existing key in s then return s current task otherwise returns current task s last task usage tarray dim example ta tarray 4 initfor i in 1 4 ta i i end assignarray ta convert to 4 element array int64 1 1 2 3 4 utilities libtask tzeros function tzeros dims construct a distributed array of zeros trailing arguments are the same as those accepted by tarray tzeros dim example tz tzeros 4 constructarray tz convert to 4 element array int64 1 0 0 0 0", "title": "API"},{"location": "/docs/library/bijectors/", "text": "index bijectors adbijector bijectors abstractbijector bijectors bijector bijectors composed bijectors inverse bijectors permute bijectors stacked bijectors bijector bijectors composel bijectors composer bijectors forward bijectors forward bijectors isclosedform bijectors logabsdetjac bijectors logabsdetjac bijectors logabsdetjacinv bijectors logabsdetjacinv bijectors logpdf with jac bijectors transformedfunctions bijectors bijector method bijector d distribution returns the constrained to unconstrained bijector for distribution d bijectors forward method forward b bijector x computes both transform and logabsdetjac in one forward pass and returns a named tuple rv b x logabsdetjac logabsdetjac b x this defaults to the call above but often one can re use computation in the computation of the forward pass and the computation of the logabsdetjac forward allows the user to take advantange of such efficiencies if they exist bijectors forward method forward d distribution forward d distribution num samples int returns a namedtuple with fields x y logabsdetjac and logpdf in the case where d isa transformeddistribution this means x rand d dist y d transform x logabsdetjac is the logabsdetjac of the forward transform logpdf is the logpdf of y not xin the case where d isa distribution this means x rand d y x logabsdetjac 0 0 logpdf is logpdf of x bijectors isclosedform method isclosedform b bijector boolisclosedform b inverse lt bijector boolreturns true or false depending on whether or not evaluation of b has a closed form implementation most bijectors have closed form evaluations but there are cases where this is not the case for example the inverse evaluation of planarlayer requires an iterative procedure to evaluate and thus is not differentiable bijectors logabsdetjac method computes the absolute determinant of the jacobian of the inverse transformation bijectors logabsdetjac method logabsdetjac b bijector x logabsdetjac ib inverse lt bijector y computes the log abs det j b x where j is the jacobian of the transform similarily for the inverse transform default implementation for inverse lt bijector is implemented as logabsdetjac of original bijector bijectors logabsdetjacinv method logabsdetjacinv b bijector y just an alias for logabsdetjac inv b y bijectors logabsdetjacinv method logabsdetjacinv td univariatetransformed y real logabsdetjacinv td multivariatetransformed y abstractvector lt real computes the logabsdetjac of the inverse transformation since rand td returns the transformed random variable bijectors logpdf with jac method logpdf with jac td univariatetransformed y real logpdf with jac td mvtransformed y abstractvector lt real logpdf with jac td matrixtransformed y abstractmatrix lt real makes use of the forward method to potentially re use computation and returns a tuple logpdf logabsdetjac bijectors transformed method transformed d distribution transformed d distribution b bijector couples distribution d with the bijector b by returning a transformeddistribution if no bijector is provided i e transformed d is called then transformed d bijector d is returned bijectors composel method composel ts bijector composed lt tuple constructs composed such that ts are applied left to right bijectors composer method composer ts bijector composed lt tuple constructs composed such that ts are applied right to left types bijectors adbijector type abstract type for a bijector n making use of auto differentation ad to implement jacobian and by impliciation logabsdetjac bijectors bijector type abstract type of bijectors with fixed dimensionality bijectors composed type composed ts a b1 bijector n b2 bijector n composed lt tuple composel ts bijector n composed lt tuple composer ts bijector n composed lt tuple where a refers to either tuple vararg lt bijector n a tuple of bijectors of dimensionality n abstractarray lt bijector n an array of bijectors of dimensionality na bijector representing composition of bijectors composel and composer results in a composed for which application occurs from left to right and right to left respectively note that all the alternative ways of constructing a composed returns a tuple of bijectors this ensures type stability of implementations of all relating methdos e g inv if you want to use an array as the container instead you can docomposed b1 b2 in general this is not advised since you lose type stability but there might be cases where this is desired e g if you have a insanely large number of bijectors to compose examplessimple examplelet s consider a simple example of exp julia gt using bijectors expjulia gt b exp exp 0 julia gt b bcomposed tuple exp 0 exp 0 0 exp 0 exp 0 julia gt b b 1 0 exp exp 1 0 evaluationtruejulia gt inv b b exp exp 1 0 1 0 inversiontruejulia gt logabsdetjac b b 1 0 determinant of jacobian3 718281828459045notesorderit s important to note that does what is expected mathematically which means that the bijectors are applied to the input right to left e g first applying b2 and then b1 b1 b2 x b1 b2 x gt truebut in the composed struct itself we store the bijectors left to right so thatcb1 b1 b2 gt composed ts b2 b1 cb2 composel b2 b1 gt composed ts b2 b1 cb1 x cb2 x b1 b2 x gt truestructure will result in flatten the composition structure while composel and composer preserve the compositional structure this is most easily seen by an example julia gt b exp exp 0 julia gt cb1 b b cb2 b b julia gt cb1 cb2 ts lt different exp 0 exp 0 exp 0 exp 0 julia gt cb1 cb2 ts isa ntuple 4 exp 0 truejulia gt bijectors composer cb1 cb2 ts composed tuple exp 0 exp 0 0 exp 0 exp 0 composed tuple exp 0 exp 0 0 exp 0 exp 0 julia gt bijectors composer cb1 cb2 ts isa tuple composed composed true bijectors inverse type inv b bijector inverse b bijector a bijector representing the inverse transform of b bijectors stacked type stacked bs stacked bs ranges stack bs bijector 0 where 0 means 0 dim bijector a bijector which stacks bijectors together which can then be applied to a vector where bs i bijector is applied to x ranges i unitrange int arguments bs can be either a tuple or an abstractarray of 0 and or 1 dimensional bijectors if bs is a tuple implementations are type stable using generated functions if bs is an abstractarray implementations are not type stable and use iterative methods ranges needs to be an iterable consisting of unitrange int length bs length ranges needs to be true examplesb1 logit 0 0 1 0 b2 identity 0 b stack b1 b2 b 0 0 1 0 b1 0 0 1 0 gt true bijectors abstractbijector type abstract type for a bijector bijectors permute type permute a lt bijector 1 a bijector implementation of a permutation the permutation is performed using a matrix of type a there are a couple of different ways to construct permute permute 0 1 1 0 will map 1 2 gt 2 1 permute 2 1 will map 1 2 gt 2 1 permute 2 2 gt 1 1 gt 2 will map 1 2 gt 2 1 permute 2 1 2 gt 2 1 will map 1 2 gt 2 1 if this is not clear the examples might be of help examplesa simple example is permuting a vector of size 3 julia gt b1 permute 0 1 0 1 0 0 0 0 1 permute array int64 2 0 1 0 1 0 0 0 0 1 julia gt b2 permute 2 1 3 specify all elements at oncepermute sparsearrays sparsematrixcsc float64 int64 2 1 1 0 1 2 1 0 3 3 1 0 julia gt b3 permute 3 2 gt 1 1 gt 2 element wisepermute sparsearrays sparsematrixcsc float64 int64 2 1 1 0 1 2 1 0 3 3 1 0 julia gt b4 permute 3 1 2 gt 2 1 block wisepermute sparsearrays sparsematrixcsc float64 int64 2 1 1 0 1 2 1 0 3 3 1 0 julia gt b1 a b2 a b3 a b4 atruejulia gt b1 1 2 3 3 element array float64 1 2 0 1 0 3 0julia gt b2 1 2 3 3 element array float64 1 2 0 1 0 3 0julia gt b3 1 2 3 3 element array float64 1 2 0 1 0 3 0julia gt b4 1 2 3 3 element array float64 1 2 0 1 0 3 0julia gt inv b1 permute linearalgebra transpose int64 array int64 2 0 1 0 1 0 0 0 0 1 julia gt inv b1 b1 1 2 3 3 element array float64 1 1 0 2 0 3 0", "title": "Bijectors"},{"location": "/docs/tutorials/index", "text": "tutorialsthis section contains tutorials on how to implement common models in turing if you prefer to have an interactive jupyter notebook please fork or download the turingtutorials repository a list of all the tutorials available can be found to the left the introduction tutorial contains an introduction to coin flipping with turing and a brief overview of probabalistic programming tutorials are under continuous development but there are some older version available at the turingtutorials within the old notebooks section some of these were built using prior versions of turing and may not function correctly but they can assist in the syntax used for common models if there is a tutorial you would like to request please open an issue on the turingtutorials repository", "title": "Tutorials"},{"location": "/docs/using-turing/advanced", "text": "advanced usagehow to define a customized distributionturing jl supports the use of distributions from the distributions jl package by extension it also supports the use of customized distributions by defining them as subtypes of distribution type of the distributions jl package as well as corresponding functions below shows a workflow of how to define a customized distribution using a flat prior as a simple example 1 define the distribution typefirst define a type of the distribution as a subtype of a corresponding distribution type in the distributions jl package struct flat lt continuousunivariatedistribution end2 implement sampling and evaluation of the log pdfsecond define rand and logpdf which will be used to run the model distributions rand rng abstractrng d flat rand rng distributions logpdf d flat x real zero x 3 define helper functionsin most cases it may be required to define helper functions such as the minimum maximum rand and logpdf functions among others 3 1 domain transformationsome helper functions are necessary for domain transformation for univariate distributions the necessary ones to implement are minimum and maximum distributions minimum d flat infdistributions maximum d flat inffunctions for domain transformation which may be required by multivariate or matrix variate distributions are size link and invlink please see turing s transform jl for examples 3 2 vectorization supportthe vectorization syntax follows rv distribution which requires rand and logpdf to be called on multiple data points at once an appropriate implementation for flat is shown below distributions logpdf d flat x abstractvector lt real zero x model internalsthe model macro accepts a function definition and generates a turing model struct for use by the sampler models can be constructed by hand without the use of a macro taking the gdemo model as an example the two code sections below macro and macro free are equivalent using turing model gdemo x begin set priors s inversegamma 2 3 m normal 0 sqrt s observe each value of x x normal m sqrt s endsample gdemo 1 5 2 0 hmc 0 1 5 1000 using turing initialize a namedtuple containing our data variables data x 1 5 2 0 create the model function mf vi sampler ctx model begin set the accumulated logp to zero resetlogp vi x model args x assume s has an inversegamma distribution s lp turing inference tilde ctx sampler inversegamma 2 3 turing varname s vi add the lp to the accumulated logp acclogp vi lp assume m has a normal distribution m lp turing inference tilde ctx sampler normal 0 sqrt s turing varname m vi add the lp to the accumulated logp acclogp vi lp observe each value of x i according to a normal distribution lp turing inference dot tilde ctx sampler normal m sqrt s x vi acclogp vi lp end instantiate a model object model dynamicppl model mf data dyanamicppl modelgen nothing nothing sample the model chain sample model hmc 0 1 5 1000 task copyingturing copies julia tasks to deliver efficient inference algorithms but it also provides alternative slower implementation as a fallback task copying is enabled by default task copying requires we use the ctask facility which is provided by libtask to create tasks maximum a posteriori estimationturing does not currently have built in methods for calculating the maximum a posteriori map for a model this is a goal for turing s implementation see this issue but for the moment we present here a method for estimating the map using optim jl using turing define the simple gdemo model model gdemo x y begin s inversegamma 2 3 m normal 0 sqrt s x normal m sqrt s y normal m sqrt s return s mendfunction get nlogp model construct a trace struct vi turing varinfo model define a function to optimize function nlogp sm spl turing samplefromprior new vi turing varinfo vi spl sm model new vi spl getlogp new vi end return nlogpend define our data points x 1 5y 2 0model gdemo x y nlogp get nlogp model import optim jl using optim create a starting point call the optimizer sm 0 1 0 1 0 lb 0 0 inf ub inf inf result optimize nlogp lb ub sm 0 fminbox parallel samplingturing does not natively support parallel sampling currently users must perform additional structual support note that running chains in parallel may cause unintended issues below is an example of how to run samplers in parallel note that each process must be given a separate seed otherwise the samples generated by independent processes will be equivalent and unhelpful to inference using distributedaddprocs 4 everywhere using turing random set the progress to false to avoid too many notifications everywhere turnprogress false set a different seed for each process for i in procs fetch spawnat i random seed rand int64 end define the model using everywhere everywhere model gdemo x begin s inversegamma 2 3 m normal 0 sqrt s for i in eachindex x x i normal m sqrt s endend sampling setup num chains 4sampler nuts 0 65 model gdemo 1 2 3 5 run all samples chns reduce chainscat pmap x gt sample model sampler 1000 1 num chains", "title": "Advanced Usage"},{"location": "/docs/using-turing/autodiff", "text": "automatic differentiationswitching ad modesturing supports four packages of automatic differentiation ad in the back end during sampling the default ad backend is forwarddiff for forward mode ad three reverse mode ad backends are also supported namely tracker zygote and reversediff zygote and reversediff are supported optionally if explicitly loaded by the user with using zygote or using reversediff next to using turing to switch between the different ad backends one can call function turing setadbackend backend sym where backend sym can be forwarddiff forwarddiff tracker tracker zygote zygote or reversediff reversediff jl when using reversediff to compile the tape only once and cache it for later use the user needs to load memoization jl first with using memoization then call turing setrdcache true however note that the use of caching in certain types of models can lead to incorrect results and or errors models for which the compiled tape can be safely cached are models with fixed size loops and no run time if statements compile time if statements are fine to empty the cache you can call turing emptyrdcache compositional sampling with differing ad modesturing supports intermixed automatic differentiation methods for different variable spaces the snippet below shows using forwarddiff to sample the mean m parameter and using the tracker based trackerad autodiff for the variance s parameter using turing define a simple normal model with unknown mean and variance model gdemo x y begin s inversegamma 2 3 m normal 0 sqrt s x normal m sqrt s y normal m sqrt s end sample using gibbs and varying autodiff backends c sample gdemo 1 5 2 gibbs hmc turing forwarddiffad 1 0 1 5 m hmc turing trackerad 0 1 5 s 1000 generally trackerad is faster when sampling from variables of high dimensionality greater than 20 and forwarddiffad is more efficient for lower dimension variables this functionality allows those who are performance sensistive to fine tune their automatic differentiation for their specific models if the differentation method is not specified in this way turing will default to using whatever the global ad backend is currently this defaults to forwarddiff", "title": "Automatic Differentiation"},{"location": "/docs/using-turing/dynamichmc", "text": "using dynamichmcturing supports the use of dynamichmc as a sampler through the dynamicnuts function dynamicnuts is not appropriate for use in compositional inference if you intend to use gibbs sampling you must use turing s native nuts function to use the dynamicnuts function you must import the dynamichmc package as well as turing turing does not formally require dynamichmc but will include additional functionality if both packages are present here is a brief example of how to apply dynamicnuts import turing and dynamichmc using logdensityproblems dynamichmc turing model definition model gdemo x y begin s inversegamma 2 3 m normal 0 sqrt s x normal m sqrt s y normal m sqrt s end pull 2 000 samples using dynamicnuts chn sample gdemo 1 5 2 0 dynamicnuts 2000", "title": "Using DynamicHMC"},{"location": "/docs/using-turing/get-started", "text": "getting startedinstallationto use turing you need to install julia first and then install turing install juliayou will need to install julia 1 0 or greater which you can get from the official julia website install turing jlturing is an officially registered julia package so the following will install a stable version of turing while inside julia s package manager press from the repl add turingif you want to use the latest version of turing with some experimental features you can try the following instead add turing mastertest turingif all tests pass you re ready to start using turing examplehere s a simple example showing the package in action using turingusing statsplots define a simple normal model with unknown mean and variance model gdemo x y begin s inversegamma 2 3 m normal 0 sqrt s x normal m sqrt s y normal m sqrt s end run sampler collect resultschn sample gdemo 1 5 2 hmc 0 1 5 1000 summarise results currently requires the master branch from mcmcchains describe chn plot and save resultsp plot chn savefig gdemo plot png", "title": "Getting Started"},{"location": "/docs/using-turing/guide", "text": "guidebasicsintroductiona probabilistic program is julia code wrapped in a model macro it can use arbitrary julia code but to ensure correctness of inference it should not have external effects or modify global state stack allocated variables are safe but mutable heap allocated objects may lead to subtle bugs when using task copying to help avoid those we provide a turing safe datatype tarray that can be used to create mutable arrays in turing programs to specify distributions of random variables turing programs should use the notation x distr where x is a symbol and distr is a distribution if x is undefined in the model function inside the probabilistic program this puts a random variable named x distributed according to distr in the current scope distr can be a value of any type that implements rand distr which samples a value from the distribution distr if x is defined this is used for conditioning in a style similar to anglican another ppl in this case x is an observed value assumed to have been drawn from the distribution distr the likelihood is computed using logpdf distr y the observe statements should be arranged so that every possible run traverses all of them in exactly the same order this is equivalent to demanding that they are not placed inside stochastic control flow available inference methods include importance sampling is sequential monte carlo smc particle gibbs pg hamiltonian monte carlo hmc hamiltonian monte carlo with dual averaging hmcda and the no u turn sampler nuts simple gaussian demobelow is a simple gaussian demo illustrate the basic usage of turing jl import packages using turingusing statsplots define a simple normal model with unknown mean and variance model gdemo x y begin s inversegamma 2 3 m normal 0 sqrt s x normal m sqrt s y normal m sqrt s endnote as a sanity check the expectation of s is 49 24 2 04166666 and the expectation of m is 7 6 1 16666666 we can perform inference by using the sample function the first argument of which is our probabalistic program and the second of which is a sampler more information on each sampler is located in the api run sampler collect results c1 sample gdemo 1 5 2 smc 1000 c2 sample gdemo 1 5 2 pg 10 1000 c3 sample gdemo 1 5 2 hmc 0 1 5 1000 c4 sample gdemo 1 5 2 gibbs pg 10 m hmc 0 1 5 s 1000 c5 sample gdemo 1 5 2 hmcda 0 15 0 65 1000 c6 sample gdemo 1 5 2 nuts 0 65 1000 the mcmcchains module which is re exported by turing provides plotting tools for the chain objects returned by a sample function see the mcmcchains repository for more information on the suite of tools available for diagnosing mcmc chains summarise resultsdescribe c3 plot resultsplot c3 savefig gdemo plot png the arguments for each sampler are smc number of particles pg number of particles number of iterations hmc leapfrog step size leapfrog step numbers gibbs component sampler 1 component sampler 2 hmcda total leapfrog length target accept ratio nuts number of adaptation steps optional target accept ratio for detailed information on the samplers please review turing jl s api documentation modelling syntax explainedusing this syntax a probabilistic model is defined in turing the model function generated by turing can then be used to condition the model onto data subsequently the sample function can be used to generate samples from the posterior distribution in the following example the defined model is conditioned to the date arg1 1 arg2 2 by passing 1 2 to the model function model model name arg 1 arg 2 begin endthe conditioned model can then be passed onto the sample function to run posterior inference model func model name 1 2 chn sample model func hmc perform inference by sampling using hmc the returned chain contains samples of the variables in the model var 1 mean chn var 1 taking the mean of a variable named var 1 the key var 1 can be a symbol or a string for example to fetch x 1 one can use chn symbol x 1 or chn x 1 the benefit of using a symbol to index allows you to retrieve all the parameters associated with that symbol as an example if you have the parameters x 1 x 2 and x 3 calling chn x will return a new chain with only x 1 x 2 and x 3 turing does not have a declarative form more generally the order in which you place the lines of a model macro matters for example the following example works define a simple normal model with unknown mean and variance model model function y begin s poisson 1 y normal s 1 return yendsample model function 10 smc 100 but if we switch the s poisson 1 and y normal s 1 lines the model will no longer sample correctly define a simple normal model with unknown mean and variance model model function y begin y normal s 1 s poisson 1 return yendsample model function 10 smc 100 sampling multiple chainsyou can use multiple processes to sample chains in parallel generate 4 chains each with 1 000 samples chains sample model sampler mcmcdistributed 1000 4 alternatively if you have julia 1 3 or greater you may sample multiple chains using multiple threads generate 4 chains each with 1 000 samples chains sample model sampler mcmcthreads 1000 4 for older versions of julia sample may not function correctly if you wish to run multiple chains you can do so with the mapreduce function replace num chains below with however many chains you wish to sample chains mapreduce c gt sample model fun sampler 1000 chainscat 1 num chains the chains variable now contains a chains object which can be indexed by chain to pull out the first chain from the chains object use chains 1 having multiple chains in the same object is valuable for evaluating convergence some diagnostic functions like gelmandiag require multiple chains sampling from an unconditional distribution the prior turing allows you to sample from a declared model s prior by calling the model without specifying inputs or a sampler in the below example we specify a gdemo model which returns two variables x and y the model includes x and y as arguments but calling the function without passing in x or y means that turing s compiler will assume they are missing values to draw from the relevant distribution the return statement is necessary to retrieve the sampled x and y values model gdemo x y begin s inversegamma 2 3 m normal 0 sqrt s x normal m sqrt s y normal m sqrt s return x yendassign the function with missing inputs to a variable and turing will produce a sample from the prior distribution samples from p x y g prior sample gdemo missing missing g prior sample output 0 685690547873451 1 1972706455914328 sampling from a conditional distribution the posterior treating observations as random variablesinputs to the model that have a value missing are treated as parameters aka random variables to be estimated sampled this can be useful if you want to simulate draws for that parameter or if you are sampling from a conditional distribution turing supports the following syntax model gdemo x type t float64 where t begin if x missing initialize x if missing x vector t undef 2 end s inversegamma 2 3 m normal 0 sqrt s for i in eachindex x x i normal m sqrt s endend construct a model with x missingmodel gdemo missing c sample model hmc 0 01 5 500 note the need to initialize x when missing since we are iterating over its elements later in the model the generated values for x can be extracted from the chains object using c x turing also supports mixed missing and non missing values in x where the missing ones will be treated as random variables to be sampled while the others get treated as observations for example model gdemo x begin s inversegamma 2 3 m normal 0 sqrt s for i in eachindex x x i normal m sqrt s endend x 1 is a parameter but x 2 is an observationmodel gdemo missing 2 4 c sample model hmc 0 01 5 500 default valuesarguments to turing models can have default values much like how default values work in normal julia functions for instance the following will assign missing to x and treat it as a random variable if the default value is not missing x will be assigned that value and will be treated as an observation instead using turing model generative x missing type t float64 where t lt real begin if x missing initialize x when missing x vector t undef 10 end s inversegamma 2 3 m normal 0 sqrt s for i in 1 length x x i normal m sqrt s end return s mendm generative chain sample m hmc 0 01 5 1000 access values inside chainyou can access the values inside a chain several ways turn them into a dataframe object use their raw axisarray form create a three dimensional array objectfor example let c be a chain 1 dataframe c converts c to a dataframe 2 c value retrieves the values inside c as an axisarray and 3 c value data retrieves the values inside c as a 3d array variable types and type parametersthe element type of a vector or matrix of random variables should match the eltype of the its prior distribution lt integer for discrete distributions and lt abstractfloat for continuous distributions moreover if the continuous random variable is to be sampled using a hamiltonian sampler the vector s element type needs to either be 1 real to enable auto differentiation through the model which uses special number types that are sub types of real or 2 some type parameter t defined in the model header using the type parameter syntax e g gdemo x type t float64 where t begin similarly when using a particle sampler the julia variable used should either be 1 a tarray or 2 an instance of some type parameter t defined in the model header using the type parameter syntax e g gdemo x type t vector float64 where t begin querying probabilities from model or chainconsider the following gdemo model model gdemo x y begin s inversegamma 2 3 m normal 0 sqrt s x normal m sqrt s y normal m sqrt s endthe following are examples of valid queries of the turing model or chain prob x 1 0 y 1 0 model gdemo s 1 0 m 1 0 calculates the likelihood of x 1 and y 1 given s 1 and m 1 prob s 1 0 m 1 0 model gdemo x nothing y nothing calculates the joint probability of s 1 and m 1 ignoring x and y x and y are ignored so they can be optionally dropped from the rhs of but it is recommended to define them prob s 1 0 m 1 0 x 1 0 model gdemo y nothing calculates the joint probability of s 1 m 1 and x 1 ignoring y prob s 1 0 m 1 0 x 1 0 y 1 0 model gdemo calculates the joint probability of all the variables after the mcmc sampling given a chain prob x 1 0 y 1 0 chain chain model gdemo calculates the element wise likelihood of x 1 0 and y 1 0 for each sample in chain if save state true was used during sampling i e sample model sampler n save state true you can simply do prob x 1 0 y 1 0 chain chain in all the above cases logprob can be used instead of prob to calculate the log probabilities instead beyond the basicscompositional sampling using gibbsturing jl provides a gibbs interface to combine different samplers for example one can combine an hmc sampler with a pg sampler to run inference for different parameters in a single model as below model simple choice xs begin p beta 2 2 z bernoulli p for i in 1 length xs if z 1 xs i normal 0 1 else xs i normal 2 1 end endendsimple choice f simple choice 1 5 2 0 0 3 chn sample simple choice f gibbs hmc 0 2 3 p pg 20 z 1000 the gibbs sampler can be used to specify unique automatic differentation backends for different variable spaces please see the automatic differentiation article for more for more details of compositional sampling in turing jl please check the corresponding paper working with mcmcchains jlturing jl wraps its samples using mcmcchains chain so that all the functions working for mcmcchains chain can be re used in turing jl two typical functions are mcmcchains describe and mcmcchains plot which can be used as follows for an obtained chain chn for more information on mcmcchains please see the github repository describe chn lists statistics of the samples plot chn plots statistics of the samples there are numerous functions in addition to describe and plot in the mcmcchains package such as those used in convergence diagnostics for more information on the package please see the github repository working with libtask jlthe libtask jl library provides write on copy data structures that are safe for use in turing s particle based samplers one data structure in particular is often required for use the tarray the following sampler types require the use of a tarray to store distributions ipmcmc is pg pmmh smcif you do not use a tarray to store arrays of distributions when using a particle based sampler you may experience errors here is an example of how the tarray using a tarray constructor function called tzeros can be applied in this way turing model definition model bayeshmm y begin declare a tarray with a length of n s tzeros int n m vector real undef k t vector vector real undef k for i 1 k t i dirichlet ones k k m i normal i 0 01 end draw from a distribution for each element in s s 1 categorical k for i 2 n s i categorical vec t s i 1 y i normal m s i 0 1 end return s m end changing default settingssome of turing jl s default settings can be changed for better usage ad chunk sizeforwarddiff turing s default ad backend uses forward mode chunk wise ad the chunk size can be manually set by setchunksize new chunk size alternatively use an auto tuning helper function auto tune chunk size mf function rep num 10 which will profile various chunk sizes here mf is the model function e g gdemo 1 5 2 and rep num is the number of repetitions during profiling ad backendturing supports four packages of automatic differentiation ad in the back end during sampling the default ad backend is forwarddiff for forward mode ad three reverse mode ad backends are also supported namely tracker zygote and reversediff zygote and reversediff are supported optionally if explicitly loaded by the user with using zygote or using reversediff next to using turing for more information on turing s automatic differentiation backend please see the automatic differentiation article progress loggingturing jl uses progresslogging jl to log the progress of sampling progress logging is enabled as default but might slow down inference it can be turned on or off by setting the keyword argument progress of sample to true or false respectively moreover you can enable or disable progress logging globally by calling turnprogress true or turnprogress false respectively turing uses heuristics to select an appropriate visualization backend if you use juno the progress is displayed with a progress bar in the atom window for jupyter notebooks the default backend is consoleprogressmonitor jl in all other cases progress logs are displayed with terminalloggers jl alternatively if you provide a custom visualization backend turing uses it instead of the default backend", "title": "Guide"},{"location": "/docs/using-turing/index", "text": "turing documentationwelcome to the documentation for turing introductionturing is a general purpose probabilistic programming language for robust efficient bayesian inference and decision making current features include general purpose probabilistic programming with an intuitive modelling interface robust efficient hamiltonian monte carlo hmc sampling for differentiable posterior distributions particle mcmc sampling for complex posterior distributions involving discrete variables and stochastic control flow and compositional inference via gibbs sampling that combines particle mcmc hmc and random walk mh rwmh", "title": "Turing Documentation"},{"location": "/docs/using-turing/performancetips", "text": "performance tipsthis section briefly summarises a few common techniques to ensure good performance when using turing we refer to julialang org for general techniques to ensure good performance of julia programs use multivariate distributionsit is generally preferable to use multivariate distributions if possible the following example model gmodel x begin m normal for i 1 length x x i normal m 0 2 endendcan be directly expressed more efficiently using a simple transformation model gmodel x begin m normal x mvnormal fill m length x 0 2 endchoose your ad backendturing currently provides support for two different automatic differentiation ad backends generally try to use forwarddiff for models with few parameters and reversediff tracker or zygote for models with large parameter vectors or linear algebra operations see automatic differentiation for details special care for tracker and zygotein case of tracker and zygote it is necessary to avoid loops for now this is mainly due to the reverse mode ad backends tracker and zygote which are inefficient for such cases reversediff does better but vectorized operations will still perform better avoiding loops can be done using filldist dist n and arraydist dists filldist dist n creates a multivariate distribution that is composed of n identical and independent copies of the univariate distribution dist if dist is univariate or it creates a matrix variate distribution composed of n identical and idependent copies of the multivariate distribution dist if dist is multivariate filldist dist n m can also be used to create a matrix variate distribution from a univariate distribution dist arraydist dists is similar to filldist but it takes an array of distributions dists as input writing a custom distribution with a custom adjoint is another option to avoid loops make your model type stablefor efficient gradient based inference e g using hmc nuts or advi it is important to ensure the model is type stable we refer to julialang org for a general discussion on type stability the following example model tmodel x y begin p n size x params vector real undef n for i 1 n params i truncated normal 0 inf end a x params y mvnormal a 1 0 endcan be transformed into the following type stable representation model tmodel x y type t vector float64 where t begin p n size x params t undef n for i 1 n params i truncated normal 0 inf end a x params y mvnormal a 1 0 endnote that you can use code warntype to find type instabilities in your model definition for example consider the following simple program model tmodel x begin p vector real undef 1 p 1 normal p p 1 x normal p 1 endwe can usemodel tmodel 1 0 varinfo turing varinfo model spl turing samplefromprior code warntype model f varinfo spl turing defaultcontext model to inspect the type instabilities in the model reuse computations in gibbs samplingoften when performing gibbs sampling one can save computational time by caching the output of expensive functions the cached values can then be reused in future gibbs sub iterations which do not change the inputs to this expensive function for example in the following model model demo x begin a gamma b normal c function1 a d function2 b x normal c d endalg gibbs mh a mh b sample demo zeros 10 alg 1000 when only updating a in a gibbs sub iteration keeping b the same the value of d doesn t change and when only updating b the value of c doesn t change however if function1 and function2 are expensive and are both run in every gibbs sub iteration a lot of time would be spent computing values that we already computed before such a problem can be overcome using memoization jl memoizing a function lets us store and reuse the output of the function for every input it is called with this has a slight time overhead but for expensive functions the savings will be far greater to use memoization jl simply define memoized versions of function1 and function2 as such using memoization memoize memoized function1 args function1 args memoize memoized function2 args function2 args then define the turing model using the new functions as such model demo x begin a gamma b normal c memoized function1 a d memoized function2 b x normal c d end", "title": "Performance Tips"},{"location": "/docs/using-turing/quick-start", "text": "probablistic programming in thirty secondsif you are already well versed in probabalistic programming and just want to take a quick look at how turing s syntax works or otherwise just want a model to start with we have provided a bayesian coin flipping model to play with this example can be run on however you have julia installed see getting started but you will need to install the packages turing distributions mcmcchains and statsplots if you have not done so already this is an excerpt from a more formal example introducing probabalistic programming which can be found in jupyter notebook form here or as part of the documentation website here import libraries using turing statsplots random set the true probability of heads in a coin p true 0 5 iterate from having seen 0 observations to 100 observations ns 0 100 draw data from a bernoulli distribution i e draw heads or tails random seed 12 data rand bernoulli p true last ns declare our turing model model coinflip y begin our prior belief about the probability of heads in a coin p beta 1 1 the number of observations n length y for n in 1 n heads or tails of a coin are drawn from a bernoulli distribution y n bernoulli p endend settings of the hamiltonian monte carlo hmc sampler iterations 1000 0 05 10 start sampling chain sample coinflip data hmc iterations plot a summary of the sampling process for the parameter p i e the probability of heads in a coin histogram chain p", "title": "Probablistic Programming in Thirty Seconds"},{"location": "/docs/using-turing/sampler-viz", "text": "sampler visualizationintroductionthe codefor each sampler we will use the same code to plot sampler paths the block below loads the relevant libraries and defines a function for plotting the sampler s trajectory across the posterior the turing model definition used here is not especially practical but it is designed in such a way as to produce visually interesting posterior surfaces to show how different samplers move along the distribution env gks encoding utf 8 allows the use of unicode characters in plots jlusing plotsusing statsplotsusing turingusing bijectorsusing randomusing dynamicppl getlogp settrans getval reconstruct vectorize setval set a seed random seed 0 define a strange model model gdemo x begin s inversegamma 2 3 m normal 0 sqrt s bumps sin m cos m m m 5 bumps for i in eachindex x x i normal m sqrt s end return s mend define our data points x 1 5 2 0 13 0 2 1 0 0 set up the model call sample from the prior model gdemo x vi turing varinfo model convert the variance parameter to the real line before sampling note we only have to do this here because we are being very hands on turing will handle all of this for you during normal sampling dist inversegamma 2 3 svn vi metadata s vns 1 mvn vi metadata m vns 1 setval vi vectorize dist bijectors link dist reconstruct dist getval vi svn svn settrans vi true svn evaluate surface at coordinates function evaluate m1 m2 spl turing samplefromprior vi svn m1 vi mvn m2 model vi spl getlogp vi endfunction plot sampler chain label extract values from chain val get chain s m lp ss link ref inversegamma 2 3 val s ms val m lps val lp how many surface points to sample granularity 100 range start stop points spread 0 5 start minimum ss spread std ss stop maximum ss spread std ss start minimum ms spread std ms stop maximum ms spread std ms rng collect range start stop stop length granularity rng collect range start stop stop length granularity make surface plot p surface rng rng evaluate camera 30 65 ticks nothing colorbar false color inferno title label line range 1 length ms scatter3d ss line range ms line range lps line range mc viridis marker z collect line range msw 0 legend false colorbar false alpha 0 5 xlabel ylabel zlabel log probability title label return pend samplersgibbsgibbs sampling tends to exhibit a jittery trajectory the example below combines hmc and pg sampling to traverse the posterior c sample model gibbs hmc 0 01 5 s pg 20 m 1000 plot sampler c hmchamiltonian monte carlo hmc sampling is a typical sampler to use as it tends to be fairly good at converging in a efficient manner it can often be tricky to set the correct parameters for this sampler however and the nuts sampler is often easier to run if you don t want to spend too much time fiddling with step size and and the number of steps to take note however that hmc does not explore the positive values very well likely due to the leapfrop and step size parameter settings c sample model hmc 0 01 10 1000 plot sampler c hmcdathe hmcda sampler is an implementation of the hamiltonian monte carlo with dual averaging algorithm found in the paper the no u turn sampler adaptively setting path lengths in hamiltonian monte carlo by hoffman and gelman 2011 the paper can be found on arxiv for the interested reader c sample model hmcda 200 0 65 0 3 1000 plot sampler c mhmetropolis hastings mh sampling is one of the earliest markov chain monte carlo methods mh sampling does not move a lot unlike many of the other samplers implemented in turing typically a much longer chain is required to converge to an appropriate parameter estimate the plot below only uses 1 000 iterations of metropolis hastings c sample model mh 1000 plot sampler c as you can see the mh sampler doesn t move parameter estimates very often nutsthe no u turn sampler nuts is an implementation of the algorithm found in the paper the no u turn sampler adaptively setting path lengths in hamiltonian monte carlo by hoffman and gelman 2011 the paper can be found on arxiv for the interested reader nuts tends to be very good at traversing complex posteriors quickly c sample model nuts 0 65 1000 plot sampler c the only parameter that needs to be set other than the number of iterations to run is the target acceptance rate in the hoffman and gelman paper they note that a target acceptance rate of 0 65 is typical here is a plot showing a very high acceptance rate note that it appears to stick to a mode and is not particularly good at exploring the posterior as compared to the 0 65 target acceptance ratio case c sample model nuts 0 95 1000 plot sampler c an exceptionally low acceptance rate will show very few moves on the posterior c sample model nuts 0 2 1000 plot sampler c pgthe particle gibbs pg sampler is an implementation of an algorithm from the paper particle markov chain monte carlo methods by andrieu doucet and holenstein 2010 the interested reader can learn more here the two parameters are the number of particles and the number of iterations the plot below shows the use of 20 particles c sample model pg 20 1000 plot sampler c next we plot using 50 particles c sample model pg 50 1000 plot sampler c", "title": "Sampler Visualization"}]}
